<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>米琴香光</title>
  <icon>https://www.gravatar.com/avatar/0ada4b51ad3a273705846d0117a03f4f</icon>
  
  <link href="/atom.xml" rel="self"/>
  
  <link href="https://hejtao.netlify.com/"/>
  <updated>2019-12-06T14:02:12.485Z</updated>
  <id>https://hejtao.netlify.com/</id>
  
  <author>
    <name>Jiang-Tao He</name>
    <email>hejtao@outlook.com</email>
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>数学通识50讲</title>
    <link href="https://hejtao.netlify.com/2019/11/25/2019-11-25/"/>
    <id>https://hejtao.netlify.com/2019/11/25/2019-11-25/</id>
    <published>2019-11-24T16:00:00.000Z</published>
    <updated>2019-12-06T14:02:12.485Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><meta name="referrer" content="no-referrer"><p><img src="/images/26.jpg" alt=""></p><div class="toc"><!-- toc --><ul><li><a href="#fa-kan-ci-shu-xue-gai-zen-me-xue">发刊词：数学该怎么学？</a></li></ul><ul><li><a href="#mo-kuai-yi-shu-xue-de-xian-suo">模块一 ｜ 数学的线索</a><ul><li><a href="#01-dao-lun-shu-xue-tong-shi-ke-de-ti-xi-he-xue-xi-gong-lue">01 ｜ 导论：数学通识课的体系和学习攻略</a></li><li><a href="#02-gou-gu-ding-li-wei-shi-me-zai-xi-fang-jiao-bi-da-ge-la-si-ding-li">02 ｜ 勾股定理：为什么在西方叫毕达哥拉斯定理</a></li><li><a href="#03-shu-xue-de-yu-jian-xing-ru-he-yong-tui-li-zou-chu-ren-zhi-mang-qu">03 ｜ 数学的预见性：如何用推理走出认知盲区</a></li><li><a href="#04-shu-xue-si-wei-shu-xue-jia-ru-he-cong-luo-ji-chu-fa-xiang-wen-ti">04 ｜ 数学思维：数学家如何从逻辑出发想问题</a></li><li><a href="#05-shu-xue-bian-jie-cong-bi-da-ge-la-si-ding-li-dao-fei-ma-da-ding-li">05 ｜ 数学边界：从毕达哥拉斯定理到费马大定理</a></li><li><a href="#06-huang-jin-fen-ge-bi-da-ge-la-si-ru-he-lian-jie-shu-xue-he-mei-xue">06 ｜ 黄金分割：毕达哥拉斯如何连接数学和美学</a></li><li><a href="#07-shu-xue-ying-yong-hua-luo-geng-hua-fan-wei-jian-de-shen-lai-zhi-bi">07 ｜ 数学应用：华罗庚化繁为简的神来之笔</a></li><li><a href="#08-shu-lie-he-ji-shu-yi-dang-xia-hen-chong-yao-dan-qu-shi-geng-chong-yao">08 ｜ 数列和级数（一）：当下很重要，但趋势更重要</a></li><li><a href="#09-shu-lie-he-ji-shu-er-chuan-xiao-pian-ju-de-shu-xue-yuan-li">09 ｜ 数列和级数（二）：传销骗局的数学原理</a></li><li><a href="#10-shu-lie-he-ji-shu-san-cang-zai-li-xi-he-yue-gong-li-de-mi-mi">10 ｜ 数列和级数（三）：藏在利息和月供里的秘密</a></li></ul></li><li><a href="#mo-kuai-er-shu-xue-de-gai-nian">模块二 ｜ 数学的概念</a><ul><li><a href="#11-ji-tu-tong-long-fang-cheng-zhe-ge-shu-xue-gong-ju-wei-shi-me-hen-qiang-da">11 ｜ 鸡兔同笼：方程这个数学工具为什么很强大</a></li><li><a href="#12-san-ci-fang-cheng-shu-xue-shi-shang-de-fa-ming-quan-zhi-zheng">12 ｜ 三次方程：数学史上的发明权之争</a></li><li><a href="#13-xu-shu-xu-gou-zhe-ge-gong-ju-you-shi-me-yong">13 ｜ 虚数：虚构这个工具有什么用</a></li><li><a href="#14-wu-qiong-wo-men-wei-shi-me-nan-yi-li-jie-wu-xian-de-shi-jie">14 ｜ 无穷：我们为什么难以理解无限的世界？</a></li><li><a href="#15-wu-qiong-xiao-yi-ru-he-shuo-fu-gang-jing-zhi-nuo">15 ｜ 无穷小（一）：如何说服杠精“芝诺”？</a></li><li><a href="#16-wu-qiong-xiao-er-niu-dun-he-bei-ke-lai-zai-zheng-shi-me">16 ｜ 无穷小（二）：牛顿和贝克莱在争什么？</a></li><li><a href="#17-wu-qiong-xiao-san-yong-dong-tai-he-ji-xian-de-yan-guang-kan-shi-jie">17 ｜ 无穷小（三）：用动态和极限的眼光看世界</a></li></ul></li><li><a href="#mo-kuai-wu-wei-ji-fen">模块五 ｜ 微积分</a><ul><li><a href="#30-wei-ji-fen-shang-ru-he-cong-hong-guan-bian-hua-liao-jie-wei-guan-qu-shi">30 ｜ 微积分（上）：如何从宏观变化了解微观趋势</a></li></ul></li></ul><!-- tocstop --></div><h3><span id="fa-kan-ci-shu-xue-gai-zen-me-xue">发刊词：数学该怎么学？</span><a href="#fa-kan-ci-shu-xue-gai-zen-me-xue" class="header-anchor">#</a></h3><p><img src="/images/18.jpg" alt=""></p><p>  在上个世纪80年代，国内流行过一句口号：“学好数理化，走遍天下都不怕。”因为当时的教学体系还不完善，数理化这些基础学科比重大，而且容易培养出建设型人才，所以受到重视。当然，随着综合教育体系的完善，这个口号也就不再流行了。</p><p>  但是，在今天来看，无论你的专业和工作是什么，你都会发现，数理化这些底层学科是不是牢固，真的决定了一个人的知识结构能搭多高，在专业上能走多远，尤其是数学。数学作为一切科学的基础，它化繁为简，直击本质的思考方式，让很多人获益。那些数学成绩好的人，做起事来总是一通百通，很容易脱颖而出。</p><p>  但是事实上，很多学习数学的人会感觉自卑，并产生厌恶。这是为什么呢？当然不是数学本身的问题，也不是我们人的问题，而是因为我们和数学之间缺失了一个桥梁。数学是一种抽象的知识体系，而我们人要靠经验感知才能认识世界，这中间需要一个桥梁，这个桥梁一旦构建起来，每一个人都能受益于数学。</p><p>  那么是否每一个人都有可能学好数学呢？公平地讲，数学往深了学确实很费脑力，对大多数人来讲有点难度，但是把平时用到的、能够提升我们思维的数学学好，是每个人都能做到的。接下来我就用一个例子谈谈怎么学数学。</p><p>  2017年，一位原央视的主持人请我和中国科技馆前馆长王渝生先生，做一个有关数学的节目。在节目开始前，主持人对我说，她高考时数学不及格，是个学渣。我说，你能有今天这样的成就，显然不是学渣。数学没学好，不是你的问题，是教学的方法和考量学生的方法不对。</p><p>  然后我就告诉她美国顶级的高中和大学是怎样教数学的。在美国最好的高中，把数学课由中国的一门课变为8～10门内容不同的课程，每门课还要开A、B、C三个难度不同的班。比如我们中国（从初中到高中）的几何，被分为平面几何A、B、C，解析几何A、B、C，等等各种难度的课程和班级。</p><p>  入门的那几门数学课足够浅显，难度较低的班会讲得更浅，内容更精简。比如平面几何的A，讲清楚几何学的原理和用途，以及推理的思维方式就好，就不让学生再做那些比较难的证明题了。像点、线、面、三角形、四边形和多边形等概念，以及平行、垂直等关系，其实对任何人都不难，都能取得好成绩。</p><p>  当然，由于你选择了简单的数学，也就没有浪费时间去攻克对自己来说很难的数学内容，就可以学更多自己喜欢的文学或历史，然后申请那些更适合自己的大学。更重要的是，虽然你所学的数学课不多，也不深，但好歹掌握了基本概念，掌握了相应的思维方式，<strong>如果将来真想再继续学，还是有可能的</strong>。否则你学了一大堆理解不了，考试通不过的内容，不仅浪费时间，而且本来能学会的简单内容也全丢掉了。</p><p>  不信我问你，还记得住计算圆球体积的公式，或者方程组的解法吗？那些都不是什么很难的内容，但是因为大家做不出数学题，考不出满意的分数，就从心里彻底放弃了这门课，以至于那些本应该记住的简单内容也干脆全忘光了。可以说，结果就是早早地就把通往数学的桥梁毁掉了，从此以后，再也没有体会过数学思维的乐趣，放弃了智识生活的可能。</p><p>  <strong>那么在我的数学课中，我会教什么？大家又应该怎么学？学完以后应该怎么用呢？</strong></p><p>  在教学方面，我会模仿美国的数学教学方式，为你做好三件事，也是我这门数学课的三个教学特色：</p><p>  <strong>首先，我会为你重建这座通往数学的桥梁，帮你把那些熟悉的知识点各安其位，放进知识体系里。</strong> 我的讲法是把一门数学课从完整的体系变成一个个的知识点，讲透之后，再还原回体系。让你能够熟练地把握知识点和课程体系的关系，这门课的体系也就搭建好了。</p><p>  以最难的几何学为例，再难的几何题，其实最终都可以拆成那五个最基本的公理。这五个公理，又可以推导出几何学的任何结论。就如同几种乐高积木可以搭出任何形状一样，我会在几何那个模块介绍给大家。</p><p>  至于这个体系能构建得多大，则要看学生能够接受的程度，学生接受的程度高，就搭一些复杂的，接受程度低，就搭一些简单的。但是能够拆解和搭建哪怕是比较小的体系，通识教育的目的就达到了。</p><p>  **其次，在介绍这些关键数学知识点的同时，我会讲清楚它们在数学上的位置，以及和各种知识体系的相关性。**这样不仅能够把各种知识打通，而且能够让你在自己的行业中超越绝大部分从业者。</p><p>  我的《数学之美》出版后，很多人读后感慨，原来数学对信息处理帮助这么大。但其实那本书中介绍的全部内容，不过是一些知识点。而仅仅是理解了那些知识点的计算机从业者，就已经获得更强的竞争力了。</p><p>  再比如，为什么大家熟知的勾股定理，在国际上通行的叫法是毕达哥拉斯定理？因为勾股定理只是经验，而毕达哥拉斯定理却完成了数学证明，但教科书出于发明权的考量并没有说明，结果就是把数学这门课的逻辑基础搞丢了。以至于很多人大学毕业工作多年依然搞不清物理上用实验证实的定律和数学上用逻辑证明的定理有什么差别。如果基础就打歪了，以后进入工作，很可能出大错。</p><p>  **最后一点，也是最重要的，是通过学习数学，实现思维方式的跃进。**为了做到这一点，并不需要讲述太难的数学知识，而是需要讲透。事实上，我们无论是讲透毕达哥拉斯定理，还是更难懂一些的欧拉公式，都可以在讲述的过程中将数学家超出凡人的思维方式讲清楚。毕竟对于大部分人来讲，一辈子用不到欧拉公式，如果他们不容易理解，用简单的例子把道理讲清楚就变得格外重要了。</p><p>  至此，我为你搭建的桥梁就算建造好了，当然，还是需要你亲自从这头走到那头去，我们接下来谈谈你怎么做，才能跟着我学好数学：</p><p>  一个学好数学最重要的办法是，不断训练自己的思维方式。</p><p>  很多人喜欢读侦探小说和悬念小说，喜欢解决各种谜题，这其实是人类的一种天性，也是对头脑的一种训练。学数学能够提高我们这方面的能力，让自己成为一个“深入的思考者”（Deep Thinker）。</p><p>  世界上有两种所谓的聪明人，一种是反应很快的人，被称为Quick Thinker，另一类则是Deep Thinker，也被称为Hard Thinker，无论是哪一种，其实都是可以后天训练的。训练快速反应最好的办法就是多听多看。但是训练Deep Thinker，就需要练习一环扣一环解套的本事了。</p><p>  用数学做这种训练的好处是，它经过上千年的发展，已经有一整套训练材料了。所以学数学，就像打游戏晋级一样，一点点往前探索，一个个击破难题。最后，请你查看课表（即目录），当然我还是想再从不同的维度上帮你提炼一下。</p><p>  首先，我们会学到虚数、极限、微分、积分等等这样的具体知识点，掌握它们之间的关联，以及它们在人类认知方面的地位。这样我们就能理解人类是如何扩展自己的认知的。如果我们把自己成长的过程和人类成长的过程做一个对标，就能通过它们扩展我们自己的认知。</p><p>  再往上一个维度，你还能了解数学在人类知识体系中的地位，比如数学和艺术的关系，和法律，和经济学的关系，等等。很多时候，数学不能直接解决我们的实际问题，但是它能够给我们提供一个思路。在更高的维度上，我会通过介绍数学的发展史，帮你理解数学思维，也就是人类的认识是如何从直观到抽象，从静态到动态，从宏观到微观和宇观，从随意到确定，再到随机，等等。</p><p>  好，如果你想重新认识一下数学，和我一起感受一次数学之美，那么欢迎你加入我的《数学通识50讲》。当然，除了数学通识，我还将开设一系列的通识课程，把每个人都需要掌握的人类知识精华，整理成课程，帮每个现代人装备自己的头脑，找到最适合这个世界的思维方式。</p><p>  好，我们马上开始数学之旅！</p><h2><span id="mo-kuai-yi-shu-xue-de-xian-suo">模块一 ｜ 数学的线索</span><a href="#mo-kuai-yi-shu-xue-de-xian-suo" class="header-anchor">#</a></h2><h3><span id="01-dao-lun-shu-xue-tong-shi-ke-de-ti-xi-he-xue-xi-gong-lue">01 ｜ 导论：数学通识课的体系和学习攻略</span><a href="#01-dao-lun-shu-xue-tong-shi-ke-de-ti-xi-he-xue-xi-gong-lue" class="header-anchor">#</a></h3><p><img src="/images/17.jpg" alt=""></p><p>  这一讲算是数学通识课的学习地图，我会带你俯瞰一下这门课的全貌，便于你系统地把握课程内容。</p><p>  如果把人类的知识体系用学科来划分的话，数学可能是其最大的一个，因此要想在50讲左右的时间里介绍它的全貌是不可能的。</p><p>  所幸的是，作为通识教育，你不需要学那么多，而且数学的各个分支，无论难易，从体系到研究方法，再到应用方法是共通的。</p><p>  成年人接受数学通识教育，其实只要做到一点就够了，就是从理解初等数学到理解高等数学——（也就是）把自己对所有和数学相关的概念和方法的理解程度，从静态的、具体的，上升到动态的、规律性的。要达到这个目的，不需要讲很多内容，但需要一些线索。</p><p>  下面我就简单介绍一下课程的内容和我选择它们来串联课程的理由。</p><p>  <strong>第一模块讲的是数学究竟是怎么从一个猜想，得出推论，然后又产生实际应用的。</strong></p><p>  根据《时间简史》和《大设计》的共同作者蒙洛迪诺的讲法，人类早期的所有知识体系都是：“前科学”。这是好听的说法，难听的说法叫做“巫术式”的。</p><p>  在所有早期文明中，唯一的例外是古希腊。但即使是在古希腊，我们所知的那些大学问家们比如泰勒斯、赫拉克利特、亚里士多德，他们的思维依然是前科学的，不是科学的，因为他们对客观世界的解释，加入了太多主观的想象。而在古希腊，真正具有划时代意义的人则是毕达哥拉斯。</p><p>  毕达哥拉斯是将数学从经验上升到系统性学科的第一人。他确立了数学的起点，也就是必须遵循严格的逻辑证明才能得到结论的研究方法，这就让数学从早期那些需要靠测量和观测的学科，比如天文学、地理学和物理学中，脱身出来，成为所有基础学科之上，带有方法论性质的特殊学科。</p><p>  因此，我们会先从毕达哥拉斯学起，他也是整个第一模块的主线。那么我会怎么讲这个模块呢？</p><p>  首先，我会讲毕达哥拉斯最出名的毕达哥拉斯定理，也就是我们所说的勾股定理。</p><p>  我们还知道，毕达哥拉斯最被后人所诟病的地方是否认无理数的存在，并假装视而不见，还把提出这个问题的学生害死了。</p><p>  对此，今天很多人说他无知，顽固，拒绝接受真理等等。但是要知道，在当时人们所知的有限的数学领域中，毕达哥拉斯是这个体系的教主，他需要这个建立在逻辑之上的体系的一致性和完备性，而逻辑上的一致性也是数学最基础的原则。</p><p>  因此，他发现无理数的出现会破坏他所理解的数学体系的完备性，动摇数学大厦时，他就采取了教主们才会采用的激进行为。</p><p>  毕达哥拉斯真正的错误在于，他不懂得要维系数学这个体系，需要定义“无理数”这样的新概念。无理数造成的数学危机解决之后，数学反而发展了，并没有像毕达哥拉斯想的那样崩溃。</p><p>  毕达哥拉斯另一个了不起的成就，就是算出了黄金分割的比例。从黄金分割出发，毕达哥拉斯发现了数学和美学的关系，并且开始用数学指导音乐。</p><p>  概括来讲，我们在第一模块“数学的线索”里面，以毕达哥拉斯为线索，一方面将很多数学知识点串联起来，向大家展示数学是什么样的体系，另一方面，我们把毕达哥拉斯作为例子，说明数学发展和体系构建常常经历的步骤。也就是，<strong>从特例到引理再到定理、推论，最后到应用的全过程。</strong></p><p>  但是数学的发展又非单一线索，从一个点出发可能产生了很多并列的推论，因此我们不得不在课程中把并行的内容按顺序来讲。比如在第一模块中，我们在讲完黄金分割的应用后，又会回来讲和它有关的等比数列。</p><p>  当你知道数学定理是如何从猜想到推论再到应用的过程，我们就进入课程的<strong>第二个模块“数的概念”，通过讲述人类对数字这个概念的认识历程，我会给你一个思维工具——“从具体到抽象”</strong>，从而解释为什么你从小学数字，但其实对数字的认识并没有提高，以及学数学多年都不能为己所用的原因。</p><p>  照理讲，我们的认知水平应该随着所学内容难度的提升而提升，但是通常不是如此。很多人学到大学关于数字的概念时，对数字的理解方式，还停留在小学阶段。</p><p>  比如，对于无穷大和无穷小这样的概念，很多人依然以为它们只是巨大的数字和极小的数字。事实上它们和我们日常遇到的具体数字不同，代表着变化的趋势和变化的快慢。因此从小学到了大学，大家对数字的理解就应该从静态到动态，但遗憾的是，很多人并没有这样的认识。</p><p>  当一个人用小学的思维方式，学习大学的数学内容，一定会觉得难以理解，于是对数学敬而远之。这并不能怪学习的人，而是怪很多数学课在设计时，没有把听众当作未来的主人，而只是把他们当作未来的工匠，教给他们一些具体知识让他们干活，而非更高级的思维认知。</p><p>  因此，在第二模块中，我们会突出数学作为“抽象思维”工具的作用，比如人们从具体算术到抽象代数，用到解方程、虚数等等，为什么要学习它们？因为它们的角色是人类造出来的抽象工具，在现实生活中并不存在，但是有了它们，现实的问题就好解决了。数学通识教育，一个重要目的就是让大家习惯于使用这样的抽象工具。</p><p>  **第三、第四模块的内容集中在我们熟知的几何和代数。**在几何的模块中，我们会以它为例子介绍什么是公理化的知识体系，它是如何建立的。</p><p>  在代数的模块中，我们会重点介绍函数和向量。函数这个概念的发明，把我们人类的认知从个体上升为整体，从单点联系，上升为规律性的网状联系。</p><p>  比如同一道题目，从小学到大学，理解是不同的，这是一个从单纯理解数字大小，到理解它方向性的过程。在小学，如果我们看到一道题，说张三以50公斤的力拉箱子，李四以30公斤的力拉，拉箱子的力是多少？答案很简单，就是80公斤。但是到了初中，我们有了负数的概念，你就要问他们拉箱子的力是相同的还是相反的，如果是相反的，只有20公斤。</p><p>  再往上学，我们就要问他们拉箱子的力夹角是多少度，在90度时和120度时，受力可是不同的，这就进入到了大学思维。</p><p>  向量和线性代数，就是把数字从单纯的数值，变成了有方向的数值。所以，我认为这两大知识点，最能代表代数模块的内涵，可以帮助大家提升认知。</p><p>  **第五模块是微积分，这已经是高等数学的内容了。**但是，我们其实在第二模块里已经不知不觉地把微积分中最难的内容提前讲了，因此在这个模块，大家反而会觉得简单。</p><p>  对于微积分，它和初等数学的工具有什么不同呢？人们开始对把数学从关注静态的关系，变成了对动态规律，特别是瞬间规律的把握上。理解这一点，并且主动应用到工作中，是我们学习微积分的目的。那些很难的概念，解题技巧，其实毫不重要。</p><p>  好，前面你学习了数学公理、数字、几何、代数和微积分，提纲挈领地回顾了数学发展的历史，这些分支有个特点，就是能给出问题唯一的答案。</p><p>  但是到了近代，很多现实问题很难有完全确定的答案。于是，**为了研究不确定世界的规律性，概率和统计发展起来了。**数学的这个分支在今天我们充满不确定性的世界里非常重要，也是所谓的大数据思维的科学基础。</p><p>  纵观数学发展的历程，以及我们应该具有的数学思维历程，我们可以看到这样的趋势，从个案到整体规律，从个别定理到完整的知识体系，从具体到抽象，从完全的确定性，到把握不确定性。</p><p>  无论是在整个的课程中，还是每一个模块之内，我们都能看到这样人类认知升级的过程。当然，我觉得这也应该是我们自己的认知升级过程。</p><p>  在课程的最后，我们会介绍数学和其它学科的关系。这样能够在完整的知识体系中，更好地理解数学。接下来，我们就先从毕达哥拉斯讲起，从数学的起点开始我们的数学之旅。</p><h3><span id="02-gou-gu-ding-li-wei-shi-me-zai-xi-fang-jiao-bi-da-ge-la-si-ding-li">02 ｜ 勾股定理：为什么在西方叫毕达哥拉斯定理</span><a href="#02-gou-gu-ding-li-wei-shi-me-zai-xi-fang-jiao-bi-da-ge-la-si-ding-li" class="header-anchor">#</a></h3><p><img src="/images/20.jpg" alt=""></p><p>  我们的第一个模块，会为大家介绍数学的线索，也就是它从猜想到定理再到应用的整个过程。我会以毕达哥拉斯定理为例来展开。</p><p>  勾股定理大家都不陌生，它讲的是直角三角形两条直角边的平方之和等于斜边的平方。</p><p>  但是，这个定理在国外都被称为毕达哥拉斯定理。毕达哥拉斯（Pythagoras，约公元前580年—约公元前500年）是古希腊著名的数学家和知识的集大成者。</p><p>  相关阅读：《科技史纲60讲》15｜为什么其他文明没有诞生古希腊的科学？</p><p>  接下来有两个疑点，你的中学老师可能在刻意回避或者说没有讲清楚，而它们又实在太重要了。</p><p>  <strong>第一个疑点：这个定理是否在毕达哥拉斯之前就被发现了？</strong></p><p>  我们过去的教科书里讲，据汉朝的数学书《周髀算经》的记载，早在公元前1000年的时候，周公和商高这两个人就谈到了“勾三股四弦五”。他们的年代比毕达哥拉斯早，因此教科书中讲是中国人商高最早提出这个定理的，于是称之为勾股定理或者商高定理。</p><p>  我们先不说《周髀算经》里所记载是否靠谱，就算靠谱，它也只是记载了一组勾股数（即直角三角形直角边和斜边都是整数的情况），并不能说明发现了其中的规律。因为比周公和商高早1500年，古埃及人在建造大金字塔时就已经按照勾股数在设计墓室的尺寸了。</p><p>  如果再往前推，美索不达米亚人早在公元前18世纪左右就知道很多组的勾股数（包括勾三股四弦五），而且留下了实物证据。比如耶鲁大学的博物馆里就保存了一块记满勾股数的泥板。</p><p><img src="/images/21.jpg" alt=""></p><p>  <strong>接下来就产生了第二个疑点，古埃及和美索不达米亚为什么不去争夺这个定理的发现权呢？</strong></p><p>  简单地讲，所有这些古代文明不过是举出了一些特例而已，甚至没有提出假说。我们在后面的课程中会看到，很多时候特例中反映出的规律和后来真正的定理可能是不同的。所以，这种特例就没有意义。</p><p>  如果像美索不达米亚人那样举了很多特例，而且没有发现例外，是否可以认为他们最先发现这个定理呢？答案是否定的，因为光举例子还是不够的，还需要做出一个明确的规律性的描述，这种描述我们可以把它称为命题。一个命题在没有证明之前，只能算是猜想，比如著名的哥德巴赫猜想。而总结出一个猜想和证明定理依然是两回事，当然这是比举几个例子进了一大步了。</p><p>  再接下来，猜想如何证实呢？在这一点上数学和自然科学完全不同。那么我们就要说到数学和自然科学的三个本质差别，也是这一讲最重要的三个知识点，它们能够帮助我们理解数学特殊的方法和思维方式，或者说了解数学的推理世界与我们真实的测量世界的区别。</p><p>  <strong>1.测量和逻辑推理的区别</strong></p><p>  我们知道几何学源于古埃及，当地人出于农业生产的考虑，对天文和土地进行度量，发明了几何学。但是，度量出来的几何其实和真正的数学还有很大的差距。</p><p>  比如说，古代文明的人们确实观察到勾股数的现象，他们画一个直角三角形，勾三尺长、股四尺长时，弦长恰好就是五尺长，于是就有了勾三股四弦五的说法。</p><p>  但是这里面存在一个大问题，我们说长度是三尺，其实并非数学上准确的长度，用尺子量出来的3，可能是3.01，也可能是2.99。这样一来勾三股四弦五就是一个比较模糊的说法了。为了让你更好地理解这一点，我们不妨看这样一个例子。</p><p><img src="/images/22.jpg" alt=""></p><p>  图中左上方有一个8x8的方格，它的面积是64，这没有疑问吧？我按照图中所示的粗线将它剪成四部分，两黄两灰，再重新组合，就得到了一个13x5的长方形，它的面积是65。请问面积是64的正方形怎么重新组合一下面积就多出1，变成65了呢？</p><p>  当然我们知道64不等于65，这里面一定有问题。那么问题在哪儿呢？其实，问题就出在再拼接时，它们并不是严丝合缝的，只不过缝隙较小，大部分人看不出来罢了。</p><p>  在数学上，观察的经验可以给我们启发，但是它不能成为我们得到数学结论的依据，数学上的结论只能从定义和公理出发，使用逻辑严格证明得到，不能通过经验总结出来。讲回到勾股定理，一个工匠注意到勾三股四弦五这个现象，和提出一个具有普遍意义的定理是两回事。</p><p>  我们通过观察还可以发现，如果勾3.5，股4.5，那么弦大约是5.7，这个“大约”的误差只有万分之一点六左右（弦长大约是5.700887），古代任何测量都发现不了。这时如果你说勾3.5股4.5弦5.7，从物理上来说基本正确，但是在数学上就错了。这是第一个差别，就是测量会出错，但推理不会。</p><p>  那么，如果我们抛开误差的影响，是否可以认为早期文明的人们发现了勾股定理呢？也不能，只能说他们观察到一些现象，而非发现了定理。这涉及到数学和自然科学的第二个主要区别，证实和证明的区别了。</p><p>  <strong>2.用事实证实和用逻辑证明的区别</strong></p><p>  在自然科学中，一个假说通过实验证实，就变成了定律。比如说与牛顿同时代英国的大科学家波义耳同法国科学家马略特一同发现：一个封闭容器中气体的压强和体积成反比。这很好理解，因为体积压得越小，内部的压强肯定越大。这两个人通过很多实验，都证实了这件事，于是这个定律就由他们两个人的名字命名了。</p><p>  但是，如果有一个非常爱较真的人一定要抬杠，说你们证实了所有的情况（各种体积和压强的组合）吗，你们敢保证没有例外么？波义耳和马略特肯定会说，我们不敢保证没有例外，但是这个规律你平时使用肯定没有问题。果然，后来人们真的发现当压强特别大时，这个定律就不管用了。但是没有关系，在大多数条件下，这个定理依然成立，今天人们在做产品时，依然可以用。</p><p>  事实上，今天几乎所有的自然科学的定律和理论，不仅存在一个被推翻的可能性，而且有很多的例外。比如，证实引力波的实验，也只能保证99.9999%的可能性结论是对的。</p><p>  但是，在数学上，用实验来验证一个假说（在数学上常常被称为猜想）是不被允许的，我们在后面介绍无穷大时，大家还会看到这甚至是做不到的。数学的结论只能从逻辑出发，通过归纳或者演绎得出来。它必须完全正确，没有例外，因为但凡有一个例外（也被称为反例），就要被完全否定掉。这里面最著名的例子就是哥德巴赫猜想。</p><p>  今天人们利用计算机，在可以验证的范围内，都验证了这个猜想是对的，但是因为没有穷尽所有的可能，就不能说猜想被证明了。因此，我们依然不能在这个基础上，构建其它的数学定理。所以，数学世界和测量世界第二个区别就是，数学理论必须要证明，保证没有例外。</p><p>  <strong>3.科学结论相对性和数学结论绝对性的区别</strong></p><p>  为什么数学要那么严格，它的定理为什么不能有任何例外，更不能特殊情况特殊处理呢？因为数学上的每一个定理都是一块基石，后人需要在此基础上往前走，试图建立一块新的基石，然后数学的大厦就一点点建成了。在这个过程中不能有丝毫的缺陷，一旦有，整个数学大厦就轰然倒塌了。</p><p>  还是以勾股定理为例，它的确立，其实教会了人们在平面计算距离的方法，在此基础之上，三角学才得以建立，笛卡尔的解析几何才得以确立，再往上才能建立起微积分等数学工具。此外我们这个模块后面会讲到的无理数的出现、黄金分割，都和它有关。</p><p>  人类今天发明的各种科技，像无线通信、航天等等，依赖于这些定理。如果出现了一个违反毕达哥拉斯定理的反例，不仅是这个定理失效了，而且整个数学就完蛋了，我们的科技也就时灵时不灵了。因此，数学上的每一个定理，必须也只能通过逻辑推演来证明，用多少实例来验证都没有用。</p><p>  理解了数学定理确立的过程，以及它随后产生的巨大影响，我们就清楚定理和定理证明在数学中的重要性了。正是因为这个原因，西方才将这个定理命名为毕达哥拉斯定理，以彰显他的贡献。是他明确提出这个定理，并且严格地证明了它，从此毕达哥拉斯定理才成为了数学上普遍的规律。</p><p>  有了一个个的定理，数学就得以建立起来，而且这个建立在逻辑推理基础上的大厦很坚固。在数学上，当一个新的定理被证明后，就会产生很多自然的推论，每一个推论可能都是一个重大的发现，甚至能带来人类认识的升级。毕达哥拉斯定理的一个直接推论，就是无理数的存在。这个内容我们下一讲再讲。</p><p><strong>要点总结：</strong></p><p>  数学和自然科学不同，它不相信测量，不是建立在实证基础之上，而是建立在逻辑基础之上的。数学也不接受大部分情况正确，但是包含例外的定理。这样整个数学大厦的基础才得以稳固。</p><p>  数学定理确立的过程大致是这样的，一开始可能只是大家注意到几个特例，然后发现很多例证提出猜想，猜想经过证明就成为了定理，定理会有推论，在此基础上，会有新的定理和应用。</p><p><strong>思考题：</strong></p><p>  在物理学中，从不同的角度理解光，会得到粒子说和波动说两种解释，数学从两个角度证明一个定理，会不会得到不同的结论？</p><h3><span id="03-shu-xue-de-yu-jian-xing-ru-he-yong-tui-li-zou-chu-ren-zhi-mang-qu">03 ｜ 数学的预见性：如何用推理走出认知盲区</span><a href="#03-shu-xue-de-yu-jian-xing-ru-he-yong-tui-li-zou-chu-ren-zhi-mang-qu" class="header-anchor">#</a></h3><p><img src="/images/19.jpg" alt=""></p><p>  上一讲，我们通过毕达哥拉斯定理解释了数学的起点，它必须是从逻辑推理和证明得来的，而非测量和实验出来的。我们这一讲就看看以毕达哥拉斯定理为起点出发，人们又发现了什么。</p><p>  在古希腊毕达哥拉斯（Pythagoras，约公元前580年—约公元前500年）所处的时代，人们认识到的数学上的数字都是有理数，它们都有我们平时所说的分数，具有A/B这样的形式，比如2/3，其中A和B都是整数，当然，整数本身可以被看成分母等于1的分数，比如5=5/1。</p><p>  毕达哥拉斯有一个很怪的想法，他坚信世界的本源是数字，而数字必须是完美的。整数很完美，而且分数的分子分母也都是整数，不会是零碎的，因此也很完美，整数和分数所构成的有理数让毕达哥拉斯一直坚信自己的想法。</p><p>  但是，一旦毕达哥拉斯定理被他证明以后，麻烦就来了。</p><p>  我们上一讲讲过，数学的定理具有永真的特点，它一旦被证明，你就找不到反例。当人们在用毕达哥拉斯定理时，就发现了问题。假设某一个直角三角形的两条直角边长都是1，那么斜边该是多少呢？</p><p>  你可以根据毕达哥拉斯定理算一下，既然两条直角边都是1，它们各自的平方也是1，加起来是2，因此斜边的平方是2，这个斜边就是一个自己乘以自己等于2的数字，从大小来看，它应该在1和2之间。接下来请问，这个自己乘以自己等于2的数字是否是“完美”的有理数？</p><p>  根据毕达哥拉斯对所有的数字都是有理数的认识，它必须是啊！好，我们就假定存在一个数字是R，它能够写成R=A/B的形式，其中A、B都是互素的整数（互素指的是两个数写成分数的形式，不可再约分），那么现在假设这个数字R的平方恰好等于2。注意一下，这里面有三个条件，请一定牢记：</p><p>  A、B都是整数。</p><p>  A、B互素，也就是不能再约分了。</p><p>  A/B的平方等于2。</p><p>这三个条件能否同时满足呢？答案是不能。为了说明这一点，大家不妨跟着我做一个简单的逻辑训练。</p><p>  好，这次我们用的方法，在数学上被称为反证法，就是先假定你说的条件都满足，然后我来找出矛盾之处，这样就能推翻原来的假设。</p><p>  具体到上面这个问题，我们从上面第三个条件出发，就得知分子A的平方除以分母B的平方等于2：</p><p>    $ A^{2} / B^{2} = 2 $</p><p>  我们把B的平方移到等式的右边2那边，就是：</p><p>    $ A^{2} = 2 \times B^{2} $</p><p>  接下来我来问你，A是奇数还是偶数？你会说它当然是偶数，因为等式的右边是2乘以B的平方，都乘以2了，那A的平方结果肯定是偶数，奇数的平方不可能是偶数，所以A必须是偶数啊。既然A是偶数，我可以把A写成2乘以一个数，比如C，也就是A=2C这种形式，其中C是一个整数。</p><p>  那么A的平方等于什么呢，等于4倍的C的平方，我就用这个4倍的C的平方代替A的平方，放在原来等式的左边，右边还是2乘以B的平方：</p><p>    $ 4 \times C^{2} = 2 \times B^{2} $</p><p>  这个等式的两边都可以用2去同时除一下，于是就成了两倍的C的平方等于B的平方：</p><p>    $ 2 \times C^{2} = B^{2} $</p><p>  这时我问你，B是偶数还是奇数？你会说当然是偶数，因为两倍的C的平方是偶数啊。</p><p>  这下子问题来了，怎么A和B都是偶数呢，这不就和上面的第二个条件，也就是“A、B互素，不能再约分”矛盾了吗？</p><p>  那么到底哪里发生了错误呢？我们先要检查一下我们的推导过程，我们发现没有错误。因此，要么是数学错了，要么是认知错了。勾股定理的证明是通过严格的逻辑推导出来的，也不会有错，于是只能是我们的认知错了。</p><p>  也就是说，存在一种数字，我们过去没有认识到，它们无法写成有理数的形式，即A/B，它们是无限的不循环小数，在这样的数中有一个自己乘以自己时等于2。我们今天把这个数字称为√2。这一类的数字其实很多，它们被统称为无理数。</p><p>  据说毕达哥拉斯的学生希帕索斯最初发现了上述矛盾，于是就去和他的老师讲了。而毕达哥拉斯是个把数学看成宗教的人，出现无限的不循环小数在毕达哥拉斯看来是数学的漏洞，但他又无法把这件事解释圆满，这就是数学史上的第一次危机。</p><p>  毕达哥拉斯决定把这位学生扔到海里杀死，好把这件事隐瞒下来。</p><p>  当然，像√2这样的“无理数”存在的事实，却不可能一扔了之，无理数是客观存在的，毕达哥拉斯是隐瞒不住的，这件事成为了这位确立了数学在人类知识体系中地位的大学问家的一个污点。另一方面，无理数的危机也带来了数学思想一次大的飞跃，它告诉人们，人类在对数字的认识上还具有局限性，需要有新的思想和理论来解释，认识本身不能有禁区，那些事先为科学设定的条条框框，最终都不得不被抛弃掉。</p><p>  从这个例子中，我们能学到什么呢？</p><p>  首先，在遇到数学和现实的矛盾时，我们需要仔细检查推理的过程是否有疏漏，这种情况占大多数。</p><p>  在排除了推导的错误后，接下来，两种情况必居其一：</p><p>  要么，我们的眼睛和我们的认知欺骗了我们，就如同我们以为所有的数都是有理数，但其实不是。这是常有的事情。</p><p>  要么，最初的假设错了或者说不够好。这种事情在历史上偶尔发生过，但是很少，我们后面在介绍非欧几何时会仔细讲到这种情况。这种情况我们通常不需要考虑。</p><p>  既然在推导没有错误时，通常是我们的观察或者认知欺骗了我们，那么我们就应该把危机看成是转机。人类在科技历史上，很多重大的发明发现恰恰来自于上述的矛盾。在数学史上，除了无理数被发现之外，几个重大的事件，比如无穷小概念的提出，对无穷大的重新认识，以及公理化集合论的确立，都和那些矛盾有关。这些矛盾有时看似造成了数学危机，但是，人们化解了危机之后，就拓展了认知，建立起新的理论。它们或者让数学本身进步了，或者在科学上做出重大的预言。</p><p>  几年前约翰·霍普金斯大学的天体物理学家亚当·里斯（Adam Riess）教授给我讲的一堂课，我至今记忆犹深，他让我坚信了对数学本身的信心。里斯等人通过计算，发现宇宙的质量是负数，这怎么可能？难道是数学错了，还是我们对宇宙的理解完全错了？</p><p>  里斯在做了仔细的检查后首先排除了推理有误的可能性，然后他们不得不承认数学的结论是对的，出错的是我们眼睛（包括观测的仪器）。于是，他们认定宇宙中一定存在我们看不见，更不了解的东西，那些就是所谓的暗能量，亚当·里斯等人后来因此获得了诺贝尔奖。</p><p>  在自然科学上，很多重大的发现，最初都不是直接和间接观测到的，而是根据数学推导出来的，比如说黑洞、引力波便是如此。在历史上，血液循环论、现代原子论最初都是建立在数学推导上的假说，然后才逐渐被实验验证了。</p><p>  世界上有很多我们不能依靠直觉和生活经验理解的事物，但是我们可以从数学出发，经过一步步推导得到正确的结论，我们甚至不需要亲力亲为地做一遍就知道我们的结论一定是正确的。这就如同你不需要会踢足球，才能评论足球一样，你只需要把握住一些准则就可以了，而数学就是这样的准则。</p><p><strong>要点总结：</strong></p><p>  从数学的定理出发，可以推导出很多针对现实世界的推论，从而改变我们对现实世界的看法，这就是数学的预见性。比如，毕达哥拉斯定理的一个直接结果指出了无理数的存在，它把人类对于数字的认识范围从有理数扩展到了无理数。</p><p>  当然，可能有读者朋友会想，那些预见性可能和我们相去甚远，其实不然，后面我们会举一些和大家相关的例子，比如如何识破庞氏骗局，为什么不能做空股票，等等。</p><blockquote><p>康德讲：“世界上只有两样东西是值得我们深深景仰的，一个是我们头上的灿烂星空，另一个是我们内心的崇高道德法则。”他所说的星空，其实包括数学这样的知识体系。对于很多云山雾罩的事情，我们只需要在逻辑上推演一遍，就能把问题的真相搞清楚了。</p></blockquote><p><strong>思考题：</strong></p><p>  我们都知道，整体要大于部分，因此10厘米长的线段上的点应该比5厘米长的多，但是如果我能用严格的逻辑证明它们上面的点一样多，你相信么？</p><p>  欢迎给我留言，并把文章分享出去，让更多的人感受到数学之美。我们下一讲再见。</p><h3><span id="04-shu-xue-si-wei-shu-xue-jia-ru-he-cong-luo-ji-chu-fa-xiang-wen-ti">04 ｜ 数学思维：数学家如何从逻辑出发想问题</span><a href="#04-shu-xue-si-wei-shu-xue-jia-ru-he-cong-luo-ji-chu-fa-xiang-wen-ti" class="header-anchor">#</a></h3><p><img src="/images/23.jpg" alt=""></p><p>  这一讲就来举一个发生在我们身边的例子，说明如何利用数学原理思考问题，并且久而久之在遇事时本能地用一个数学的头脑辅助判断。</p><p>  当然，数学思维高深精妙，但是万法归一，最重要的那个原则就是，从逻辑出发想问题，这样就可以发现很多日常中被忽略的问题，从而找出真正答案。</p><p>  我们先从最近的一次金融危机讲起。在金融危机之后，英国女王问全世界的经济学家们，你们这么多人怎么没有一个预测到金融危机？这让学者们都很没面子。</p><p>  经济学家们当时确实是过于乐观了，所以很多暂时不会出问题的隐患被隐瞒了下来，因此大家会觉得没问题。不过当时有一些其实并不懂经济学的人，利用特殊的方法，嗅出了问题。</p><p>  比如巴菲特从直觉出发，觉得那些金融衍生品刻意包装，一定是为了掩盖很多真相，坚决不参与那场赌博。像这样的投资人并不少，其中最著名的是一个叫贝尔（Michael Burry）的医生，他数学很好，而且雇了一些数学家替他做事，靠坚守数学上的一些基本道理，成为那场豪赌中获利最丰厚的赢家。</p><p>  贝尔他们的逻辑其实很简单，就是我们常常说“复利”增长从数学上讲是无法长期为继的。比如说，财富每年增长7%，这个速度在很多人看来并不算快，但是如果两千多年前的陶朱公以及他的后人能维持这个财富增长速度，哪怕当年他只留下一个铜板，今天他的传人所拥有的铜钱的数量要超过宇宙中的原子的数量，这在现实中当然不可能。</p><p>  做投资的人都清楚，在一开始投资基数较小的时候，能够维持指数增长，一旦基数变大，就做不到了，还不切实际地想维持，就是拆东墙补西墙的庞氏骗局了。</p><p>  很多人觉得自己足够聪明不会上庞氏骗局的当。但是变相的庞氏骗局要识破就没那么容易了。2008年金融危机中的罪魁祸首CDS，就是奸商们包装的一个不容易看懂的庞氏骗局，接下来我们就来说说它。我们知道2008年金融危机的原因是美国房屋的次级贷款出了大问题，那它和CDS有什么关系呢？别着急，我们从次级贷款说起，然后你就明白什么是CDS了。</p><p>  让我们先回到克林顿当总统的时代。那时，克林顿政府为了让本来付不起首付的穷人也能买房子，允许银行提供购房首付的贷款。比如100万的房子，通常需要贷款80万，首付20万，但是假如有一个人叫林肯，他没钱支付首付，当时除了允许他把房子先抵押了，从A银行获得正常的80万贷款，还允许他以较高的利息从B银行获得首付20万的贷款。</p><p>  如果房价一直上涨，这没有问题，因为即使林肯付不起月供了，A银行也可以通过变卖房子收回自己的80万贷款，剩余的钱，还够B银行也能拿回自己的20万。B银行提供的就是次级贷款，由于它的风险显然比A银行大，因此利率也高，这样如果有个别几个人的贷款拿不回，它也能从其他购房者偿还的利息中填补漏洞。</p><p>  当然，B银行还有一个更稳妥的做法，就是从高利息（比如每年10%）中拿出一部分（比如1%），向C保险公司购买贷款者违约的保险。</p><p>  保险公司C根据历史数据发现房屋贷款收不回来的情况很少，只占房贷的2%左右，而它从B银行可以连续挣15年的钱（不考虑复利的因素），15年下来，担保10亿的房产就能收入1.5亿，成本只有2000万，这利润率高达650%的事情保险公司自然就答应了。</p><p>  接下来，投资银行D看到C公司做了这样一笔好买卖，非常眼红，就和C商量将这10亿美元的保险生意卖给自己，并愿意留给C公司20%的好处，即3000万美元。C公司想，1.5亿虽然多，但是要承担15年的保险义务，不如一次性得到3000万实在，就答应了。</p><p>  D公司是投资银行，更精明，将C公司为B银行作担保的业务，包装成证券，叫做CDS（信用违约交换），加价3000万美元卖给了另一家投资银行E。E公司可能将各种类似的CDS又打了一个包，以新的证券形式在市场上市了。</p><p>  就这样，在经过无数次包装后，CDS的内部结构大部分人已经看不懂了，但是人们总觉得自己可以从下家身上赚到钱。于是一同把CDS炒到了50万亿美元这么大的规模，这甚至超过当时美国房市本身的总值。</p><p>  这个骗局的本质是什么呢？就是大家炒来炒去，都是在赌一件事，就是今后15~30年，房价会一直快速上涨。</p><p>  然而，房价不可能永远快速上涨，特别是在经济本身没有上涨的前提下。一旦有大量房主还不上钱，或者不愿意还钱，这些CDS就变得一钱不值。更糟糕的是，给购房者提供次级贷款的银行，后面的保险公司以及很多购买了CDS的投资银行也都完蛋了，整个金融体制就垮了。</p><p>  这件事可以通过数学算出来，其实不只是刚才提到的贝尔，当时有不少人在CDS的骗局破灭之前，发现了问题，后来挣到了大笔的钱。只不过贝尔挣钱的比例太高，他的故事后来被拍成了电影《大空头》，他从此成为了名人。</p><p>  接下来我们就说说什么叫做具有数学的思维。它不是指算小账算得清楚，而是说善于基于数学知识，使用逻辑发现问题，或者预见到不得不做的事情。我们在生活中，有时不得不面对非常复杂的问题，里面有很多噪音难以一一滤出，这时就需要掌握一种工具让我们能够不受噪音影响作出正确的判断。而数学常常是我们可以信赖的工具。</p><p>  下面我和你分享一个我的经历。有一次在一个由政府组织的关于“一带一路”的座谈会上，几位领导问我，“吴教授，咱们关起门来讲，中国输出了那么多资本，最后钱能回来么？”</p><p>  我说，挣得回来，挣不回来，我不知道，因为这里面牵扯太多的因素。但是资本输出和帮助其它国家富裕这两件事都必须做，我可以从数学证明这两件事的必要性。他们很好奇这件事和数学有什么关系，于是我继续讲：</p><p>  中国在过去的四十年里，实现了每年8%的指数增长，除了中国人勤劳勇敢。另外有两个数学上的原因，一是因为最初的基数小，能够持续高速增长。二是过去国内市场空白一片，供不应求，国际上其它国家人均财富，比中国高很多，相比中国过去的生产能力，购买力近乎无限。</p><p>  但是40年后的今天，中国人均GDP已经达到了世界的平均水平，总的经济体量已经世界第二，占全世界的18%。那么中国还能不能维持过去的增长速度呢？从数学上讲，根本做不到。</p><p>  我们就假定中国经济能够按照每年6%的速度增长，这个速度虽然比过去慢了一点，但是比全世界3%的平均水平快很多。再过40年，中国GDP大约能增长10倍。而全世界经济增长的速度只有3%左右，再扣除中国的贡献，中国以外的国家和地区的增速只有2.34%左右，这样增长40年，只能增长1.5倍左右，那时中国GDP大约占到全世界50%。</p><p>  这时候矛盾就出现了，中国以外有全世界4/5以上的人口，总的财富仅仅和中国一样多。那时，全世界都没有足够的财富买得起中国不断制造的产品和不断提供的服务。这时只有两个办法，一个是提高世界其它地区的购买力和经济增长，另一个是让中国经济增长降到世界的平均水平。</p><p>  后者显然不是我们想要的，于是借钱给其它国家购买中国的产品和服务，当然中国可以换得一些战略资源，同时让世界其它国家也维持足够高的经济增长，以便它们能维持购买力，并且还得起钱，就是中国不得不做的事情了。而这就是“一带一路”要实现的目标。至于投资和贷款能否拿得回来，那要看操作的水平了。</p><p>  在历史上，19世纪的英国，二战后的美国，以及80年代的日本，都是资本输出国，因为你不输出资本，大家就买不起你的东西，而你也就无法维持体面的经济增长。中国10年前不提“一带一路”的事情，一是因为还没有必要性，二是因为自己的钱不多；近几年才提出，是因为今天中国正好从处在人均GDP低于世界平均水平到变成高于平均水平的转折点上。因此在商业和资本两个层面全球化就变得迫在眉睫了。</p><p>  我们在生活中，常常说“算笔账”这三个字。其背后其实就是说基于一些事实，用数学这个工具来考量，发现问题。为什么数学思维可以很容易地发现问题呢？因为我们常常用到在数学证明中的工具：矛盾律。就是说一个事物不能既有A属性，又没有A属性。比如我们上一讲在证明√2是无理数时说到，如果它是有理数P/Q，那么P和Q这两个整数，既不能同时是素数，又必须同时是偶数，这就违背了矛盾律。同样，中国既不可能拥有全世界所有的财富，还让世界其它地区买得起中国的商品，这也违背了矛盾律。</p><p><strong>要点总结：</strong></p><p>  通过数学的思维方式，发现生活中的问题，看清我们必须采取的行动，这就是学习数学的意义所在。这既可以被看成是认知的升级，也可以被认为是掌握了数学原理之后的灵活应用。当然，数学有很多它做不到的事情，下一讲我们进一步讲讲数学思维的边界。</p><h3><span id="05-shu-xue-bian-jie-cong-bi-da-ge-la-si-ding-li-dao-fei-ma-da-ding-li">05 ｜ 数学边界：从毕达哥拉斯定理到费马大定理</span><a href="#05-shu-xue-bian-jie-cong-bi-da-ge-la-si-ding-li-dao-fei-ma-da-ding-li" class="header-anchor">#</a></h3><p><img src="/images/24.jpg" alt=""></p><p>  我们前面讲了数学的预见性，以及数学思维的用处，但是这讲我想和你谈谈数学的局限性，大家可能会有一个疑问，就是这种局限性是来自于我们自己的数学知识不够，还是来源于数学本身的局限性呢？</p><p>  应该讲这两方面的原因都有，第一部分因素在大家听完这门课后会补上很多，不用担心；第二部分则是我们这一讲要讲的内容。我们有必要了解数学本身的局限性，才能更好地使用它的原理和思维方式。今天我们还是从毕达哥拉斯定理的推广说起。</p><p>  在几何上有很多整数组满足毕达哥拉斯定理，它们就是勾股数，比如（3，4，5），（5，12，13）等。从代数上解释勾股数，就是方程 $ a<sup>{2}+b</sup>{2}=c^{2} $ 的整数解。</p><p>  当然，人类总是很好奇，人们就在想，如果上面方程中的平方变成立方，甚至任意N次方，它还有整数解吗？比如，是否有三个整数a，b，c，使得，$ a<sup>{3}+b</sup>{3}=c^3 $ ？</p><p>  这个问题困扰了人类几千年。后来有一个叫费马的数学爱好者就提出一个假说，说除了平方的情况，其他更高次方的方程都找不到整数解，它被称为费马大定理（或者费马最后定理）。</p><p>  虽然它被称为定理，但数学家们只是把它看成是猜想，或者假说，因为没有证明。我们前面讲到，猜想，哪怕用很多数据验证过了，只要没有证明，就无法成为数学大厦中的一块砖，就无法在它的基础上搭建新的东西。</p><p>  因此，在费马之后的几百年里，很多数学家都试图证明它，但是都不得要领。费马自己说他已经证明了这个定理，只是那张纸不够大写不下，但后人认为是费马搞错了。</p><p>  于是费马大定理就成了一道跨越了三个多世纪的超级难题。直到1994年，才由著名的英国旅美数学家怀尔斯证明出来，而这个过程也是一波三折。</p><p>  1986年，怀尔斯在做了十多年的准备后，觉得证明费马大定理的时间成熟了，终于决定将全部精力投入到该定理的证明上了。为了确保别人不受他的启发率先证明了这个著名的定理，他决定在证明出这个定理以前不发表任何关键性的论文。</p><p>  但是，如果一个人苦思冥想，推导的逻辑错了自己也看不出来，为了避免这种情况的发生，怀尔斯利用在普林斯顿大学教课的机会，不断地将自己部分的想法作为课程的内容讲出来，让博士生们来挑错。</p><p>  1993年6月底，怀尔斯觉得自己准备好了，便回到他的故乡英国剑桥，在剑桥大学著名的牛顿研究所举行三场报告会。为了产生爆炸性的新闻效果，怀尔斯甚至没有预告报告会的真实目的。因此，前两场报告其实人不多，但是这两场报告之后，大家都明白接下来他要证明费马大定理了。</p><p>  于是在举行最后一场报告时，牛顿研究所里挤满了人，据估计可能只有1/4的人能听懂讲座，其余的人来这里是为了见证一个历史性的时刻。</p><p>  很多听众带来了照相机，而研究所所长也事先准备好了一瓶香槟酒。当怀尔斯写完费马大定理的证明时，很平静地说道：“我想我就在这里结束”，会场上爆发出一阵持久的鼓掌声。这场报告会被誉为了20世纪该研究所最重要的报告会。</p><p>  不过故事到此并没有结束，数学家们在检查怀尔斯长达170页证明的逻辑之后，发现了一个小漏洞。怀尔斯开始认为这个小漏洞很快能补上，但是后来才发现这个小漏洞会颠覆整个证明的过程。</p><p>  怀尔斯又独立地工作了半年，但毫无进展，在他准备放弃之前，向普林斯顿大学的另一个数学家讲述了自己的困境。对方告诉他，他需要一位信得过的，可以讨论问题的助手帮忙。</p><p>  经过一段时间的考虑和物色，怀尔斯请了剑桥大学年轻的数学家泰勒来一同工作，最后在泰勒的帮助下怀尔斯补上了那个小漏洞。由于有了上一次带有乌龙性质的经历，怀尔斯这次有点怀疑自己是在做梦。于是他到外面转了20分钟，发现自己没有在做梦，这才喜出望外。</p><p>  由于怀尔斯在证明这个定理时已经超过了40岁，无法获得菲尔兹奖，因此国际数学大会破例给他颁发了一个特别贡献奖，这也是迄今为止唯一一个特别贡献奖。关于费马大定理证明过程的更多细节，大家可以听罗辑思维的第85期节目。</p><p>  那么证明这个古老的数学难题有什么意义呢？<strong>这个定理证明过程本身导致了很多数学研究成果的出现，特别是对于椭圆方程的研究。今天区块链技术用到的椭圆加密方法，就是以它为基础的。</strong></p><p>  在怀尔斯之前，有一批数学家，特别是日本的谷山丰，对这一系列理论做出了重大的贡献，怀尔斯的成功是在他们的工作基础之上的。今天的比特币可以讲完全是谷山丰理论的一次有意义的应用。而在怀尔斯之后，泰勒等人还在不断发展这方面的理论。</p><p>  对于三个世纪数学家们证明费马大定理的过程，我和大家分享我的三点体会：</p><ul><li><p>今天的数学（指纯粹数学，不是应用数学）真的很难，想在这方面取得突破性贡献不容易，怀尔斯从10岁开始就立志解决这个问题，他努力了30年。他最后的证明长达200页。但是，有了理论，使用它做有意义的事情，还是容易得多。比特币就是一个很好的例子。</p></li><li><p>数学是世界上最严密的知识体系，任何的推导不能有丝毫的纰漏。怀尔斯差点因为一个小的疏忽毁掉了整个工作，希望通过这一点，大家对数学的严密性有所体会。</p></li><li><p>数学走到今天这一步，是在一个个定理的基础上一点点搭建起来的，而今天的成就，又为明天的发展奠定了基础，这样数学就获得了可叠加的进步。</p></li></ul><p>  毕达哥拉斯定理是，a的平方+b的平方=c的平方的情形。费马大定理是，a的N次方+b的N次方=c的N次方的情形。因此，前者是起点，后者是一个普遍情况的延伸。接下来，如果我们沿着毕达哥拉斯定理和费马大定理继续往前拓展，会是什么情况呢？</p><p>  比如任意一个多项式方程 $ 2x^{2} + 3 y^{3} = z^{4} $ ，或者 $ x^{2} + 3 y^{3} - w^{5} = z^{4} $ ，请问它们有没有整数解？这个问题就是著名的希尔伯特第十问题（简称第十问题）。</p><p>  对于任意一个多项式方程，我们能否在有限步内，判定它是否有解？</p><p>  对于一些特例，我们知道有整数解，比如 $ x^{2} + y^{2} = z^{2} $ 就有；对于另一些特例，我们知道没有整数解，比如费马大定理所描述的情况。</p><p>  但是，对于更多的，一般性的不确定方程，我们不仅不知道怎么解，甚至无法判断一个方程有没有整数解。因此，1900年在巴黎举行的国际数学大会上，希尔伯特在提出23个著名的数学问题时，把它列为了第十个。</p><p>  第十问题其实隐含了一个更为深刻的认识论问题，就是对于大部分数学问题，我们能否找到答案？到目前为止，我们所能解决的数学问题其实只是所有数学问题中很小的一部分。</p><p>  当然，很多人会说尚未找到答案不等于没有答案。第十问题实际上在直接挑战数学的边界，也就是说，通过数学的方法，我们可能根本无法判断一些问题的答案存在与否。如果连答案是否存在都不知道，就更不用说通过数学的方法解决它们了。</p><p>  这样就为数学划定了一个明确的边界。从1900年之后，特别是在二战之后，欧美不少数学家致力于解决这个问题，因为这也涉及到计算机所能处理问题的边界。</p><p>  第十问题的解决颇具戏剧性。在上个世纪60年代，被认为最可能解决这个难题的是美国著名的女数学家朱莉娅·罗宾逊，她从博士一毕业就致力于研究这个问题，也取得了很多突破性的进展。</p><p>  虽然罗宾逊因为这方面的贡献成为了美国科学院第一位女院士，美国数学学会第一位女会长，她离解决这个问题最终还是差几步。1970年，俄罗斯天才的数学家尤里·马季亚谢维奇在大学毕业后一年就解决了这个问题，证明了这类问题是无解的，从此在世界上一举成名。</p><p>  纯数学这个学科除了需要一些运气之外，比拼的是人的智力，智力到哪个程度，成就就到哪个水平，这倒不是宿命论，而是说明人要根据自己的特长选择做事。</p><p>  第十问题的解决其实扑灭了人类的一丝希望，但是也让人类老老实实地在边界内做事情。人类过去常常希望找到一个工程问题的解析解，即答案是以一个公式的形式存在，这样套入任何数字，就得到了具体的答案。</p><p>  但是，很多问题最后证明找不到严格推导出来的解析解，当然这也不妨碍大家在工程上可以使用近似的数值解，解决实际问题。认清这一点，做事的方法也就改变了。</p><p>  搞流体力学和控制理论的人都知道，那里面有很多复杂的非线性方程要解决。在上个世纪，美苏两国走了两条不同的道路。前苏联因为数学水平较高，而计算机技术很落后，因此他们习惯于下硬功夫做很难的数学题，找到非线性问题的解析解。</p><p>  而在美国方面，数学水平高的人没有前苏联多，但是计算机技术先进，因此他们习惯于把很麻烦的非线性问题变成很多计算量大，但是却很简单的线性问题（或者其它数值计算问题），找到工程上能接受的近似解。</p><p>  那么谁取得的效果好呢？从结果来看，美国似乎更好些。关于什么是线性方程，我们后面会讲到，这里大家记住线性方程简单，非线性方程非常复杂即可。</p><p><strong>要点总结：</strong></p><p>  我们介绍了费马大定理的来龙去脉，它往前和毕达哥拉斯定理的关系，往后和希尔伯特第十问题的关系。我也和大家分享了我对这个定理被证明过程的体会。</p><p>  <strong>我们通过希尔伯特第十问题介绍了数学的边界，这是一个硬的边界，大家不要试图逾越。但是数学的边界有些时候不是我们解决问题的边界，因为世界上除了数学的方法，还有其他方法。</strong></p><p>  到目前为止，我们以毕达哥拉斯定理的产生和发展为线索，介绍了数学猜想到数学公理的推导过程，接下来的两讲，我们还是以毕达哥拉斯这个人为线索，谈谈数学的应用，以及在其它知识体系中的位置。我们下一讲再见。</p><h3><span id="06-huang-jin-fen-ge-bi-da-ge-la-si-ru-he-lian-jie-shu-xue-he-mei-xue">06 ｜ 黄金分割：毕达哥拉斯如何连接数学和美学</span><a href="#06-huang-jin-fen-ge-bi-da-ge-la-si-ru-he-lian-jie-shu-xue-he-mei-xue" class="header-anchor">#</a></h3><p><img src="/images/25.jpg" alt=""></p><p>  今天大家对毕达哥拉斯的了解，除了勾股定理，还有就是黄金分割。而他用数学指导艺术和音乐，也确立了数学在其它知识体系和人类文明成就中的中心地位。这一讲，我们就从黄金分割出发，进一步理解数学的用途。这个用途不仅仅是在思维方面，也能实实在在指导我们的工作。</p><p>  我们先来看一张照片，感受一下黄金分割。</p><p><img src="/images/27.jpg" alt=""></p><p>  这是雅典卫城的帕特农神庙，它无论是在艺术史上，还是建筑史上地位都很高，如果你度量一下它正面的宽与高，正好符合我们所说的黄金分割。</p><p>  黄金分割大家并不陌生，你可能还会说出它的比例大约是1:0.618，也就是1.618。其实不仅帕特农神庙本身和里面很多雕塑的关键比例符合黄金分割，著名的雕塑《断臂的维纳斯》，它的身高和腿长的比例，腿和上身的比例也都符合黄金分割。符合这个黄金比例的雕塑或建筑就看上去很顺眼，很美观。</p><p>  那么黄金分割是如何确定的呢，这个比例为什么看起来顺眼呢？<strong>简单地讲，它的美感来自几何图形的相似性。</strong></p><p>  比如我画了一个符合黄金分割的长方形，它的长度是X，宽度是Y。如果我们用剪刀从中剪掉一个边长为Y的正方形（也就是图中灰色的部分），剩下来的长方形，长宽之比依然会符合黄金分割。</p><p><img src="/images/28.jpg" alt=""></p><p>  当然，我们还可以继续剪掉一个正方形（图中绿色的部分），剩下的长方形（图中透明的部分）的长宽依然会符合黄金分割的比例。也就是说，如果我们这样不断地切下去，剩余部分都是成同一比例的。</p><p>  黄金分割的这个比例很容易算出来。根据黄金分割上述的相似性质，我们可以很容易算出来X/Y的比例是1.618左右，更精确地讲，是√5加上1之后的和除以2，这是一个无理数，通常用希腊字母Ф来表示。</p><p>  黄金分割为什么漂亮？除了在几何上层层相似，这个相似性之外，它也反映了自然界的物理学特征。如果我们把刚才图中的长方形不断做切割，然后将每个被切掉的正方形的边用圆弧替代，就得到了这样一个螺旋线。由于这个螺旋线每转动同样的角度，得到的圆弧是等比例的，因此它也被称为等角螺线。如果你对比这个螺旋线和下面的蜗牛壳，是否觉得很相似？</p><p><img src="/images/29.jpg" alt=""><img src="/images/30.jpg" alt=""></p><p>  不仅蜗牛壳如此，龙卷风的性质乃至像银河系这样星系的形状都是如此。需要指出的是，这不是巧合，而是因为任何东西如果从中心出发，同比例放大，必然得到这样的形状。</p><p><img src="/images/31.jpg" alt=""><img src="/images/32.jpg" alt=""></p><p>  或许正是因为黄金分割反映了宇宙自身的一个常数，我们对它才特别有亲切感，所以哪个建筑或者画作如果有意无意满足了这个条件，它就显得特别美。除了帕特农神庙，埃菲尔铁塔等建筑的主要尺寸的比例，也正好符合黄金分割，甚至符合等角螺旋线。</p><p><img src="/images/33.jpg" alt=""></p><p>  类似的，《蒙娜丽莎》的主要结构部分也可以对应一条等角螺旋线。需要说明的是，无论是帕特农神庙的设计者，还是达·芬奇或者埃菲尔，他们都知道黄金分割，并且刻意使用了这个比例。</p><p><img src="/images/34.jpg" alt=""></p><p>  最先提出黄金分割的人是谁呢？古埃及人似乎早在4500年前就知道了这个比例的存在，因为大金字塔从任何一个面看上去，其正切面的斜边长和金字塔高度之比正好是黄金分割的比例。</p><p>  当然，没有证据表明他们算出了精确的比例公式，因为他们不知道有无理数存在。</p><p>  今天一般认为，算出黄金分割公式的还是毕达哥拉斯。虽然相传毕达哥拉斯是在一次听到一个铁匠打铁和谐而动听的声音后，研究出了黄金分割，但是我觉得这种说法缺乏依据。</p><p>  大家更认可的说法是，毕达哥拉斯学派的人在做正五边形和五角星的图形时，发现了黄金分割的比例。在正五角星中，每一个等腰三角形的斜边和底边的比例都是黄金分割1.618。</p><p><img src="/images/35.jpg" alt=""></p><p>  我们刚才说毕达哥拉斯还可能是从铁匠的打铁声中获得了黄金分割的启发，但是无从考证，不过毕达哥拉斯学派利用数学指导音乐是真实的事情。毕达哥拉斯认为，要产生让人愉快的音乐，就不能随机在连续的音调中选择音阶，而需要根据数学上的比例设计：</p><p>  首先，人们发现两根琴弦，如果它们的长度比是2:1，它们所奏出来的音节就相差一个8度，如果我们用简谱来记录，也就是1-2-3-4-5-6-7-i，高音1的音高是中音1的两倍。在这一个8度中最高音和最低音的频率之比也就是为2:1。</p><p>  接下来，将这8度又一分为二，按照4:3和3:2的比例，分出一个4度音和一个5度音，它们分别对应1-2-3-4和4-5-6-7-i。注意，由于4/3 x 3/2 = 2:1，因此一个4度音和一个5度音会还原成一个8度音。</p><p>  最后，每个4度音分成两个整声调，即分出2和3，5度音分为三个整声调，即分出5，6，7。这样就是按照比例设计的了。</p><p>  如果不按照比例分配音节是什么结果呢？我们听到的声音就如同噪音，而不是有规律的乐音。今天对耳蜗的解刨学研究发现，耳蜗的形状其实也是螺旋线的，和黄金分割的螺旋线非常吻合。这可能是按照黄金分割设定音律后，声音悦耳的原因。</p><p>  毕达哥拉斯和他的学派对音乐和美学的影响一直影响到柏拉图和亚里士多德，以及后来诸多文艺复兴的学者。</p><p>  数学不仅和音乐密切相关，也对建筑和绘画艺术产生了重大的影响。我们看从文艺复兴时期开始，到19世纪浪漫主义时期的西方油画，都会惊叹于它们的逼真。这个逼真的效果从哪里来？它源于艺术家们使用单点透视的方法，成功地将三维形象绘制到一个二维平面上。当然，这个绘画技术不是一天发明的。</p><p>  其实，早在古希腊时期，人们就发现了远处景物显得小，近处的显得大这样的特点，并且将这种特点反映到绘画中了，他们把这种方法叫做短缩法。但是，古希腊人并不知道物体在离开我们远去时，该遵循什么数学法则进行缩小。</p><p>  到了文艺复兴时期，佛罗伦萨的画家乌切洛沉溺于使用几何学技术将绘画变得逼真，在他为美第奇家族绘制的《圣罗马诺之战》中，我们可以看到明显采用透视法炫技的痕迹。</p><p>  大家可以仔细看看地上倒下的战士和旁边的长矛，都指向远方的消失点。他用透视法为绘画构建了立体的舞台。不过，如果你仔细看，会觉得这幅画中有不少别扭的地方，因为这幅画好像不止一个透视的方向。</p><p><img src="/images/36.jpg" alt=""></p><p>  那么是谁真正解决了透视法中的数学问题，并且将这种技巧给予了广大艺术家的呢？他是文艺复兴时期大名鼎鼎的建筑师和工程师布鲁内莱斯基，今天佛罗伦萨的圣母百花大教堂就是他的杰作。关于这座在建筑史上划时代建筑的建造过程，我们在《科技史纲60讲》中已经介绍了，这里就不再赘述了。</p><p>  布鲁内莱斯基所发明的单点透视法，完全符合我们视觉应有的几何学原理，具体讲就是相似三角形的原理，因此按照这样的方法画出来的画就非常逼真。下面我们就从视觉中的几何学原理出发，简单介绍一下单点透视法。</p><p>  假定我们前方100米和500米处各有一棵大树，它们都是50米高。我们知道近处的树在我们的眼睛里显得高，远处的显得小。那么看起来，它们的比例到底该是几比几呢？简单地讲，就是应该和距离成反比，即100米处50米高的树，放到500米处，应该显得只有10米高。如果放到无穷远处，则应该是0米高，也就是地平线上的一个点。对于其他的距离，我们看到的高度也是同样和距离成反比。这样，如果我们把各个距离之处50米高的大树连城一条线，就是我们得到的透视的视觉效果了。</p><p>  下图是我在电视剧《权力的游戏》的外景地（北爱尔兰）拍的照片。从照片可以看出，所有相同大小的景物，按照远近的比例缩小，在远处汇聚到一点。</p><p><img src="/images/37.jpg" alt=""></p><p>  理解了我们视觉的数学原理，就可以利用它创造出不同的艺术效果。比如在现实世界里，我们看到的是单点透视，因为人的眼睛不可能同时往两边看，但是我们可以在艺术创作中采用两点和多点透视。</p><p>  下图是两点透视的效果图，景物消失在一左一右两点上。我们通常目光只能集中在一个方向，看不了这么广的视角，但是你如果用鱼眼镜头拍照，就能拍出这样的效果。</p><p><img src="/images/38.jpg" alt=""></p><p>  我们在今后的课程中，还会讲到，艺术需要数学，也需要光学。印象派绘画的一大特点，就是很好地利用了当时人类在物理上对于色彩和亮度认识的进步。</p><p><strong>要点总结：</strong></p><p>  最后总结一下今天的内容，其实我们是在回答数学的用途。</p><p>  数学和艺术，以及其他的知识体系有着千丝万缕的联系，我们以黄金分割和透视法为例子介绍了这种关系。了解一些基本的数学知识和方法对我们做其他事情有很多好处。当然，有些人会讲，我们学不会那些数学上的道理啊，没关系，有些方法你只要记住就好。</p><p>  我们下一讲就从黄金分割出发，介绍优选法，大家只要掌握它的一些基本原则，就能直接使用了。</p><h3><span id="07-shu-xue-ying-yong-hua-luo-geng-hua-fan-wei-jian-de-shen-lai-zhi-bi">07 ｜ 数学应用：华罗庚化繁为简的神来之笔</span><a href="#07-shu-xue-ying-yong-hua-luo-geng-hua-fan-wei-jian-de-shen-lai-zhi-bi" class="header-anchor">#</a></h3><h3><span id="08-shu-lie-he-ji-shu-yi-dang-xia-hen-chong-yao-dan-qu-shi-geng-chong-yao">08 ｜ 数列和级数（一）：当下很重要，但趋势更重要</span><a href="#08-shu-lie-he-ji-shu-yi-dang-xia-hen-chong-yao-dan-qu-shi-geng-chong-yao" class="header-anchor">#</a></h3><h3><span id="09-shu-lie-he-ji-shu-er-chuan-xiao-pian-ju-de-shu-xue-yuan-li">09 ｜ 数列和级数（二）：传销骗局的数学原理</span><a href="#09-shu-lie-he-ji-shu-er-chuan-xiao-pian-ju-de-shu-xue-yuan-li" class="header-anchor">#</a></h3><h3><span id="10-shu-lie-he-ji-shu-san-cang-zai-li-xi-he-yue-gong-li-de-mi-mi">10 ｜ 数列和级数（三）：藏在利息和月供里的秘密</span><a href="#10-shu-lie-he-ji-shu-san-cang-zai-li-xi-he-yue-gong-li-de-mi-mi" class="header-anchor">#</a></h3><h2><span id="mo-kuai-er-shu-xue-de-gai-nian">模块二 ｜ 数学的概念</span><a href="#mo-kuai-er-shu-xue-de-gai-nian" class="header-anchor">#</a></h2><h3><span id="11-ji-tu-tong-long-fang-cheng-zhe-ge-shu-xue-gong-ju-wei-shi-me-hen-qiang-da">11 ｜ 鸡兔同笼：方程这个数学工具为什么很强大</span><a href="#11-ji-tu-tong-long-fang-cheng-zhe-ge-shu-xue-gong-ju-wei-shi-me-hen-qiang-da" class="header-anchor">#</a></h3><h3><span id="12-san-ci-fang-cheng-shu-xue-shi-shang-de-fa-ming-quan-zhi-zheng">12 ｜ 三次方程：数学史上的发明权之争</span><a href="#12-san-ci-fang-cheng-shu-xue-shi-shang-de-fa-ming-quan-zhi-zheng" class="header-anchor">#</a></h3><h3><span id="13-xu-shu-xu-gou-zhe-ge-gong-ju-you-shi-me-yong">13 ｜ 虚数：虚构这个工具有什么用</span><a href="#13-xu-shu-xu-gou-zhe-ge-gong-ju-you-shi-me-yong" class="header-anchor">#</a></h3><h3><span id="14-wu-qiong-wo-men-wei-shi-me-nan-yi-li-jie-wu-xian-de-shi-jie">14 ｜ 无穷：我们为什么难以理解无限的世界？</span><a href="#14-wu-qiong-wo-men-wei-shi-me-nan-yi-li-jie-wu-xian-de-shi-jie" class="header-anchor">#</a></h3><h3><span id="15-wu-qiong-xiao-yi-ru-he-shuo-fu-gang-jing-zhi-nuo">15 ｜ 无穷小（一）：如何说服杠精“芝诺”？</span><a href="#15-wu-qiong-xiao-yi-ru-he-shuo-fu-gang-jing-zhi-nuo" class="header-anchor">#</a></h3><h3><span id="16-wu-qiong-xiao-er-niu-dun-he-bei-ke-lai-zai-zheng-shi-me">16 ｜ 无穷小（二）：牛顿和贝克莱在争什么？</span><a href="#16-wu-qiong-xiao-er-niu-dun-he-bei-ke-lai-zai-zheng-shi-me" class="header-anchor">#</a></h3><h3><span id="17-wu-qiong-xiao-san-yong-dong-tai-he-ji-xian-de-yan-guang-kan-shi-jie">17 ｜ 无穷小（三）：用动态和极限的眼光看世界</span><a href="#17-wu-qiong-xiao-san-yong-dong-tai-he-ji-xian-de-yan-guang-kan-shi-jie" class="header-anchor">#</a></h3><h2><span id="mo-kuai-wu-wei-ji-fen">模块五 ｜ 微积分</span><a href="#mo-kuai-wu-wei-ji-fen" class="header-anchor">#</a></h2><h3><span id="30-wei-ji-fen-shang-ru-he-cong-hong-guan-bian-hua-liao-jie-wei-guan-qu-shi">30 ｜ 微积分（上）：如何从宏观变化了解微观趋势</span><a href="#30-wei-ji-fen-shang-ru-he-cong-hong-guan-bian-hua-liao-jie-wei-guan-qu-shi" class="header-anchor">#</a></h3><p><img src="/images/39.jpg" alt=""></p><p>  我们在前面讲到，线性代数和微积分是高等数学中最重要的两门课，前者有很强的实用价值，后者能提高思维水平，虽然大家平时在工作中未必有机会直接使用它。就拿我来说，工作后用线性代数的机会可能是微积分的100倍。</p><p>  但是，学没学过微积分，思维方式会不同，眼中的世界也会有差别。因此，作为数学通识课，我们还是有必要解释微积分的思想，但是我们也就是停留在它的思想方法上，而非细节上。</p><p>  微积分有两位主要的发明人，牛顿和莱布尼茨。牛顿发明微积分的一个重要原因是，他需要一个数学工具解决力学问题，比如如何计算速度。可能有人会说，这还不容易，在小学我们就教了，就是距离除以时间。</p><p>  没有错，我们从小学到中学都是这么教的，但这只是一段时间𝛥t的平均速度。如果我要问你，在某一时刻的瞬间速度是多少？你就不知道了，或者只能拿平均速度来近似瞬间速度。或者说，拿宏观的规律近似微观的。</p><p>  但是在很多场合，我们要了解的是瞬间速度，而不是平均速度。比如一个警察抓超速，依据的就是驾驶者的瞬间速度，而不是他一路开过来的平均速度。对于瞬间速度，牛顿之前的科学家并没有太多的了解，当然也不会计算了。</p><p>  <strong>那么牛顿是怎么解决这个问题的呢？他采用了无限逼近的方法。具体的想法是这样的：</strong></p><p>  首先我们回到速度的定义，就是一段时间里的位移量𝛥S除以相应的时间𝛥t，我们可以写成速度v=𝛥S/𝛥t。我把这种关系用一个示意图表示出来：</p><p><img src="/images/41.jpg" alt=""></p><p>  在左边的图中，横轴是时间轴，纵轴是位移，那条曲线是位移随着时间变化的函数S(t)。我在图中标记了从t0开始的一段时间𝛥t，以及相应的位移量𝛥S，它们构成一个直角三角形的两条直角边。位移量除以时间，就是斜边的斜率。</p><p>  当时间间隔𝛥t逐渐变小时，这个比值会变化，会越来越反映出在t0点附近的速度。我们在前面介绍了极限的概念，当𝛥t趋近于0时，那条反映速度的斜线，就是曲线在t0点的切线，牛顿就把那个切线的斜率，定义为在t0点的瞬间速度。我们不妨这么写，v(t0)=𝛥S/𝛥t，当𝛥t→0（趋近于0）时。</p><p>  通过上述方式，牛顿就从平均速度出发，定义了瞬间速度，也就是说，某个时刻的瞬间速度，是这个时刻附近一个无穷小的时间内的平均速度。</p><p>  如果我们用曲线来考察这种瞬间变化，那么瞬间速度就是距离函数曲线在某个点切线的斜率。由于在每一个时间点，切线的斜率是变化的，因此如果把各个点的切线斜率画出来，它也是一条函数曲线。</p><p>  牛顿把这个由每个点切线斜率构成的函数，称为原来函数的流数，我们今天称之为导数。通常我们用y=f(x)表示原函数，用y=f’(x)表示它的导数。在上面的例子中，位移的变化函数S(t)是原函数，速度变化的函数v(t)则是原函数的导数，我们可以写成v(t)=S’(t)。</p><p><img src="/images/40.jpg" alt=""></p><p>  正如同速度反映的是距离的变化速率，一个函数的导数所反映的也是原函数变化的速率，比如在上面的图中，我们可以看出原函数增长越来越慢，因此它的导数，也就是增速，是逐渐下降的。</p><p>  现在我们回顾一下函数这个概念，它反映的是一个变量随着另一个变量的变化，而导数这个概念，则反映函数变化的快慢。比如抛物线函数y=x^2，它在x=1这个点，导数是2，也就是说x增加一小份（无穷小），y要增加两小份。</p><p>  相比之下，直线y=x在同一个点的增速就要慢一点，它的导数是1，也就是说x增加一小份，y也增加一小份，因此我们说抛物线在x=1这个点的变化比直线更快。·</p><p>  对于同一根曲线，我们前后也能对比，比如抛物线在x=2这个点的导数是4，因此我们说，它在x=2时，比x=1时，变化更快。</p><p>  我们过去也会说，某个函数变化快，某个函数变化慢，但是这些都是宏观的描述，没有量化度量。导数解决了这个问题。我们还说，某个函数，越变越快，这也只是宏观的、定性的分析。</p><p>  有了导数的概念之后，我们就可以准确地度量任意一个函数在某一个点的变化。因此导数的本质是对变化快慢的准确量化度量。</p><p>  <strong>导数是微积分中最重要的概念之一，从导数出发我们稍微往前走一小步，就进入到微积分的微分了。</strong></p><p>  什么是微分呢？它其实就是在前面有关速度的例子中，𝛥t趋近于零时，𝛥S的值。对此一般性的函数，我们用dx表示自变量趋于零的情况，用dy表示函数的微分。</p><p>  如果我们对比一下导数的定义f’(x) = 𝛥y/𝛥x，其中𝛥x趋近于零，以及微分的定义dy =f’(x)dx，就可以看出它们讲的其实是一回事，因为𝛥x和𝛥y趋近于零之后，就是dx和dy。有时人们直接将导数写成f’(x) =dy/dx。</p><p>  如果我们孤立地看微分dy，它是个无穷小，搞出这样一个新概念有什么必要呢？我们用一个具体的例子，也就是有关圆柱体积变化趋势的例子来说明。</p><p>  我们知道，圆柱体的体积：V=𝛑R^2 h，如果我要问，这个体积随半径变化快，还是随高度变化快？在没有微分这个概念时，一般人根据直觉，会觉得随半径变化快，因为是平方关系，而它随高度变化只是线性关系。</p><p>  但真实情况是什么样呢？我们可以把体积函数分别对半径和高度各做一次微分，得到下面两个结果：</p><p>  体积对半径R微分：dV/dR=2𝛑Rh</p><p>  体积对高度h微分：dV/dh=𝛑R^2</p><p>  大家不必关心细节，了解一下这样两个结论：</p><p>  由于半径增加所带来的体积增量，和圆柱体当前的半径成正比，也和它的高度成正比。</p><p>  由于高度增加所带来的体积增量，和圆柱体当前半径的平方成正比，但和它的高度无关。</p><p>  这时，你如果对比一下两个微分函数就会发现，哪个变化的速率快，还真不好说。假如R等于10，h也等于10，体积就随半径变化快。如果R=10，h只有1，那就是随着高度变化快。</p><p>  假如你是一个工程师，要建造一个巨大的储油罐，无论你增大半径，还是增加高度，都有相当的工程难度。现在你的研发经费有限，只能在一个维度，增大储油罐的体积，你应该怎么做呢？</p><p>  如果你没有学过微积分，你可能会觉得该增加半径。但是听了今天的课程之后你就知道，在这个储油罐比较“扁平”时，应该增加高度。总的来讲，当高度没有达到半径的1/2时，都应该增加高度。</p><p>  我们在工作和生活中，其实经常遇到这样的问题，一个函数取决于很多变量，这时我们不知道该在哪个方向改变，怎样才能以最快的速度进步。微分这个工具，其实给解决这一类的问题提供了很好的方法。它引出了一个梯度的概念，利用梯度，我们就能解决这个问题了。</p><p>  梯度是微分的一个扩展。在上面的圆柱体问题中，对圆柱体函数，我们可以针对半径求微分dV/dR，也可以针对高度求微分dV/dh。如果我们把这两个微分的结果放到一起，就是梯度，也就是说圆柱体积函数的梯度是（2𝛑Rh，𝛑R^2）。</p><p>  梯度的物理含义可以这样理解，如果你去登山，怎样沿着最陡的方向，最快地爬到山顶呢？梯度函数告诉你在任意一点，往不同方向走的上升速度是不一样的，因此你很容易找到前进的目标。在圆柱体函数中的梯度是上面那个式子，我们在前面得到的结论是，只要高度小于1/2的半径，就应该优先增加高度。</p><p>  如果是一个长方体，情况又如何呢？我们先把体积函数写出来，体积等于长乘以宽乘以高度，即 V=L<em>W</em>H。接下来，我们可以用微分计算出它的梯度函数。</p><p>  这里面过程我就省略了，我直接给出答案。这时体积的梯度为 （宽度乘以高度，长度乘以高度，长度乘以宽度），一共三个分量。这时你会发现，长宽高，哪个最小，就应该优先增加哪一个。</p><p>  比如说，长为10，宽和高分别是4和6，这时梯度函数为（24，60，40），你应该增加宽度。这其实和我们的直觉是一致的，如果我们这样不断优化，最后的结果是长方体变成立方体时，体积达到最大。</p><p>  不只是数学问题，其实很多时候，我们都面临在限制要素中作选择的问题。很多时候，我们总想全方位改进自己，但是人的精力和资源有限，因此在某一时刻，可能只能向一个方向努力。</p><p>  希望梯度这个概念在你选择方向时能够给你启发。很多人从直觉出发，觉得该补短板，另一些人则觉得，该把长板变得更长。第一类人会和你讲木桶理论，第二类人会和你讲长板理论，每一类都有很多成功的例子，也有很多失败的教训。</p><p>  于是很多人就不知道该用哪一个理论了。事实上你今天学了梯度理论后，就很容易作决断了，那就是在任何时刻算出梯度，然后沿着最陡，但是收益最大的路径前进就好。</p><p>  在增加长方体体积时，显然是在采用补短板的策略，但是在增加圆柱体体积时，就看情况而定了，如果高度太低，它是严重的短板，需要弥补，但是只要它超过圆柱体半径的一半时，就要增加长板（半径）的优势了。</p><p>  如果说你有一个目标函数，它可能受到多个变量的影响，那是你长期进步的趋势，但是在每一个时刻，你需要计算一下那个函数针对各个变量的微分，也就是梯度函数，找到进步最显著的方向去努力。这就是通过宏观趋势把握微观变化。</p><p><strong>要点总结：</strong></p><p>  我们从导数出发，介绍了微分的概念，它是我们从函数的宏观趋势，把握每一个点细节变化的工具。然后我们介绍了多变量函数的微分，也就是梯度的概念，并且说明了如何在有大量不确定性，或者说大量的变量中找到前进方向的方法，具体讲就是往坡度最高的方向努力。因此，微积分给我们的第一个思维提升就是练习从宏观趋势中把握微观变化的趋势，让我们认清每一步的方向。</p><p>  下一讲，我们还讲微积分，透过微积分讨论企业增长里的奇点和连续性。我们下一讲再见。</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;link rel=&quot;stylesheet&quot; class=&quot;aplayer-secondary-style-marker&quot; href=&quot;/assets/css/APlayer.min.css&quot;&gt;&lt;script src=&quot;/assets/js/APlayer.min.js&quot; cla
      
    
    </summary>
    
    
      <category term="吴军,数学,电子书" scheme="https://hejtao.netlify.com/tags/%E5%90%B4%E5%86%9B-%E6%95%B0%E5%AD%A6-%E7%94%B5%E5%AD%90%E4%B9%A6/"/>
    
  </entry>
  
  <entry>
    <title>MySQL是怎样运行的：从根儿上理解 MySQL</title>
    <link href="https://hejtao.netlify.com/2019/09/20/2019-9-20/"/>
    <id>https://hejtao.netlify.com/2019/09/20/2019-9-20/</id>
    <published>2019-09-19T16:00:00.000Z</published>
    <updated>2019-11-28T13:22:23.157Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><meta name="referrer" content="no-referrer"><div class="toc"><!-- toc --><ul><li><a href="#chong-xin-ren-shi-mysql">重新认识MySQL</a><ul><li><a href="#ke-hu-duan-fu-wu-qi">客户端 + 服务器</a></li><li><a href="#qi-dong-fu-wu-qi-cheng-xu">启动服务器程序</a><ul><li><a href="#unix">UNIX</a></li><li><a href="#windows">Windows</a></li></ul></li><li><a href="#qi-dong-ke-hu-duan-cheng-xu">启动客户端程序</a></li><li><a href="#ke-hu-duan-yu-fu-wu-qi-de-tong-xin">客户端与服务器的通信</a><ul><li><a href="#tcp-ip">TCP/IP</a></li><li><a href="#ming-ming-guan-dao-he-gong-xiang-nei-cun">命名管道和共享内存</a></li><li><a href="#unix-yu-tao-jie-zi-wen-jian">UNIX域套接字文件</a></li></ul></li><li><a href="#fu-wu-qi-chu-li-ke-hu-duan-qing-qiu">服务器处理客户端请求</a></li><li><a href="#cun-chu-yin-qing">存储引擎</a></li></ul></li><li><a href="#qi-dong-xuan-xiang-he-xi-tong-bian-liang">启动选项和系统变量</a><ul><li><a href="#zai-ming-ling-xing-shang-shi-yong-xuan-xiang">在命令行上使用选项</a></li><li><a href="#pei-zhi-wen-jian-zhong-shi-yong-xuan-xiang">配置文件中使用选项</a><ul><li><a href="#windows-1">Windows</a></li><li><a href="#unix-1">UNIX</a></li></ul></li><li><a href="#xi-tong-bian-liang">系统变量</a><ul><li><a href="#cha-kan-xi-tong-bian-liang">查看系统变量</a></li><li><a href="#she-zhi-xi-tong-bian-liang">设置系统变量</a></li></ul></li><li><a href="#zhuang-tai-bian-liang">状态变量</a></li></ul></li><li><a href="#zi-fu-ji-he-bi-jiao-gui-ze">字符集和比较规则</a><ul><li><a href="#zi-fu-ji-de-zhuan-huan">字符集的转换</a></li></ul></li><li><a href="#innodb-ji-lu-cun">InnoDB记录存</a><ul><li><a href="#innodb-ye">InnoDB页</a></li><li><a href="#innodb-xing-ge-shi">InnoDB行格式</a><ul><li><a href="#compact-xing-ge-shi">Compact行格式</a></li><li><a href="#xing-shu-ju-yi-chu">行数据溢出</a></li><li><a href="#xing-yi-chu-de-lin-jie-dian">行溢出的临界点</a></li></ul></li></ul></li><li><a href="#innodb-shu-ju-ye">InnoDB数据页</a><ul><li><a href="#shu-ju-ye-jie-gou">数据页结构</a></li><li><a href="#ji-lu-zai-ye-zhong-de-cun-chu">记录在页中的存储</a><ul><li><a href="#ji-lu-tou-xin-xi">记录头信息</a></li></ul></li><li><a href="#page-directory">Page Directory</a></li><li><a href="#page-header">Page Header</a></li><li><a href="#file-header">File Header</a></li><li><a href="#file-trailer">File Trailer</a></li></ul></li><li><a href="#b-shu-suo-yin">B+树索引</a><ul><li><a href="#wu-suo-yin-cha-zhao">无索引查找</a><ul><li><a href="#zai-ye-nei-cha-zhao">在页内查找</a></li><li><a href="#zai-duo-ye-zhong-cha-zhao">在多页中查找</a></li></ul></li><li><a href="#suo-yin">索引</a><ul><li><a href="#mu-lu-xiang">目录项</a></li><li><a href="#yong-ye-cun-fang-mu-lu-xiang">用页存放目录项</a></li><li><a href="#ju-cu-suo-yin">聚簇索引</a></li><li><a href="#er-ji-suo-yin">二级索引</a></li></ul></li></ul></li><li><a href="#b-shu-suo-yin-de-shi-yong">B+树索引的使用</a><ul><li><a href="#he-li-shi-yong-suo-yin">合理使用索引</a><ul><li><a href="#quan-zhi-pi-pei">全值匹配</a></li><li><a href="#pi-pei-zuo-bian-de-lie">匹配左边的列</a></li><li><a href="#pi-pei-lie-qian-zhui">匹配列前缀</a></li></ul></li><li><a href="#hui-biao-de-dai-jie">回表的代价</a><ul><li><a href="#er-ji-suo-yin-hui-biao-or-quan-biao-sao-ma">二级索引 + 回表 or 全表扫码</a></li><li><a href="#fu-gai-suo-yin">覆盖索引</a></li></ul></li><li><a href="#he-li-di-jian-li-suo-yin">合理地建立索引</a></li></ul></li><li><a href="#mysql-de-shu-ju-mu-lu">MySQL的数据目录</a><ul><li><a href="#shu-ju-ku-he-wen-jian-xi-tong-de-guan-xi">数据库和文件系统的关系</a></li><li><a href="#shu-ju-mu-lu">数据目录</a><ul><li><a href="#shu-ju-mu-lu-he-an-zhuang-mu-lu-de-qu-bie">数据目录和安装目录的区别</a></li><li><a href="#cha-zhao-shu-ju-mu-lu">查找数据目录</a></li></ul></li><li><a href="#shu-ju-mu-lu-de-jie-gou">数据目录的结构</a><ul><li><a href="#shu-ju-ku-zai-wen-jian-xi-tong-zhong-de-biao-shi">数据库在文件系统中的表示</a></li><li><a href="#biao-zai-wen-jian-xi-tong-zhong-de-biao-shi">表在文件系统中的表示</a></li></ul></li><li><a href="#wen-jian-xi-tong-dui-shu-ju-ku-de-ying-xiang">文件系统对数据库的影响</a></li><li><a href="#mysql-xi-tong-shu-ju-ku-jian-jie">MySQL系统数据库简介</a></li></ul></li></ul><!-- tocstop --></div><p>本文为敝人的学习记录，感兴趣的请在掘金小册购买同名原著 😎</p><h2><span id="chong-xin-ren-shi-mysql">重新认识MySQL</span><a href="#chong-xin-ren-shi-mysql" class="header-anchor">#</a></h2><h3><span id="ke-hu-duan-fu-wu-qi">客户端 + 服务器</span><a href="#ke-hu-duan-fu-wu-qi" class="header-anchor">#</a></h3><p>MySQL服务器进程(也叫数据库实例)MySQL客户端进程</p><p>进程：进程号(PID，由操作系统随机分配)、进程名称</p><p>MySQL服务器进程的默认名称为mysqld，MySQL客户端进程的默认名称为mysql</p><h3><span id="qi-dong-fu-wu-qi-cheng-xu">启动服务器程序</span><a href="#qi-dong-fu-wu-qi-cheng-xu" class="header-anchor">#</a></h3><h4><span id="unix">UNIX</span><a href="#unix" class="header-anchor">#</a></h4><p>使用安装目录下(比如 <code>/usr/local/mysql/bin/</code>):</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysqld</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysqld_safe</span><br></pre></td></tr></table></figure><p><code>mysqld_safe</code>是一个启动脚本的命令，调用了<code>mysqld</code>，并启动一个监控进程(重启，日志)</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mysql.server start</span><br><span class="line">ysql.server stop</span><br></pre></td></tr></table></figure><p><code>mysql.server</code>是一个链接文件， 会调用<code>mysqld_safe</code></p><h4><span id="windows">Windows</span><a href="#windows" class="header-anchor">#</a></h4><p>使用安装目录下(比如 <code>D:\Program Files\mysql-5.7.26-winx64\bin\</code>) <code>mysqld.exe</code> 可执行文件</p><p>使用 Windows服务。把某个程序注册为Windows服务的格式：&quot;可执行文件路径&quot; --install [-manual] [服务名称]</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">D:\Program Files\mysql-5.7.26-winx64\bin\mysqld --install [MySQL_Service]</span><br><span class="line">net start MySQL_Service</span><br><span class="line">net stop MySQL_Service</span><br></pre></td></tr></table></figure><h3><span id="qi-dong-ke-hu-duan-cheng-xu">启动客户端程序</span><a href="#qi-dong-ke-hu-duan-cheng-xu" class="header-anchor">#</a></h3><p>mysql -h主机名  -u用户名 -p密码</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mysql -hlocalhost  -uroot -p123abc</span><br><span class="line">mysql -u root -p</span><br><span class="line">mysql --host=localhost  --user=root --password=123abc</span><br></pre></td></tr></table></figure><p><img src="https://upload-images.jianshu.io/upload_images/1863961-c583b0a1eabe5ff6.PNG?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt=""></p><p>退出客户端</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">quit</span><br><span class="line">exit</span><br><span class="line">\q</span><br></pre></td></tr></table></figure><h3><span id="ke-hu-duan-yu-fu-wu-qi-de-tong-xin">客户端与服务器的通信</span><a href="#ke-hu-duan-yu-fu-wu-qi-de-tong-xin" class="header-anchor">#</a></h3><p>本质是两个进程间的通信</p><h4><span id="tcp-ip">TCP/IP</span><a href="#tcp-ip" class="header-anchor">#</a></h4><p>每台计算机都有一个唯一的IP地址每个进程向操作系统申请一个端口号(0~65535)通过IP地址 + 端口号来与某个进程通信MySQL服务器进程的默认端口号为3306，自定义MySQL服务器进程的端口号如下</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysqld -P3307</span><br></pre></td></tr></table></figure><h4><span id="ming-ming-guan-dao-he-gong-xiang-nei-cun">命名管道和共享内存</span><a href="#ming-ming-guan-dao-he-gong-xiang-nei-cun" class="header-anchor">#</a></h4><p>Windows系统中的进程间通信方式</p><p>命名管道</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">mysqld --enable-named-pipe</span><br><span class="line"></span><br><span class="line">mysql --pipe</span><br><span class="line">or</span><br><span class="line">mysql --protocol=pipe</span><br></pre></td></tr></table></figure><p>共享内存</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mysqld --shared-memory</span><br><span class="line"></span><br><span class="line">mysql --protocol=memory</span><br></pre></td></tr></table></figure><h4><span id="unix-yu-tao-jie-zi-wen-jian">UNIX域套接字文件</span><a href="#unix-yu-tao-jie-zi-wen-jian" class="header-anchor">#</a></h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql --protocol=socket</span><br></pre></td></tr></table></figure><p>服务器程序默认监听的套接字文件路径为<code>/tmp/mysql.sock</code>，指定套接字文件路径：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mysqld --socket=/tmp/a.txt</span><br><span class="line">mysql -hlocalhost -uroot --socket=/tmp/a.txt -p</span><br></pre></td></tr></table></figure><h3><span id="fu-wu-qi-chu-li-ke-hu-duan-qing-qiu">服务器处理客户端请求</span><a href="#fu-wu-qi-chu-li-ke-hu-duan-qing-qiu" class="header-anchor">#</a></h3><p><img src="https://upload-images.jianshu.io/upload_images/1863961-a6bef812a91553aa.PNG?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt=""></p><h3><span id="cun-chu-yin-qing">存储引擎</span><a href="#cun-chu-yin-qing" class="header-anchor">#</a></h3><p><img src="https://upload-images.jianshu.io/upload_images/1863961-b31ff09869340b51.PNG?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt=""><code>XA</code>列代表是否支持分布式事务<code>Savepoints</code>代表是否支持部分事务回滚</p><h2><span id="qi-dong-xuan-xiang-he-xi-tong-bian-liang">启动选项和系统变量</span><a href="#qi-dong-xuan-xiang-he-xi-tong-bian-liang" class="header-anchor">#</a></h2><h3><span id="zai-ming-ling-xing-shang-shi-yong-xuan-xiang">在命令行上使用选项</span><a href="#zai-ming-ling-xing-shang-shi-yong-xuan-xiang" class="header-anchor">#</a></h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mysqld --skip-networking</span><br><span class="line">mysqld --default-storage-engine=MyISAM \\ 等号两边不能有空格</span><br></pre></td></tr></table></figure><p>使用<code>mysql --help</code>可以看到mysql程序支持的启动选项使用<code>mysqld --verbose --help</code>查看mysqld支持的启动选项</p><h3><span id="pei-zhi-wen-jian-zhong-shi-yong-xuan-xiang">配置文件中使用选项</span><a href="#pei-zhi-wen-jian-zhong-shi-yong-xuan-xiang" class="header-anchor">#</a></h3><h4><span id="windows">Windows</span><a href="#windows" class="header-anchor">#</a></h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">%WINDIR%\my.ini</span><br><span class="line">%WINDIR%\my.cnf</span><br><span class="line"></span><br><span class="line">C:\my.ini</span><br><span class="line">C:\my.cnf</span><br><span class="line"></span><br><span class="line">BASEDIR\my.ini  \\ MySQL安装路径</span><br><span class="line">BASEDIR\my.cnf</span><br><span class="line"></span><br><span class="line">defaults-extra-file命令行指定的额外配置文件路径，如</span><br><span class="line">mysqld --defaults-extra-file=C:\Users\chiangtao ho\my_extra_file.txt</span><br><span class="line"></span><br><span class="line">%APPDATA%\MySQL\.mylogin.cnf登录路径选项（仅限客户端）</span><br></pre></td></tr></table></figure><h4><span id="unix">UNIX</span><a href="#unix" class="header-anchor">#</a></h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">/etc/my.cnf</span><br><span class="line">/etc/mysql/my.cnf</span><br><span class="line">SYSCONFDIR/my.cnf</span><br><span class="line">$MYSQL_HOME/my.cnf特定于服务器的选项（仅限服务器）</span><br><span class="line"></span><br><span class="line">defaults-extra-file</span><br><span class="line"></span><br><span class="line">~/.my.cnf用户特定选项</span><br><span class="line"></span><br><span class="line">~/.mylogin.cnf用户特定的登录路径选项（仅限客户端）</span><br></pre></td></tr></table></figure><h3><span id="xi-tong-bian-liang">系统变量</span><a href="#xi-tong-bian-liang" class="header-anchor">#</a></h3><h4><span id="cha-kan-xi-tong-bian-liang">查看系统变量</span><a href="#cha-kan-xi-tong-bian-liang" class="header-anchor">#</a></h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SHOW</span> <span class="keyword">VARIABLES</span> <span class="keyword">like</span> <span class="string">'max_connections'</span>;</span><br><span class="line"><span class="keyword">SHOW</span> <span class="keyword">VARIABLES</span> <span class="keyword">LIKE</span> <span class="string">'default%'</span>;</span><br></pre></td></tr></table></figure><blockquote><p>系统变量的单词之间必须使用下划线_连接</p></blockquote><h4><span id="she-zhi-xi-tong-bian-liang">设置系统变量</span><a href="#she-zhi-xi-tong-bian-liang" class="header-anchor">#</a></h4><p>变量的作用范围<strong>GLOBAL</strong>：全局变量，影响服务器的整体操作<strong>SESSION (LOCAL)</strong>：会话变量，影响某个客户端连接的操作</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SET</span> <span class="keyword">GLOBAL</span> default_storage_engine = MyISAM;</span><br><span class="line"><span class="keyword">SET</span> @@GLOBAL.default_storage_engine = MyISAM;</span><br><span class="line"></span><br><span class="line"><span class="keyword">SET</span> <span class="keyword">SESSION</span> default_storage_engine = MyISAM;</span><br><span class="line"><span class="keyword">SET</span> @@SESSION.default_storage_engine = MyISAM;</span><br><span class="line"><span class="keyword">SET</span> default_storage_engine = MyISAM; \\ 默认作用范围是LOCAL</span><br></pre></td></tr></table></figure><blockquote><p>那我们的SHOW VARIABLES语句默认查看的是SESSION作用范围的系统变量并不是所有系统变量都具有GLOBAL和SESSION的作用范围</p></blockquote><h3><span id="zhuang-tai-bian-liang">状态变量</span><a href="#zhuang-tai-bian-liang" class="header-anchor">#</a></h3><p>与系统变量类似，状态变量也有GLOBAL和SESSION两个作用范围的</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SHOW</span> <span class="keyword">STATUS</span> <span class="keyword">LIKE</span> <span class="string">'thread%'</span>;</span><br></pre></td></tr></table></figure><h2><span id="zi-fu-ji-he-bi-jiao-gui-ze">字符集和比较规则</span><a href="#zi-fu-ji-he-bi-jiao-gui-ze" class="header-anchor">#</a></h2><p>查看字符集</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SHOW</span> <span class="keyword">CHARSET</span>;</span><br><span class="line"><span class="keyword">SHOW</span> <span class="built_in">CHARACTER</span> <span class="keyword">SET</span>;</span><br></pre></td></tr></table></figure><p><img src="https://upload-images.jianshu.io/upload_images/1863961-7c37618995aa0d2a.PNG?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt=""></p><p><strong>Default collation</strong>表示字符集默认的比较规则<strong>Maxlen</strong>代表该字符集表示一个字符最多需要几个字节</p><p>查看比较规则<img src="https://upload-images.jianshu.io/upload_images/1863961-434c1321853a6064.PNG?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt=""></p><p><img src="https://upload-images.jianshu.io/upload_images/1863961-28b9ac453cbdcce8.PNG?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt=""></p><blockquote><p>MySQL中utf8是utf8mb3的别名，所以在MySQL中utf8就意味着使用1~3个字节来表示一个字符，如果大家有使用4字节编码一个字符的情况，比如存储一些emoji表情，使用utf8mb4</p></blockquote><p>MySQL有4个级别的字符集和比较规则，分别是：服务器级别 <code>character_set_server</code>, <code>collation_server</code></p><p>数据库级别 <code>character_set_database</code>, <code>collation_database</code></p><p>表级别</p><p>列级别</p><blockquote><p>编码和解码使用的字符集不一致将导致乱码</p></blockquote><h3><span id="zi-fu-ji-de-zhuan-huan">字符集的转换</span><a href="#zi-fu-ji-de-zhuan-huan" class="header-anchor">#</a></h3><p><code>character_set_client</code> 服务器解码请求语句时使用的字符集</p><p><code>character_set_connection</code>服务器处理请求时会把请求字符串从<code>character_set_client</code>转为<code>character_set_connection</code></p><p><code>character_set_results</code>服务器向客户端返回数据时使用的字符集</p><p><img src="https://upload-images.jianshu.io/upload_images/1863961-d6053a1496be0af5.PNG?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt=""></p><blockquote><p>通常把 <code>character_set_client</code> 、<code>character_set_connection</code>、<code>character_set_results</code> 这三个系统变量设置成和客户端使用的相同的字符集</p></blockquote><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SET</span> <span class="keyword">NAMES</span> 字符集名;</span><br><span class="line"></span><br><span class="line"><span class="keyword">SET</span> character_set_client = 字符集名;</span><br><span class="line"><span class="keyword">SET</span> character_set_connection = 字符集名;</span><br><span class="line"><span class="keyword">SET</span> character_set_results = 字符集名;</span><br></pre></td></tr></table></figure><h2><span id="innodb-ji-lu-cun">InnoDB记录存</span><a href="#innodb-ji-lu-cun" class="header-anchor">#</a></h2><h3><span id="innodb-ye">InnoDB页</span><a href="#innodb-ye" class="header-anchor">#</a></h3><p>InnoDB是一个将表中的数据存储到磁盘上的存储引擎。磁盘读写的速度比内存的读写速度差了几个数量级，因此设计InnoDB时将数据划分为若干个页并以页作为磁盘和内存之间交互的基本单位，页的大小一般为 16 KB。</p><h3><span id="innodb-xing-ge-shi">InnoDB行格式</span><a href="#innodb-xing-ge-shi" class="header-anchor">#</a></h3><p>4种行格式:</p><p>Compact</p><p>Redundant</p><p>Dynamic</p><p>Compressed</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> 表名 ROW_FORMAT=行格式名称</span><br></pre></td></tr></table></figure><h4><span id="compact-xing-ge-shi">Compact行格式</span><a href="#compact-xing-ge-shi" class="header-anchor">#</a></h4><p><img src="https://upload-images.jianshu.io/upload_images/1863961-769f50ea36079f99.PNG?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt=""></p><p>所有变长字段的真实数据占用的字节长度都被存放在<strong>变长字段长度列表</strong>把值为NULL的列统一存储到<strong>NULL值列表</strong>中<strong>记录头信息</strong>是由固定的5个字节组成</p><blockquote><p>MySQL会为每个记录默认的添加一些列（隐藏列），包括：<strong>row_id</strong>（DB_ROW_ID）、<strong>transaction_id</strong>（DB_TRX_ID）、<strong>roll_pointer</strong>（DB_ROLL_PTR）。</p></blockquote><h4><span id="xing-shu-ju-yi-chu">行数据溢出</span><a href="#xing-shu-ju-yi-chu" class="header-anchor">#</a></h4><p><img src="https://upload-images.jianshu.io/upload_images/1863961-a7e5ed104feb0ad1.PNG?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt=""></p><p>对于MySQL的每条记录，除了BLOB或者TEXT类型的列之外，其他所有的列（不包括隐藏列和记录头信息）占用的字节长度加起来不能超过65535个字节。这个65535个字节除了列本身的数据之外，还包括一些其他的数据，即</p><ul><li>真实数据本身</li><li>真实数据占用字节的长度标识（&lt;= 2 bytes）</li><li>NULL值标识（&lt;= 1 byte），当列都有NOT NULL属性时为0</li></ul><p>因此，上图中设置变长类型<code>VARCHAR(M)</code>（M表示允许的字符数量）M=65535时导致了溢出。</p><p><img src="https://upload-images.jianshu.io/upload_images/1863961-0e1da580a7f2aa45.PNG?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt=""></p><p>真实数据：65533 = 65529(c1)+ 4(c2)长度标识：2NULL值标识：1共65536 &gt; 65535溢出。</p><p><img src="https://upload-images.jianshu.io/upload_images/1863961-f0eb4612f6ec51fd.PNG?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt=""></p><p>更换字符集后溢出。</p><p><img src="https://upload-images.jianshu.io/upload_images/1863961-58720a826df6d70e.PNG?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt=""></p><p>VARCHAR(M)类型的列就最多可以存储65533个字节，而一个页的大小一般是16KB，也就是16384字节，因此在Compact和Reduntant行格式中，在本记录只会存储该列的前768个字节的数据和一个指向其他页的地址，然后把剩下的数据存放到其他页中；而在Dynamic和Compressed行格式中，记录中只存储其他页的地址。</p><h4><span id="xing-yi-chu-de-lin-jie-dian">行溢出的临界点</span><a href="#xing-yi-chu-de-lin-jie-dian" class="header-anchor">#</a></h4><p>MySQL中规定一个页中至少要存放两行记录</p><ul><li>每个页除了存放记录外，也需要存储一些额外的信息，这些额外信息加起来需要132个字节</li><li>每个记录的额外信息需要27字节<ul><li>真实数据的长度标识 1B</li><li>NULL值标识 1B</li><li>记录头信息 5B</li><li>row_id 6B</li><li>transaction_id 6B</li><li>roll_pointer 7B</li></ul></li></ul><blockquote><p>不溢出的临界条件：132 + 2×(27 + n) &lt; 16384</p></blockquote><h2><span id="innodb-shu-ju-ye">InnoDB数据页</span><a href="#innodb-shu-ju-ye" class="header-anchor">#</a></h2><h3><span id="shu-ju-ye-jie-gou">数据页结构</span><a href="#shu-ju-ye-jie-gou" class="header-anchor">#</a></h3><p><img src="https://upload-images.jianshu.io/upload_images/1863961-7b48bacba1c08eed.PNG?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt=""></p><h3><span id="ji-lu-zai-ye-zhong-de-cun-chu">记录在页中的存储</span><a href="#ji-lu-zai-ye-zhong-de-cun-chu" class="header-anchor">#</a></h3><p><img src="https://upload-images.jianshu.io/upload_images/1863961-c4157ce34c34235e.PNG?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt=""></p><h4><span id="ji-lu-tou-xin-xi">记录头信息</span><a href="#ji-lu-tou-xin-xi" class="header-anchor">#</a></h4><p>以 page_demo 表为例</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> page_demo(</span><br><span class="line">    c1 <span class="built_in">INT</span>,</span><br><span class="line">    c2 <span class="built_in">INT</span>,</span><br><span class="line">    c3 <span class="built_in">VARCHAR</span>(<span class="number">10000</span>),</span><br><span class="line">    PRIMARY <span class="keyword">KEY</span> (c1)</span><br><span class="line">) <span class="keyword">CHARSET</span>=<span class="keyword">ascii</span> ROW_FORMAT=<span class="keyword">Compact</span>;</span><br></pre></td></tr></table></figure><p><img src="/images/1.PNG" alt=""></p><p>由于指定 c1 为主键，所以在行格式中就没有隐藏列 row_id。</p><p>插入数据4条记录</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> page_demo <span class="keyword">VALUES</span>(<span class="number">1</span>, <span class="number">100</span>, <span class="string">'aaaa'</span>),</span><br><span class="line">    (<span class="number">2</span>, <span class="number">200</span>, <span class="string">'bbbb'</span>),</span><br><span class="line">    (<span class="number">3</span>, <span class="number">300</span>, <span class="string">'cccc'</span>),</span><br><span class="line">    (<span class="number">4</span>, <span class="number">400</span>, <span class="string">'dddd'</span>);</span><br></pre></td></tr></table></figure><p><img src="/images/2.PNG" alt=""></p><ul><li><p>delete_mask</p><p>标记当前记录是否被删除，值为0的时候代表记录没有被删除，1则被删除了；所有被删的记录会组成一个<strong>垃圾链表</strong>，新记录插入到表时可以覆盖这些被删除的记录占用的存储空间。</p></li><li><p>n_owned</p><p>见<a href="#page-directory">Page Directory</a></p></li><li><p>heap_no</p><p>表示当前记录在本页中的位置，从上图中可以看出，插入的4条记录在本页中的位置分别是：2、3、4、5。最小记录和最大记录分别为0、1。</p><p><img src="/images/3.PNG" alt=""></p></li><li><p>record_type</p><p>记录类型，共4种：</p><p>0：普通记录</p><p>1：B+树非叶节点记录 （或目录项记录，见<a href="#mu-lu-xiang">目录项</a>）</p><p>2：最小记录</p><p>3：最大记录</p></li><li><p>min_rec_mask</p><p>代表B+树的每层非叶节点中的最小记录 （或者主键值最小的目录项记录的min_rec_mask值为1）</p></li><li><p>next_record</p><p>表示从当前记录的真实数据到下一条记录的真实数据的地址偏移量。例如第一条记录的next_record值为32，意味着从第一条记录的真实数据的地址处向后找32个字节便是下一条记录的真实数据。记录按照主键从小到大的顺序形成了一个单链表</p><p><img src="/images/4.PNG" alt=""></p></li></ul><p>如果删除第二条记录</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">DELETE</span> <span class="keyword">FROM</span> page_demo <span class="keyword">WHERE</span> c1 = <span class="number">2</span>;</span><br></pre></td></tr></table></figure><p><img src="/images/5.PNG" alt=""></p><p>删除第2条记录前后的主要变化：</p><ul><li>第2条记录的delete_mask值设置为1；</li><li>第2条记录的next_record值变为了0，意味着该记录没有下一条记录了；</li><li>第1条记录的next_record指向了第3条记录；</li><li>最大记录的n_owned值从5变成了4。</li></ul><h3><span id="page-directory">Page Directory</span><a href="#page-directory" class="header-anchor">#</a></h3><p>设计页目录是为了方便快速查找记录，就像书的目录那样，创建 page directory 的步骤：</p><ul><li>将所有正常的记录（包括最大和最小记录，不包括标记为已删除的记录）划分为几个组；</li><li>每个组内最大的那条记录的头信息的 n_owned 表示组内记录的数量；</li><li>将每个组的最大的那条记录的地址偏移量（也称槽，slot）集中起来存放，构成 Page Directory；</li></ul><p><img src="/images/6.PNG" alt=""></p><p>InnoDB规定最小记录所在的分组只能有 1 条记录，最大记录所在的分组的记录条数在 1~8 条之间，其它分组中记录的条数则在是 4~8 条之间。</p><p>利用页目录查找指定主键的记录的过程分为两步：</p><ul><li>通过二分法确定该记录所在的槽，并找到该槽中主键值最小的那条记录；</li><li>通过记录的 next_record 属性遍历组中的各个记录。</li></ul><h3><span id="page-header">Page Header</span><a href="#page-header" class="header-anchor">#</a></h3><p>存储数据的状态信息，比如本页中已经存储了多少条记录，第一条记录的地址是什么，页目录中存储了多少个槽等等。</p><h3><span id="file-header">File Header</span><a href="#file-header" class="header-anchor">#</a></h3><p>不同类型的页都会以File Header作为第一个组成部分，它记录了针对各种页都通用的一些信息。索引页（数据页）通过 file header 构成双向链表</p><p><img src="/images/7.PNG" alt=""></p><h3><span id="file-trailer">File Trailer</span><a href="#file-trailer" class="header-anchor">#</a></h3><p>与file header一样对不同类型的页通用，主要用于校验页数据的完整性。</p><h2><span id="b-shu-suo-yin">B+树索引</span><a href="#b-shu-suo-yin" class="header-anchor">#</a></h2><h3><span id="wu-suo-yin-cha-zhao">无索引查找</span><a href="#wu-suo-yin-cha-zhao" class="header-anchor">#</a></h3><h4><span id="zai-ye-nei-cha-zhao">在页内查找</span><a href="#zai-ye-nei-cha-zhao" class="header-anchor">#</a></h4><ul><li><p>以主键查找依据页目录（槽）采用二分查找定位分组，再遍历分组</p></li><li><p>以主键以外的列查找遍历页内的记录链表</p></li></ul><h4><span id="zai-duo-ye-zhong-cha-zhao">在多页中查找</span><a href="#zai-duo-ye-zhong-cha-zhao" class="header-anchor">#</a></h4><ul><li>定位记录所在的页</li><li>页内查找</li></ul><h3><span id="suo-yin">索引</span><a href="#suo-yin" class="header-anchor">#</a></h3><p>建立索引是为了快速定位记录所在的数据页。</p><ul><li>对数据页进行排序。即让下一个数据页的记录的主键值大于上一个页的记录的主键值，因此在插入新的记录时涉及数据页间的记录的调整<img src="/images/8.PNG" alt=""></li></ul><blockquote><p>对页进行排序后，全部记录的主键值就构成了一个递增的序列，从而可以利用二分法实现快速查找。</p></blockquote><ul><li>对每个页设置目录项</li></ul><h4><span id="mu-lu-xiang">目录项</span><a href="#mu-lu-xiang" class="header-anchor">#</a></h4><p>目录项包括</p><ul><li>数据页中的记录的最小主键值，用key来表示；</li><li>页号，用page_no表示。</li></ul><p><img src="/images/9.PNG" alt=""></p><h4><span id="yong-ye-cun-fang-mu-lu-xiang">用页存放目录项</span><a href="#yong-ye-cun-fang-mu-lu-xiang" class="header-anchor">#</a></h4><p><img src="/images/10.PNG" alt=""><img src="/images/11.PNG" alt=""><img src="/images/12.PNG" alt=""></p><p>用户记录都存放在B+树的叶节点上，而目录项都存放在非页节点上。</p><h4><span id="ju-cu-suo-yin">聚簇索引</span><a href="#ju-cu-suo-yin" class="header-anchor">#</a></h4><p>特性包括：</p><ol><li>依据记录的主键值排序<ul><li>页内的记录是按照主键的大小顺序排成一个单向链表</li><li>数据页根据主键大小顺序排成一个双向链表</li><li>存放目录项记录的页根据主键大小分为不同的层次</li></ul></li><li>B+树的叶节点存储的是完整的记录，即记录的所有列的值（包括隐藏列）</li></ol><h4><span id="er-ji-suo-yin">二级索引</span><a href="#er-ji-suo-yin" class="header-anchor">#</a></h4><p>依据记录的其它列（比如c1）的值排序形成的B+树。将聚簇索引的主键值换为c1的值，此外，叶节点存储的不是完整的记录而只有主键和c1。</p><blockquote><p>通过二级索引来查找完整记录：通过二级索引找到主键值之后再通过聚簇索引查找完整记录。</p></blockquote><h2><span id="b-shu-suo-yin-de-shi-yong">B+树索引的使用</span><a href="#b-shu-suo-yin-de-shi-yong" class="header-anchor">#</a></h2><h3><span id="he-li-shi-yong-suo-yin">合理使用索引</span><a href="#he-li-shi-yong-suo-yin" class="header-anchor">#</a></h3><p>考虑表 person_info</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> person_info(</span><br><span class="line">    <span class="keyword">id</span> <span class="built_in">INT</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> auto_increment,</span><br><span class="line">    <span class="keyword">name</span> <span class="built_in">VARCHAR</span>(<span class="number">100</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">    birthday <span class="built_in">DATE</span> <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">    phone <span class="built_in">CHAR</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">    country <span class="built_in">varchar</span>(<span class="number">100</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">    PRIMARY <span class="keyword">KEY</span> (<span class="keyword">id</span>),</span><br><span class="line">    <span class="keyword">KEY</span> idx_name_birthday_phone (<span class="keyword">name</span>, birthday, phone)</span><br><span class="line">);</span><br></pre></td></tr></table></figure><p>idx_name_birthday_phone 为二级索引<img src="/images/13.PNG" alt=""></p><h4><span id="quan-zhi-pi-pei">全值匹配</span><a href="#quan-zhi-pi-pei" class="header-anchor">#</a></h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> person_info <span class="keyword">WHERE</span> <span class="keyword">name</span> = <span class="string">'Ashburn'</span> <span class="keyword">AND</span> birthday = <span class="string">'1990-09-27'</span> <span class="keyword">AND</span> phone = <span class="string">'15123983239'</span>;</span><br></pre></td></tr></table></figure><blockquote><p>由于查询优化器的存在，调换name、birthday、phone这几个搜索列的顺序<strong>不影响</strong>查询的执行过程。</p></blockquote><h4><span id="pi-pei-zuo-bian-de-lie">匹配左边的列</span><a href="#pi-pei-zuo-bian-de-lie" class="header-anchor">#</a></h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> person_info <span class="keyword">WHERE</span> <span class="keyword">name</span> = <span class="string">'Ashburn'</span>;</span><br></pre></td></tr></table></figure><p>可以使用索引idx_name_birthday_phone，而</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> person_info <span class="keyword">WHERE</span> birthday = <span class="string">'1990-09-27'</span>;</span><br></pre></td></tr></table></figure><p>不能使用索引idx_name_birthday_phone。</p><h4><span id="pi-pei-lie-qian-zhui">匹配列前缀</span><a href="#pi-pei-lie-qian-zhui" class="header-anchor">#</a></h4><p>比如查询名字以 As 开头的记录</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> person_info <span class="keyword">WHERE</span> <span class="keyword">name</span> <span class="keyword">LIKE</span> <span class="string">'As%'</span>;</span><br></pre></td></tr></table></figure><h3><span id="hui-biao-de-dai-jie">回表的代价</span><a href="#hui-biao-de-dai-jie" class="header-anchor">#</a></h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> person_info <span class="keyword">WHERE</span> <span class="keyword">name</span> &gt; <span class="string">'Asa'</span> <span class="keyword">AND</span> <span class="keyword">name</span> &lt; <span class="string">'Barlow'</span>;</span><br></pre></td></tr></table></figure><p>二级索引搜索到的结果（即值在Asa～Barlow之间的记录）在磁盘中的存储是相连的，集中分布在一个或几个数据页中，因此可以很快从磁盘中读出，这种读取方式可以称为顺序I/O。而回表是根据不连续的id值到聚簇索引中读出完整的用户记录（可能分布在不同的数据页中），这种读取方式可以称为随机I/O。一般情况下，顺序I/O比随机I/O的性能高很多。</p><h4><span id="er-ji-suo-yin-hui-biao-or-quan-biao-sao-ma">二级索引 + 回表 or 全表扫码</span><a href="#er-ji-suo-yin-hui-biao-or-quan-biao-sao-ma" class="header-anchor">#</a></h4><p>需要回表的记录越多，使用二级索引的性能就越低，甚至不如使用聚簇索引全表扫码；</p><p>使用<code>LIMIT</code>限制回表次数，使优化器倾向于使用二级索引 + 回表的方式执行查询。</p><h4><span id="fu-gai-suo-yin">覆盖索引</span><a href="#fu-gai-suo-yin" class="header-anchor">#</a></h4><p>如果需要查询的列包含在二级索引中，就可以避免回表查询，这种只需要用到索引的查询方式称为索引覆盖。例如对于索引idx_name_birthday_phone</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="keyword">name</span>, birthday, phone <span class="keyword">FROM</span> person_info <span class="keyword">WHERE</span> <span class="keyword">name</span> &gt; <span class="string">'Asa'</span> <span class="keyword">AND</span> <span class="keyword">name</span> &lt; <span class="string">'Barlow'</span></span><br></pre></td></tr></table></figure><h3><span id="he-li-di-jian-li-suo-yin">合理地建立索引</span><a href="#he-li-di-jian-li-suo-yin" class="header-anchor">#</a></h3><ul><li><p>只给搜索、排序、分组的列创建索引</p><p>即只给出现在 WHERE、ORDER BY、GROUP BY 子句中的列创建索引；</p></li><li><p>列的方差越大越适合建立索引</p><p>列的数据越分散，越适合索引查询。举个极端的例子，数据都相同的列，对这样的列建立索引毫无意义；</p></li><li><p>列的数据类型越小越适合建立索引</p><p>比较数据大小更快，占用的存储空间更小；</p></li><li><p>索引字符串的前缀</p>  <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> person_info(</span><br><span class="line">    <span class="keyword">name</span> <span class="built_in">VARCHAR</span>(<span class="number">100</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">    birthday <span class="built_in">DATE</span> <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">    phone <span class="built_in">CHAR</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">    country <span class="built_in">varchar</span>(<span class="number">100</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">    <span class="keyword">KEY</span> idx_name_birthday_phone (<span class="keyword">name</span>(<span class="number">10</span>), birthday, phone)</span><br><span class="line">);</span><br></pre></td></tr></table></figure><p>其中 name(10) 表示在建立的B+树索引中只保留记录的前10个字符的编码，但是该索引不支持 name 排序</p>  <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> person_info <span class="keyword">ORDER</span> <span class="keyword">BY</span> <span class="keyword">name</span> <span class="keyword">LIMIT</span> <span class="number">10</span>;</span><br></pre></td></tr></table></figure></li><li><p>让索引列在比较表达式中单独出现</p>  <figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">WHERE my_col * 2 &lt; 4</span><br><span class="line">WHERE my_col &lt; 4/2</span><br></pre></td></tr></table></figure><p>如果列是以某个表达式或者函数调用形式出现是用不到索引的，比如上面的<code>my_col * 2</code>；</p></li><li><p>开启主键AUTO_INCREMENT属性</p><p>可减少页分裂和记录移位的次数。</p></li></ul><h2><span id="mysql-de-shu-ju-mu-lu">MySQL的数据目录</span><a href="#mysql-de-shu-ju-mu-lu" class="header-anchor">#</a></h2><h3><span id="shu-ju-ku-he-wen-jian-xi-tong-de-guan-xi">数据库和文件系统的关系</span><a href="#shu-ju-ku-he-wen-jian-xi-tong-de-guan-xi" class="header-anchor">#</a></h3><p>InnoDB、MyISAM等存储引擎都是把表存储在磁盘上。操作系统通过文件系统管理磁盘。</p><p>InnoDB、MyISAM等存储引擎 $ \Leftrightarrow $ 文件系统 $ \Leftrightarrow $ 磁盘</p><h3><span id="shu-ju-mu-lu">数据目录</span><a href="#shu-ju-mu-lu" class="header-anchor">#</a></h3><h4><span id="shu-ju-mu-lu-he-an-zhuang-mu-lu-de-qu-bie">数据目录和安装目录的区别</span><a href="#shu-ju-mu-lu-he-an-zhuang-mu-lu-de-qu-bie" class="header-anchor">#</a></h4><p>数据目录是用来存储MySQL在运行过程中产生的数据，要与MySQL的安装目录区别开来。</p><h4><span id="cha-zhao-shu-ju-mu-lu">查找数据目录</span><a href="#cha-zhao-shu-ju-mu-lu" class="header-anchor">#</a></h4><p><img src="/images/14.PNG" alt=""></p><h3><span id="shu-ju-mu-lu-de-jie-gou">数据目录的结构</span><a href="#shu-ju-mu-lu-de-jie-gou" class="header-anchor">#</a></h3><h4><span id="shu-ju-ku-zai-wen-jian-xi-tong-zhong-de-biao-shi">数据库在文件系统中的表示</span><a href="#shu-ju-ku-zai-wen-jian-xi-tong-zhong-de-biao-shi" class="header-anchor">#</a></h4><p>每新建一个数据库，MySQL执行了：</p><ul><li>在数据目录下创建一个和数据库名同名的子目录；</li><li>并在该子目录下创建一个db.opt文件，这个文件中包含了该数据库的各种属性，比方说该数据库的字符集和比较规则等。</li></ul><p>查看数据库<img src="/images/15.PNG" alt="">查看数据目录<img src="/images/16.PNG" alt=""></p><p>除了information_schema这个系统数据库外，其他的数据库在数据目录下都有对应的子目录。</p><h4><span id="biao-zai-wen-jian-xi-tong-zhong-de-biao-shi">表在文件系统中的表示</span><a href="#biao-zai-wen-jian-xi-tong-zhong-de-biao-shi" class="header-anchor">#</a></h4><p>每个表包含两部分信息：</p><ul><li><p>表结构的定义</p><p>用<code>表名.frm</code>文件来描述表结构</p></li><li><p>表中的数据</p><p>InnoDB: 数据存在独立表空间(file-per-table tablespace)中，即 <code>test.ibd</code> 文件</p><p>MyISAM: <code>表名.MYD</code>表示表的数据文件、<code>表名.MYI</code>表示表的索引文件</p></li></ul><h3><span id="wen-jian-xi-tong-dui-shu-ju-ku-de-ying-xiang">文件系统对数据库的影响</span><a href="#wen-jian-xi-tong-dui-shu-ju-ku-de-ying-xiang" class="header-anchor">#</a></h3><ul><li><p>数据库名和表名不得超过文件系统所允许的最大长度</p></li><li><p>特殊字符</p><p>MySQL会把数据库名和表名中除<strong>数字</strong>和<strong>拉丁字母</strong>外的所有字符在文件名里都映射成 @+编码值的形式，如<code>test?.frm</code> $ \rightarrow $ <code>test@003f.frm</code></p></li><li><p>文件大小受文件系统限制</p></li></ul><h3><span id="mysql-xi-tong-shu-ju-ku-jian-jie">MySQL系统数据库简介</span><a href="#mysql-xi-tong-shu-ju-ku-jian-jie" class="header-anchor">#</a></h3><ul><li><p>mysql</p><p>存储了MySQL的账户和权限信息，一些存储过程、事件的定义信息，一些运行过程中产生的日志信息、以及时区信息等</p></li><li><p>information_schema</p><p>这个数据库保存着MySQL服务器维护的所有其他数据库的信息，比如表、视图、触发器、列、索引等</p></li><li><p>performance_schema</p><p>这个数据库里主要保存MySQL服务器运行过程中的一些状态信息，包括统计最近执行的语句，执行时间，内存使用情况等</p></li><li><p>sys</p><p>这个数据库主要是通过视图的形式把information_schema和performance_schema结合起来</p></li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;link rel=&quot;stylesheet&quot; class=&quot;aplayer-secondary-style-marker&quot; href=&quot;/assets/css/APlayer.min.css&quot;&gt;&lt;script src=&quot;/assets/js/APlayer.min.js&quot; cla
      
    
    </summary>
    
    
      <category term="MySQL, 长文" scheme="https://hejtao.netlify.com/tags/MySQL-%E9%95%BF%E6%96%87/"/>
    
  </entry>
  
  <entry>
    <title>SQL Notes</title>
    <link href="https://hejtao.netlify.com/2019/09/05/2019-9-5/"/>
    <id>https://hejtao.netlify.com/2019/09/05/2019-9-5/</id>
    <published>2019-09-04T16:00:00.000Z</published>
    <updated>2019-11-11T19:59:33.205Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><meta name="referrer" content="no-referrer"><div class="toc"><!-- toc --><ul><li><a href="#lian-biao-cha-xun">联表查询</a></li><li><a href="#zi-fu-ti-huan">字符替换</a></li><li><a href="#zheng-ze-cha-xun">正则查询</a></li><li><a href="#dao-ru-sql-wen-jian">导入SQL文件</a></li><li><a href="#pai-xu">排序</a></li></ul><!-- tocstop --></div><h4><span id="lian-biao-cha-xun">联表查询</span><a href="#lian-biao-cha-xun" class="header-anchor">#</a></h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> library.id, library.name, r.reader_sum, b.book_sum <span class="keyword">FROM</span> </span><br><span class="line"><span class="keyword">library</span> </span><br><span class="line"><span class="keyword">INNER</span> <span class="keyword">JOIN</span></span><br><span class="line">( <span class="keyword">SELECT</span> library_id, <span class="keyword">count</span>(*) <span class="keyword">AS</span> reader_sum <span class="keyword">FROM</span> reader <span class="keyword">WHERE</span> library_group_id = <span class="number">10</span> <span class="keyword">GROUP</span> <span class="keyword">BY</span> library_id ) <span class="keyword">AS</span> r</span><br><span class="line"><span class="keyword">ON</span> r.library_id = library.id </span><br><span class="line"><span class="keyword">INNER</span> <span class="keyword">JOIN</span></span><br><span class="line">( <span class="keyword">SELECT</span> library_id, <span class="keyword">count</span>( * ) <span class="keyword">AS</span> book_sum <span class="keyword">FROM</span> book <span class="keyword">WHERE</span> library_group_id = <span class="number">10</span> <span class="keyword">GROUP</span> <span class="keyword">BY</span> library_id ) <span class="keyword">AS</span> b</span><br><span class="line"><span class="keyword">ON</span> b.library_id = library.id;</span><br></pre></td></tr></table></figure><h4><span id="zi-fu-ti-huan">字符替换</span><a href="#zi-fu-ti-huan" class="header-anchor">#</a></h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">UPDATE</span> <span class="keyword">account</span> <span class="keyword">SET</span> grade = <span class="keyword">replace</span>(grade,<span class="string">'級'</span>,<span class="string">'级'</span>);</span><br></pre></td></tr></table></figure><h4><span id="zheng-ze-cha-xun">正则查询</span><a href="#zheng-ze-cha-xun" class="header-anchor">#</a></h4><p><img src="https://upload-images.jianshu.io/upload_images/1863961-2bcf89b08ee87c02.PNG?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt=""></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> <span class="keyword">account</span> <span class="keyword">WHERE</span> grade REGEXP <span class="string">'級'</span>; <span class="comment">-- 查询包含</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="keyword">name</span> <span class="keyword">FROM</span> person <span class="keyword">WHERE</span> <span class="keyword">name</span> REGEXP <span class="string">'^[aeiou]|ok$'</span>; <span class="comment">-- aeiou开头，或ok结尾</span></span><br></pre></td></tr></table></figure><h4><span id="dao-ru-sql-wen-jian">导入SQL文件</span><a href="#dao-ru-sql-wen-jian" class="header-anchor">#</a></h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SET</span> @@global.max_allowed_packet = <span class="number">1024</span>*<span class="number">1024</span>*<span class="number">1024</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">SET</span> @@global.sql_mode =<span class="string">'ONLY_FULL_GROUP_BY,STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION'</span>;</span><br><span class="line"><span class="keyword">SET</span> @@sql_mode =<span class="string">'ONLY_FULL_GROUP_BY,STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION'</span>;</span><br></pre></td></tr></table></figure><h4><span id="pai-xu">排序</span><a href="#pai-xu" class="header-anchor">#</a></h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> book <span class="keyword">WHERE</span> library_id = <span class="number">257</span> <span class="keyword">AND</span> (title REGEXP <span class="string">"我"</span> <span class="keyword">OR</span> author REGEXP <span class="string">"我"</span>) <span class="keyword">ORDER</span> <span class="keyword">BY</span> <span class="keyword">LOCATE</span>(<span class="string">"我"</span>, <span class="keyword">CONCAT</span>(title, author)), <span class="keyword">LENGTH</span>(title), <span class="keyword">LENGTH</span>(author);</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;link rel=&quot;stylesheet&quot; class=&quot;aplayer-secondary-style-marker&quot; href=&quot;/assets/css/APlayer.min.css&quot;&gt;&lt;script src=&quot;/assets/js/APlayer.min.js&quot; cla
      
    
    </summary>
    
    
      <category term="SQL" scheme="https://hejtao.netlify.com/tags/SQL/"/>
    
  </entry>
  
  <entry>
    <title>麻省理工 MapReduce 实验</title>
    <link href="https://hejtao.netlify.com/2019/04/30/2019-4-30/"/>
    <id>https://hejtao.netlify.com/2019/04/30/2019-4-30/</id>
    <published>2019-04-29T16:00:00.000Z</published>
    <updated>2019-11-11T19:59:33.204Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><meta name="referrer" content="no-referrer"><div class="toc"><!-- toc --><ul><li><a href="#mapreduce-zhi-xing-gai-shu">MapReduce执行概述</a></li><li><a href="#xu-yan-shou-xi-yuan-dai-ma">序言：熟悉源代码</a></li><li><a href="#part-i-map-reduce-shu-ru-he-shu-chu">Part I: Map/Reduce 输入和输出</a></li><li><a href="#part-ii-single-worker-dan-ci-tong-ji">Part II: Single-worker单词统计</a></li><li><a href="#part-iii-fen-bu-shi-mapreduce-ren-wu">Part III: 分布式 MapReduce 任务</a></li><li><a href="#part-iv-worker-cuo-wu-chu-li">Part IV: worker错误处理</a></li></ul><!-- tocstop --></div><p><a href="http://nil.csail.mit.edu/6.824/2018/labs/lab-1.html" target="_blank" rel="noopener">原文链接</a></p><h3><span id="mapreduce-zhi-xing-gai-shu">MapReduce执行概述</span><a href="#mapreduce-zhi-xing-gai-shu" class="header-anchor">#</a></h3><p><a href="http://nil.csail.mit.edu/6.824/2018/papers/mapreduce.pdf" target="_blank" rel="noopener">论文地址</a><img src="https://upload-images.jianshu.io/upload_images/1863961-e3049b9f4645a329.PNG?imageMogr2/auto-orient/strip%7CimageView2/2/w/840" alt=""></p><p>通过自动将输入数据划分为$M$个片段，Map调用分布在多台机器上。 不同片段的输入数据可以由不同的机器并行处理。 Reduce调用的分布式则通过使用分区函数(即 $hash(key)$  $mod$  $R$)将键空间划分为$R$个部分来实现，$R$的大小和分区函数由用户指定。上图显示了MapReduce操作的总体流程。 当用户程序调用MapReduce函数时，会发生以下操作序列(图中的编号标签对应于下面的数字)：</p><ol><li>用户程序中的MapReduce库首先将输入文件拆分为16MB到64MB(用户可通过参数设置)的$M$个片段。 然后，它会在一组计算机上启动该程序的许多副本；</li><li>master为副本之一，其余的是由master分配工作的workers。 有$M$个Map任务和$R$个Reduce任务需要分配。master为每个空闲的worker分配一个Map任务或Reduce任务；</li><li>被分配Map任务的worker读取相应输入片段。 它从输入片段中解析键/值对，并将键/值对传递给用户定义的Map函数。 Map函数生成的中间键/值对缓存在内存中；</li><li>内存中的键\值对被周期性地写入到本地磁盘，并通过分区函数划分为$R$个分区。 键\值对在本地磁盘的位置将被传回到master，master再将位置信息转发给Reduce worker；</li><li>当Reduce worker收到来自master的位置信息后，它使用远程过程调用(RPC)从Map worker的本地磁盘读取缓冲数据。 当Reduce worker读取了所有中间数据时，它会根据中间键进行排序，以便将所有相同的中间键组合在一起。 之所以需要排序是因为通常有许多不同的键映射到同一个reduce任务。 如果中间数据量太大而无法容纳在内存中，则使用外部排序；</li><li>Reduce worker对排好序的中间数据进行遍历。对遇到的每个唯一中间键，它将键和相应的一组中间值传递给用户的Reduce函数。 Reduce函数的输出附加到此Reduce分区的最终输出文件。</li><li>完成所有Map任务和Reduce任务后，master会唤醒用户程序。 此时，用户程序中的MapReduce()将返回用户代码。</li></ol><h3><span id="xu-yan-shou-xi-yuan-dai-ma">序言：熟悉源代码</span><a href="#xu-yan-shou-xi-yuan-dai-ma" class="header-anchor">#</a></h3><p>提供的Map/Reduce代码支持两种操作模式，即串行和分布式。 在前者中，map和reduce任务每次执行一个：首先是第一个map任务执行完成，然后是第二个，然后是第三个，等等。当所有map任务完成后，执行第一个reduce任务，然后是第二个，等等。这种模式虽然不快，但方便调试。 分布式模式运行着许多worker线程，这些线程先并行执行map任务，然后reduce任务。 这要快得多，但也难以调试。mapreduce包提供了一个简单的Map/Reduce库。 应用程序通常调用<code>master.go</code>中的<code>Distributed()</code>来启动分布式模式，而调用<code>master.go</code>中的<code>Sequential()</code>来获取调试的串行执行。</p><p>代码如下执行：</p><ol><li>该应用程序提供了许多输入文件、一个<strong>map函数</strong>、一个<strong>reduce函数</strong>和<strong>reduce任务的数量</strong>（$nReduce$）；</li><li>创建master。 master启动一个RPC服务器(参见<code>master_rpc.go</code>)，并等待worker注册(使用RPC调用<code>Register()</code>，在<code>master.go</code>中定义)。 当任务变得可用时(在步骤4和5中)，<code>schedule()</code>(位于schedule.go)决定如何将这些任务分配给workers以及如何处理worker故障；</li><li>master将每个输入文件视为一个  Map任务，并为每个Map任务至少调用一次(at-least-once)<code>doMap()</code>(<code>common_map.go</code>)，可以通过直接使用<code>Sequential()</code>或通过向worker (<code>worker.go</code>)发出DoTask RPC来实现。每次调用<code>doMap()</code>都会读取适当的文件，调用该文件中的map函数，并将生成的键/值对写入$nReduce$个中间文件。doMap() 对每个键哈希化以便挑选中间文件和 将会处理键的reduce任务。 完成所有map任务后，将会有$nMap \times nReduce$个文件。 每个文件名都包含一个前缀，map任务编号和reduce任务编号。 如果有两个map任务和三个reduce任务，map任务将创建如下六个中间文件：<code>mrtmp.xxx-0-0</code><code>mrtmp.xxx-0-1</code><code>mrtmp.xxx-0-2</code><code>mrtmp.xxx-1-0</code><code>mrtmp.xxx-1-1</code><code>mrtmp.xxx-1-2</code>每个worker必须能够读取由任何其他worker写入的文件以及输入文件。 现实部署利用分布式存储系统(如GFS)来允许此读取，即使workers在不同的计算机上运行。 在本实验中，您将在同一台计算机上运行所有workers，并使用本地文件系统；</li><li>接下来master为每个reduce任务至少调用一次(at-least-once) <code>doReduce()</code>(<code>common_reduce.go</code>)。 与<code>doMap()</code>一样，可以直接或通过worker来完成。 用于reduce任务r的`doReduce()从每个map任务中收集第$r$个中间文件，并为这些文件中出现的每个键调用reduce函数。 reduce任务生成$nReduce$个结果文件；</li><li>master调用<code>mr.merge()</code>(<code>master_splitmerge.go</code>)，将上一步生成的所有$nReduce$个文件合并为单个输出；</li><li>master向每个woker发送Shutdown RPC，然后关闭自己的RPC服务器。</li></ol><blockquote><p>说明：在后续的练习中，您必须编写/修改<code>doMap()</code>，<code>doReduce()</code>和<code>schedule()</code>，它们分别位于<code>common_map.go</code>、<code>common_reduce.go</code>和<code>schedule.go</code>中。 您还必须在<code>../main/wc.go</code>中编写map函数和reduce函数。</p></blockquote><h3><span id="part-i-map-reduce-shu-ru-he-shu-chu">Part I: Map/Reduce 输入和输出</span><a href="#part-i-map-reduce-shu-ru-he-shu-chu" class="header-anchor">#</a></h3><p>提供的Map/Reduce实现缺少部分代码。 在编写第一个Map/Reduce函数对之前，您需要修改sequential的实现代码。 特别是，提供的代码缺少两个关键部分：分配一个map任务输出的函数，以及收集一个reduce任务所有输入的函数。 这些任务分别由<code>common_map.go</code>中的<code>doMap()</code>函数和<code>common_reduce.go</code>中的<code>doReduce()</code>函数执行。</p><p>为了帮助您确定是否正确实现了<code>doMap()</code>和<code>doReduce()</code>，我们为您提供了一个Go测试套件(<code>test_test.go</code>)用于检查文件中实现。 例如测试修改后的sequence实现代码，请运行：<code>go test -run Sequential</code>or<code>go test -v -run Sequential</code></p><p><strong>解答：</strong>该部分任务只需要补全<code>common_map.go</code>中的<code>doMap()</code>和<code>common_reduce.go</code>中的<code>doReduce()</code>的代码，补全的结果如下：</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> mapreduce</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">"hash/fnv"</span></span><br><span class="line"><span class="string">"io/ioutil"</span></span><br><span class="line"><span class="string">"encoding/json"</span></span><br><span class="line"><span class="string">"log"</span></span><br><span class="line"><span class="string">"os"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">doMap</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">jobName <span class="keyword">string</span>, // the name of the MapReduce job</span></span></span><br><span class="line"><span class="function"><span class="params">mapTask <span class="keyword">int</span>, // which <span class="keyword">map</span> task this is</span></span></span><br><span class="line"><span class="function"><span class="params">inFile <span class="keyword">string</span>,</span></span></span><br><span class="line">nReduce int, // the number of reduce task that will be run ("R" in the paper)</span><br><span class="line">mapF <span class="function"><span class="keyword">func</span>(<span class="params">filename <span class="keyword">string</span>, content <span class="keyword">string</span></span>) []<span class="title">KeyValue</span>,</span></span><br><span class="line"><span class="function">)</span> &#123;</span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// doMap manages one map task: it should read one of the input files</span></span><br><span class="line"><span class="comment">// (inFile), call the user-defined map function (mapF) for that file's</span></span><br><span class="line"><span class="comment">// content, and partition mapF's output into nReduce intermediate files.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// There is one intermediate file per reduce task. The file name</span></span><br><span class="line"><span class="comment">// includes both the map task number and the reduce task number. Use</span></span><br><span class="line"><span class="comment">// the filename generated by reduceName(jobName, mapTask, r)</span></span><br><span class="line"><span class="comment">// as the intermediate file for reduce task r. Call ihash() (see</span></span><br><span class="line"><span class="comment">// below) on each key, mod nReduce, to pick r for a key/value pair.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// mapF() is the map function provided by the application. The first</span></span><br><span class="line"><span class="comment">// argument should be the input file name, though the map function</span></span><br><span class="line"><span class="comment">// typically ignores it. The second argument should be the entire</span></span><br><span class="line"><span class="comment">// input file content. mapF() returns a slice containing the</span></span><br><span class="line"><span class="comment">// key/value pairs for reduce; see common.go for the definition of</span></span><br><span class="line"><span class="comment">// KeyValue.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Look at Go's ioutil and os packages for functions to read</span></span><br><span class="line"><span class="comment">// and write files.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Coming up with a scheme for how to format the key/value pairs on</span></span><br><span class="line"><span class="comment">// disk can be tricky, especially when taking into account that both</span></span><br><span class="line"><span class="comment">// keys and values could contain newlines, quotes, and any other</span></span><br><span class="line"><span class="comment">// character you can think of.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// One format often used for serializing data to a byte stream that the</span></span><br><span class="line"><span class="comment">// other end can correctly reconstruct is JSON. You are not required to</span></span><br><span class="line"><span class="comment">// use JSON, but as the output of the reduce tasks *must* be JSON,</span></span><br><span class="line"><span class="comment">// familiarizing yourself with it here may prove useful. You can write</span></span><br><span class="line"><span class="comment">// out a data structure as a JSON string to a file using the commented</span></span><br><span class="line"><span class="comment">// code below. The corresponding decoding functions can be found in</span></span><br><span class="line"><span class="comment">// common_reduce.go.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//   enc := json.NewEncoder(file)</span></span><br><span class="line"><span class="comment">//   for _, kv := ... &#123;</span></span><br><span class="line"><span class="comment">//     err := enc.Encode(&amp;kv)</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Remember to close the file after you have written all the values!</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Your code here (Part I).</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//读取输入文件</span></span><br><span class="line">content, err := ioutil.ReadFile(inFile)  </span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Fatal(<span class="string">"doMap读取输入文件错误"</span>,err)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//map操作</span></span><br><span class="line">kvPairs := mapF(inFile, <span class="keyword">string</span>(content))  <span class="comment">//调用mapF，返回键值对</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//将键值对写入到中间文件</span></span><br><span class="line">tmpFiles := <span class="built_in">make</span>([] *os.File, nReduce)  <span class="comment">//R个中间文件</span></span><br><span class="line">encoders := <span class="built_in">make</span>([] *json.Encoder, nReduce)</span><br><span class="line"><span class="keyword">for</span> i := <span class="number">0</span>; i &lt; nReduce; i++ &#123;</span><br><span class="line">tmpFileName := reduceName(jobName, mapTask, i)  <span class="comment">//中间文件名,mrtmp.test-mapTask-i</span></span><br><span class="line"></span><br><span class="line">tmpFiles[i], err = os.Create(tmpFileName)  <span class="comment">//创建中间文件mrtmp.test-mapTask-i</span></span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Fatal(<span class="string">"doMap生成中间文件错误"</span>, err)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">defer</span> tmpFiles[i].Close()</span><br><span class="line"></span><br><span class="line">encoders[i] = json.NewEncoder(tmpFiles[i])</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Fatal(<span class="string">"doMap编码错误"</span>, err)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> _ , kv := <span class="keyword">range</span> kvPairs &#123;</span><br><span class="line">hashKey := ihash(kv.Key) % nReduce  <span class="comment">//根据键将键值对分成R组</span></span><br><span class="line"></span><br><span class="line">err := encoders[hashKey].Encode(&amp;kv)  <span class="comment">//将R个键值对写入R个中间文件</span></span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Fatal(<span class="string">"doMap编码错误"</span>, err)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">ihash</span>(<span class="params">s <span class="keyword">string</span></span>) <span class="title">int</span></span> &#123;</span><br><span class="line">h := fnv.New32a()</span><br><span class="line">h.Write([]<span class="keyword">byte</span>(s))</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">int</span>(h.Sum32() &amp; <span class="number">0x7fffffff</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> mapreduce</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">"encoding/json"</span></span><br><span class="line"><span class="string">"log"</span></span><br><span class="line"><span class="string">"os"</span></span><br><span class="line"><span class="string">"sort"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">doReduce</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">jobName <span class="keyword">string</span>, // the name of the whole MapReduce job</span></span></span><br><span class="line"><span class="function"><span class="params">reduceTask <span class="keyword">int</span>, // which reduce task this is</span></span></span><br><span class="line"><span class="function"><span class="params">outFile <span class="keyword">string</span>, // write the output here</span></span></span><br><span class="line">nMap int, // the number of map tasks that were run ("M" in the paper)</span><br><span class="line">reduceF <span class="function"><span class="keyword">func</span>(<span class="params">key <span class="keyword">string</span>, values []<span class="keyword">string</span></span>) <span class="title">string</span>,</span></span><br><span class="line"><span class="function">)</span> &#123;</span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// doReduce manages one reduce task: it should read the intermediate</span></span><br><span class="line"><span class="comment">// files for the task, sort the intermediate key/value pairs by key,</span></span><br><span class="line"><span class="comment">// call the user-defined reduce function (reduceF) for each key, and</span></span><br><span class="line"><span class="comment">// write reduceF's output to disk.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// You'll need to read one intermediate file from each map task;</span></span><br><span class="line"><span class="comment">// reduceName(jobName, m, reduceTask) yields the file</span></span><br><span class="line"><span class="comment">// name from map task m.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Your doMap() encoded the key/value pairs in the intermediate</span></span><br><span class="line"><span class="comment">// files, so you will need to decode them. If you used JSON, you can</span></span><br><span class="line"><span class="comment">// read and decode by creating a decoder and repeatedly calling</span></span><br><span class="line"><span class="comment">// .Decode(&amp;kv) on it until it returns an error.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// You may find the first example in the golang sort package</span></span><br><span class="line"><span class="comment">// documentation useful.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// reduceF() is the application's reduce function. You should</span></span><br><span class="line"><span class="comment">// call it once per distinct key, with a slice of all the values</span></span><br><span class="line"><span class="comment">// for that key. reduceF() returns the reduced value for that key.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// You should write the reduce output as JSON encoded KeyValue</span></span><br><span class="line"><span class="comment">// objects to the file named outFile. We require you to use JSON</span></span><br><span class="line"><span class="comment">// because that is what the merger than combines the output</span></span><br><span class="line"><span class="comment">// from all the reduce tasks expects. There is nothing special about</span></span><br><span class="line"><span class="comment">// JSON -- it is just the marshalling format we chose to use. Your</span></span><br><span class="line"><span class="comment">// output code will look something like this:</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// enc := json.NewEncoder(file)</span></span><br><span class="line"><span class="comment">// for key := ... &#123;</span></span><br><span class="line"><span class="comment">// enc.Encode(KeyValue&#123;key, reduceF(...)&#125;)</span></span><br><span class="line"><span class="comment">// &#125;</span></span><br><span class="line"><span class="comment">// file.Close()</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Your code here (Part I).</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//遍历属于自己的中间文件，将键值对合并到kvs中</span></span><br><span class="line">kvs := <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="keyword">string</span>][]<span class="keyword">string</span>)</span><br><span class="line"><span class="keyword">for</span> i := <span class="number">0</span>; i &lt; nMap; i++ &#123;</span><br><span class="line">fileName := reduceName(jobName, i, reduceTask)</span><br><span class="line"></span><br><span class="line">file, err := os.Open(fileName)  <span class="comment">//打开中间文件mrtmp.test-i-reduceTask</span></span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Fatal(<span class="string">"doReduce打开文件错误"</span>, err)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">dec := json.NewDecoder(file)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> &#123;  <span class="comment">//每个中间文件可能包含多个键值对</span></span><br><span class="line"><span class="keyword">var</span> kv KeyValue</span><br><span class="line">err = dec.Decode(&amp;kv)  <span class="comment">//解码一个键值对</span></span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">break</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">_, ok := kvs[kv.Key]</span><br><span class="line"><span class="keyword">if</span> !ok &#123;  <span class="comment">//出现新的键则初始化kvs</span></span><br><span class="line">kvs[kv.Key] = []<span class="keyword">string</span>&#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line">kvs[kv.Key] = <span class="built_in">append</span>(kvs[kv.Key], kv.Value)  <span class="comment">//加入与键对应的值</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">file.Close()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//将键集合到一起并排序</span></span><br><span class="line"><span class="keyword">var</span> keys []<span class="keyword">string</span>  </span><br><span class="line"><span class="keyword">for</span> k := <span class="keyword">range</span> kvs &#123;</span><br><span class="line">keys = <span class="built_in">append</span>(keys, k)</span><br><span class="line">&#125;</span><br><span class="line">sort.Strings(keys)</span><br><span class="line"></span><br><span class="line"><span class="comment">//创建输出文件</span></span><br><span class="line">out := mergeName(jobName, reduceTask)  </span><br><span class="line">file, err := os.Create(out)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Fatal(<span class="string">"doReduce创建输出文件错误"</span>, err)</span><br><span class="line">&#125;</span><br><span class="line">enc := json.NewEncoder(file)</span><br><span class="line"></span><br><span class="line"><span class="comment">//reduce操作</span></span><br><span class="line"><span class="keyword">for</span> _, k := <span class="keyword">range</span> keys &#123;</span><br><span class="line">res := reduceF(k, kvs[k])  <span class="comment">//调用客户端的reduceF，进行reduce</span></span><br><span class="line">enc.Encode(KeyValue&#123;k, res&#125;)  <span class="comment">//reduce后的键值对写入到输出文件</span></span><br><span class="line">&#125;</span><br><span class="line">file.Close()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>运行<code>go test -run Sequential</code>，结果如下： <img src="https://upload-images.jianshu.io/upload_images/1863961-b5960850942d11a2.PNG?imageMogr2/auto-orient/strip%7CimageView2/2/w/640" alt=""></p><h3><span id="part-ii-single-worker-dan-ci-tong-ji">Part II: Single-worker单词统计</span><a href="#part-ii-single-worker-dan-ci-tong-ji" class="header-anchor">#</a></h3><p>在该部分，您将要实现一个简单的Map/Reduce示例——单词统计。 具体是需要实现<code>main/wc.go</code>中的<code>mapF()</code>和<code>reduceF()</code>函数。 您的工作是插入代码，以便<code>wc.go</code>返回输入文件中每个单词出现的次数。 一个单词是任意连续的字母序列，其中字母可用Golang的<a href="https://golang.org/pkg/unicode/#IsLetter" target="_blank" rel="noopener">unicode.IsLetter</a>函数来判断。</p><p>在<code>~/6.824/src/main</code>目录中提供了一些路径名为<code>pg-*.txt</code>形式的输入文件， 可用如下命令给<code>wc.go</code>使用输入文件运行：<code>go run wc.go master sequential pg-*.txt</code></p><p>查看MapReduce论文的第2部分。<code>mapF()</code>和<code>reduceF()</code>函数与论文第2.1节中的函数略有不同。<code>mapF()</code>将接收一个文件名和该文件的内容，并将内容分成单词最终输出一个<code>mapreduce.KeyValue</code>型切片。 对于单词统计可将单词作为键。对输出中的每个键都将调用一次<code>reduceF()</code>，其中包含<code>mapF()</code>为该键生成的所有值的切片。 <code>reduceF()</code>返回一个包含键出现总数的字符串。</p><blockquote><p>提示1：关于Go的字符串处理，可以参读 <a href="http://blog.golang.org/strings" target="_blank" rel="noopener">Go Blog on strings</a>提示2：可以使用<a href="https://golang.org/pkg/strings/#FieldsFunc" target="_blank" rel="noopener">strings.FieldsFunc</a>函数将字符串拆分成单词提示3： 利用Go的<a href="https://golang.org/pkg/strconv/" target="_blank" rel="noopener">strconv</a>包可以很方便地将字符串转换成整型</p></blockquote><p>使用如下命令来验证答案：<code>go run wc.go master sequential pg-*.txt</code></p><p><strong>答案：</strong></p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">"fmt"</span></span><br><span class="line"><span class="string">"mapreduce"</span></span><br><span class="line"><span class="string">"os"</span></span><br><span class="line"><span class="string">"strconv"</span></span><br><span class="line"><span class="string">"strings"</span></span><br><span class="line"><span class="string">"unicode"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// The map function is called once for each file of input. The first</span></span><br><span class="line"><span class="comment">// argument is the name of the input file, and the second is the</span></span><br><span class="line"><span class="comment">// file's complete contents. You should ignore the input file name,</span></span><br><span class="line"><span class="comment">// and look only at the contents argument. The return value is a slice</span></span><br><span class="line"><span class="comment">// of key/value pairs.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">mapF</span>(<span class="params">filename <span class="keyword">string</span>, contents <span class="keyword">string</span></span>) []<span class="title">mapreduce</span>.<span class="title">KeyValue</span></span> &#123;</span><br><span class="line"><span class="comment">// Your code here (Part II).</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> res []mapreduce.KeyValue</span><br><span class="line"></span><br><span class="line">f := <span class="function"><span class="keyword">func</span>(<span class="params">c <span class="keyword">rune</span></span>) <span class="title">bool</span></span> &#123; <span class="comment">//不是字母</span></span><br><span class="line"><span class="keyword">return</span> !unicode.IsLetter(c)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">words := strings.FieldsFunc(contents, f) <span class="comment">//在不是字母地方拆分字符串contents</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> _, key := <span class="keyword">range</span> words &#123;</span><br><span class="line">res = <span class="built_in">append</span>(res, mapreduce.KeyValue&#123;key, <span class="string">"1"</span>&#125;)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> res</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// The reduce function is called once for each key generated by the</span></span><br><span class="line"><span class="comment">// map tasks, with a list of all the values created for that key by</span></span><br><span class="line"><span class="comment">// any map task.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">reduceF</span>(<span class="params">key <span class="keyword">string</span>, values []<span class="keyword">string</span></span>) <span class="title">string</span></span> &#123;</span><br><span class="line"><span class="comment">// Your code here (Part II).</span></span><br><span class="line"></span><br><span class="line">count := <span class="number">0</span></span><br><span class="line"><span class="keyword">for</span> _, value := <span class="keyword">range</span> values &#123;</span><br><span class="line">num, _ := strconv.ParseInt(value, <span class="number">10</span>, <span class="number">64</span>) <span class="comment">// 将字符串value（例如："157"）按照十进制转换成整型</span></span><br><span class="line">count = count + <span class="keyword">int</span>(num)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> strconv.Itoa(count) <span class="comment">//整型转换成字符串</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Can be run in 3 ways:</span></span><br><span class="line"><span class="comment">// 1) Sequential (e.g., go run wc.go master sequential x1.txt .. xN.txt)</span></span><br><span class="line"><span class="comment">// 2) Master (e.g., go run wc.go master localhost:7777 x1.txt .. xN.txt)</span></span><br><span class="line"><span class="comment">// 3) Worker (e.g., go run wc.go worker localhost:7777 localhost:7778 &amp;)</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line"><span class="keyword">if</span> <span class="built_in">len</span>(os.Args) &lt; <span class="number">4</span> &#123;</span><br><span class="line">fmt.Printf(<span class="string">"%s: see usage comments in file\n"</span>, os.Args[<span class="number">0</span>])</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> os.Args[<span class="number">1</span>] == <span class="string">"master"</span> &#123;</span><br><span class="line"><span class="keyword">var</span> mr *mapreduce.Master</span><br><span class="line"><span class="keyword">if</span> os.Args[<span class="number">2</span>] == <span class="string">"sequential"</span> &#123;</span><br><span class="line">mr = mapreduce.Sequential(<span class="string">"wcseq"</span>, os.Args[<span class="number">3</span>:], <span class="number">3</span>, mapF, reduceF)</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">mr = mapreduce.Distributed(<span class="string">"wcseq"</span>, os.Args[<span class="number">3</span>:], <span class="number">3</span>, os.Args[<span class="number">2</span>])</span><br><span class="line">&#125;</span><br><span class="line">mr.Wait()</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">mapreduce.RunWorker(os.Args[<span class="number">2</span>], os.Args[<span class="number">3</span>], mapF, reduceF, <span class="number">100</span>, <span class="literal">nil</span>)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>运行<code>go run wc.go master sequential pg-sherlock_holmes.txt</code>和<code>sort -n -k2 mrtmp.wcseq | tail -10</code>的结果： <img src="https://upload-images.jianshu.io/upload_images/1863961-2d925a0b957652b7.PNG?imageMogr2/auto-orient/strip%7CimageView2/2/w/640" alt=""></p><h3><span id="part-iii-fen-bu-shi-mapreduce-ren-wu">Part III: 分布式 MapReduce 任务</span><a href="#part-iii-fen-bu-shi-mapreduce-ren-wu" class="header-anchor">#</a></h3><p>在当前的实现中，是通过串行的方式来执行Map任务和Reduce任务。 Map/Reduce最大的卖点之一是它可以自动地并行执行原始的串行代码而无需开发人员的任何额外工作。 在这一部分中，您将完成一个分布式MapReduce版本，即将工作拆分为在多核上运行的一组worker线程。 尽管不像真实的Map/Reduce部署被分布在多台机器上那样，但你本部分的实现中将使用RPC来模拟分布式计算。</p><p><code>mapreduce/master.go</code>中的代码完成了管理MapReduce的大部分工作。 我们还为您提供了<code>mapreduce/worker.go</code>中worker线程的完整代码以及在<code>mapreduce/common_rpc.go</code>中处理RPC的一些代码。</p><p><strong>你的任务是实现<code>mapreduce/schedule.go</code>中的<code>schedule()</code>函数</strong>。 master在MapReduce期间将两次调用<code>schedule()</code>，一次用于Map阶段，一次用于Reduce阶段。 <code>schedule()</code>的功能是将任务分发给可用的worker。 任务的数量通常比worker线程多，因此<code>schedule()</code>必须为每个worker分配一系列任务，一次一个。 <code>schedule()</code>应该等到所有任务都完成后再返回。</p><p><code>schedule()</code>通过读取<code>registerChan</code>参数来了解一组worker。 该channel为每个worker生成一个包含worker的RPC地址的字符串。所有的worker都会出现在registerChan，其中一些worker可能在调用<code>schedule()</code>之前就存在，而另一些worker可能在<code>schedule()</code>运行时才启动。<code>schedule()</code>应该充分利用所有的worker，包括启动后出现的worker。</p><p><code>schedule()</code>通过向worker发送<code>Worker.DoTask</code>RPC来通知worker执行任务。 此RPC的参数由<code>mapreduce/common_rpc.go</code>中的<code>DoTaskArgs</code>定义。<code>File</code>元素仅由Map任务使用，代表要读取的文件的名称；<code>schedule()</code>可以在<code>mapFiles</code>中找到这些文件名。</p><p>使用<code>mapreduce/common_rpc.go</code>中的<code>call()</code>函数将RPC发送给worker。 第一个参数是worker的地址，从<code>registerChan</code>读取，第二个参数是<code>Worker.DoTask</code>， 第三个参数是<code>DoTaskArgs</code>结构，最后一个参数是<code>nil</code>。</p><p>您对在第III部分的解答仅涉及对<code>schedule.go</code>的修改；如果您在调试过程中修改了其他文件，请恢复其原始内容。请先测试再提交。</p><p>使用<code>go test -run TestParallel</code>来测试您的答案。 该命令将执行两个测试，<code>TestParallelBasic</code>和<code>TestParallelCheck</code>，后者验证您的<code>schedule()</code>是否使worker并行执行任务。</p><blockquote><p>提示1：<code>schedule()</code>应该并行地向worker发送RPC，以便worker可以并发执行任务。 你会发现go语句对此很有用，参见<a href="http://golang.org/doc/effective_go.html#concurrency" target="_blank" rel="noopener">Concurrency in Go</a>。提示2：<code>schedule()</code>必须等待worker完成一个任务后才能给它另下一个任务，Go的channel对此很有用。提示3： <a href="https://golang.org/pkg/sync/#WaitGroup" target="_blank" rel="noopener">sync.WaitGroup</a>提示4：追踪错误的最简单的方法是插入print语句（在common.go中可能是调用<code>debug()</code>），使用<code>go test -run TestParallel &gt; out</code>将输出收集到一个文件中，然后分析输出是否与你对代码的预期相符。 最后一步是最重要的。提示5：检查您的代码是否有竞争的情况可在测试中运行<a href="https://golang.org/doc/articles/race_detector.html" target="_blank" rel="noopener">race detector</a>。</p></blockquote><blockquote><p>注意：我们提供的代码是在单个UNIX进程中将worker作为线程运行，并且可以在单台机器上使用多核。 要想在使用网络进行通信的多台机器上运行worker必须进行一些修改：RPC必须使用TCP而不是UNIX-domain套接字；需要有一种方法来启动所有机器上的worker进程；所有的机器都必须通过某种网络文件系统共享存储。</p></blockquote><p><strong>答案</strong>见Part IV。</p><h3><span id="part-iv-worker-cuo-wu-chu-li">Part IV: worker错误处理</span><a href="#part-iv-worker-cuo-wu-chu-li" class="header-anchor">#</a></h3><p>在这部分中，您将实现master处理失败的worker的功能。由于worker的状态不是持久的，该功能在MapReduce中相对容易实现。 如果worker在处理来自master的RPC时发生错误，master的<code>call()</code>最终会因超时而返回<code>false</code>。在这种情况下，master会将该任务重新分配给另一个worker。</p><p>RPC故障并不一定意味着worker没有执行任务；worker可能已执行任务但是返回结果丢失，或者worker可能仍在执行但master的RPC超时。因此，可能会发生两个worker接收相同任务、计算并产生输出的情况。 需要对map或reduce函数进行两次调用才能为给定输入生成相同的输出，因此如果后续处理读取一个输出或者读取另一个输出，则不会出现不一致。 此外，MapReduce框架确保map和reduce函数输出以原子方式出现：输出文件要么不存在，要么包含单个map或单个reduce函数执行的整个输出（提供的代码不涉及这部分）。</p><p>您的实现必须通过<code>test_test.go</code>中剩下的两个测试用例。 第一个用例测试一个worker的失败，而第二个测试用例测试对多个worker的失败的处理。 测试用例会定期启动新的worker，master可以使用这些worker来推进程序过程，但这些worker在处理完一些任务后会失败。 使用下面的命令来运行测试：<code>go test -run Failure</code></p><p>在第IV部分，只涉及对<code>schedule.go</code>的修改。 如果您在调试过程中修改了其他文件，请恢复其原始内容，然后再进行测试、提交。</p><p>Part III、Part IV<strong>答案：</strong></p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> mapreduce</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">"fmt"</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// schedule() starts and waits for all tasks in the given phase (mapPhase</span></span><br><span class="line"><span class="comment">// or reducePhase). the mapFiles argument holds the names of the files that</span></span><br><span class="line"><span class="comment">// are the inputs to the map phase, one per map task. nReduce is the</span></span><br><span class="line"><span class="comment">// number of reduce tasks. the registerChan argument yields a stream</span></span><br><span class="line"><span class="comment">// of registered workers; each item is the worker's RPC address,</span></span><br><span class="line"><span class="comment">// suitable for passing to call(). registerChan will yield all</span></span><br><span class="line"><span class="comment">// existing registered workers (if any) and new ones as they register.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">schedule</span>(<span class="params">jobName <span class="keyword">string</span>, mapFiles []<span class="keyword">string</span>, nReduce <span class="keyword">int</span>, phase jobPhase, registerChan <span class="keyword">chan</span> <span class="keyword">string</span></span>)</span> &#123;</span><br><span class="line"><span class="keyword">var</span> ntasks <span class="keyword">int</span></span><br><span class="line"><span class="keyword">var</span> n_other <span class="keyword">int</span> <span class="comment">// number of inputs (for reduce) or outputs (for map)</span></span><br><span class="line"><span class="keyword">switch</span> phase &#123;</span><br><span class="line"><span class="keyword">case</span> mapPhase:</span><br><span class="line">ntasks = <span class="built_in">len</span>(mapFiles)</span><br><span class="line">n_other = nReduce</span><br><span class="line"><span class="keyword">case</span> reducePhase:</span><br><span class="line">ntasks = nReduce</span><br><span class="line">n_other = <span class="built_in">len</span>(mapFiles)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">fmt.Printf(<span class="string">"Schedule: %v %v tasks (%d I/Os)\n"</span>, ntasks, phase, n_other)</span><br><span class="line"></span><br><span class="line"><span class="comment">// All ntasks tasks have to be scheduled on workers. Once all tasks</span></span><br><span class="line"><span class="comment">// have completed successfully, schedule() should return.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Your code here (Part III, Part IV).</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line">done := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">bool</span>)</span><br><span class="line"><span class="keyword">for</span> i := <span class="number">0</span>; i &lt; ntasks; i++ &#123;</span><br><span class="line"><span class="keyword">go</span> <span class="function"><span class="keyword">func</span>(<span class="params">num <span class="keyword">int</span></span>)</span> &#123;</span><br><span class="line">args := DoTaskArgs&#123;jobName, mapFiles[num], phase, num, n_other&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> worker <span class="keyword">string</span></span><br><span class="line">reply := <span class="built_in">new</span>(<span class="keyword">struct</span>&#123;&#125;)</span><br><span class="line">ok := <span class="literal">false</span></span><br><span class="line"><span class="keyword">for</span> ok != <span class="literal">true</span> &#123;</span><br><span class="line">worker = &lt;-registerChan</span><br><span class="line">ok = call(worker, <span class="string">"Worker.DoTask"</span>, args, reply)</span><br><span class="line">&#125;</span><br><span class="line">done &lt;- <span class="literal">true</span>           <span class="comment">//任务完成</span></span><br><span class="line">registerChan &lt;- worker <span class="comment">//该worker工作完毕，处于空闲，加入channel中以分配给其它任务</span></span><br><span class="line">&#125;(i)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i := <span class="number">0</span>; i &lt; ntasks; i++ &#123; <span class="comment">//等待所有任务完成</span></span><br><span class="line">&lt;-done</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">fmt.Printf(<span class="string">"Schedule: %v done\n"</span>, phase)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>运行<code>go test -run TestParallel</code>的结果： <img src="https://upload-images.jianshu.io/upload_images/1863961-da345dba91fc382f.PNG?imageMogr2/auto-orient/strip%7CimageView2/2/w/640" alt=""></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;link rel=&quot;stylesheet&quot; class=&quot;aplayer-secondary-style-marker&quot; href=&quot;/assets/css/APlayer.min.css&quot;&gt;&lt;script src=&quot;/assets/js/APlayer.min.js&quot; cla
      
    
    </summary>
    
    
      <category term="Golang" scheme="https://hejtao.netlify.com/tags/Golang/"/>
    
      <category term="MapReduce" scheme="https://hejtao.netlify.com/tags/MapReduce/"/>
    
  </entry>
  
  <entry>
    <title>远程过程调用和线程(RPC and Thread)</title>
    <link href="https://hejtao.netlify.com/2019/03/25/2019-3-25/"/>
    <id>https://hejtao.netlify.com/2019/03/25/2019-3-25/</id>
    <published>2019-03-24T16:00:00.000Z</published>
    <updated>2019-11-11T19:59:33.204Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><meta name="referrer" content="no-referrer"><p><a href="http://nil.csail.mit.edu/6.824/2018/schedule.html" target="_blank" rel="noopener">MIT Distributed System Course: Lecture 2</a>Remote Procedure Call (RPC)</p><p><strong>目标</strong>：建立编程友好的客户端/服务器通信</p><p><strong>RPC消息图</strong>：客户端      服务器请求---&gt;                &lt;---响应</p><p><strong>软件结构</strong>：client app             handlers   stubs                   dispatcher   RPC lib               RPC lib       net  ------------ net</p><p><strong>Go rpc包</strong>：<a href="https://golang.org/pkg/net/rpc/" target="_blank" rel="noopener">官方文档</a><code>import &quot;net/rpc</code>rpc包提供对通过网络或其他I / O连接的对象的导出方法的访问。 服务器注册一个对象，并作为一种服务可见。 注册的对象其导出方法可以被远程访问。 服务器可以注册不同类型的多个对象（服务），但是注册相同类型的多个对象是错误的。</p><p>只有满足下列标准的方法（method）才能被远程访问：</p><ul><li>the method's type is exported.</li><li>the method is exported.</li><li>the method has two arguments, both exported (or builtin) types.</li><li>the method's second argument is a pointer.</li><li>the method has return type error.</li></ul><p>实际上，该方法必须看起来像</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> (<span class="params">t *T</span>) <span class="title">MethodName</span>(<span class="params">argType T1, replyType *T2</span>) <span class="title">error</span></span></span><br></pre></td></tr></table></figure><p>其中<code>T1</code>和<code>T2</code>可以通过 encoding/gob包来编码。即便使用不同的编解码器，上述标准仍然适用。</p><p>第一个参数<code>T1</code>表示调用者提供的参数;第二个参数<code>T2</code>表示要返回给调用者的结果参数。服务器可以通过调用ServeConn来处理单个连接上的请求。更典型的例子有创建网络侦听器并调用Accept，创建HTTP侦听器并调用HandleHTTP和http.Serve。</p><p>希望使用该服务的客户端首先和服务器建立连接，然后在连接的基础上调用NewClient。可以使用Dial函数（DialHTTP）方便地执行原始网络连接（HTTP连接）的两个步骤。新建的客户端对象具备Call方法和Go方法。</p><p>Call方法等待远程调用完成，而Go方法使用Call结构的Done通道启动异步调用和发出完成信号。</p><p>除非设置了显式编解码器，否则一般使用encoding/gob包来传输数据。</p><p>一个服务器导出Arith类型的对象的例子：</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> server</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">"errors"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Args <span class="keyword">struct</span> &#123;</span><br><span class="line">A, B <span class="keyword">int</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Quotient <span class="keyword">struct</span> &#123;</span><br><span class="line">Quo, Rem <span class="keyword">int</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Arith <span class="keyword">int</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> (<span class="params">t *Arith</span>) <span class="title">Multiply</span>(<span class="params">args *Args, reply *<span class="keyword">int</span></span>) <span class="title">error</span></span> &#123;</span><br><span class="line">*reply = args.A * args.B</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> (<span class="params">t *Arith</span>) <span class="title">Divide</span>(<span class="params">args *Args, quo *Quotient</span>) <span class="title">error</span></span> &#123;</span><br><span class="line"><span class="keyword">if</span> args.B == <span class="number">0</span> &#123;</span><br><span class="line"><span class="keyword">return</span> errors.New(<span class="string">"divide by zero"</span>)</span><br><span class="line">&#125;</span><br><span class="line">quo.Quo = args.A / args.B</span><br><span class="line">quo.Rem = args.A % args.B</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>服务器端调用 HTTP service：</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">arith := <span class="built_in">new</span>(Arith)</span><br><span class="line">rpc.Register(arith)</span><br><span class="line">rpc.HandleHTTP()</span><br><span class="line">l, e := net.Listen(<span class="string">"tcp"</span>, <span class="string">":1234"</span>)</span><br><span class="line"><span class="keyword">if</span> e != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Fatal(<span class="string">"listen error:"</span>, e)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">go</span> http.Serve(l, <span class="literal">nil</span>)</span><br></pre></td></tr></table></figure><p>现在，客户端拥有了一项服务Arith，该服务提供了Arith.Multiply和Arith.Divide方法。要调用这些方法，客户端得先拨通服务器：</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">client, err := rpc.DialHTTP(<span class="string">"tcp"</span>, serverAddress + <span class="string">":1234"</span>)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Fatal(<span class="string">"dialing:"</span>, err)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>然后进行远程调用：</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Synchronous call</span></span><br><span class="line">args := &amp;server.Args&#123;<span class="number">7</span>,<span class="number">8</span>&#125;</span><br><span class="line"><span class="keyword">var</span> reply <span class="keyword">int</span></span><br><span class="line">err = client.Call(<span class="string">"Arith.Multiply"</span>, args, &amp;reply)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Fatal(<span class="string">"arith error:"</span>, err)</span><br><span class="line">&#125;</span><br><span class="line">fmt.Printf(<span class="string">"Arith: %d*%d=%d"</span>, args.A, args.B, reply)</span><br></pre></td></tr></table></figure><p>或者</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Asynchronous call</span></span><br><span class="line">quotient := <span class="built_in">new</span>(Quotient)</span><br><span class="line">divCall := client.Go(<span class="string">"Arith.Divide"</span>, args, quotient, <span class="literal">nil</span>)</span><br><span class="line">replyCall := &lt;-divCall.Done<span class="comment">// will be equal to divCall</span></span><br><span class="line"><span class="comment">// check errors, print, etc.</span></span><br></pre></td></tr></table></figure><p>服务器通常会为客户端提供一个简单的、类型安全的封装。net/rpc包已冻结，不会增加新的功能属性。</p><p><strong>Go举例</strong>：一个简单的key/value存储服务器——Put(key,value), Get(key)-&gt;value</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">"fmt"</span></span><br><span class="line"><span class="string">"log"</span></span><br><span class="line"><span class="string">"net"</span></span><br><span class="line"><span class="string">"net/rpc"</span></span><br><span class="line"><span class="string">"sync"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// RPC request/reply definitions</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="keyword">const</span> (</span><br><span class="line">OK       = <span class="string">"OK"</span></span><br><span class="line">ErrNoKey = <span class="string">"ErrNoKey"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Err <span class="keyword">string</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> PutArgs <span class="keyword">struct</span> &#123;</span><br><span class="line">Key   <span class="keyword">string</span></span><br><span class="line">Value <span class="keyword">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> PutReply <span class="keyword">struct</span> &#123;</span><br><span class="line">Err Err</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> GetArgs <span class="keyword">struct</span> &#123;</span><br><span class="line">Key <span class="keyword">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> GetReply <span class="keyword">struct</span> &#123;</span><br><span class="line">Err   Err</span><br><span class="line">Value <span class="keyword">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Client</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">connect</span>(<span class="params"></span>) *<span class="title">rpc</span>.<span class="title">Client</span></span> &#123;</span><br><span class="line">client, err := rpc.Dial(<span class="string">"tcp"</span>, <span class="string">":1234"</span>)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Fatal(<span class="string">"dialing:"</span>, err)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> client</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">get</span>(<span class="params">key <span class="keyword">string</span></span>) <span class="title">string</span></span> &#123;</span><br><span class="line">client := connect()</span><br><span class="line">args := GetArgs&#123;Key: key&#125;</span><br><span class="line">reply := GetReply&#123;&#125;</span><br><span class="line">err := client.Call(<span class="string">"KV.Get"</span>, &amp;args, &amp;reply) <span class="comment">//远程调用KV.Get，等待它完成，并返回其错误状态。</span></span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Fatal(<span class="string">"error:"</span>, err)</span><br><span class="line">&#125;</span><br><span class="line">client.Close()</span><br><span class="line"></span><br><span class="line">log.Println(reply.Err)</span><br><span class="line"><span class="keyword">return</span> reply.Value</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">put</span>(<span class="params">key <span class="keyword">string</span>, val <span class="keyword">string</span></span>)</span> &#123;</span><br><span class="line">client := connect()</span><br><span class="line">args := PutArgs&#123;Key: key, Value: val&#125;</span><br><span class="line">reply := PutReply&#123;&#125;</span><br><span class="line">err := client.Call(<span class="string">"KV.Put"</span>, &amp;args, &amp;reply) <span class="comment">//远程调用KV.Put</span></span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Fatal(<span class="string">"error:"</span>, err)</span><br><span class="line">&#125;</span><br><span class="line">client.Close()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Server</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> KV <span class="keyword">struct</span> &#123;</span><br><span class="line">mu   sync.Mutex</span><br><span class="line">data <span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">server</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">kv := <span class="built_in">new</span>(KV)</span><br><span class="line">kv.data = <span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">string</span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">rpcs := rpc.NewServer()</span><br><span class="line">rpcs.Register(kv)</span><br><span class="line"></span><br><span class="line">l, e := net.Listen(<span class="string">"tcp"</span>, <span class="string">":1234"</span>)</span><br><span class="line"><span class="keyword">if</span> e != <span class="literal">nil</span> &#123;</span><br><span class="line">log.Fatal(<span class="string">"listen error:"</span>, e)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">go</span> <span class="function"><span class="keyword">func</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line"><span class="keyword">for</span> &#123;</span><br><span class="line">conn, err := l.Accept()</span><br><span class="line"><span class="keyword">if</span> err == <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">go</span> rpcs.ServeConn(conn)</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="keyword">break</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">l.Close()</span><br><span class="line">&#125;()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> (<span class="params">kv *KV</span>) <span class="title">Get</span>(<span class="params">args *GetArgs, reply *GetReply</span>) <span class="title">error</span></span> &#123;</span><br><span class="line">kv.mu.Lock()</span><br><span class="line"><span class="keyword">defer</span> kv.mu.Unlock()</span><br><span class="line"></span><br><span class="line">val, ok := kv.data[args.Key]</span><br><span class="line"><span class="keyword">if</span> ok &#123;</span><br><span class="line">reply.Err = OK</span><br><span class="line">reply.Value = val</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">reply.Err = ErrNoKey</span><br><span class="line">reply.Value = <span class="string">""</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> (<span class="params">kv *KV</span>) <span class="title">Put</span>(<span class="params">args *PutArgs, reply *PutReply</span>) <span class="title">error</span></span> &#123;</span><br><span class="line">kv.mu.Lock()</span><br><span class="line"><span class="keyword">defer</span> kv.mu.Unlock()</span><br><span class="line"></span><br><span class="line">kv.data[args.Key] = args.Value</span><br><span class="line">reply.Err = OK</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// main</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">server()</span><br><span class="line"></span><br><span class="line">put(<span class="string">"passwd"</span>, <span class="string">"2w6C*kcXWWmzK$Jg"</span>) <span class="comment">//客户端存储密码</span></span><br><span class="line">fmt.Println(get(<span class="string">"passwd"</span>))        <span class="comment">//客户端获取密码</span></span><br><span class="line">&#125;</span><br><span class="line">command-line-arguments</span><br><span class="line"><span class="number">2019</span>/<span class="number">04</span>/<span class="number">02</span> <span class="number">18</span>:<span class="number">34</span>:<span class="number">11</span> OK</span><br><span class="line"><span class="number">2</span>w6C*kcXWWmzK$Jg</span><br></pre></td></tr></table></figure><ul><li><p>共同：必须为每种RPC类型声明Args和Reply结构</p></li><li><p>Client:connect()的Dial()创建与服务器的TCP连接Call()要求RPC库执行远程调用指定server function name, args,replylibrary marshalls args, sends request, waits, unmarshally replyCall()的返回值表示是否收到回复usually you'll also have a reply.Err indicating service-level failure</p></li><li><p>server：Go要求您声明一个带有方法的对象作为RPC处理程序(RPC handler)然后，您使用RPC库注册该对象您接受TCP连接，并给它们提供RPC库</p><ul><li>RPC库读取每个请求为此请求创建一个新的goroutineunmarshalls request调用命名方法（调度）marshalls reply在TCP连接上写回复</li><li>服务器的Get()和Put()处理程序必须锁定，因为RPC库给每个请求创建goroutines解读args; 修改reply</li></ul></li></ul><hr><p><strong>线程</strong>:线程是一种有用的结构化工具Go称他们为goroutines;其他人称他们为线程他们可能很棘手</p><p><strong>Why threads?</strong>用它们实现并发，在分布式系统中自然地出现</p><ul><li>I / O并发：在等待来自其他服务器的响应时，处理下一个请求</li><li>多核：线程在多个核心上并行运行</li></ul><p><strong>Thread =“执行线程”</strong>线程允许一个程序（逻辑上）一次执行许多事情线程共享内存each thread includes some per-thread state，包括：程序计数器，寄存器，堆栈</p><p><strong>程序中有多少个线程？</strong></p><ul><li>由结构驱动例如每个客户端一个线程，一个用于后台任务</li><li>多核并行one active thread per core。Go的 runtime 自动地在可用内核上调度可运行的goroutine</li><li>I / O并发数量由延迟和容量决定继续增加直到吞吐量停止增长</li><li>Go threads are pretty cheap100或1000是好的，但可能达不到数百万的量级创建线程比方法调用更昂贵</li></ul><p><strong>Threading challenges：</strong></p><ul><li>共享数据一个线程读取另一个线程正在改变的数据？例如当两个线程执行count = count + 1时，this is a &quot;race&quot; -- and is usually a bug——使用互斥锁（或其他同步）——或避免共享</li><li>线程之间的协调如何等待所有Map线程完成？——使用Go channel或WaitGroup</li><li>并发的粒度粗粒度(coarse-grained)  —— 简单，但并发/并行很少细粒度  —— 更多的并发、竞争(race)和死锁</li></ul><p><strong>什么是爬虫？</strong>目标是获取所有网页，例如提供给索引器(indexer)网页形成一个图(graph)每个页面的多个链接graph has cycles</p><p><strong>Crawler challenges</strong></p><ul><li>安排I / O并发同时获取多个URL增加每秒获取的URL由于网络延迟远远超过网络容量</li><li>Fetch each URL only once避免浪费网络带宽对远程服务器很好需要记住访问过的URL</li><li>知道什么时候完成</li></ul><p><strong>Crawler solutions：</strong></p><ul><li>串行爬虫：fetched map 避免重复、进入死循环它是一个单一的映射，通过递归调用传递一次只能爬取一页</li></ul><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">"fmt"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Fetcher <span class="keyword">interface</span> &#123;</span><br><span class="line">Fetch(url <span class="keyword">string</span>) (urls []<span class="keyword">string</span>, err error) <span class="comment">//由一个URL返回多个URL</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> fakeResult <span class="keyword">struct</span> &#123;</span><br><span class="line">body <span class="keyword">string</span></span><br><span class="line">urls []<span class="keyword">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> fakeFetcher <span class="keyword">map</span>[<span class="keyword">string</span>]*fakeResult</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> (<span class="params">f fakeFetcher</span>) <span class="title">Fetch</span>(<span class="params">url <span class="keyword">string</span></span>) (<span class="params">[]<span class="keyword">string</span>, error</span>)</span> &#123;</span><br><span class="line"><span class="keyword">if</span> res, ok := f[url]; ok &#123;</span><br><span class="line">fmt.Printf(<span class="string">"found:   %s\n"</span>, url)</span><br><span class="line"><span class="keyword">return</span> res.urls, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">fmt.Printf(<span class="string">"missing: %s\n"</span>, url)</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span>, fmt.Errorf(<span class="string">"not found: %s"</span>, url) <span class="comment">//打印字符串错误</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> fetcher = fakeFetcher&#123; </span><br><span class="line"></span><br><span class="line"><span class="string">"http://golang.org/"</span>: &amp;fakeResult&#123;</span><br><span class="line"><span class="string">"The Go Programming Language"</span>,</span><br><span class="line">[]<span class="keyword">string</span>&#123;</span><br><span class="line"><span class="string">"http://golang.org/pkg/"</span>,</span><br><span class="line"><span class="string">"http://golang.org/cmd/"</span>,</span><br><span class="line">&#125;,</span><br><span class="line">&#125;,</span><br><span class="line"></span><br><span class="line"><span class="string">"http://golang.org/pkg/"</span>: &amp;fakeResult&#123;</span><br><span class="line"><span class="string">"Packages"</span>,</span><br><span class="line">[]<span class="keyword">string</span>&#123;</span><br><span class="line"><span class="string">"http://golang.org/"</span>,</span><br><span class="line"><span class="string">"http://golang.org/cmd/"</span>,</span><br><span class="line"><span class="string">"http://golang.org/pkg/fmt/"</span>,</span><br><span class="line"><span class="string">"http://golang.org/pkg/os/"</span>,</span><br><span class="line">&#125;,</span><br><span class="line">&#125;,</span><br><span class="line"></span><br><span class="line"><span class="string">"http://golang.org/pkg/fmt/"</span>: &amp;fakeResult&#123;</span><br><span class="line"><span class="string">"Package fmt"</span>,</span><br><span class="line">[]<span class="keyword">string</span>&#123;</span><br><span class="line"><span class="string">"http://golang.org/"</span>,</span><br><span class="line"><span class="string">"http://golang.org/pkg/"</span>,</span><br><span class="line">&#125;,</span><br><span class="line">&#125;,</span><br><span class="line"></span><br><span class="line"><span class="string">"http://golang.org/pkg/os/"</span>: &amp;fakeResult&#123;</span><br><span class="line"><span class="string">"Package os"</span>,</span><br><span class="line">[]<span class="keyword">string</span>&#123;</span><br><span class="line"><span class="string">"http://golang.org/"</span>,</span><br><span class="line"><span class="string">"http://golang.org/pkg/"</span>,</span><br><span class="line">&#125;,</span><br><span class="line">&#125;,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 串行爬虫</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Serial</span>(<span class="params">url <span class="keyword">string</span>, fetcher Fetcher, fetched <span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">bool</span></span>)</span> &#123;</span><br><span class="line"><span class="keyword">if</span> fetched[url] &#123; <span class="comment">// 已经爬取</span></span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">fetched[url] = <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">urls, err := fetcher.Fetch(url)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> _, u := <span class="keyword">range</span> urls &#123;</span><br><span class="line">Serial(u, fetcher, fetched)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">Serial(<span class="string">"http://golang.org/"</span>, fetcher, <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">bool</span>))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>ConcurrentMutex爬虫：<ul><li>为每个页面的爬取创建一个线程，因此可以并发爬取，爬取率更高</li><li>线程共享 fetched map</li><li>Why the Mutex (== lock)?<ol><li>没有锁：两个网页包含指向同一URL的链接，导致两个线程同时获取这这个页面T1、T2检查获取[url]，当两者都看到url尚未获取，两者都取，导致错误</li><li>同时读写（或写入+写入）是竞争</li><li>如果我注释掉Lock()/Unlock()调用会发生什么？go run crawler.gogo run -race crawler.goThe lock causes the check and update to be atomic</li></ol></li><li>How does it decide it is done?sync.WaitGroupimplicitly waits for children to finish recursive fetches</li></ul></li></ul><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">"fmt"</span></span><br><span class="line"><span class="string">"sync"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Fetcher <span class="keyword">interface</span> &#123;</span><br><span class="line">Fetch(url <span class="keyword">string</span>) (urls []<span class="keyword">string</span>, err error) <span class="comment">//由一个URL返回多个URL</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> fakeResult <span class="keyword">struct</span> &#123;</span><br><span class="line">body <span class="keyword">string</span></span><br><span class="line">urls []<span class="keyword">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> fakeFetcher <span class="keyword">map</span>[<span class="keyword">string</span>]*fakeResult</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> (<span class="params">f fakeFetcher</span>) <span class="title">Fetch</span>(<span class="params">url <span class="keyword">string</span></span>) (<span class="params">[]<span class="keyword">string</span>, error</span>)</span> &#123;</span><br><span class="line"><span class="keyword">if</span> res, ok := f[url]; ok &#123;</span><br><span class="line">fmt.Printf(<span class="string">"found:   %s\n"</span>, url)</span><br><span class="line"><span class="keyword">return</span> res.urls, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">fmt.Printf(<span class="string">"missing: %s\n"</span>, url)</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span>, fmt.Errorf(<span class="string">"not found: %s"</span>, url) <span class="comment">//打印字符串错误</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> fetcher = fakeFetcher&#123;</span><br><span class="line"></span><br><span class="line"><span class="string">"http://golang.org/"</span>: &amp;fakeResult&#123;</span><br><span class="line"><span class="string">"The Go Programming Language"</span>,</span><br><span class="line">[]<span class="keyword">string</span>&#123;</span><br><span class="line"><span class="string">"http://golang.org/pkg/"</span>,</span><br><span class="line"><span class="string">"http://golang.org/cmd/"</span>,</span><br><span class="line">&#125;,</span><br><span class="line">&#125;,</span><br><span class="line"></span><br><span class="line"><span class="string">"http://golang.org/pkg/"</span>: &amp;fakeResult&#123;</span><br><span class="line"><span class="string">"Packages"</span>,</span><br><span class="line">[]<span class="keyword">string</span>&#123;</span><br><span class="line"><span class="string">"http://golang.org/"</span>,</span><br><span class="line"><span class="string">"http://golang.org/cmd/"</span>,</span><br><span class="line"><span class="string">"http://golang.org/pkg/fmt/"</span>,</span><br><span class="line"><span class="string">"http://golang.org/pkg/os/"</span>,</span><br><span class="line">&#125;,</span><br><span class="line">&#125;,</span><br><span class="line"></span><br><span class="line"><span class="string">"http://golang.org/pkg/fmt/"</span>: &amp;fakeResult&#123;</span><br><span class="line"><span class="string">"Package fmt"</span>,</span><br><span class="line">[]<span class="keyword">string</span>&#123;</span><br><span class="line"><span class="string">"http://golang.org/"</span>,</span><br><span class="line"><span class="string">"http://golang.org/pkg/"</span>,</span><br><span class="line">&#125;,</span><br><span class="line">&#125;,</span><br><span class="line"></span><br><span class="line"><span class="string">"http://golang.org/pkg/os/"</span>: &amp;fakeResult&#123;</span><br><span class="line"><span class="string">"Package os"</span>,</span><br><span class="line">[]<span class="keyword">string</span>&#123;</span><br><span class="line"><span class="string">"http://golang.org/"</span>,</span><br><span class="line"><span class="string">"http://golang.org/pkg/"</span>,</span><br><span class="line">&#125;,</span><br><span class="line">&#125;,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Concurrent crawler with shared state and Mutex</span></span><br><span class="line"><span class="keyword">type</span> fetchState <span class="keyword">struct</span> &#123;</span><br><span class="line">mu      sync.Mutex</span><br><span class="line">fetched <span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">bool</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">makeState</span>(<span class="params"></span>) *<span class="title">fetchState</span></span> &#123;</span><br><span class="line">f := &amp;fetchState&#123;&#125;</span><br><span class="line">f.fetched = <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">bool</span>)</span><br><span class="line"><span class="keyword">return</span> f</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">ConcurrentMutex</span>(<span class="params">url <span class="keyword">string</span>, fetcher Fetcher, f *fetchState</span>)</span> &#123;</span><br><span class="line">f.mu.Lock()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> f.fetched[url] &#123; <span class="comment">// 已经爬取</span></span><br><span class="line">f.mu.Unlock()</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">f.fetched[url] = <span class="literal">true</span></span><br><span class="line">f.mu.Unlock()</span><br><span class="line"></span><br><span class="line">urls, err := fetcher.Fetch(url)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> done sync.WaitGroup</span><br><span class="line"><span class="keyword">for</span> _, u := <span class="keyword">range</span> urls &#123;</span><br><span class="line">done.Add(<span class="number">1</span>)</span><br><span class="line"><span class="keyword">go</span> <span class="function"><span class="keyword">func</span>(<span class="params">u <span class="keyword">string</span></span>)</span> &#123;</span><br><span class="line"><span class="keyword">defer</span> done.Done() <span class="comment">//等价于defer done.Add(-1)</span></span><br><span class="line">ConcurrentMutex(u, fetcher, f)</span><br><span class="line">&#125;(u)</span><br><span class="line">&#125;</span><br><span class="line">done.Wait() <span class="comment">//等待所有的goroutine完成</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">ConcurrentMutex(<span class="string">"http://golang.org/"</span>, fetcher, makeState())</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>ConcurrentChannel爬虫<ul><li>Go channel：channel是一个对象,可能有很多个, ch：= make（chan int）channel允许一个线程将对象发送到另一个线程：<code>ch &lt; - x</code>，sender等待goroutine接收<code>y：= &lt; - ch; for y := range ch</code>，receiver等待goroutine发送可以用channel来进行通信和同步多个线程可以在一个channel上发送和接收在发送时握住锁可能很危险...</li><li>ConcurrentChannel master（）master()创建一个worker goroutine来获取每个页面worker()在channel上发送URL多个worker在一个channel上发送master()从channel中读取URL[图：主人，通道，工人]</li><li>无需锁定 fetched map，因为它不是共享的！</li><li>有共享数据吗？channel通道上发送的切片和字符串master()传递给worker()的参数</li></ul></li></ul><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">"fmt"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Fetcher <span class="keyword">interface</span> &#123;</span><br><span class="line">Fetch(url <span class="keyword">string</span>) (urls []<span class="keyword">string</span>, err error) <span class="comment">//由一个URL返回多个URL</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> fakeResult <span class="keyword">struct</span> &#123;</span><br><span class="line">body <span class="keyword">string</span></span><br><span class="line">urls []<span class="keyword">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> fakeFetcher <span class="keyword">map</span>[<span class="keyword">string</span>]*fakeResult</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> (<span class="params">f fakeFetcher</span>) <span class="title">Fetch</span>(<span class="params">url <span class="keyword">string</span></span>) (<span class="params">[]<span class="keyword">string</span>, error</span>)</span> &#123;</span><br><span class="line"><span class="keyword">if</span> res, ok := f[url]; ok &#123;</span><br><span class="line">fmt.Printf(<span class="string">"found:   %s\n"</span>, url)</span><br><span class="line"><span class="keyword">return</span> res.urls, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">fmt.Printf(<span class="string">"missing: %s\n"</span>, url)</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span>, fmt.Errorf(<span class="string">"not found: %s"</span>, url) <span class="comment">//打印字符串错误</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> fetcher = fakeFetcher&#123;</span><br><span class="line"></span><br><span class="line"><span class="string">"http://golang.org/"</span>: &amp;fakeResult&#123;</span><br><span class="line"><span class="string">"The Go Programming Language"</span>,</span><br><span class="line">[]<span class="keyword">string</span>&#123;</span><br><span class="line"><span class="string">"http://golang.org/pkg/"</span>,</span><br><span class="line"><span class="string">"http://golang.org/cmd/"</span>,</span><br><span class="line">&#125;,</span><br><span class="line">&#125;,</span><br><span class="line"></span><br><span class="line"><span class="string">"http://golang.org/pkg/"</span>: &amp;fakeResult&#123;</span><br><span class="line"><span class="string">"Packages"</span>,</span><br><span class="line">[]<span class="keyword">string</span>&#123;</span><br><span class="line"><span class="string">"http://golang.org/"</span>,</span><br><span class="line"><span class="string">"http://golang.org/cmd/"</span>,</span><br><span class="line"><span class="string">"http://golang.org/pkg/fmt/"</span>,</span><br><span class="line"><span class="string">"http://golang.org/pkg/os/"</span>,</span><br><span class="line">&#125;,</span><br><span class="line">&#125;,</span><br><span class="line"></span><br><span class="line"><span class="string">"http://golang.org/pkg/fmt/"</span>: &amp;fakeResult&#123;</span><br><span class="line"><span class="string">"Package fmt"</span>,</span><br><span class="line">[]<span class="keyword">string</span>&#123;</span><br><span class="line"><span class="string">"http://golang.org/"</span>,</span><br><span class="line"><span class="string">"http://golang.org/pkg/"</span>,</span><br><span class="line">&#125;,</span><br><span class="line">&#125;,</span><br><span class="line"></span><br><span class="line"><span class="string">"http://golang.org/pkg/os/"</span>: &amp;fakeResult&#123;</span><br><span class="line"><span class="string">"Package os"</span>,</span><br><span class="line">[]<span class="keyword">string</span>&#123;</span><br><span class="line"><span class="string">"http://golang.org/"</span>,</span><br><span class="line"><span class="string">"http://golang.org/pkg/"</span>,</span><br><span class="line">&#125;,</span><br><span class="line">&#125;,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Concurrent crawler with channels</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">worker</span>(<span class="params">url <span class="keyword">string</span>, ch <span class="keyword">chan</span> []<span class="keyword">string</span>, fetcher Fetcher</span>)</span> &#123;</span><br><span class="line">urls, err := fetcher.Fetch(url)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">ch &lt;- []<span class="keyword">string</span>&#123;&#125;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">ch &lt;- urls</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">master</span>(<span class="params">ch <span class="keyword">chan</span> []<span class="keyword">string</span>, fetcher Fetcher</span>)</span> &#123;</span><br><span class="line">n := <span class="number">1</span></span><br><span class="line">fetched := <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">bool</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> urls := <span class="keyword">range</span> ch &#123;</span><br><span class="line"><span class="keyword">for</span> _, u := <span class="keyword">range</span> urls &#123;</span><br><span class="line"><span class="keyword">if</span> fetched[u] == <span class="literal">false</span> &#123;</span><br><span class="line">fetched[u] = <span class="literal">true</span></span><br><span class="line">n += <span class="number">1</span></span><br><span class="line"><span class="keyword">go</span> worker(u, ch, fetcher)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">n -= <span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> n == <span class="number">0</span> &#123;</span><br><span class="line"><span class="keyword">break</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">ConcurrentChannel</span>(<span class="params">url <span class="keyword">string</span>, fetcher Fetcher</span>)</span> &#123;</span><br><span class="line">ch := <span class="built_in">make</span>(<span class="keyword">chan</span> []<span class="keyword">string</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">go</span> <span class="function"><span class="keyword">func</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">ch &lt;- []<span class="keyword">string</span>&#123;url&#125;</span><br><span class="line">&#125;()</span><br><span class="line"></span><br><span class="line">master(ch, fetcher)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">ConcurrentChannel(<span class="string">"http://golang.org/"</span>, fetcher)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br>**什么时候使用sharing和locks，而不是channels？** - 大多数问题都可以用任何一种方式解决 - 最有意义的取决于程序员的想法    state(状态) -- sharing and locks    communication -- channels    waiting for events -- channels - 使用Go的竞争检测器：    [Data Race Detector](https://golang.org/doc/articles/race_detector.html)    go test -race]]></content>
    
    <summary type="html">
    
      
      
        &lt;link rel=&quot;stylesheet&quot; class=&quot;aplayer-secondary-style-marker&quot; href=&quot;/assets/css/APlayer.min.css&quot;&gt;&lt;script src=&quot;/assets/js/APlayer.min.js&quot; cla
      
    
    </summary>
    
    
      <category term="Golang" scheme="https://hejtao.netlify.com/tags/Golang/"/>
    
      <category term="RPC" scheme="https://hejtao.netlify.com/tags/RPC/"/>
    
      <category term="并发" scheme="https://hejtao.netlify.com/tags/%E5%B9%B6%E5%8F%91/"/>
    
  </entry>
  
  <entry>
    <title>Go并发模式 (Cocurrency Pattern)</title>
    <link href="https://hejtao.netlify.com/2019/02/10/2019-2-10/"/>
    <id>https://hejtao.netlify.com/2019/02/10/2019-2-10/</id>
    <published>2019-02-09T16:00:00.000Z</published>
    <updated>2019-11-11T19:59:33.203Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><meta name="referrer" content="no-referrer"><p>这篇博客的原创来自Go的<a href="https://blog.golang.org/advanced-go-concurrency-patterns" target="_blank" rel="noopener">官方博客</a>，其中提供了丰富的关于Go的并发的相关资料。本文仅仅是对 Rob Pike 的演讲 Go Concurrency Patterns 和 Sameer Ajmani 的续集  Advanced Go Concurrency Patterns 的学习，相关内容的视频和ppt在网上都可以找到。</p><h4><span id="1-han-shu-fan-hui-channel">1. 函数返回 channel</span><a href="#1-han-shu-fan-hui-channel" class="header-anchor">#</a></h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">"fmt"</span></span><br><span class="line"><span class="string">"math/rand"</span></span><br><span class="line"><span class="string">"time"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">boring</span>(<span class="params">msg <span class="keyword">string</span></span>) &lt;-<span class="title">chan</span> <span class="title">string</span></span> &#123; <span class="comment">// 返回字符串通道，仅接收</span></span><br><span class="line">c := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">string</span>)</span><br><span class="line"><span class="keyword">go</span> <span class="function"><span class="keyword">func</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line"><span class="keyword">for</span> i := <span class="number">0</span>; ; i++ &#123;</span><br><span class="line">c &lt;- fmt.Sprintf(<span class="string">"%s %d"</span>, msg, i)</span><br><span class="line">time.Sleep(time.Duration(rand.Intn(<span class="number">3e3</span>)) * time.Millisecond)</span><br><span class="line">&#125;</span><br><span class="line">&#125;()</span><br><span class="line"><span class="keyword">return</span> c</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">c := boring(<span class="string">"boring!"</span>) <span class="comment">// 通道作为返回的函数</span></span><br><span class="line"><span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">5</span>; i++ &#123;</span><br><span class="line">fmt.Printf(<span class="string">"You say: %q\n"</span>, &lt;-c)</span><br><span class="line">&#125;</span><br><span class="line">fmt.Println(<span class="string">"You're boring; I'm leaving."</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">输出：</span><br><span class="line">You say: <span class="string">"boring! 0"</span></span><br><span class="line">You say: <span class="string">"boring! 1"</span></span><br><span class="line">You say: <span class="string">"boring! 2"</span></span><br><span class="line">You say: <span class="string">"boring! 3"</span></span><br><span class="line">You say: <span class="string">"boring! 4"</span></span><br><span class="line">You<span class="string">'re boring; I'</span>m leaving.</span><br></pre></td></tr></table></figure><h4><span id="2-tong-dao-zuo-wei-fu-wu">2. 通道作为服务</span><a href="#2-tong-dao-zuo-wei-fu-wu" class="header-anchor">#</a></h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">joe := boring(<span class="string">"Joe"</span>)</span><br><span class="line">ann := boring(<span class="string">"Ann"</span>)</span><br><span class="line"><span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">5</span>; i++ &#123;</span><br><span class="line">fmt.Println(&lt;-joe)</span><br><span class="line">fmt.Println(&lt;-ann)</span><br><span class="line">&#125;</span><br><span class="line">fmt.Println(<span class="string">"You're both boring; I'm leaving."</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">输出：</span><br><span class="line">Joe <span class="number">0</span></span><br><span class="line">Ann <span class="number">0</span></span><br><span class="line">Joe <span class="number">1</span></span><br><span class="line">Ann <span class="number">1</span></span><br><span class="line">Joe <span class="number">2</span></span><br><span class="line">Ann <span class="number">2</span></span><br><span class="line">Joe <span class="number">3</span></span><br><span class="line">Ann <span class="number">3</span></span><br><span class="line">Joe <span class="number">4</span></span><br><span class="line">Ann <span class="number">4</span></span><br><span class="line">You<span class="string">'re both boring; I'</span>m leaving.</span><br></pre></td></tr></table></figure><h4><span id="3-duo-chong-tong-dao-shan-ru-han-shu-fan-in-function">3.多重通道(扇入函数，fan-in function)</span><a href="#3-duo-chong-tong-dao-shan-ru-han-shu-fan-in-function" class="header-anchor">#</a></h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">"fmt"</span></span><br><span class="line"><span class="string">"math/rand"</span></span><br><span class="line"><span class="string">"time"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">boring</span>(<span class="params">msg <span class="keyword">string</span></span>) &lt;-<span class="title">chan</span> <span class="title">string</span></span> &#123; <span class="comment">// 返回字符串通道，仅接收</span></span><br><span class="line">c := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">string</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">go</span> <span class="function"><span class="keyword">func</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line"><span class="keyword">for</span> i := <span class="number">0</span>; ; i++ &#123;</span><br><span class="line">c &lt;- fmt.Sprintf(<span class="string">"%s %d"</span>, msg, i)</span><br><span class="line">time.Sleep(time.Duration(rand.Intn(<span class="number">1e3</span>)) * time.Millisecond)</span><br><span class="line">&#125;</span><br><span class="line">&#125;()</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> c</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">fanIn</span>(<span class="params">input1, input2 &lt;-<span class="keyword">chan</span> <span class="keyword">string</span></span>) &lt;-<span class="title">chan</span> <span class="title">string</span></span> &#123;</span><br><span class="line">c := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">string</span>)</span><br><span class="line"><span class="keyword">go</span> <span class="function"><span class="keyword">func</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line"><span class="keyword">for</span> &#123;</span><br><span class="line">c &lt;- &lt;-input1</span><br><span class="line">&#125;</span><br><span class="line">&#125;()</span><br><span class="line"></span><br><span class="line"><span class="keyword">go</span> <span class="function"><span class="keyword">func</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line"><span class="keyword">for</span> &#123;</span><br><span class="line">c &lt;- &lt;-input2</span><br><span class="line">&#125;</span><br><span class="line">&#125;()</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> c</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">c := fanIn(boring(<span class="string">"Joe"</span>), boring(<span class="string">"Ann"</span>))</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">10</span>; i++ &#123;</span><br><span class="line">fmt.Println(&lt;-c)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">fmt.Println(<span class="string">"You're both boring; I'm leaving."</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://upload-images.jianshu.io/upload_images/1863961-e259e9b8d2d6bbe2.PNG?imageMogr2/auto-orient/strip%7CimageView2/2/w/640" alt=""></p><h4><span id="4-tong-dao-fa-song-tong-dao-shi-goroutine-you-xu">4. 通道发送通道，使 goroutine 有序</span><a href="#4-tong-dao-fa-song-tong-dao-shi-goroutine-you-xu" class="header-anchor">#</a></h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">"fmt"</span></span><br><span class="line"><span class="string">"math/rand"</span></span><br><span class="line"><span class="string">"time"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Message <span class="keyword">struct</span> &#123;</span><br><span class="line">str  <span class="keyword">string</span></span><br><span class="line">wait <span class="keyword">chan</span> <span class="keyword">bool</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">boring</span>(<span class="params">msg <span class="keyword">string</span></span>) <span class="title">chan</span> <span class="title">Message</span></span> &#123;</span><br><span class="line">c := <span class="built_in">make</span>(<span class="keyword">chan</span> Message)</span><br><span class="line">waitForIt := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">bool</span>) <span class="comment">// 被所有 Message 共享</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">go</span> <span class="function"><span class="keyword">func</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line"><span class="keyword">for</span> i := <span class="number">0</span>; ; i++ &#123;</span><br><span class="line">c &lt;- Message&#123;fmt.Sprintf(<span class="string">"%s: %d"</span>, msg, i), waitForIt&#125;</span><br><span class="line">time.Sleep(time.Duration(rand.Intn(<span class="number">1e3</span>)) * time.Millisecond)</span><br><span class="line">&lt;-waitForIt  <span class="comment">// 进入等待</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;()</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> c</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">fanIn</span>(<span class="params">input1, input2 <span class="keyword">chan</span> Message</span>) <span class="title">chan</span> <span class="title">Message</span></span> &#123;</span><br><span class="line">c := <span class="built_in">make</span>(<span class="keyword">chan</span> Message)</span><br><span class="line"><span class="keyword">go</span> <span class="function"><span class="keyword">func</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line"><span class="keyword">for</span> &#123;</span><br><span class="line">c &lt;- &lt;-input1</span><br><span class="line">&#125;</span><br><span class="line">&#125;()</span><br><span class="line"></span><br><span class="line"><span class="keyword">go</span> <span class="function"><span class="keyword">func</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line"><span class="keyword">for</span> &#123;</span><br><span class="line">c &lt;- &lt;-input2</span><br><span class="line">&#125;</span><br><span class="line">&#125;()</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> c</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">c := fanIn(boring(<span class="string">"Joe"</span>), boring(<span class="string">"Ann"</span>))</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">5</span>; i++ &#123;</span><br><span class="line">msg1 := &lt;-c</span><br><span class="line">fmt.Println(msg1.str)</span><br><span class="line">msg2 := &lt;-c</span><br><span class="line">fmt.Println(msg2.str)  <span class="comment">// 当 Joe 和 Ann 的信息都收到后，才开放下一次消息接收</span></span><br><span class="line">msg1.wait &lt;- <span class="literal">true</span></span><br><span class="line">msg2.wait &lt;- <span class="literal">true</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4><span id="5-select-yu-ju">5. select 语句</span><a href="#5-select-yu-ju" class="header-anchor">#</a></h4><p>使用 select 来写扇入函数，减少 goroutine 数量</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">fanIn</span>(<span class="params">input1, input2 &lt;-<span class="keyword">chan</span> <span class="keyword">string</span></span>) &lt;-<span class="title">chan</span> <span class="title">string</span></span> &#123;</span><br><span class="line">    c := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">string</span>)</span><br><span class="line">    <span class="keyword">go</span> <span class="function"><span class="keyword">func</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> &#123;</span><br><span class="line">            <span class="keyword">select</span> &#123;</span><br><span class="line">            <span class="keyword">case</span> s := &lt;-input1:  c &lt;- s</span><br><span class="line">            <span class="keyword">case</span> s := &lt;-input2:  c &lt;- s</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;()</span><br><span class="line">    <span class="keyword">return</span> c</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>select设置超时</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">"fmt"</span></span><br><span class="line"><span class="string">"math/rand"</span></span><br><span class="line"><span class="string">"time"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">boring</span>(<span class="params">msg <span class="keyword">string</span></span>) &lt;-<span class="title">chan</span> <span class="title">string</span></span> &#123; <span class="comment">// 返回字符串通道，仅接收</span></span><br><span class="line">c := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">string</span>)</span><br><span class="line"><span class="keyword">go</span> <span class="function"><span class="keyword">func</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line"><span class="keyword">for</span> i := <span class="number">0</span>; ; i++ &#123;</span><br><span class="line">c &lt;- fmt.Sprintf(<span class="string">"%s %d"</span>, msg, i)</span><br><span class="line">time.Sleep(time.Duration(rand.Intn(<span class="number">1500</span>)) * time.Millisecond)</span><br><span class="line">&#125;</span><br><span class="line">&#125;()</span><br><span class="line"><span class="keyword">return</span> c</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">c := boring(<span class="string">"Joe"</span>)</span><br><span class="line"><span class="keyword">for</span> &#123;</span><br><span class="line"><span class="keyword">select</span> &#123;</span><br><span class="line"><span class="keyword">case</span> s := &lt;-c:</span><br><span class="line">fmt.Println(s)</span><br><span class="line"><span class="keyword">case</span> &lt;-time.After(<span class="number">1</span> * time.Second):</span><br><span class="line">fmt.Println(<span class="string">"You're too slow."</span>)</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">输出：</span><br><span class="line">Joe <span class="number">0</span></span><br><span class="line">Joe <span class="number">1</span></span><br><span class="line">Joe <span class="number">2</span></span><br><span class="line">Joe <span class="number">3</span></span><br><span class="line">Joe <span class="number">4</span></span><br><span class="line">You<span class="string">'re too slow.</span></span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;link rel=&quot;stylesheet&quot; class=&quot;aplayer-secondary-style-marker&quot; href=&quot;/assets/css/APlayer.min.css&quot;&gt;&lt;script src=&quot;/assets/js/APlayer.min.js&quot; cla
      
    
    </summary>
    
    
      <category term="Golang" scheme="https://hejtao.netlify.com/tags/Golang/"/>
    
  </entry>
  
  <entry>
    <title>MySQL驱动</title>
    <link href="https://hejtao.netlify.com/2018/12/31/2018-12-31/"/>
    <id>https://hejtao.netlify.com/2018/12/31/2018-12-31/</id>
    <published>2018-12-30T16:00:00.000Z</published>
    <updated>2019-11-11T19:59:33.200Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><meta name="referrer" content="no-referrer"><p>MySQL基础见<a href="http://www.runoob.com/mysql/mysql-tutorial.html" target="_blank" rel="noopener">菜鸟教程</a>;本文参考了<a href="https://github.com/astaxie/build-web-application-with-golang/blob/master/zh/05.2.md" target="_blank" rel="noopener">astaxie/build-web-application-with-golang</a>.</p><h4><span id="qi-dong-yi-mi-ma-deng-ru-he-chuang-jian-shu-ju-ku">启动、以密码登入和创建数据库</span><a href="#qi-dong-yi-mi-ma-deng-ru-he-chuang-jian-shu-ju-ku" class="header-anchor">#</a></h4><p>windows:在bin目录下，运行(git-bash以管理员运行，加winpty)<code>mysqld --remove</code> 删除之前的mysql服务<code>mysqld -install mysql</code> 安装windows服务，服务名称为mysql(任意取)<code>mysqld --initialize-insecure</code> 可无密码登陆root<code>net start mysql</code> 启动服务(关闭的命令是 <code>net stop mysql</code>) ubuntu:<code>service mysql start</code>　启动服务　　<code>service mysql stop</code>　关闭服务　<code>service restart stop</code>　重启服务<code>ps -ef | grep mysqld</code>   查看mysql进程列表执行如下SQL语句以密码登入<code>ALTER USER 'root'@'localhost' IDENTIFIED WITH mysql_native_password BY '123456';</code> <img src="https://upload-images.jianshu.io/upload_images/1863961-b53852355153eddc.JPG?imageMogr2/auto-orient/strip%7CimageView2/2/w/740" alt=""> 或者编写 test.sql 创建 <img src="https://upload-images.jianshu.io/upload_images/1863961-279c6b518995b5ab.JPG?imageMogr2/auto-orient/strip%7CimageView2/2/w/740" alt=""> source test.sql 文件 <img src="https://upload-images.jianshu.io/upload_images/1863961-89f3de8a8ea85d68.JPG?imageMogr2/auto-orient/strip%7CimageView2/2/w/740" alt=""></p><h4><span id="bian-xie-go-wen-jian">编写Go文件</span><a href="#bian-xie-go-wen-jian" class="header-anchor">#</a></h4><p>test.go 内容如下：</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">"database/sql"</span></span><br><span class="line"><span class="string">"fmt"</span></span><br><span class="line"></span><br><span class="line">_ <span class="string">"github.com/go-sql-driver/mysql"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">db, err := sql.Open(<span class="string">"mysql"</span>, <span class="string">"root:123456@/test"</span>) <span class="comment">//Linux用户名:MySQL密码@/数据库名test</span></span><br><span class="line">checkErr(err)</span><br><span class="line">stm, err := db.Prepare(<span class="string">"DROP TABLE IF EXISTS userinfo;"</span>) <span class="comment">//准备SQL语句，删除数据表</span></span><br><span class="line">checkErr(err)</span><br><span class="line">_, err = stm.Exec() <span class="comment">//Excute, 执行语句</span></span><br><span class="line">checkErr(err)</span><br><span class="line">stm, err = db.Prepare(<span class="string">`CREATE TABLE userinfo (</span></span><br><span class="line"><span class="string">                                uid INT(10) NOT NULL AUTO_INCREMENT,</span></span><br><span class="line"><span class="string">                                name VARCHAR(64) NOT NULL DEFAULT '匿名',</span></span><br><span class="line"><span class="string">                                city VARCHAR(64) NULL DEFAULT '不详',</span></span><br><span class="line"><span class="string">                                moment DATE NOT NULL DEFAULT '1949-10-10',</span></span><br><span class="line"><span class="string">                                PRIMARY KEY (uid)</span></span><br><span class="line"><span class="string">                            ) DEFAULT CHARSET=utf8;`</span>) <span class="comment">//创建数据表，设置utf8以支持中文字符</span></span><br><span class="line">checkErr(err)</span><br><span class="line">_, err = stm.Exec()</span><br><span class="line">checkErr(err)</span><br><span class="line"></span><br><span class="line"><span class="comment">//增加数据</span></span><br><span class="line">stm, err = db.Prepare(<span class="string">"INSERT userinfo SET name=?, city=?, moment=?"</span>) <span class="comment">//准备SQL语句</span></span><br><span class="line">checkErr(err)</span><br><span class="line">_, err = stm.Exec(<span class="string">"诸葛亮"</span>, <span class="string">"山东临沂"</span>, <span class="string">"234-10-8"</span>) <span class="comment">//Excute, 传入参数并执行</span></span><br><span class="line">checkErr(err)</span><br><span class="line">_, err = stm.Exec(<span class="string">"关羽"</span>, <span class="string">"山西运城"</span>, <span class="string">"220-1-1"</span>)</span><br><span class="line">checkErr(err)</span><br><span class="line">_, err = stm.Exec(<span class="string">"荀彧"</span>, <span class="string">"河南许昌"</span>, <span class="string">"212-1-1"</span>)</span><br><span class="line">checkErr(err)</span><br><span class="line"></span><br><span class="line">stm, err = db.Prepare(<span class="string">"INSERT userinfo SET city=?"</span>)</span><br><span class="line">checkErr(err)</span><br><span class="line">res, err := stm.Exec(<span class="string">"河南禹州"</span>)</span><br><span class="line">id, err := res.LastInsertId()</span><br><span class="line">checkErr(err)</span><br><span class="line">fmt.Println(<span class="string">"最后插入的用户序号为:"</span>, id)</span><br><span class="line"></span><br><span class="line"><span class="comment">//查询数据</span></span><br><span class="line">rows, err := db.Query(<span class="string">"SELECT * FROM userinfo"</span>)</span><br><span class="line">checkErr(err)</span><br><span class="line">fmt.Println(<span class="string">"打印数据表的每行信息:"</span>)</span><br><span class="line">fmt.Println(<span class="string">"---------------------"</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> rows.Next() &#123;</span><br><span class="line"><span class="keyword">var</span> uid <span class="keyword">int</span></span><br><span class="line"><span class="keyword">var</span> name <span class="keyword">string</span></span><br><span class="line"><span class="keyword">var</span> city <span class="keyword">string</span></span><br><span class="line"><span class="keyword">var</span> moment <span class="keyword">string</span></span><br><span class="line">err = rows.Scan(&amp;uid, &amp;name, &amp;city, &amp;moment)</span><br><span class="line">checkErr(err)</span><br><span class="line"></span><br><span class="line">fmt.Print(uid, <span class="string">" "</span>)</span><br><span class="line">fmt.Print(name, <span class="string">" "</span>)</span><br><span class="line">fmt.Print(city, <span class="string">" "</span>)</span><br><span class="line">fmt.Println(moment)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//删除数据</span></span><br><span class="line">stm, err = db.Prepare(<span class="string">"DELETE FROM userinfo WHERE uid=?"</span>)</span><br><span class="line">checkErr(err)</span><br><span class="line">res, err = stm.Exec(<span class="number">2</span>)</span><br><span class="line">checkErr(err)</span><br><span class="line">fmt.Println(<span class="string">"删除了第2行"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">//更改数据</span></span><br><span class="line">stm, err = db.Prepare(<span class="string">"UPDATE userinfo SET name=? WHERE uid=? OR uid=?"</span>)</span><br><span class="line">checkErr(err)</span><br><span class="line">res, err = stm.Exec(<span class="string">"郭嘉"</span>, id<span class="number">-1</span>, id)</span><br><span class="line">checkErr(err)</span><br><span class="line">affect, err := res.RowsAffected()</span><br><span class="line">checkErr(err)</span><br><span class="line">fmt.Println(<span class="string">"总共有"</span>, affect, <span class="string">"行的信息发生了更改"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">//查询数据</span></span><br><span class="line">rows, err = db.Query(<span class="string">"SELECT * FROM userinfo"</span>)</span><br><span class="line">checkErr(err)</span><br><span class="line">fmt.Println(<span class="string">"打印数据表的每行信息:"</span>)</span><br><span class="line">fmt.Println(<span class="string">"---------------------"</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> rows.Next() &#123;</span><br><span class="line"><span class="keyword">var</span> uid <span class="keyword">int</span></span><br><span class="line"><span class="keyword">var</span> name <span class="keyword">string</span></span><br><span class="line"><span class="keyword">var</span> city <span class="keyword">string</span></span><br><span class="line"><span class="keyword">var</span> moment <span class="keyword">string</span></span><br><span class="line">err = rows.Scan(&amp;uid, &amp;name, &amp;city, &amp;moment)</span><br><span class="line">checkErr(err)</span><br><span class="line"></span><br><span class="line">fmt.Print(uid, <span class="string">" "</span>)</span><br><span class="line">fmt.Print(name, <span class="string">" "</span>)</span><br><span class="line">fmt.Print(city, <span class="string">" "</span>)</span><br><span class="line">fmt.Println(moment)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">db.Close()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">checkErr</span>(<span class="params">err error</span>)</span> &#123;</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="built_in">panic</span>(err)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>运行结果： <img src="https://upload-images.jianshu.io/upload_images/1863961-ab78626ef24500f9.JPG?imageMogr2/auto-orient/strip%7CimageView2/2/w/740" alt=""> 进入MySQL查看数据表： <img src="https://upload-images.jianshu.io/upload_images/1863961-135e838917e196c5.JPG?imageMogr2/auto-orient/strip%7CimageView2/2/w/740" alt=""></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;link rel=&quot;stylesheet&quot; class=&quot;aplayer-secondary-style-marker&quot; href=&quot;/assets/css/APlayer.min.css&quot;&gt;&lt;script src=&quot;/assets/js/APlayer.min.js&quot; cla
      
    
    </summary>
    
    
      <category term="Golang" scheme="https://hejtao.netlify.com/tags/Golang/"/>
    
      <category term="MySQL" scheme="https://hejtao.netlify.com/tags/MySQL/"/>
    
  </entry>
  
  <entry>
    <title>大话数据结构</title>
    <link href="https://hejtao.netlify.com/2018/12/20/2018-12-20/"/>
    <id>https://hejtao.netlify.com/2018/12/20/2018-12-20/</id>
    <published>2018-12-20T15:04:00.000Z</published>
    <updated>2019-11-11T19:59:33.200Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><meta name="referrer" content="no-referrer"><div class="toc"><!-- toc --><ul><li><a href="#3-4-shun-xu-cun-chu-jie-gou">3.4 顺序存储结构</a></li><li><a href="#3-6-lian-shi-cun-chu-jie-gou">3.6 链式存储结构</a></li><li><a href="#3-11-dan-lian-biao-jie-gou-yu-shun-xu-cun-chu-jie-gou">3.11 单链表结构与顺序存储结构</a></li><li><a href="#3-12-jing-tai-lian-biao">3.12 静态链表</a></li><li><a href="#3-13-xun-huan-lian-biao">3.13 循环链表</a></li><li><a href="#3-14-shuang-xiang-lian-biao">3.14 双向链表</a></li><li><a href="#4-2-zhan">4.2 栈</a></li><li><a href="#4-10-dui-lie">4.10 队列</a></li><li><a href="#4-12-xun-huan-dui-lie">4.12 循环队列</a></li><li><a href="#6-4-shu-de-cun-chu-jie-gou">6.4 树的存储结构</a><ul><li><a href="#6-5-2-te-shu-er-cha-shu">6.5.2 特殊二叉树</a></li></ul></li><li><a href="#6-6-er-cha-shu-xing-zhi">6.6 二叉树性质</a></li><li><a href="#6-8-bian-li-er-cha-shu">6.8 遍历二叉树</a></li><li><a href="#6-8-6-tui-dao-bian-li-jie-guo">6.8.6 推导遍历结果</a></li><li><a href="#6-10-xian-suo-er-cha-shu">6.10 线索二叉树</a><ul><li><a href="#6-11-1-shu-zhuan-huan-wei-er-cha-shu">6.11.1 树转换为二叉树</a></li></ul></li><li><a href="#6-12-he-fu-man-shu">6.12 <strong>赫夫曼树</strong></a><ul><li><a href="#7-4-1-lin-jie-ju-zhen-adjacency-matrix">7.4.1 <strong>邻接矩阵</strong>(adjacency matrix)</a></li><li><a href="#7-4-2-lin-jie-biao">7.4.2 <strong>邻接表</strong></a></li><li><a href="#7-5-1-shen-du-you-xian-bian-li-depth-first-search">7.5.1 <strong>深度优先遍历</strong>(Depth First Search)</a></li><li><a href="#7-5-2-guang-du-you-xian-bian-li-breadth-first-search">7.5.2 <strong>广度优先遍历</strong>(Breadth First Search)</a></li><li><a href="#8-4-1-er-fen-cha-zhao">8.4.1 二分查找</a></li></ul></li><li><a href="#8-6-er-cha-cha-zhao-shu-binary-sort-tree">8.6 二叉查找树(Binary Sort Tree)</a><ul><li><a href="#8-6-2-er-cha-cha-zhao-shu-cha-ru">8.6.2 二叉查找树插入</a></li><li><a href="#8-6-3-er-cha-cha-zhao-shu-shan-chu">8.6.3 二叉查找树删除</a></li></ul></li><li><a href="#8-7-ping-heng-er-cha-shu-avl-shu">8.7 平衡二叉树(AVL树)</a><ul><li><a href="#9-2-1-pai-xu-de-wen-ding-xing">9.2.1 排序的稳定性</a></li><li><a href="#9-2-2-nei-pai-xu-he-wai-pai-xu">9.2.2 内排序和外排序</a></li><li><a href="#9-3-2-mou-pao-pai-xu-suan-fa-bubble-sort">9.3.2 冒泡排序算法(Bubble Sort)</a></li><li><a href="#9-3-3-mou-pao-pai-xu-you-hua">9.3.3 冒泡排序优化</a></li></ul></li></ul><ul><li><a href="#9-4-1-jian-dan-xuan-ze-pai-xu-simple-selection-sort">9.4.1 简单选择排序(Simple Selection Sort)</a><ul><li><a href="#9-5-1-zhi-jie-cha-ru-pai-xu-straight-insertion-sort">9.5.1 直接插入排序(Straight Insertion Sort)</a></li></ul><ul><li><a href="#9-6-xi-er-pai-xu-shell-sort">9.6 希尔排序(Shell Sort)</a></li><li><a href="#9-7-dui-pai-xu">9.7 堆排序</a></li><li><a href="#9-8-gui-bing-pai-xu">9.8 归并排序</a></li><li><a href="#9-9-kuai-su-pai-xu">9.9 快速排序</a></li></ul></li></ul><!-- tocstop --></div><h4><span id="3-4-shun-xu-cun-chu-jie-gou">3.4 顺序存储结构</span><a href="#3-4-shun-xu-cun-chu-jie-gou" class="header-anchor">#</a></h4><p>数值data(起始位置)；数组长度MaxSize；线性表长度lengthLOC($a_{i}$)=LOC($a_{1}$)+(i-1)c</p><h4><span id="3-6-lian-shi-cun-chu-jie-gou">3.6 链式存储结构</span><a href="#3-6-lian-shi-cun-chu-jie-gou" class="header-anchor">#</a></h4><p><strong>单链表</strong>，每个节点只包含一个指针域头指针，头节点，第一个节点</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">"fmt"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Node <span class="keyword">struct</span> &#123;</span><br><span class="line">data <span class="keyword">string</span></span><br><span class="line">next *Node</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> LinkList <span class="keyword">struct</span> &#123;</span><br><span class="line">length <span class="keyword">int</span></span><br><span class="line">head   *Node</span><br><span class="line">rear   *Node</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewLinkList</span>(<span class="params">head *Node</span>) *<span class="title">LinkList</span></span> &#123;</span><br><span class="line"><span class="keyword">return</span> &amp;LinkList&#123;<span class="number">0</span>, head, head&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> (<span class="params">this *LinkList</span>) <span class="title">Append</span>(<span class="params">data <span class="keyword">string</span></span>)</span> &#123;</span><br><span class="line"><span class="keyword">if</span> this.rear == <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line">node := &amp;Node&#123;data: data&#125;</span><br><span class="line"></span><br><span class="line">this.rear.next = node</span><br><span class="line">this.rear = node</span><br><span class="line">this.length++</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> (<span class="params">this *LinkList</span>) <span class="title">Reverse</span>(<span class="params"></span>) *<span class="title">LinkList</span></span> &#123;</span><br><span class="line">head := this.head</span><br><span class="line"><span class="keyword">if</span> head == <span class="literal">nil</span> || head.next == <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> this</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> pre *Node = <span class="literal">nil</span></span><br><span class="line">cur := head.next <span class="comment">//head不为空时，当前为第1节点</span></span><br><span class="line">this.rear = head.next  <span class="comment">//第1节点不为空时，作为最后节点</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> cur != <span class="literal">nil</span> &#123;</span><br><span class="line">cur.next, pre, cur = pre, cur, cur.next</span><br><span class="line"></span><br><span class="line"><span class="comment">//buf := cur.next</span></span><br><span class="line"><span class="comment">//cur.next = pre</span></span><br><span class="line"><span class="comment">//pre = cur</span></span><br><span class="line"><span class="comment">//cur = buf</span></span><br><span class="line">&#125;</span><br><span class="line">head.next = pre <span class="comment">//指向第最后一个节点</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> this</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">head := &amp;Node&#123;&#125;</span><br><span class="line">bl := NewLinkList(head)</span><br><span class="line"></span><br><span class="line">bl.Append(<span class="string">"1"</span>)</span><br><span class="line">bl.Append(<span class="string">"2"</span>)</span><br><span class="line">bl.Append(<span class="string">"3"</span>)</span><br><span class="line">bl.Append(<span class="string">"4"</span>)</span><br><span class="line">bl.Reverse()</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> node := bl.head; node != <span class="literal">nil</span>; node = node.next &#123;</span><br><span class="line">fmt.Print(node.data, <span class="string">"  "</span>)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&gt; Output:</span><br><span class="line">command-line-arguments</span><br><span class="line">  <span class="number">4</span>  <span class="number">3</span>  <span class="number">2</span>  <span class="number">1</span></span><br></pre></td></tr></table></figure><h4><span id="3-11-dan-lian-biao-jie-gou-yu-shun-xu-cun-chu-jie-gou">3.11 单链表结构与顺序存储结构</span><a href="#3-11-dan-lian-biao-jie-gou-yu-shun-xu-cun-chu-jie-gou" class="header-anchor">#</a></h4><p>内存分配；时间复杂度(查找，插入和删除)；空间复杂度</p><h4><span id="3-12-jing-tai-lian-biao">3.12 静态链表</span><a href="#3-12-jing-tai-lian-biao" class="header-anchor">#</a></h4><h4><span id="3-13-xun-huan-lian-biao">3.13 循环链表</span><a href="#3-13-xun-huan-lian-biao" class="header-anchor">#</a></h4><p>尾指针rear头节点rear-&gt;next第一个节点rear-&gt;next-&gt;next合并：p=rearA-&gt;nextq=rearB-&gt;nextrearA-&gt;next=rearB-&gt;next-&gt;nextrearB-&gt;next=pfree(q)</p><h4><span id="3-14-shuang-xiang-lian-biao">3.14 双向链表</span><a href="#3-14-shuang-xiang-lian-biao" class="header-anchor">#</a></h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">"fmt"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Node <span class="keyword">struct</span> &#123;</span><br><span class="line">data <span class="keyword">string</span></span><br><span class="line">pre  *Node</span><br><span class="line">next *Node</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> BiLinkList <span class="keyword">struct</span> &#123;</span><br><span class="line">length <span class="keyword">int</span></span><br><span class="line">head   *Node</span><br><span class="line">rear   *Node</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewBiLinkList</span>(<span class="params">head *Node</span>) *<span class="title">BiLinkList</span></span> &#123;</span><br><span class="line"><span class="keyword">return</span> &amp;BiLinkList&#123;<span class="number">0</span>, head, head&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> (<span class="params">this *BiLinkList</span>) <span class="title">Append</span>(<span class="params">data <span class="keyword">string</span></span>)</span> &#123;</span><br><span class="line">node := &amp;Node&#123;data: data&#125;</span><br><span class="line"></span><br><span class="line">this.rear.next = node</span><br><span class="line">node.pre = this.rear</span><br><span class="line">this.rear = node</span><br><span class="line">this.length++</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> (<span class="params">this *BiLinkList</span>) <span class="title">InsertNext</span>(<span class="params">p *Node, e <span class="keyword">string</span></span>)</span> &#123;</span><br><span class="line"><span class="comment">//省略判断 nd 不为空且属于链表</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> p.next == <span class="literal">nil</span> &#123;</span><br><span class="line">this.Append(e)</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">s := &amp;Node&#123;data: e&#125;</span><br><span class="line">s.pre = p</span><br><span class="line">s.next = p.next</span><br><span class="line">p.next.pre = s</span><br><span class="line">p.next = s</span><br><span class="line">&#125;</span><br><span class="line">this.length++</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">head := &amp;Node&#123;&#125;</span><br><span class="line">bl := NewBiLinkList(head)</span><br><span class="line"></span><br><span class="line">bl.Append(<span class="string">"1"</span>)</span><br><span class="line">bl.Append(<span class="string">"2"</span>)</span><br><span class="line">bl.Append(<span class="string">"3"</span>)</span><br><span class="line"></span><br><span class="line">bl.InsertNext(head.next.next, <span class="string">"2.5"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">//for i := 0; i &lt; bl.length; i++ &#123;</span></span><br><span class="line"><span class="comment">//fmt.Print(head.next.data, "  ")</span></span><br><span class="line"><span class="comment">//head = head.next</span></span><br><span class="line"><span class="comment">//&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> node := bl.head; node.next != <span class="literal">nil</span>; node = node.next &#123;</span><br><span class="line">fmt.Print(node.data, <span class="string">"  "</span>)</span><br><span class="line">&#125;</span><br><span class="line">fmt.Print(bl.rear.data)  <span class="comment">//打印末节点</span></span><br><span class="line">&#125;</span><br><span class="line">&gt; Output:</span><br><span class="line">command-line-arguments</span><br><span class="line">  <span class="number">1</span>  <span class="number">2</span>  <span class="number">2.5</span>  <span class="number">3</span></span><br></pre></td></tr></table></figure><p>使用标准库</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">"container/list"</span></span><br><span class="line"><span class="string">"fmt"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">bl := list.New()</span><br><span class="line"><span class="keyword">for</span> i := <span class="number">1</span>; i &lt; <span class="number">4</span>; i++ &#123;</span><br><span class="line">bl.PushBack(i)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">head := bl.Front()</span><br><span class="line">rear := bl.Back()</span><br><span class="line"><span class="keyword">for</span> p := head; p != rear; p = p.Next() &#123;</span><br><span class="line">fmt.Print(p.Value, <span class="string">"  "</span>)</span><br><span class="line">&#125;</span><br><span class="line">fmt.Print(rear.Value)</span><br><span class="line">&#125;</span><br><span class="line">&gt; Output:</span><br><span class="line">command-line-arguments</span><br><span class="line"><span class="number">1</span>  <span class="number">2</span>  <span class="number">3</span></span><br></pre></td></tr></table></figure><h4><span id="4-2-zhan">4.2 栈</span><a href="#4-2-zhan" class="header-anchor">#</a></h4><p>123依次进栈，出栈次序不可能有312(12同时在栈中,2一定先出)s-&gt;top 栈顶指针栈顶指针为-1表示控栈s-&gt;data[s-&gt;top]栈顶元素</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Stack <span class="keyword">struct</span> &#123; <span class="comment">//用于存放 int 的栈</span></span><br><span class="line">nums []<span class="keyword">int</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> (<span class="params">this *Stack</span>) <span class="title">Push</span>(<span class="params">n <span class="keyword">int</span></span>)</span> &#123;</span><br><span class="line">this.nums = <span class="built_in">append</span>(this.nums, n)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> (<span class="params">this *Stack</span>) <span class="title">Pop</span>(<span class="params"></span>) <span class="title">int</span></span> &#123;</span><br><span class="line">res := this.nums[<span class="built_in">len</span>(this.nums)<span class="number">-1</span>]</span><br><span class="line">this.nums = this.nums[:<span class="built_in">len</span>(this.nums)<span class="number">-1</span>]</span><br><span class="line"><span class="keyword">return</span> res</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4><span id="4-10-dui-lie">4.10 队列</span><a href="#4-10-dui-lie" class="header-anchor">#</a></h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Queue <span class="keyword">struct</span> &#123; <span class="comment">//Queue 是用于存放 int 的队列</span></span><br><span class="line">nums []<span class="keyword">int</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> (<span class="params">this *Queue</span>) <span class="title">Push</span>(<span class="params">n <span class="keyword">int</span></span>)</span> &#123;</span><br><span class="line">this.nums = <span class="built_in">append</span>(this.nums, n)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> (<span class="params">this *Queue</span>) <span class="title">Pop</span>(<span class="params"></span>) <span class="title">int</span></span> &#123;</span><br><span class="line">res := this.nums[<span class="number">0</span>]</span><br><span class="line">this.nums = this.nums[<span class="number">1</span>:]</span><br><span class="line"><span class="keyword">return</span> res</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4><span id="4-12-xun-huan-dui-lie">4.12 循环队列</span><a href="#4-12-xun-huan-dui-lie" class="header-anchor">#</a></h4><p>队列满的条件: <strong>(rear+1)%QueueSize == front</strong>队列长度:<strong>(rear-front+QueueSize)%QueueSize</strong></p><h4><span id="6-4-shu-de-cun-chu-jie-gou">6.4 树的存储结构</span><a href="#6-4-shu-de-cun-chu-jie-gou" class="header-anchor">#</a></h4><p>双亲表示(数组)，孩子兄弟表示(数组)，孩子表示(数组+链表)</p><h5><span id="6-5-2-te-shu-er-cha-shu">6.5.2 特殊二叉树</span><a href="#6-5-2-te-shu-er-cha-shu" class="header-anchor">#</a></h5><p>斜树，满二叉树，完全二叉树</p><h4><span id="6-6-er-cha-shu-xing-zhi">6.6 二叉树性质</span><a href="#6-6-er-cha-shu-xing-zhi" class="header-anchor">#</a></h4><p>总结点数：$n=n_{0}+n_{1}+n_{2}$分支线总数： $n-1=n_{1}+2n_{2}$完全二叉树深度：$[log_{2}n]+1$完全二叉树按层序排号：节点$i$的左节点为$2i$</p><h4><span id="6-8-bian-li-er-cha-shu">6.8 遍历二叉树</span><a href="#6-8-bian-li-er-cha-shu" class="header-anchor">#</a></h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">"fmt"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> BinaryTree <span class="keyword">struct</span> &#123;</span><br><span class="line">data  <span class="keyword">string</span></span><br><span class="line">left  *BinaryTree</span><br><span class="line">right *BinaryTree</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">PreOrderRec</span>(<span class="params">bt *BinaryTree</span>)</span> &#123; <span class="comment">//前序</span></span><br><span class="line"><span class="keyword">if</span> bt == <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">fmt.Print(bt.data, <span class="string">" "</span>)</span><br><span class="line">PreOrderRec(bt.left)</span><br><span class="line">PreOrderRec(bt.right)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">MidOrderRec</span>(<span class="params">bt *BinaryTree</span>)</span> &#123; <span class="comment">//中序</span></span><br><span class="line"><span class="keyword">if</span> bt == <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">MidOrderRec(bt.left)</span><br><span class="line">fmt.Print(bt.data, <span class="string">" "</span>)</span><br><span class="line">MidOrderRec(bt.right)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">PostOrderRec</span>(<span class="params">bt *BinaryTree</span>)</span> &#123; <span class="comment">//后序</span></span><br><span class="line"><span class="keyword">if</span> bt == <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">PostOrderRec(bt.left)</span><br><span class="line">PostOrderRec(bt.right)</span><br><span class="line">fmt.Print(bt.data, <span class="string">" "</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">node9 := &amp;BinaryTree&#123;data: <span class="string">"I"</span>&#125;</span><br><span class="line">node8 := &amp;BinaryTree&#123;data: <span class="string">"H"</span>&#125;</span><br><span class="line">node7 := &amp;BinaryTree&#123;data: <span class="string">"G"</span>&#125;</span><br><span class="line">node6 := &amp;BinaryTree&#123;data: <span class="string">"F"</span>&#125;</span><br><span class="line">node5 := &amp;BinaryTree&#123;data: <span class="string">"E"</span>, right: node9&#125;</span><br><span class="line">node4 := &amp;BinaryTree&#123;<span class="string">"D"</span>, node7, node8&#125;</span><br><span class="line">node3 := &amp;BinaryTree&#123;<span class="string">"C"</span>, node5, node6&#125;</span><br><span class="line">node2 := &amp;BinaryTree&#123;data: <span class="string">"B"</span>, left: node4&#125;</span><br><span class="line">root := &amp;BinaryTree&#123;<span class="string">"A"</span>, node2, node3&#125;</span><br><span class="line"></span><br><span class="line">PreOrderRec(root)</span><br><span class="line">fmt.Println()</span><br><span class="line">MidOrderRec(root)</span><br><span class="line">fmt.Println()</span><br><span class="line">PostOrderRec(root)</span><br><span class="line">&#125;</span><br><span class="line">&gt; Output:</span><br><span class="line">command-line-arguments</span><br><span class="line">A B D G H C E I F </span><br><span class="line">G D H B A E I C F </span><br><span class="line">G H D B I E F C A</span><br></pre></td></tr></table></figure><h4><span id="6-8-6-tui-dao-bian-li-jie-guo">6.8.6 推导遍历结果</span><a href="#6-8-6-tui-dao-bian-li-jie-guo" class="header-anchor">#</a></h4><p>前序遍历序列+中序遍历序列-&gt;二叉树后序遍历序列+中序遍历序列-&gt;二叉树前中后：BAC ABC ACB</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">"fmt"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> BinaryTree <span class="keyword">struct</span> &#123;</span><br><span class="line">data  <span class="keyword">string</span></span><br><span class="line">left  *BinaryTree</span><br><span class="line">right *BinaryTree</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">PreOrderRec</span>(<span class="params">bt *BinaryTree</span>)</span> &#123; <span class="comment">//前序</span></span><br><span class="line"><span class="keyword">if</span> bt == <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">fmt.Print(bt.data, <span class="string">" "</span>)</span><br><span class="line">PreOrderRec(bt.left)</span><br><span class="line">PreOrderRec(bt.right)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">MidOrderRec</span>(<span class="params">bt *BinaryTree</span>)</span> &#123; <span class="comment">//中序</span></span><br><span class="line"><span class="keyword">if</span> bt == <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">MidOrderRec(bt.left)</span><br><span class="line">fmt.Print(bt.data, <span class="string">" "</span>)</span><br><span class="line">MidOrderRec(bt.right)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">PostOrderRec</span>(<span class="params">bt *BinaryTree</span>)</span> &#123; <span class="comment">//后序</span></span><br><span class="line"><span class="keyword">if</span> bt == <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">PostOrderRec(bt.left)</span><br><span class="line">PostOrderRec(bt.right)</span><br><span class="line">fmt.Print(bt.data, <span class="string">" "</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">PreMid2Tree</span>(<span class="params">pre, mid []<span class="keyword">string</span></span>) *<span class="title">BinaryTree</span></span> &#123; <span class="comment">//前序+中序推导二叉树</span></span><br><span class="line"><span class="keyword">if</span> <span class="built_in">len</span>(pre) != <span class="built_in">len</span>(mid) &#123;</span><br><span class="line"><span class="built_in">panic</span>(<span class="string">"两个切片的长度不相等"</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> <span class="built_in">len</span>(mid) == <span class="number">0</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">root := &amp;BinaryTree&#123; <span class="comment">//前序第一个元素为root</span></span><br><span class="line">data: pre[<span class="number">0</span>],</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> <span class="built_in">len</span>(mid) == <span class="number">1</span> &#123;</span><br><span class="line"><span class="keyword">return</span> root</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">position := IndexOf(root.data, mid) <span class="comment">//找出root在中序的位置</span></span><br><span class="line"></span><br><span class="line">root.left = PreMid2Tree(pre[<span class="number">1</span>:position+<span class="number">1</span>], mid[:position]) <span class="comment">//递归</span></span><br><span class="line">root.right = PreMid2Tree(pre[position+<span class="number">1</span>:], mid[position+<span class="number">1</span>:])</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> root</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">IndexOf</span>(<span class="params">ele <span class="keyword">string</span>, seq []<span class="keyword">string</span></span>) <span class="title">int</span></span> &#123;</span><br><span class="line"><span class="keyword">for</span> i, v := <span class="keyword">range</span> seq &#123;</span><br><span class="line"><span class="keyword">if</span> v == ele &#123;</span><br><span class="line"><span class="keyword">return</span> i</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">panic</span>(<span class="string">"IndexOf错误，元素不存在"</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">bt := PreMid2Tree([]<span class="keyword">string</span>&#123;<span class="string">"A"</span>, <span class="string">"B"</span>, <span class="string">"D"</span>, <span class="string">"G"</span>, <span class="string">"H"</span>, <span class="string">"C"</span>, <span class="string">"E"</span>, <span class="string">"I"</span>, <span class="string">"F"</span>&#125;,</span><br><span class="line">[]<span class="keyword">string</span>&#123;<span class="string">"G"</span>, <span class="string">"D"</span>, <span class="string">"H"</span>, <span class="string">"B"</span>, <span class="string">"A"</span>, <span class="string">"E"</span>, <span class="string">"I"</span>, <span class="string">"C"</span>, <span class="string">"F"</span>&#125;)</span><br><span class="line"></span><br><span class="line">PostOrderRec(bt)</span><br><span class="line">&#125;</span><br><span class="line">&gt; Output:</span><br><span class="line">command-line-arguments</span><br><span class="line">G H D B I E F C A</span><br></pre></td></tr></table></figure><h4><span id="6-10-xian-suo-er-cha-shu">6.10 线索二叉树</span><a href="#6-10-xian-suo-er-cha-shu" class="header-anchor">#</a></h4><p>将节点的空指针改为指向在遍历序列中的前驱或后继的指针。</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> ThreadBiTree <span class="keyword">struct</span> &#123;</span><br><span class="line">    data  <span class="keyword">string</span></span><br><span class="line">    left  *ThreadBiTree</span><br><span class="line">    right *ThreadBiTree</span><br><span class="line">    lTag  *ThreadBiTree <span class="comment">//一个bit位，区分是指向孩子还是线索</span></span><br><span class="line">    rTag  *ThreadBiTree</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> pre *ThreadBiTree <span class="comment">//保存前驱</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">MidThreading</span>(<span class="params">bt *ThreadBiTree</span>)</span> &#123; <span class="comment">//中序遍历线索化</span></span><br><span class="line">    <span class="keyword">if</span> bt == <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    MidThreading(bt.left)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> bt.left == <span class="literal">nil</span> &#123; <span class="comment">//若bt有左空指针，则把pre设为bt的前驱，并设置标志位</span></span><br><span class="line">        bt.left = pre</span><br><span class="line">        bt.lTag = <span class="number">1</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> bt.right == <span class="literal">nil</span> &#123; <span class="comment">//若bt有右空指针，则把bt设为pre的后继，并设置标志位</span></span><br><span class="line">        pre.right = bt</span><br><span class="line">        pre.rTag = <span class="number">1</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    pre = bt</span><br><span class="line"></span><br><span class="line">    MidThreading(bt.right)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5><span id="6-11-1-shu-zhuan-huan-wei-er-cha-shu">6.11.1 树转换为二叉树</span><a href="#6-11-1-shu-zhuan-huan-wei-er-cha-shu" class="header-anchor">#</a></h5><p>兄弟连线；只保留第一个孩子的连线</p><h4><span id="6-12-he-fu-man-shu">6.12 <strong>赫夫曼树</strong></span><a href="#6-12-he-fu-man-shu" class="header-anchor">#</a></h4><p>带权路径长度(WPL)最小的二叉树<img src="https://upload-images.jianshu.io/upload_images/1863961-81d44580cf5163ee.JPG?imageMogr2/auto-orient/strip%7CimageView2/2/w/640" alt="Huffman Tree"></p><p>WPL(a)= 5<em>1+15</em>2+40<em>3+30</em>4+10<em>4WPL(b)= 5</em>3+15<em>3+40</em>2+30<em>2+10</em>2</p><p>构造<img src="https://upload-images.jianshu.io/upload_images/1863961-1acee79132eab45b.JPG?imageMogr2/auto-orient/strip%7CimageView2/2/w/640" alt=""></p><p>排序：A5, E10, B15, D30, C40</p><h5><span id="7-4-1-lin-jie-ju-zhen-adjacency-matrix">7.4.1 <strong>邻接矩阵</strong>(adjacency matrix)</span><a href="#7-4-1-lin-jie-ju-zhen-adjacency-matrix" class="header-anchor">#</a></h5><p>无向图：<img src="https://upload-images.jianshu.io/upload_images/1863961-d9ce3ee2d67e574e.JPG?imageMogr2/auto-orient/strip%7CimageView2/2/w/640" alt=""></p><p>有向图：<img src="https://upload-images.jianshu.io/upload_images/1863961-d915f439c8959688.JPG?imageMogr2/auto-orient/strip%7CimageView2/2/w/640" alt=""></p><p>有向网：<img src="https://upload-images.jianshu.io/upload_images/1863961-f214b0dd61c11ca3.JPG?imageMogr2/auto-orient/strip%7CimageView2/2/w/640" alt=""></p><p>无向网的实现：</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">"fmt"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> (</span><br><span class="line">INFINITY <span class="keyword">int32</span> = <span class="number">65536</span> <span class="comment">// 无穷</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Edge <span class="keyword">struct</span> &#123; <span class="comment">//边的顶点和权值</span></span><br><span class="line">v0     <span class="keyword">string</span></span><br><span class="line">v1     <span class="keyword">string</span></span><br><span class="line">weight <span class="keyword">int32</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Graph <span class="keyword">struct</span> &#123; <span class="comment">//无向网</span></span><br><span class="line">v []<span class="keyword">string</span> <span class="comment">//顶点数组</span></span><br><span class="line">e []Edge   <span class="comment">//边的权值</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">IndexOfVertex</span>(<span class="params">vs []<span class="keyword">string</span>, v <span class="keyword">string</span></span>) <span class="title">int</span></span> &#123; <span class="comment">//顶点在顶点数组的位置</span></span><br><span class="line"><span class="keyword">for</span> i, value := <span class="keyword">range</span> vs &#123;</span><br><span class="line"><span class="keyword">if</span> value == v &#123;</span><br><span class="line"><span class="keyword">return</span> i</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">panic</span>(<span class="string">"边的顶点不在顶点数组中！"</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> (<span class="params">this *Graph</span>) <span class="title">AdjMatrix</span>(<span class="params"></span>) [][]<span class="title">int32</span></span> &#123;</span><br><span class="line">vertexNum := <span class="built_in">len</span>(this.v)</span><br><span class="line"></span><br><span class="line">adjM := <span class="built_in">make</span>([][]<span class="keyword">int32</span>, vertexNum) <span class="comment">//生成矩阵用两次make()</span></span><br><span class="line"><span class="keyword">for</span> i := <span class="number">0</span>; i &lt; vertexNum; i++ &#123;   <span class="comment">//初始化</span></span><br><span class="line">adjM[i] = <span class="built_in">make</span>([]<span class="keyword">int32</span>, vertexNum)</span><br><span class="line"><span class="keyword">for</span> j := <span class="number">0</span>; j &lt; vertexNum; j++ &#123;</span><br><span class="line"><span class="keyword">if</span> j == i &#123;</span><br><span class="line">adjM[i][j] = <span class="number">0</span></span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">adjM[i][j] = INFINITY</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">e := this.e</span><br><span class="line">v := this.v</span><br><span class="line"><span class="keyword">for</span> _, edge := <span class="keyword">range</span> e &#123;</span><br><span class="line">adjM[IndexOfVertex(v, edge.v0)][IndexOfVertex(v, edge.v1)] = edge.weight</span><br><span class="line">adjM[IndexOfVertex(v, edge.v1)][IndexOfVertex(v, edge.v0)] = edge.weight <span class="comment">//因为是无向图所以是对称矩阵</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> adjM</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">v := []<span class="keyword">string</span>&#123;<span class="string">"A"</span>, <span class="string">"B"</span>, <span class="string">"C"</span>, <span class="string">"D"</span>&#125;</span><br><span class="line">e := []Edge&#123;</span><br><span class="line">Edge&#123;<span class="string">"A"</span>, <span class="string">"B"</span>, <span class="number">5</span>&#125;,</span><br><span class="line">Edge&#123;<span class="string">"A"</span>, <span class="string">"C"</span>, <span class="number">3</span>&#125;,</span><br><span class="line">Edge&#123;<span class="string">"A"</span>, <span class="string">"D"</span>, <span class="number">6</span>&#125;,</span><br><span class="line">Edge&#123;<span class="string">"B"</span>, <span class="string">"C"</span>, <span class="number">7</span>&#125;,</span><br><span class="line">Edge&#123;<span class="string">"C"</span>, <span class="string">"D"</span>, <span class="number">9</span>&#125;,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">graph := &amp;Graph&#123;v, e&#125; <span class="comment">//生成无向网</span></span><br><span class="line"></span><br><span class="line">fmt.Println(graph.AdjMatrix())</span><br><span class="line"><span class="comment">//     A    B     C    D</span></span><br><span class="line"><span class="comment">//A [  0    5      3    6   ]</span></span><br><span class="line"><span class="comment">//B [  5    0      7  65536 ]</span></span><br><span class="line"><span class="comment">//C [  3    7      0    9   ]</span></span><br><span class="line"><span class="comment">//D [  6  65536    9    0   ]</span></span><br><span class="line">&#125;</span><br><span class="line">&gt; Output:</span><br><span class="line">command-line-arguments</span><br><span class="line">[[<span class="number">0</span> <span class="number">5</span> <span class="number">3</span> <span class="number">6</span>] [<span class="number">5</span> <span class="number">0</span> <span class="number">7</span> <span class="number">65536</span>] [<span class="number">3</span> <span class="number">7</span> <span class="number">0</span> <span class="number">9</span>] [<span class="number">6</span> <span class="number">65536</span> <span class="number">9</span> <span class="number">0</span>]]</span><br></pre></td></tr></table></figure><h5><span id="7-4-2-lin-jie-biao">7.4.2 <strong>邻接表</strong></span><a href="#7-4-2-lin-jie-biao" class="header-anchor">#</a></h5><p>无向图：<img src="https://upload-images.jianshu.io/upload_images/1863961-a0854989cc6149ef.JPG?imageMogr2/auto-orient/strip%7CimageView2/2/w/640" alt=""></p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">"fmt"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Edge <span class="keyword">struct</span> &#123; <span class="comment">//给定顶点定义边</span></span><br><span class="line">v0 <span class="keyword">string</span></span><br><span class="line">v1 <span class="keyword">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Graph <span class="keyword">struct</span> &#123; <span class="comment">//无向图</span></span><br><span class="line">v []<span class="keyword">string</span> <span class="comment">//顶点数组</span></span><br><span class="line">e []Edge   <span class="comment">//边数组</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Node <span class="keyword">struct</span> &#123; <span class="comment">//邻接表的边表节点</span></span><br><span class="line">adjvex <span class="keyword">int</span></span><br><span class="line">next   *Node</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Vertex <span class="keyword">struct</span> &#123; <span class="comment">//邻接表的顶点</span></span><br><span class="line">data      <span class="keyword">string</span></span><br><span class="line">firstedge *Node</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> LinkList <span class="keyword">struct</span> &#123; <span class="comment">//邻接表的链表</span></span><br><span class="line">head *Vertex</span><br><span class="line">rear *Node</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> (<span class="params">this *LinkList</span>) <span class="title">Append</span>(<span class="params">adjvex <span class="keyword">int</span></span>)</span> &#123;</span><br><span class="line">newNode := &amp;Node&#123;adjvex: adjvex&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> this.rear == <span class="literal">nil</span> &#123;</span><br><span class="line">this.head.firstedge = newNode</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">this.rear.next = newNode</span><br><span class="line">this.rear = newNode</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">this.rear = newNode</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">IndexOfVertex</span>(<span class="params">vs []<span class="keyword">string</span>, v <span class="keyword">string</span></span>) <span class="title">int</span></span> &#123; <span class="comment">//顶点在顶点数组的位置</span></span><br><span class="line"><span class="keyword">for</span> i, value := <span class="keyword">range</span> vs &#123;</span><br><span class="line"><span class="keyword">if</span> value == v &#123;</span><br><span class="line"><span class="keyword">return</span> i</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">panic</span>(<span class="string">"边的顶点不在顶点数组中！"</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> (<span class="params">this *Graph</span>) <span class="title">AdjList</span>(<span class="params"></span>) []<span class="title">LinkList</span></span> &#123;</span><br><span class="line">vertexNum := <span class="built_in">len</span>(this.v)</span><br><span class="line">v := this.v</span><br><span class="line">e := this.e</span><br><span class="line"></span><br><span class="line">adjL := <span class="built_in">make</span>([]LinkList, vertexNum) <span class="comment">//用一个单向链表的数组来表示邻接表</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//for i := 0; i &lt; vertexNum; i++ &#123; //初始</span></span><br><span class="line"><span class="comment">//  adjL[i].head.data = v[i]                因为此时head为nil，没有data字段</span></span><br><span class="line"><span class="comment">//&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i := <span class="number">0</span>; i &lt; vertexNum; i++ &#123; <span class="comment">//初始</span></span><br><span class="line">adjL[i].head = &amp;Vertex&#123;data: v[i]&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> _, edge := <span class="keyword">range</span> e &#123;</span><br><span class="line">i := IndexOfVertex(v, edge.v0)</span><br><span class="line">j := IndexOfVertex(v, edge.v1)</span><br><span class="line">adjL[i].Append(j)</span><br><span class="line">adjL[j].Append(i)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> adjL</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">v := []<span class="keyword">string</span>&#123;<span class="string">"v0"</span>, <span class="string">"v1"</span>, <span class="string">"v2"</span>, <span class="string">"v3"</span>&#125;</span><br><span class="line">e := []Edge&#123;</span><br><span class="line">Edge&#123;<span class="string">"v0"</span>, <span class="string">"v1"</span>&#125;,</span><br><span class="line">Edge&#123;<span class="string">"v0"</span>, <span class="string">"v2"</span>&#125;,</span><br><span class="line">Edge&#123;<span class="string">"v0"</span>, <span class="string">"v3"</span>&#125;,</span><br><span class="line">Edge&#123;<span class="string">"v1"</span>, <span class="string">"v2"</span>&#125;,</span><br><span class="line">Edge&#123;<span class="string">"v2"</span>, <span class="string">"v3"</span>&#125;,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">graph := &amp;Graph&#123;v, e&#125; <span class="comment">//生成无向图</span></span><br><span class="line"></span><br><span class="line">adjL := graph.AdjList()</span><br><span class="line"><span class="keyword">for</span> _, v := <span class="keyword">range</span> adjL &#123;</span><br><span class="line">fmt.Print(v.head.data, <span class="string">" "</span>)</span><br><span class="line"><span class="keyword">for</span> node := v.head.firstedge; node != <span class="literal">nil</span>; node = node.next &#123;</span><br><span class="line">fmt.Print(node.adjvex, <span class="string">" "</span>)</span><br><span class="line">&#125;</span><br><span class="line">fmt.Println()</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&gt; Output:</span><br><span class="line">command-line-arguments</span><br><span class="line">v0 <span class="number">1</span> <span class="number">2</span> <span class="number">3</span> </span><br><span class="line">v1 <span class="number">0</span> <span class="number">2</span> </span><br><span class="line">v2 <span class="number">0</span> <span class="number">1</span> <span class="number">3</span> </span><br><span class="line">v3 <span class="number">0</span> <span class="number">2</span></span><br></pre></td></tr></table></figure><p>有向网：<img src="https://upload-images.jianshu.io/upload_images/1863961-95004e37703686d9.JPG?imageMogr2/auto-orient/strip%7CimageView2/2/w/640" alt=""></p><h5><span id="7-5-1-shen-du-you-xian-bian-li-depth-first-search">7.5.1 <strong>深度优先遍历</strong>(Depth First Search)</span><a href="#7-5-1-shen-du-you-xian-bian-li-depth-first-search" class="header-anchor">#</a></h5><p><img src="https://upload-images.jianshu.io/upload_images/1863961-4139cb15eb112b82.JPG?imageMogr2/auto-orient/strip%7CimageView2/2/w/640" alt=""></p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">"fmt"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> flag []<span class="keyword">bool</span> <span class="comment">//全局变量</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Edge <span class="keyword">struct</span> &#123; <span class="comment">//给定顶点定义边</span></span><br><span class="line">v0 <span class="keyword">string</span></span><br><span class="line">v1 <span class="keyword">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Graph <span class="keyword">struct</span> &#123; <span class="comment">//无向图</span></span><br><span class="line">v []<span class="keyword">string</span> <span class="comment">//顶点数组</span></span><br><span class="line">e []Edge   <span class="comment">//边数组</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> (<span class="params">this *Graph</span>) <span class="title">AdjMatrix</span>(<span class="params"></span>) [][]<span class="title">int</span></span> &#123;</span><br><span class="line">vertexNum := <span class="built_in">len</span>(this.v)</span><br><span class="line"></span><br><span class="line">adjM := <span class="built_in">make</span>([][]<span class="keyword">int</span>, vertexNum) <span class="comment">//生成矩阵用两次make()</span></span><br><span class="line"><span class="keyword">for</span> i := <span class="number">0</span>; i &lt; vertexNum; i++ &#123; <span class="comment">//初始化</span></span><br><span class="line">adjM[i] = <span class="built_in">make</span>([]<span class="keyword">int</span>, vertexNum)</span><br><span class="line"><span class="keyword">for</span> j := <span class="number">0</span>; j &lt; vertexNum; j++ &#123;</span><br><span class="line">adjM[i][j] = <span class="number">0</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">e := this.e</span><br><span class="line">v := this.v</span><br><span class="line"><span class="keyword">for</span> _, edge := <span class="keyword">range</span> e &#123;</span><br><span class="line">adjM[IndexOfVertex(v, edge.v0)][IndexOfVertex(v, edge.v1)] = <span class="number">1</span></span><br><span class="line">adjM[IndexOfVertex(v, edge.v1)][IndexOfVertex(v, edge.v0)] = <span class="number">1</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> adjM</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">IndexOfVertex</span>(<span class="params">vs []<span class="keyword">string</span>, v <span class="keyword">string</span></span>) <span class="title">int</span></span> &#123;</span><br><span class="line"><span class="keyword">for</span> i, value := <span class="keyword">range</span> vs &#123;</span><br><span class="line"><span class="keyword">if</span> value == v &#123;</span><br><span class="line"><span class="keyword">return</span> i</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">panic</span>(<span class="string">"边的顶点不在顶点数组中！"</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">DFSTraverse</span>(<span class="params">adjM [][]<span class="keyword">int</span></span>)</span> &#123; <span class="comment">//输入无向图的邻接矩阵</span></span><br><span class="line">vertexNum := <span class="built_in">len</span>(adjM)</span><br><span class="line"></span><br><span class="line">flag = <span class="built_in">make</span>([]<span class="keyword">bool</span>, vertexNum) <span class="comment">//初始化flag，注意这里不能用 :=</span></span><br><span class="line"><span class="keyword">for</span> i := <span class="number">0</span>; i &lt; vertexNum; i++ &#123;</span><br><span class="line">flag[i] = <span class="literal">false</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i := <span class="number">0</span>; i &lt; vertexNum; i++ &#123; <span class="comment">//对未访问的节点执行深度搜索</span></span><br><span class="line"><span class="keyword">if</span> !flag[i] &#123;</span><br><span class="line">DFS(vertexNum, i, adjM)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">DFS</span>(<span class="params">vertexNum <span class="keyword">int</span>, i <span class="keyword">int</span>, adjM [][]<span class="keyword">int</span></span>)</span> &#123;</span><br><span class="line">flag[i] = <span class="literal">true</span></span><br><span class="line">fmt.Print(i, <span class="string">"  "</span>)               <span class="comment">//打印被访问的节点序号</span></span><br><span class="line"><span class="keyword">for</span> j := <span class="number">0</span>; j &lt; vertexNum; j++ &#123; <span class="comment">//对未被访问的邻节点递归</span></span><br><span class="line"><span class="keyword">if</span> adjM[i][j] == <span class="number">1</span> &amp;&amp; !flag[j] &#123;</span><br><span class="line">DFS(vertexNum, j, adjM)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">v := []<span class="keyword">string</span>&#123;<span class="string">"A"</span>, <span class="string">"B"</span>, <span class="string">"C"</span>, <span class="string">"D"</span>, <span class="string">"E"</span>, <span class="string">"F"</span>, <span class="string">"G"</span>, <span class="string">"H"</span>, <span class="string">"I"</span>&#125;</span><br><span class="line">e := []Edge&#123;</span><br><span class="line">Edge&#123;<span class="string">"A"</span>, <span class="string">"B"</span>&#125;,</span><br><span class="line">Edge&#123;<span class="string">"A"</span>, <span class="string">"F"</span>&#125;,</span><br><span class="line">Edge&#123;<span class="string">"B"</span>, <span class="string">"C"</span>&#125;,</span><br><span class="line">Edge&#123;<span class="string">"B"</span>, <span class="string">"G"</span>&#125;,</span><br><span class="line">Edge&#123;<span class="string">"B"</span>, <span class="string">"I"</span>&#125;,</span><br><span class="line">Edge&#123;<span class="string">"F"</span>, <span class="string">"G"</span>&#125;,</span><br><span class="line">Edge&#123;<span class="string">"F"</span>, <span class="string">"E"</span>&#125;,</span><br><span class="line">Edge&#123;<span class="string">"C"</span>, <span class="string">"D"</span>&#125;,</span><br><span class="line">Edge&#123;<span class="string">"C"</span>, <span class="string">"I"</span>&#125;,</span><br><span class="line">Edge&#123;<span class="string">"G"</span>, <span class="string">"D"</span>&#125;,</span><br><span class="line">Edge&#123;<span class="string">"G"</span>, <span class="string">"H"</span>&#125;,</span><br><span class="line">Edge&#123;<span class="string">"E"</span>, <span class="string">"D"</span>&#125;,</span><br><span class="line">Edge&#123;<span class="string">"E"</span>, <span class="string">"H"</span>&#125;,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">graph := &amp;Graph&#123;v, e&#125; <span class="comment">//生成无向图</span></span><br><span class="line">adjM := graph.AdjMatrix()</span><br><span class="line"><span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="built_in">len</span>(adjM); i++ &#123;</span><br><span class="line">fmt.Println(adjM[i])</span><br><span class="line">&#125;</span><br><span class="line">fmt.Println(<span class="string">"-------------------"</span>)</span><br><span class="line">DFSTraverse(adjM)</span><br><span class="line">&#125;</span><br><span class="line">&gt; Output:</span><br><span class="line">command-line-arguments</span><br><span class="line">[<span class="number">0</span> <span class="number">1</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">1</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span>]</span><br><span class="line">[<span class="number">1</span> <span class="number">0</span> <span class="number">1</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">1</span> <span class="number">0</span> <span class="number">1</span>]</span><br><span class="line">[<span class="number">0</span> <span class="number">1</span> <span class="number">0</span> <span class="number">1</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">1</span>]</span><br><span class="line">[<span class="number">0</span> <span class="number">0</span> <span class="number">1</span> <span class="number">0</span> <span class="number">1</span> <span class="number">0</span> <span class="number">1</span> <span class="number">0</span> <span class="number">0</span>]</span><br><span class="line">[<span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">1</span> <span class="number">0</span> <span class="number">1</span> <span class="number">0</span> <span class="number">1</span> <span class="number">0</span>]</span><br><span class="line">[<span class="number">1</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">1</span> <span class="number">0</span> <span class="number">1</span> <span class="number">0</span> <span class="number">0</span>]</span><br><span class="line">[<span class="number">0</span> <span class="number">1</span> <span class="number">0</span> <span class="number">1</span> <span class="number">0</span> <span class="number">1</span> <span class="number">0</span> <span class="number">1</span> <span class="number">0</span>]</span><br><span class="line">[<span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">1</span> <span class="number">0</span> <span class="number">1</span> <span class="number">0</span> <span class="number">0</span>]</span><br><span class="line">[<span class="number">0</span> <span class="number">1</span> <span class="number">1</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span>]</span><br><span class="line">-------------------</span><br><span class="line"><span class="number">0</span>  <span class="number">1</span>  <span class="number">2</span>  <span class="number">3</span>  <span class="number">4</span>  <span class="number">5</span>  <span class="number">6</span>  <span class="number">7</span>  <span class="number">8</span></span><br></pre></td></tr></table></figure><h5><span id="7-5-2-guang-du-you-xian-bian-li-breadth-first-search">7.5.2 <strong>广度优先遍历</strong>(Breadth First Search)</span><a href="#7-5-2-guang-du-you-xian-bian-li-breadth-first-search" class="header-anchor">#</a></h5><p><img src="https://upload-images.jianshu.io/upload_images/1863961-1aab42f56392a97a.JPG?imageMogr2/auto-orient/strip%7CimageView2/2/w/640" alt=""></p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">"fmt"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Edge <span class="keyword">struct</span> &#123; <span class="comment">//给定顶点定义边</span></span><br><span class="line">v0 <span class="keyword">string</span></span><br><span class="line">v1 <span class="keyword">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Graph <span class="keyword">struct</span> &#123; <span class="comment">//无向图</span></span><br><span class="line">v []<span class="keyword">string</span> <span class="comment">//顶点数组</span></span><br><span class="line">e []Edge   <span class="comment">//边数组</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Node <span class="keyword">struct</span> &#123; <span class="comment">//邻接表的边表节点</span></span><br><span class="line">adjvex <span class="keyword">int</span></span><br><span class="line">next   *Node</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Vertex <span class="keyword">struct</span> &#123; <span class="comment">//邻接表的顶点</span></span><br><span class="line">data      <span class="keyword">string</span></span><br><span class="line">firstedge *Node</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> LinkList <span class="keyword">struct</span> &#123; <span class="comment">//邻接表的链表</span></span><br><span class="line">head *Vertex</span><br><span class="line">rear *Node</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Queue <span class="keyword">struct</span> &#123;</span><br><span class="line">nums []<span class="keyword">int</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> (<span class="params">this *Queue</span>) <span class="title">Push</span>(<span class="params">n <span class="keyword">int</span></span>)</span> &#123;</span><br><span class="line">this.nums = <span class="built_in">append</span>(this.nums, n)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> (<span class="params">this *Queue</span>) <span class="title">Pop</span>(<span class="params"></span>) <span class="title">int</span></span> &#123;</span><br><span class="line">res := this.nums[<span class="number">0</span>]</span><br><span class="line">this.nums = this.nums[<span class="number">1</span>:]</span><br><span class="line"><span class="keyword">return</span> res</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> (<span class="params">this *LinkList</span>) <span class="title">Append</span>(<span class="params">adjvex <span class="keyword">int</span></span>)</span> &#123;</span><br><span class="line">newNode := &amp;Node&#123;adjvex: adjvex&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> this.rear == <span class="literal">nil</span> &#123;</span><br><span class="line">this.head.firstedge = newNode</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">this.rear.next = newNode</span><br><span class="line">this.rear = newNode</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">this.rear = newNode</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">IndexOfVertex</span>(<span class="params">vs []<span class="keyword">string</span>, v <span class="keyword">string</span></span>) <span class="title">int</span></span> &#123; <span class="comment">//顶点在顶点数组的位置</span></span><br><span class="line"><span class="keyword">for</span> i, value := <span class="keyword">range</span> vs &#123;</span><br><span class="line"><span class="keyword">if</span> value == v &#123;</span><br><span class="line"><span class="keyword">return</span> i</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">panic</span>(<span class="string">"边的顶点不在顶点数组中！"</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> (<span class="params">this *Graph</span>) <span class="title">AdjList</span>(<span class="params"></span>) []<span class="title">LinkList</span></span> &#123;</span><br><span class="line">vertexNum := <span class="built_in">len</span>(this.v)</span><br><span class="line">v := this.v</span><br><span class="line">e := this.e</span><br><span class="line"></span><br><span class="line">adjL := <span class="built_in">make</span>([]LinkList, vertexNum) <span class="comment">//用一个单向链表的数组来表示邻接表</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//for i := 0; i &lt; vertexNum; i++ &#123; //初始</span></span><br><span class="line"><span class="comment">//adjL[i].head.data = v[i]                因为此时head为nil，没有data字段</span></span><br><span class="line"><span class="comment">//&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i := <span class="number">0</span>; i &lt; vertexNum; i++ &#123; <span class="comment">//初始</span></span><br><span class="line">adjL[i].head = &amp;Vertex&#123;data: v[i]&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> _, edge := <span class="keyword">range</span> e &#123;</span><br><span class="line">i := IndexOfVertex(v, edge.v0)</span><br><span class="line">j := IndexOfVertex(v, edge.v1)</span><br><span class="line">adjL[i].Append(j)</span><br><span class="line">adjL[j].Append(i)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> adjL</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">BFSTraverse</span>(<span class="params">adjL []LinkList</span>)</span> &#123; <span class="comment">//输入邻接表</span></span><br><span class="line">vertexNum := <span class="built_in">len</span>(adjL)</span><br><span class="line"></span><br><span class="line">flag := <span class="built_in">make</span>([]<span class="keyword">bool</span>, vertexNum) <span class="comment">//标记被访问的节点</span></span><br><span class="line"><span class="keyword">for</span> i := <span class="number">0</span>; i &lt; vertexNum; i++ &#123;</span><br><span class="line">flag[i] = <span class="literal">false</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Q := <span class="built_in">new</span>(Queue) <span class="comment">//队列</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i := <span class="number">0</span>; i &lt; vertexNum; i++ &#123;</span><br><span class="line"><span class="keyword">if</span> !flag[i] &#123; <span class="comment">//如果顶点未被访问</span></span><br><span class="line">flag[i] = <span class="literal">true</span></span><br><span class="line">Q.Push(i)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> <span class="built_in">len</span>(Q.nums) &gt; <span class="number">0</span> &#123; <span class="comment">//队列不为空</span></span><br><span class="line">j := Q.Pop()</span><br><span class="line">fmt.Print(adjL[j].head.data, <span class="string">" "</span>) <span class="comment">//打印节点</span></span><br><span class="line"><span class="keyword">for</span> node := adjL[j].head.firstedge; node != <span class="literal">nil</span>; node = node.next &#123;</span><br><span class="line"><span class="keyword">if</span> flag[node.adjvex] == <span class="literal">false</span> &#123;</span><br><span class="line">flag[node.adjvex] = <span class="literal">true</span></span><br><span class="line">Q.Push(node.adjvex)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">v := []<span class="keyword">string</span>&#123;<span class="string">"A"</span>, <span class="string">"B"</span>, <span class="string">"C"</span>, <span class="string">"D"</span>, <span class="string">"E"</span>, <span class="string">"F"</span>, <span class="string">"G"</span>, <span class="string">"H"</span>, <span class="string">"I"</span>&#125;</span><br><span class="line">e := []Edge&#123;</span><br><span class="line">Edge&#123;<span class="string">"A"</span>, <span class="string">"B"</span>&#125;,</span><br><span class="line">Edge&#123;<span class="string">"A"</span>, <span class="string">"F"</span>&#125;,</span><br><span class="line">Edge&#123;<span class="string">"B"</span>, <span class="string">"C"</span>&#125;,</span><br><span class="line">Edge&#123;<span class="string">"B"</span>, <span class="string">"G"</span>&#125;,</span><br><span class="line">Edge&#123;<span class="string">"B"</span>, <span class="string">"I"</span>&#125;,</span><br><span class="line">Edge&#123;<span class="string">"F"</span>, <span class="string">"G"</span>&#125;,</span><br><span class="line">Edge&#123;<span class="string">"F"</span>, <span class="string">"E"</span>&#125;,</span><br><span class="line">Edge&#123;<span class="string">"C"</span>, <span class="string">"D"</span>&#125;,</span><br><span class="line">Edge&#123;<span class="string">"C"</span>, <span class="string">"I"</span>&#125;,</span><br><span class="line">Edge&#123;<span class="string">"G"</span>, <span class="string">"D"</span>&#125;,</span><br><span class="line">Edge&#123;<span class="string">"G"</span>, <span class="string">"H"</span>&#125;,</span><br><span class="line">Edge&#123;<span class="string">"E"</span>, <span class="string">"D"</span>&#125;,</span><br><span class="line">Edge&#123;<span class="string">"E"</span>, <span class="string">"H"</span>&#125;,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">graph := &amp;Graph&#123;v, e&#125; <span class="comment">//生成无向图</span></span><br><span class="line"></span><br><span class="line">adjL := graph.AdjList()</span><br><span class="line"><span class="keyword">for</span> _, v := <span class="keyword">range</span> adjL &#123;</span><br><span class="line">fmt.Print(v.head.data, <span class="string">" "</span>)</span><br><span class="line"><span class="keyword">for</span> node := v.head.firstedge; node != <span class="literal">nil</span>; node = node.next &#123;</span><br><span class="line">fmt.Print(adjL[node.adjvex].head.data, <span class="string">" "</span>)</span><br><span class="line">&#125;</span><br><span class="line">fmt.Println()</span><br><span class="line">&#125;</span><br><span class="line">fmt.Println(<span class="string">"-----------------"</span>)</span><br><span class="line">BFSTraverse(adjL)</span><br><span class="line">&#125;</span><br><span class="line">&gt; Output:</span><br><span class="line">command-line-arguments</span><br><span class="line">A B F </span><br><span class="line">B A C G I </span><br><span class="line">C B D I </span><br><span class="line">D C G E </span><br><span class="line">E F D H </span><br><span class="line">F A G E </span><br><span class="line">G B F D H </span><br><span class="line">H G E </span><br><span class="line">I B C </span><br><span class="line">-----------------</span><br><span class="line">A B F C G I E D H</span><br></pre></td></tr></table></figure><h5><span id="8-4-1-er-fen-cha-zhao">8.4.1 二分查找</span><a href="#8-4-1-er-fen-cha-zhao" class="header-anchor">#</a></h5><p><img src="https://upload-images.jianshu.io/upload_images/1863961-e7c869cf58b3751b.JPG?imageMogr2/auto-orient/strip%7CimageView2/2/w/640" alt=""></p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">"fmt"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">BiSearch</span>(<span class="params">a []<span class="keyword">int</span>, n, key <span class="keyword">int</span></span>) <span class="title">int</span></span> &#123;</span><br><span class="line"><span class="keyword">var</span> low, high, mid <span class="keyword">int</span></span><br><span class="line">low = <span class="number">1</span></span><br><span class="line">high = n</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> low &lt;= high &#123;</span><br><span class="line">mid = (low + high) / <span class="number">2</span></span><br><span class="line"><span class="comment">//mid = low + (high-low)(key-1)/(99-1)  插值</span></span><br><span class="line"><span class="keyword">if</span> key == a[mid] &#123;</span><br><span class="line"><span class="keyword">return</span> mid</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> key &lt; a[mid] &#123;</span><br><span class="line">high = mid - <span class="number">1</span></span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">low = mid + <span class="number">1</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">a := []<span class="keyword">int</span>&#123;<span class="number">0</span>, <span class="number">1</span>, <span class="number">16</span>, <span class="number">24</span>, <span class="number">35</span>, <span class="number">47</span>, <span class="number">59</span>, <span class="number">62</span>, <span class="number">73</span>, <span class="number">88</span>, <span class="number">99</span>&#125;</span><br><span class="line">fmt.Println(BiSearch(a, <span class="number">10</span>, <span class="number">62</span>))</span><br><span class="line">&#125;</span><br><span class="line">&gt; Output:</span><br><span class="line">command-line-arguments</span><br><span class="line"><span class="number">7</span></span><br></pre></td></tr></table></figure><h4><span id="8-6-er-cha-cha-zhao-shu-binary-sort-tree">8.6 二叉查找树(Binary Sort Tree)</span><a href="#8-6-er-cha-cha-zhao-shu-binary-sort-tree" class="header-anchor">#</a></h4><p>左小右大<img src="https://upload-images.jianshu.io/upload_images/1863961-ac2cd3676f5e970c.JPG?imageMogr2/auto-orient/strip%7CimageView2/2/w/640" alt=""></p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">"fmt"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> BinaryTree <span class="keyword">struct</span> &#123;</span><br><span class="line">data  <span class="keyword">int</span></span><br><span class="line">left  *BinaryTree</span><br><span class="line">right *BinaryTree</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">SearchBST</span>(<span class="params">root *BinaryTree, key <span class="keyword">int</span></span>) <span class="title">bool</span></span> &#123;</span><br><span class="line"><span class="keyword">if</span> root == <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">switch</span> &#123;</span><br><span class="line"><span class="keyword">case</span> key &lt; root.data:</span><br><span class="line"><span class="keyword">return</span> SearchBST(root.left, key)</span><br><span class="line"><span class="keyword">case</span> key &gt; root.data:</span><br><span class="line"><span class="keyword">return</span> SearchBST(root.right, key)</span><br><span class="line"><span class="keyword">default</span>:</span><br><span class="line"><span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">node10 := &amp;BinaryTree&#123;data: <span class="number">37</span>&#125;</span><br><span class="line">node9 := &amp;BinaryTree&#123;data: <span class="number">93</span>&#125;</span><br><span class="line">node8 := &amp;BinaryTree&#123;data: <span class="number">51</span>&#125;</span><br><span class="line">node7 := &amp;BinaryTree&#123;data: <span class="number">35</span>, right: node10&#125;</span><br><span class="line">node6 := &amp;BinaryTree&#123;data: <span class="number">99</span>, left: node9&#125;</span><br><span class="line">node5 := &amp;BinaryTree&#123;data: <span class="number">73</span>&#125;</span><br><span class="line">node4 := &amp;BinaryTree&#123;data: <span class="number">47</span>, left: node7, right: node8&#125;</span><br><span class="line">node3 := &amp;BinaryTree&#123;<span class="number">88</span>, node5, node6&#125;</span><br><span class="line">node2 := &amp;BinaryTree&#123;data: <span class="number">58</span>, left: node4&#125;</span><br><span class="line">root := &amp;BinaryTree&#123;<span class="number">62</span>, node2, node3&#125;</span><br><span class="line"></span><br><span class="line">fmt.Print(SearchBST(root, <span class="number">73</span>), <span class="string">" "</span>)</span><br><span class="line">fmt.Print(SearchBST(root, <span class="number">99</span>), <span class="string">" "</span>)</span><br><span class="line">fmt.Print(SearchBST(root, <span class="number">37</span>), <span class="string">" "</span>)</span><br><span class="line">fmt.Print(SearchBST(root, <span class="number">48</span>), <span class="string">" "</span>)</span><br><span class="line">fmt.Print(SearchBST(root, <span class="number">100</span>))</span><br><span class="line">&#125;</span><br><span class="line">&gt; Output:</span><br><span class="line">command-line-arguments</span><br><span class="line"><span class="literal">true</span> <span class="literal">true</span> <span class="literal">true</span> <span class="literal">false</span> <span class="literal">false</span></span><br></pre></td></tr></table></figure><h5><span id="8-6-2-er-cha-cha-zhao-shu-cha-ru">8.6.2 二叉查找树插入</span><a href="#8-6-2-er-cha-cha-zhao-shu-cha-ru" class="header-anchor">#</a></h5><p><img src="https://upload-images.jianshu.io/upload_images/1863961-a95e74e49282a74c.JPG?imageMogr2/auto-orient/strip%7CimageView2/2/w/640" alt=""></p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">"fmt"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> BinaryTree <span class="keyword">struct</span> &#123;</span><br><span class="line">data  <span class="keyword">int</span></span><br><span class="line">left  *BinaryTree</span><br><span class="line">right *BinaryTree</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">InsertBST</span>(<span class="params">root *BinaryTree, key <span class="keyword">int</span></span>) (<span class="params"><span class="keyword">bool</span>, *BinaryTree</span>)</span> &#123;</span><br><span class="line"><span class="comment">//if SearchBST(root, key) &#123;  //假设不存在</span></span><br><span class="line"><span class="comment">//return false, root</span></span><br><span class="line"><span class="comment">//&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="literal">true</span>, Insert(root, key)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Insert</span>(<span class="params">root *BinaryTree, key <span class="keyword">int</span></span>) *<span class="title">BinaryTree</span></span> &#123;</span><br><span class="line"><span class="keyword">if</span> root == <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> &amp;BinaryTree&#123;data: key&#125; <span class="comment">//插入的本质要生成新的节点</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> key &lt; root.data &#123;</span><br><span class="line">root.left = Insert(root.left, key)</span><br><span class="line">&#125; <span class="keyword">else</span> &#123; <span class="comment">// 没有key = root.data 的情况</span></span><br><span class="line">root.right = Insert(root.right, key)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> root</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">node10 := &amp;BinaryTree&#123;data: <span class="number">37</span>&#125;</span><br><span class="line">node9 := &amp;BinaryTree&#123;data: <span class="number">93</span>&#125;</span><br><span class="line">node8 := &amp;BinaryTree&#123;data: <span class="number">51</span>&#125;</span><br><span class="line">node7 := &amp;BinaryTree&#123;data: <span class="number">35</span>, right: node10&#125;</span><br><span class="line">node6 := &amp;BinaryTree&#123;data: <span class="number">99</span>, left: node9&#125;</span><br><span class="line">node5 := &amp;BinaryTree&#123;data: <span class="number">73</span>&#125;</span><br><span class="line">node4 := &amp;BinaryTree&#123;data: <span class="number">47</span>, left: node7, right: node8&#125;</span><br><span class="line">node3 := &amp;BinaryTree&#123;<span class="number">88</span>, node5, node6&#125;</span><br><span class="line">node2 := &amp;BinaryTree&#123;data: <span class="number">58</span>, left: node4&#125;</span><br><span class="line">root := &amp;BinaryTree&#123;<span class="number">62</span>, node2, node3&#125;</span><br><span class="line"></span><br><span class="line">fmt.Print(root.right.right.left.data, root.right.right.left.right, <span class="string">" "</span>)</span><br><span class="line">_, root = InsertBST(root, <span class="number">95</span>)</span><br><span class="line">fmt.Print(root.right.right.left.right.data)</span><br><span class="line">&#125;</span><br><span class="line">&gt; Output:</span><br><span class="line">command-line-arguments</span><br><span class="line"><span class="number">93</span> &lt;<span class="literal">nil</span>&gt; <span class="number">95</span></span><br></pre></td></tr></table></figure><h5><span id="8-6-3-er-cha-cha-zhao-shu-shan-chu">8.6.3 二叉查找树删除</span><a href="#8-6-3-er-cha-cha-zhao-shu-shan-chu" class="header-anchor">#</a></h5><p><img src="https://upload-images.jianshu.io/upload_images/1863961-73f49cf999259ca8.JPG?imageMogr2/auto-orient/strip%7CimageView2/2/w/640" alt=""></p><p><img src="https://upload-images.jianshu.io/upload_images/1863961-f901a4ee0de2558c.JPG?imageMogr2/auto-orient/strip%7CimageView2/2/w/640" alt=""></p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">"fmt"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> BinaryTree <span class="keyword">struct</span> &#123;</span><br><span class="line">data  <span class="keyword">int</span></span><br><span class="line">left  *BinaryTree</span><br><span class="line">right *BinaryTree</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//删除data为key的节点，并返回该二叉树的根节点。</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">DeleteBST</span>(<span class="params">root *BinaryTree, key <span class="keyword">int</span></span>) *<span class="title">BinaryTree</span></span> &#123;</span><br><span class="line"><span class="keyword">if</span> root == <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">switch</span> &#123;</span><br><span class="line"><span class="keyword">case</span> key &gt; root.data: <span class="comment">//在右子树中</span></span><br><span class="line">root.right = DeleteBST(root.right, key)</span><br><span class="line"><span class="keyword">case</span> key &lt; root.data: <span class="comment">//在左子树中</span></span><br><span class="line">root.left = DeleteBST(root.left, key)</span><br><span class="line"><span class="keyword">default</span>: <span class="comment">//key == root.data</span></span><br><span class="line"><span class="keyword">if</span> root.left == <span class="literal">nil</span> &amp;&amp; root.right == <span class="literal">nil</span> &#123; <span class="comment">//该节点为叶节点</span></span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> root.left == <span class="literal">nil</span> &amp;&amp; root.right != <span class="literal">nil</span> &#123; <span class="comment">//该节点仅有右子树</span></span><br><span class="line"><span class="keyword">return</span> root.right</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> root.left != <span class="literal">nil</span> &amp;&amp; root.right == <span class="literal">nil</span> &#123; <span class="comment">//该节点仅有左子树</span></span><br><span class="line"><span class="keyword">return</span> root.left</span><br><span class="line">&#125; <span class="keyword">else</span> &#123; <span class="comment">//该节点有左、右子树</span></span><br><span class="line">success := FindMin(root.right) <span class="comment">//找到key的后继节点,即48</span></span><br><span class="line">root.right = DeleteBST(root.right, success)</span><br><span class="line">root.data = success</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> root</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//找到BST中data最小的节点</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">FindMin</span>(<span class="params">root *BinaryTree</span>) <span class="title">int</span></span> &#123;</span><br><span class="line"><span class="keyword">if</span> root.left == <span class="literal">nil</span> &#123; <span class="comment">//最小值在根节点</span></span><br><span class="line"><span class="keyword">return</span> root.data</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> FindMin(root.left) <span class="comment">//最小值在左子树</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">node16 := &amp;BinaryTree&#123;data: <span class="number">50</span>&#125;</span><br><span class="line">node15 := &amp;BinaryTree&#123;data: <span class="number">48</span>&#125;</span><br><span class="line">node14 := &amp;BinaryTree&#123;data: <span class="number">36</span>&#125;</span><br><span class="line">node13 := &amp;BinaryTree&#123;data: <span class="number">56</span>&#125;</span><br><span class="line">node12 := &amp;BinaryTree&#123;<span class="number">49</span>, node15, node16&#125;</span><br><span class="line">node11 := &amp;BinaryTree&#123;data: <span class="number">37</span>, left: node14&#125;</span><br><span class="line">node10 := &amp;BinaryTree&#123;data: <span class="number">29</span>&#125;</span><br><span class="line">node9 := &amp;BinaryTree&#123;data: <span class="number">93</span>&#125;</span><br><span class="line">node8 := &amp;BinaryTree&#123;<span class="number">51</span>, node12, node13&#125;</span><br><span class="line">node7 := &amp;BinaryTree&#123;<span class="number">35</span>, node10, node11&#125;</span><br><span class="line">node6 := &amp;BinaryTree&#123;data: <span class="number">99</span>, left: node9&#125;</span><br><span class="line">node5 := &amp;BinaryTree&#123;data: <span class="number">73</span>&#125;</span><br><span class="line">node4 := &amp;BinaryTree&#123;data: <span class="number">47</span>, left: node7, right: node8&#125;</span><br><span class="line">node3 := &amp;BinaryTree&#123;<span class="number">88</span>, node5, node6&#125;</span><br><span class="line">node2 := &amp;BinaryTree&#123;data: <span class="number">58</span>, left: node4&#125;</span><br><span class="line">root := &amp;BinaryTree&#123;<span class="number">62</span>, node2, node3&#125;</span><br><span class="line"></span><br><span class="line">root = DeleteBST(root, <span class="number">47</span>)</span><br><span class="line">NewNode := root.left.left</span><br><span class="line">fmt.Print(NewNode.data, <span class="string">" "</span>) <span class="comment">//打印代替删除位置的新节点</span></span><br><span class="line">fmt.Print(NewNode.left.data, NewNode.right.data)</span><br><span class="line">&#125;</span><br><span class="line">&gt; Output:</span><br><span class="line">command-line-arguments</span><br><span class="line"><span class="number">48</span> <span class="number">35</span> <span class="number">51</span></span><br></pre></td></tr></table></figure><h4><span id="8-7-ping-heng-er-cha-shu-avl-shu">8.7 平衡二叉树(AVL树)</span><a href="#8-7-ping-heng-er-cha-shu-avl-shu" class="header-anchor">#</a></h4><p><strong>平衡因子</strong>(BF)=左子树的深度-右子树的深度<strong>旋转：</strong><img src="https://upload-images.jianshu.io/upload_images/1863961-b493bc28e8068b46.JPG?imageMogr2/auto-orient/strip%7CimageView2/2/w/640" alt=""><img src="https://upload-images.jianshu.io/upload_images/1863961-b6715f1391c81757.JPG?imageMogr2/auto-orient/strip%7CimageView2/2/w/640" alt=""></p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//右旋</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">RRotate</span>(<span class="params">k2 *BinaryTree</span>) *<span class="title">BinaryTree</span></span> &#123;</span><br><span class="line">k1 := k2.left</span><br><span class="line">y := k1.right</span><br><span class="line">k1.right = k2</span><br><span class="line">k2.left = y</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> k1</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>双旋转：</strong><img src="https://upload-images.jianshu.io/upload_images/1863961-132deac059f8995f.JPG?imageMogr2/auto-orient/strip%7CimageView2/2/w/640" alt=""></p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//左右旋转</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">LRRotate</span>(<span class="params">k3 *BinaryTree</span>) *<span class="title">BinaryTree</span></span> &#123;</span><br><span class="line">k3.left = LRotate(k3.left)</span><br><span class="line"><span class="keyword">return</span> RRotate(k3)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://upload-images.jianshu.io/upload_images/1863961-fe05b14c2bdb3e2c.JPG?imageMogr2/auto-orient/strip%7CimageView2/2/w/800" alt=""></p><p>将任意二叉树一次性调整AVL</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">"fmt"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> BinaryTree <span class="keyword">struct</span> &#123;</span><br><span class="line">data  <span class="keyword">int</span></span><br><span class="line">bf    <span class="keyword">int</span> <span class="comment">//Balance Factor</span></span><br><span class="line">left  *BinaryTree</span><br><span class="line">right *BinaryTree</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//右旋</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">R_Rotate</span>(<span class="params">root *BinaryTree</span>) *<span class="title">BinaryTree</span></span> &#123;</span><br><span class="line">a := root.left</span><br><span class="line">b := a.right</span><br><span class="line">a.right = root</span><br><span class="line">root.left = b</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> a</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//左旋</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">L_Rotate</span>(<span class="params">root *BinaryTree</span>) *<span class="title">BinaryTree</span></span> &#123;</span><br><span class="line">a := root.right</span><br><span class="line">b := a.left</span><br><span class="line">a.left = root</span><br><span class="line">root.right = b</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> a</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//左右旋转</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">LR_Rotate</span>(<span class="params">root *BinaryTree</span>) *<span class="title">BinaryTree</span></span> &#123;</span><br><span class="line">root.left = L_Rotate(root.left)</span><br><span class="line"><span class="keyword">return</span> R_Rotate(root)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//右左旋转</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">RL_Rotate</span>(<span class="params">root *BinaryTree</span>) *<span class="title">BinaryTree</span></span> &#123;</span><br><span class="line">root.right = R_Rotate(root.right)</span><br><span class="line"><span class="keyword">return</span> L_Rotate(root)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//将任意二叉树转化成AVL</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Balance</span>(<span class="params">root *BinaryTree</span>) *<span class="title">BinaryTree</span></span> &#123;</span><br><span class="line">a := &amp;BinaryTree&#123;left: root&#125; <span class="comment">//给二叉树生成一个父母节点</span></span><br><span class="line">_, isAVL := Bal(root)        <span class="comment">//调整二叉树的子树并判断二叉树是否平衡</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> !isAVL &#123;</span><br><span class="line">Bal(a)                 <span class="comment">//处理a的左子树，即二叉树</span></span><br><span class="line">_, isAVL = Bal(a.left) <span class="comment">//判断二叉树是否平衡</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> a.left <span class="comment">//返回二叉树</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//调整子树</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Bal</span>(<span class="params">root *BinaryTree</span>) (<span class="params"><span class="keyword">int</span>, <span class="keyword">bool</span></span>)</span> &#123;</span><br><span class="line"><span class="keyword">if</span> root == <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>, <span class="literal">true</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">leftHeight, leftIsBalanced := Bal(root.left)</span><br><span class="line">rightHeight, rightIsBalanced := Bal(root.right)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> !leftIsBalanced &#123;</span><br><span class="line">root.left = Rotate(root.left)    <span class="comment">//调整左子树</span></span><br><span class="line">leftHeight = UpdateBF(root.left) <span class="comment">//刷新左子树的BF和高度</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> !rightIsBalanced &#123;</span><br><span class="line">root.right = Rotate(root.right)</span><br><span class="line">rightHeight = UpdateBF(root.right)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">root.bf = leftHeight - rightHeight <span class="comment">//计算本身的BF</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> Abs(root.bf) &lt;= <span class="number">1</span> &#123;</span><br><span class="line"><span class="keyword">return</span> Max(leftHeight, rightHeight) + <span class="number">1</span>, <span class="literal">true</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> Max(leftHeight, rightHeight) + <span class="number">1</span>, <span class="literal">false</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//对不平衡树进行旋转调整</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Rotate</span>(<span class="params">root *BinaryTree</span>) *<span class="title">BinaryTree</span></span> &#123;</span><br><span class="line"><span class="keyword">if</span> root.bf &gt; <span class="number">0</span> &#123; <span class="comment">//左边太重，需要右旋</span></span><br><span class="line"><span class="keyword">if</span> root.left.bf &lt; <span class="number">0</span> &#123;</span><br><span class="line"><span class="keyword">return</span> LR_Rotate(root)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> R_Rotate(root)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> root.right.bf &gt; <span class="number">0</span> &#123;</span><br><span class="line"><span class="keyword">return</span> RL_Rotate(root)</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> L_Rotate(root)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">UpdateBF</span>(<span class="params">root *BinaryTree</span>) <span class="title">int</span></span> &#123;</span><br><span class="line"><span class="keyword">if</span> root == <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">leftHeight := UpdateBF(root.left)</span><br><span class="line">rightHeight := UpdateBF(root.right)</span><br><span class="line">root.bf = leftHeight - rightHeight</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> Max(leftHeight, rightHeight) + <span class="number">1</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Max</span>(<span class="params">a, b <span class="keyword">int</span></span>) <span class="title">int</span></span> &#123;</span><br><span class="line"><span class="keyword">if</span> a &gt; b &#123;</span><br><span class="line"><span class="keyword">return</span> a</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> b</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Abs</span>(<span class="params">a <span class="keyword">int</span></span>) <span class="title">int</span></span> &#123;</span><br><span class="line"><span class="keyword">if</span> a &gt; <span class="number">0</span> &#123;</span><br><span class="line"><span class="keyword">return</span> a</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> -a</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">InsertBST</span>(<span class="params">root *BinaryTree, key <span class="keyword">int</span></span>) (<span class="params"><span class="keyword">bool</span>, *BinaryTree</span>)</span> &#123;</span><br><span class="line"><span class="comment">//if SearchBST(root, key) &#123;  //假设不存在</span></span><br><span class="line"><span class="comment">//  return false, root</span></span><br><span class="line"><span class="comment">//&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="literal">true</span>, Insert(root, key)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Insert</span>(<span class="params">root *BinaryTree, key <span class="keyword">int</span></span>) *<span class="title">BinaryTree</span></span> &#123;</span><br><span class="line"><span class="keyword">if</span> root == <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> &amp;BinaryTree&#123;data: key&#125; <span class="comment">//插入的本质要生成新的节点</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> key &lt; root.data &#123;</span><br><span class="line">root.left = Insert(root.left, key)</span><br><span class="line">&#125; <span class="keyword">else</span> &#123; <span class="comment">// 没有key = root.data 的情况</span></span><br><span class="line">root.right = Insert(root.right, key)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> root</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">PrintBF</span>(<span class="params">root *BinaryTree</span>)</span> &#123;</span><br><span class="line"><span class="keyword">if</span> root == <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">PrintBF(root.left)</span><br><span class="line">fmt.Print(root.bf, <span class="string">" "</span>)</span><br><span class="line">PrintBF(root.right)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">root := &amp;BinaryTree&#123;data: <span class="number">1</span>&#125;</span><br><span class="line">InsertBST(root, <span class="number">7</span>)</span><br><span class="line">InsertBST(root, <span class="number">2</span>)</span><br><span class="line">InsertBST(root, <span class="number">4</span>)</span><br><span class="line">InsertBST(root, <span class="number">8</span>)</span><br><span class="line">InsertBST(root, <span class="number">3</span>)</span><br><span class="line">InsertBST(root, <span class="number">10</span>)</span><br><span class="line">InsertBST(root, <span class="number">5</span>)</span><br><span class="line">InsertBST(root, <span class="number">9</span>)</span><br><span class="line">InsertBST(root, <span class="number">6</span>)</span><br><span class="line"></span><br><span class="line">UpdateBF(root)</span><br><span class="line">PrintBF(root) <span class="comment">//二叉树的BF</span></span><br><span class="line">fmt.Println()</span><br><span class="line">PrintBF(Balance(root)) <span class="comment">//平衡调整后的二叉树的BF</span></span><br><span class="line">&#125;</span><br><span class="line">&gt; Output:</span><br><span class="line">command-line-arguments</span><br><span class="line"><span class="number">-5</span> <span class="number">-3</span> <span class="number">0</span> <span class="number">-1</span> <span class="number">-1</span> <span class="number">0</span> <span class="number">1</span> <span class="number">-2</span> <span class="number">0</span> <span class="number">1</span> </span><br><span class="line"><span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">-1</span> <span class="number">-1</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span></span><br></pre></td></tr></table></figure><h5><span id="9-2-1-pai-xu-de-wen-ding-xing">9.2.1 排序的稳定性</span><a href="#9-2-1-pai-xu-de-wen-ding-xing" class="header-anchor">#</a></h5><p><img src="https://upload-images.jianshu.io/upload_images/1863961-da3eb9745c415426.JPG?imageMogr2/auto-orient/strip%7CimageView2/2/w/640" alt=""></p><h5><span id="9-2-2-nei-pai-xu-he-wai-pai-xu">9.2.2 内排序和外排序</span><a href="#9-2-2-nei-pai-xu-he-wai-pai-xu" class="header-anchor">#</a></h5><p><strong>内排序</strong>是在排序的整个过程中，待排序的所有记录全部在内存中。<strong>外排序</strong>的整个过程则需要在内外存之间交换数据。</p><h5><span id="9-3-2-mou-pao-pai-xu-suan-fa-bubble-sort">9.3.2 冒泡排序算法(Bubble Sort)</span><a href="#9-3-2-mou-pao-pai-xu-suan-fa-bubble-sort" class="header-anchor">#</a></h5><p>冒泡排序就是把小的元素往前调或者把大的元素往后调。比较是相邻的两个元素比较，交换也发生在这两个元素之间。所以，如果两个元素相等，我想你是不会再无聊地把他们俩交换一下的；如果两个相等的元素没有相邻，那么即使通过前面的两两交换把两个相邻起来，这时候也不会交换，所以相同元素的前后顺序并没有改 变，所以冒泡排序是一种稳定排序算法。<img src="https://upload-images.jianshu.io/upload_images/1863961-35aca3bf05e9be84.JPG?imageMogr2/auto-orient/strip%7CimageView2/2/w/640" alt=""></p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">"fmt"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">"fmt"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">BubbleSort</span>(<span class="params">a []<span class="keyword">int</span></span>)</span> &#123;</span><br><span class="line">length := <span class="built_in">len</span>(a)</span><br><span class="line"><span class="keyword">for</span> i := <span class="number">1</span>; i &lt; length<span class="number">-1</span>; i++ &#123; <span class="comment">//需要交换(length-2)次，从后往前排</span></span><br><span class="line"><span class="keyword">for</span> j := <span class="number">1</span>; j &lt; length-i; j++ &#123; <span class="comment">//当i=1时，j可以取到(length-2)</span></span><br><span class="line"><span class="keyword">if</span> a[j] &gt; a[j+<span class="number">1</span>] &#123;</span><br><span class="line">a[j], a[j+<span class="number">1</span>] = a[j+<span class="number">1</span>], a[j]</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">a := []<span class="keyword">int</span>&#123;<span class="number">0</span>, <span class="number">9</span>, <span class="number">1</span>, <span class="number">5</span>, <span class="number">8</span>, <span class="number">3</span>, <span class="number">7</span>, <span class="number">4</span>, <span class="number">6</span>, <span class="number">2</span>&#125;</span><br><span class="line">BubbleSort(a)</span><br><span class="line">fmt.Println(a)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>递归实现. for 循环找出最大值排到末尾，去掉末尾把对新的序列递归</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">package main</span><br><span class="line"></span><br><span class="line">import (</span><br><span class="line">&quot;fmt&quot;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">func RecurBubble(a []int) &#123;</span><br><span class="line">length := len(a)</span><br><span class="line">if length &lt; 3 &#123;  //递归跳出条件</span><br><span class="line">return</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">for j := 1; j &lt;= length-2; j++ &#123;</span><br><span class="line">if a[j] &gt; a[j+1] &#123;</span><br><span class="line">a[j], a[j+1] = a[j+1], a[j]</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">a = a[0 : length-1] //不包括第 length-1 个元素</span><br><span class="line"></span><br><span class="line">RecurBubble(a)</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">func main() &#123;</span><br><span class="line">a := []int&#123;0, 9, 1, 5, 8, 3, 7, 4, 6, 2&#125;</span><br><span class="line">RecurBubble(a)</span><br><span class="line">fmt.Println(a)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5><span id="9-3-3-mou-pao-pai-xu-you-hua">9.3.3 冒泡排序优化</span><a href="#9-3-3-mou-pao-pai-xu-you-hua" class="header-anchor">#</a></h5><p><img src="https://upload-images.jianshu.io/upload_images/1863961-2c7713c7b8115947.JPG?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt=""></p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">"fmt"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">BubbleSort2</span>(<span class="params">a []<span class="keyword">int</span></span>)</span> &#123;</span><br><span class="line">flag := <span class="literal">true</span> <span class="comment">// 有数据交换</span></span><br><span class="line">length := <span class="built_in">len</span>(a)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i := <span class="number">1</span>; i &lt; length<span class="number">-1</span> &amp;&amp; flag; i++ &#123; </span><br><span class="line">flag = <span class="literal">false</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> j := <span class="number">1</span>; j &lt; length-i; j++ &#123;</span><br><span class="line"><span class="keyword">if</span> a[j] &gt; a[j+<span class="number">1</span>] &#123;</span><br><span class="line">a[j], a[j+<span class="number">1</span>] = a[j+<span class="number">1</span>], a[j]</span><br><span class="line">flag = <span class="literal">true</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">a := []<span class="keyword">int</span>&#123;<span class="number">0</span>, <span class="number">9</span>, <span class="number">1</span>, <span class="number">5</span>, <span class="number">8</span>, <span class="number">3</span>, <span class="number">7</span>, <span class="number">4</span>, <span class="number">6</span>, <span class="number">2</span>&#125;</span><br><span class="line">BubbleSort2(a)</span><br><span class="line">fmt.Println(a)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3><span id="9-4-1-jian-dan-xuan-ze-pai-xu-simple-selection-sort">9.4.1 简单选择排序(Simple Selection Sort)</span><a href="#9-4-1-jian-dan-xuan-ze-pai-xu-simple-selection-sort" class="header-anchor">#</a></h3><p>复杂度与冒泡排序同为$O(n^{2})$,但性能更优(数据交换次数更少)。选择排序是给每个位置选择当前元素最小的，比如给第一个位置选择最小的，在剩余元素里面给第二个元素选择第二小的，依次类推，直到第n-1个元素，第n个 元素不用选择了，因为只剩下它一个最大的元素了。</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">"fmt"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">SelectionSort</span>(<span class="params">a []<span class="keyword">int</span></span>)</span> &#123;</span><br><span class="line"><span class="keyword">var</span> min <span class="keyword">int</span></span><br><span class="line">length := <span class="built_in">len</span>(a)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i := <span class="number">1</span>; i &lt; length<span class="number">-1</span>; i++ &#123; <span class="comment">//插入次数(length-2)，从前往后排；把后面序列中较小的数插</span></span><br><span class="line">min = i</span><br><span class="line"></span><br><span class="line"><span class="comment">// 循环找出序列中的最小数的下标</span></span><br><span class="line"><span class="keyword">for</span> j := i + <span class="number">1</span>; j &lt; length; j++ &#123; <span class="comment">//j取到i后的所有数</span></span><br><span class="line"><span class="keyword">if</span> a[j] &lt; a[min] &#123; <span class="comment">//之后有更小的数</span></span><br><span class="line">min = j</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> i != min &#123; <span class="comment">//下标改变，交换，防止数据丢失</span></span><br><span class="line">a[i], a[min] = a[min], a[i]</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">a := []<span class="keyword">int</span>&#123;<span class="number">0</span>, <span class="number">9</span>, <span class="number">1</span>, <span class="number">5</span>, <span class="number">8</span>, <span class="number">3</span>, <span class="number">7</span>, <span class="number">4</span>, <span class="number">6</span>, <span class="number">2</span>&#125;</span><br><span class="line">SelectionSort(a)</span><br><span class="line">fmt.Println(a)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>反过来排</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">package main</span><br><span class="line"></span><br><span class="line">import (</span><br><span class="line">&quot;fmt&quot;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">func SelectionSort(a []int) &#123;</span><br><span class="line">var max int</span><br><span class="line">length := len(a)</span><br><span class="line"></span><br><span class="line">for i := length - 1; i &gt; 0; i-- &#123; 从大到小排</span><br><span class="line">max = i</span><br><span class="line">for j := 1; j &lt; i; j++ &#123;</span><br><span class="line">if a[j] &gt; a[max] &#123;</span><br><span class="line">max = j</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">if max != i &#123;</span><br><span class="line">a[i], a[max] = a[max], a[i]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">func main() &#123;</span><br><span class="line">a := []int&#123;0, 9, 1, 5, 8, 3, 7, 4, 6, 2&#125;</span><br><span class="line">SelectionSort(a)</span><br><span class="line">fmt.Println(a)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>递归</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">"fmt"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">SelectionSort</span>(<span class="params">a []<span class="keyword">int</span></span>)</span> &#123;</span><br><span class="line">length := <span class="built_in">len</span>(a)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> length &lt; <span class="number">3</span> &#123;</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">max := length - <span class="number">1</span></span><br><span class="line"><span class="keyword">for</span> j := <span class="number">1</span>; j &lt; length<span class="number">-1</span>; j++ &#123;</span><br><span class="line"><span class="keyword">if</span> a[j] &gt; a[max] &#123;</span><br><span class="line">max = j</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> max != length<span class="number">-1</span> &#123;</span><br><span class="line">a[length<span class="number">-1</span>], a[max] = a[max], a[length<span class="number">-1</span>]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">SelectionSort(a[:length<span class="number">-1</span>])</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">a := []<span class="keyword">int</span>&#123;<span class="number">0</span>, <span class="number">9</span>, <span class="number">1</span>, <span class="number">5</span>, <span class="number">8</span>, <span class="number">3</span>, <span class="number">7</span>, <span class="number">4</span>, <span class="number">6</span>, <span class="number">2</span>&#125;</span><br><span class="line">SelectionSort(a)</span><br><span class="line">fmt.Println(a)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5><span id="9-5-1-zhi-jie-cha-ru-pai-xu-straight-insertion-sort">9.5.1 直接插入排序(Straight Insertion Sort)</span><a href="#9-5-1-zhi-jie-cha-ru-pai-xu-straight-insertion-sort" class="header-anchor">#</a></h5><p>插入排序是在一个已经有序的小序列的基础上，一次插入一个元素。当然，刚开始这个有序的小序列只有1个元素，就是第一个元素。比较是从有序序列的末尾开 始，也就是想要插入的元素和已经有序的最大者开始比起，如果比它大则直接插入在其后面，否则一直往前找直到找到它该插入的位置。如果碰见一个和插入元素相 等的，那么插入元素把想插入的元素放在相等元素的后面。所以，相等元素的前后顺序没有改变，从原无序序列出去的顺序就是排好序后的顺序，所以插入排序是稳 定的。复杂度同为为$O(n^{2})$，性能：<strong>插入排序&gt;选择排序&gt;冒泡排序</strong></p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">"fmt"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">InsertionSort</span>(<span class="params">a []<span class="keyword">int</span></span>)</span> &#123;</span><br><span class="line">length := <span class="built_in">len</span>(a)</span><br><span class="line"><span class="keyword">var</span> j <span class="keyword">int</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i := <span class="number">2</span>; i &lt; length; i++ &#123; <span class="comment">//第二个数到最后一个数</span></span><br><span class="line"><span class="keyword">if</span> a[i] &lt; a[i<span class="number">-1</span>] &#123; <span class="comment">//第i个数比前面的数小，需要插入</span></span><br><span class="line">a[<span class="number">0</span>] = a[i] <span class="comment">//哨兵</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> j = i - <span class="number">1</span>; a[j] &gt; a[<span class="number">0</span>]; j-- &#123; <span class="comment">//j取 i-1 到 1</span></span><br><span class="line">a[j+<span class="number">1</span>] = a[j] <span class="comment">//将大于第i个数的数后移一位，留出空位</span></span><br><span class="line">&#125;</span><br><span class="line">a[j+<span class="number">1</span>] = a[<span class="number">0</span>] <span class="comment">//将第i个数放入空位</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">a := []<span class="keyword">int</span>&#123;<span class="number">0</span>, <span class="number">9</span>, <span class="number">1</span>, <span class="number">5</span>, <span class="number">8</span>, <span class="number">3</span>, <span class="number">7</span>, <span class="number">4</span>, <span class="number">6</span>, <span class="number">2</span>&#125;</span><br><span class="line">InsertionSort(a)</span><br><span class="line">fmt.Println(a)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4><span id="9-6-xi-er-pai-xu-shell-sort">9.6 希尔排序(Shell Sort)</span><a href="#9-6-xi-er-pai-xu-shell-sort" class="header-anchor">#</a></h4><p>希尔排序是按照不同步长对元素进行插入排序，当刚开始元素很无序的时候，步长最大，所以插入排序的元素个数很少，速度很快；当元素基本有序了，步长很小， 插入排序对于有序的序列效率很高。所以，希尔排序的时间复杂度会比o(n^2)好一些。由于多次插入排序，我们知道一次插入排序是稳定的，不会改变相同元 素的相对顺序，但在不同的插入排序过程中，相同的元素可能在各自的插入排序中移动，最后其稳定性就会被打乱，所以shell排序是不稳定的。<img src="https://upload-images.jianshu.io/upload_images/1863961-8713bb4788430478.JPG?imageMogr2/auto-orient/strip%7CimageView2/2/w/640" alt=""></p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">"fmt"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">ShellSort</span>(<span class="params">a []<span class="keyword">int</span></span>)</span> &#123;</span><br><span class="line"><span class="keyword">var</span> i, j <span class="keyword">int</span></span><br><span class="line">length := <span class="built_in">len</span>(a) - <span class="number">1</span> <span class="comment">//去掉第0位</span></span><br><span class="line">inc := length <span class="comment">//增量</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> inc &gt; <span class="number">1</span> &#123;</span><br><span class="line">inc = inc/<span class="number">3</span> + <span class="number">1</span></span><br><span class="line"><span class="keyword">for</span> i = <span class="number">1</span> + inc; i &lt;= length; i++ &#123; <span class="comment">//第(1+inc)个数到最后一个数</span></span><br><span class="line"><span class="keyword">if</span> a[i] &lt; a[i-inc] &#123;</span><br><span class="line">a[<span class="number">0</span>] = a[i]</span><br><span class="line"><span class="keyword">for</span> j = i - inc; j &gt; <span class="number">0</span> &amp;&amp; a[j] &gt; a[<span class="number">0</span>]; j -= inc &#123;</span><br><span class="line">a[j+inc] = a[j]</span><br><span class="line">&#125;</span><br><span class="line">a[j+inc] = a[<span class="number">0</span>]</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">a := []<span class="keyword">int</span>&#123;<span class="number">0</span>, <span class="number">9</span>, <span class="number">1</span>, <span class="number">5</span>, <span class="number">8</span>, <span class="number">3</span>, <span class="number">7</span>, <span class="number">4</span>, <span class="number">6</span>, <span class="number">2</span>&#125;</span><br><span class="line">ShellSort(a)</span><br><span class="line">fmt.Println(a)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4><span id="9-7-dui-pai-xu">9.7 堆排序</span><a href="#9-7-dui-pai-xu" class="header-anchor">#</a></h4><p>时间复杂度$O(nlogn)$</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">"fmt"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">HeapSort</span>(<span class="params">a []<span class="keyword">int</span></span>)</span> &#123;</span><br><span class="line">length := <span class="built_in">len</span>(a) - <span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//循环后a[1]为最大值</span></span><br><span class="line"><span class="keyword">for</span> i := length / <span class="number">2</span>; i &gt; <span class="number">0</span>; i-- &#123; <span class="comment">//(length/2)是最后一个节点的父节点到根节点</span></span><br><span class="line">HeapAdjust(a, i, length)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i := length; i &gt; <span class="number">1</span>; i-- &#123; <span class="comment">//从最后节点到第二个节点</span></span><br><span class="line">a[<span class="number">1</span>], a[i] = a[i], a[<span class="number">1</span>] <span class="comment">//排序第i位</span></span><br><span class="line">HeapAdjust(a, <span class="number">1</span>, i<span class="number">-1</span>)   <span class="comment">//将1到i-1中的最大数放到a[1]</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">HeapAdjust</span>(<span class="params">a []<span class="keyword">int</span>, s, m <span class="keyword">int</span></span>)</span> &#123;</span><br><span class="line"><span class="keyword">var</span> temp, j <span class="keyword">int</span></span><br><span class="line">temp = a[s]</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> j = <span class="number">2</span> * s; j &lt;= m; j *= <span class="number">2</span> &#123; <span class="comment">//以s为父节点开始</span></span><br><span class="line"><span class="keyword">if</span> j &lt; m &amp;&amp; a[j] &lt; a[j+<span class="number">1</span>] &#123; <span class="comment">//取出较大的孩子节点</span></span><br><span class="line">j = j + <span class="number">1</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> temp &gt;= a[j] &#123; <span class="comment">//父节点已经最大</span></span><br><span class="line"><span class="keyword">break</span></span><br><span class="line">&#125;</span><br><span class="line">a[s] = a[j] <span class="comment">//将最大的值替换给父节点</span></span><br><span class="line">s = j       <span class="comment">//将当前节点作为父节点，进行下一轮操作</span></span><br><span class="line">&#125;</span><br><span class="line">a[s] = temp</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">a := []<span class="keyword">int</span>&#123;<span class="number">0</span>, <span class="number">9</span>, <span class="number">1</span>, <span class="number">5</span>, <span class="number">8</span>, <span class="number">3</span>, <span class="number">7</span>, <span class="number">4</span>, <span class="number">6</span>, <span class="number">2</span>&#125;</span><br><span class="line">HeapAdjust(a, <span class="number">1</span>, <span class="number">9</span>)</span><br><span class="line">fmt.Println(a)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4><span id="9-8-gui-bing-pai-xu">9.8 归并排序</span><a href="#9-8-gui-bing-pai-xu" class="header-anchor">#</a></h4><p>归并排序是把序列递归地分成短序列，递归出口是短序列只有1个元素(认为直接有序)或者2个序列(1次比较和交换),然后把各个有序的段序列合并成一个有 序的长序列，不断合并直到原序列全部排好序。可以发现，在1个或2个元素时，1个元素不会交换，2个元素如果大小相等也没有人故意交换，这不会破坏稳定 性。那么，在短的有序序列合并的过程中，稳定是否受到破坏？没有，合并过程中我们可以保证如果两个当前元素相等时，我们把处在前面的序列的元素保存在结 果序列的前面，这样就保证了稳定性。所以，归并排序也是稳定的排序算法。</p><p>递归方法<img src="https://upload-images.jianshu.io/upload_images/1863961-494a82286018f65f.JPG?imageMogr2/auto-orient/strip%7CimageView2/2/w/640" alt=""></p><p>Merge()归并排序示意图：<img src="https://upload-images.jianshu.io/upload_images/1863961-cfe727471bdad794.JPG?imageMogr2/auto-orient/strip%7CimageView2/2/w/640" alt=""></p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">"fmt"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 将a排序到b</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">MergeSort</span>(<span class="params">a []<span class="keyword">int</span></span>) []<span class="title">int</span></span> &#123;</span><br><span class="line">length := <span class="built_in">len</span>(a)</span><br><span class="line">b := <span class="built_in">make</span>([]<span class="keyword">int</span>, length)</span><br><span class="line"></span><br><span class="line">MSort(a, b, <span class="number">1</span>, length<span class="number">-1</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> b</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">MSort</span>(<span class="params">a, b []<span class="keyword">int</span>, s, t <span class="keyword">int</span></span>)</span> &#123;</span><br><span class="line"><span class="keyword">if</span> s == t &#123;</span><br><span class="line">b[s] = a[s] <span class="comment">//将a复制到到b</span></span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">m := (s + t) / <span class="number">2</span></span><br><span class="line">MSort(a, b, s, m)</span><br><span class="line">MSort(a, b, m+<span class="number">1</span>, t)</span><br><span class="line">Merge(b, s, m, t) <span class="comment">//将b归并排序</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Merge</span>(<span class="params">SR []<span class="keyword">int</span>, i, m, n <span class="keyword">int</span></span>)</span> &#123;</span><br><span class="line">TR := <span class="built_in">make</span>([]<span class="keyword">int</span>, <span class="built_in">len</span>(SR)) <span class="comment">//归并的序列暂存到TR</span></span><br><span class="line"></span><br><span class="line">s := i <span class="comment">//保存起始位置</span></span><br><span class="line">j := m + <span class="number">1</span></span><br><span class="line">k := i <span class="comment">//TR序号</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i &lt;= m &amp;&amp; j &lt;= n &#123;</span><br><span class="line"><span class="keyword">if</span> SR[i] &lt; SR[j] &#123;</span><br><span class="line">TR[k] = SR[i]</span><br><span class="line">i++</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">TR[k] = SR[j]</span><br><span class="line">j++</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">k++</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> i &lt;= m &#123;</span><br><span class="line"><span class="keyword">for</span> l := <span class="number">0</span>; l &lt;= m-i; l++ &#123;</span><br><span class="line">TR[k+l] = SR[i+l]</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> j &lt;= n &#123;</span><br><span class="line"><span class="keyword">for</span> l := <span class="number">0</span>; l &lt;= n-j; l++ &#123;</span><br><span class="line">TR[k+l] = SR[j+l]</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> p := s; p &lt;= n; p++ &#123; <span class="comment">//将排好序的TR写回到SR</span></span><br><span class="line"><span class="keyword">if</span> SR[p] != TR[p] &#123;</span><br><span class="line">SR[p] = TR[p]</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">a := []<span class="keyword">int</span>&#123;<span class="number">0</span>, <span class="number">9</span>, <span class="number">1</span>, <span class="number">5</span>, <span class="number">8</span>, <span class="number">3</span>, <span class="number">7</span>, <span class="number">4</span>, <span class="number">6</span>, <span class="number">5</span>, <span class="number">16</span>&#125;</span><br><span class="line">fmt.Println(MergeSort(a))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>非递归方法</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">"fmt"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">MergeSort2</span>(<span class="params">a []<span class="keyword">int</span></span>)</span> &#123;</span><br><span class="line">length := <span class="built_in">len</span>(a) - <span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> k := <span class="number">1</span>; k &lt; length; &#123;</span><br><span class="line">MergePass(a, k, length)</span><br><span class="line">k = k * <span class="number">2</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">MergePass</span>(<span class="params">a []<span class="keyword">int</span>, s, n <span class="keyword">int</span></span>)</span> &#123;</span><br><span class="line">i := <span class="number">1</span></span><br><span class="line"><span class="keyword">for</span> i &lt;= n<span class="number">-2</span>*s+<span class="number">1</span> &#123;</span><br><span class="line">Merge2(a, i, i+s<span class="number">-1</span>, i+<span class="number">2</span>*s<span class="number">-1</span>) <span class="comment">//i+2*s-1&lt;=n</span></span><br><span class="line">i = i + <span class="number">2</span>*s</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> i &lt; n-s+<span class="number">1</span> &#123; <span class="comment">//n&gt;i+s-1,归并最后两个子块</span></span><br><span class="line">Merge2(a, i, i+s<span class="number">-1</span>, n)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Merge2</span>(<span class="params">SR []<span class="keyword">int</span>, i, m, n <span class="keyword">int</span></span>)</span> &#123;</span><br><span class="line">TR := <span class="built_in">make</span>([]<span class="keyword">int</span>, n-i+<span class="number">1</span>) <span class="comment">//与Merge相比栈空间更小</span></span><br><span class="line"></span><br><span class="line">s := i <span class="comment">//保存起始位置</span></span><br><span class="line">j := m + <span class="number">1</span></span><br><span class="line">k := <span class="number">0</span> <span class="comment">//TR序号</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i &lt;= m &amp;&amp; j &lt;= n &#123;</span><br><span class="line"><span class="keyword">if</span> SR[i] &lt; SR[j] &#123;</span><br><span class="line">TR[k] = SR[i]</span><br><span class="line">i++</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">TR[k] = SR[j]</span><br><span class="line">j++</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">k++</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> i &lt;= m &#123;</span><br><span class="line"><span class="keyword">for</span> l := <span class="number">0</span>; l &lt;= m-i; l++ &#123;</span><br><span class="line">TR[k+l] = SR[i+l]</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> j &lt;= n &#123;</span><br><span class="line"><span class="keyword">for</span> l := <span class="number">0</span>; l &lt;= n-j; l++ &#123;</span><br><span class="line">TR[k+l] = SR[j+l]</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> p := s; p &lt;= n; p++ &#123; <span class="comment">//将排好序的TR写回到SR</span></span><br><span class="line"><span class="keyword">if</span> SR[p] != TR[p-s] &#123;</span><br><span class="line">SR[p] = TR[p-s]</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">a := []<span class="keyword">int</span>&#123;<span class="number">0</span>, <span class="number">9</span>, <span class="number">1</span>, <span class="number">5</span>, <span class="number">8</span>, <span class="number">3</span>, <span class="number">7</span>, <span class="number">4</span>, <span class="number">6</span>, <span class="number">5</span>, <span class="number">16</span>, <span class="number">3</span>, <span class="number">41</span>, <span class="number">7</span>, <span class="number">55</span>, <span class="number">21</span>&#125;</span><br><span class="line">MergeSort2(a)</span><br><span class="line">fmt.Println(a)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4><span id="9-9-kuai-su-pai-xu">9.9 快速排序</span><a href="#9-9-kuai-su-pai-xu" class="header-anchor">#</a></h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">"fmt"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">QuickSort</span>(<span class="params">a []<span class="keyword">int</span></span>)</span> &#123;</span><br><span class="line">Qsort(a, <span class="number">1</span>, <span class="built_in">len</span>(a)<span class="number">-1</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Qsort</span>(<span class="params">a []<span class="keyword">int</span>, low, high <span class="keyword">int</span></span>)</span> &#123;</span><br><span class="line"><span class="keyword">if</span> low &lt; high &#123;</span><br><span class="line">pivot := Partition(a, low, high)</span><br><span class="line"></span><br><span class="line">Qsort(a, low, pivot<span class="number">-1</span>)</span><br><span class="line">Qsort(a, pivot+<span class="number">1</span>, high)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Partition</span>(<span class="params">a []<span class="keyword">int</span>, low, high <span class="keyword">int</span></span>) <span class="title">int</span></span> &#123;</span><br><span class="line">pivotValue := a[low]</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> low &lt; high &#123;</span><br><span class="line"><span class="keyword">for</span> pivotValue &lt;= a[high] &#123; <span class="comment">//找出a[high]&lt;pivotValue</span></span><br><span class="line">high--</span><br><span class="line">&#125;</span><br><span class="line">a[low], a[high] = a[high], a[low] <span class="comment">//将a[hign]放到pivoValue左边</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> low &lt; high &amp;&amp; pivotValue &gt;= a[low] &#123; <span class="comment">//找出a[low]&gt;pivotValue</span></span><br><span class="line">low++</span><br><span class="line">&#125;</span><br><span class="line">a[low], a[high] = a[high], a[low] <span class="comment">//将a[low]放到pivoValue右边</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> low</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Partition2</span>(<span class="params">a []<span class="keyword">int</span>, low, high <span class="keyword">int</span></span>) <span class="title">int</span></span> &#123;</span><br><span class="line">pivotValue := a[low]</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> low &lt; high &#123;</span><br><span class="line"><span class="keyword">for</span> pivotValue &lt;= a[high] &#123; <span class="comment">//找出a[high]&lt;pivotValue</span></span><br><span class="line">high--</span><br><span class="line">&#125;</span><br><span class="line">a[low] = a[high] <span class="comment">//将a[hign]放到较低的位置</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> low &lt; high &amp;&amp; pivotValue &gt;= a[low] &#123; <span class="comment">//找出a[low]&gt;pivotValue</span></span><br><span class="line">low++</span><br><span class="line">&#125;</span><br><span class="line">a[high] = a[low] <span class="comment">//将a[low]放到较高的位置</span></span><br><span class="line">&#125;</span><br><span class="line">a[low] = pivotValue</span><br><span class="line"><span class="keyword">return</span> low</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">a := []<span class="keyword">int</span>&#123;<span class="number">0</span>, <span class="number">50</span>, <span class="number">10</span>, <span class="number">90</span>, <span class="number">30</span>, <span class="number">70</span>, <span class="number">40</span>, <span class="number">80</span>, <span class="number">60</span>, <span class="number">20</span>&#125;</span><br><span class="line">QuickSort(a)</span><br><span class="line">fmt.Println(a)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://upload-images.jianshu.io/upload_images/1863961-25127e3a301cf527.JPG?imageMogr2/auto-orient/strip%7CimageView2/2/w/640" alt=""></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;link rel=&quot;stylesheet&quot; class=&quot;aplayer-secondary-style-marker&quot; href=&quot;/assets/css/APlayer.min.css&quot;&gt;&lt;script src=&quot;/assets/js/APlayer.min.js&quot; cla
      
    
    </summary>
    
    
      <category term="Golang" scheme="https://hejtao.netlify.com/tags/Golang/"/>
    
      <category term="长文" scheme="https://hejtao.netlify.com/tags/%E9%95%BF%E6%96%87/"/>
    
      <category term="数据结构" scheme="https://hejtao.netlify.com/tags/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/"/>
    
  </entry>
  
  <entry>
    <title>Go内存模型</title>
    <link href="https://hejtao.netlify.com/2018/11/14/2018-11-14/"/>
    <id>https://hejtao.netlify.com/2018/11/14/2018-11-14/</id>
    <published>2018-11-13T16:00:00.000Z</published>
    <updated>2019-11-11T19:59:33.199Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><meta name="referrer" content="no-referrer"><div class="toc"><!-- toc --><ul><li><a href="#1-shi-me-shi-go-nei-cun-mo-xing">1. 什么是 Go内存模型？</a></li><li><a href="#2-happens-before">2. Happens Before</a></li><li><a href="#3-synchronization">3. Synchronization</a><ul><li><a href="#3-1-initialization">3.1 Initialization</a></li><li><a href="#3-2-goroutine-creation">3.2 Goroutine creation</a></li><li><a href="#3-3-goroutine-destruction">3.3 Goroutine destruction</a></li><li><a href="#3-4-channel-communication">3.4 Channel communication</a></li><li><a href="#3-5-locks">3.5 Locks</a></li><li><a href="#3-6-once">3.6 Once</a></li></ul></li><li><a href="#4-incorrect-synchronization">4. Incorrect synchronization</a></li></ul><!-- tocstop --></div><p>本文主要翻译自官方文档 <a href="https://golang.org/ref/mem" target="_blank" rel="noopener">The Go Memory Model</a></p><h3><span id="1-shi-me-shi-go-nei-cun-mo-xing">1. 什么是 Go内存模型？</span><a href="#1-shi-me-shi-go-nei-cun-mo-xing" class="header-anchor">#</a></h3><p>我们知道不同的 goroutine 可以对同一个变量进行读写操作。Go内存模型指定了在什么样的条件下可以保证一个 goroutine 写入到变量的值可以被另外一个 goroutine 正确的读取。</p><h3><span id="2-happens-before">2. Happens Before</span><a href="#2-happens-before" class="header-anchor">#</a></h3><p>在单个 goroutine 中，读、写操作按照程序设计的顺序进行。需要注意的是，在不改变 goroutine 程序行为的前提下，这些读、写顺序在编译的过程中可能会被<strong>重排</strong>。因此导致对相同变量的读、写操作在不同的 goroutine 看来执行顺序可能不同。例如，如果在某个 goroutine 中执行 a = 1; b = 2;，另一个 goroutine 可能观察到变量 b 比 a 先被赋值。</p><p>Happens Before 是针对Go语言编程中内存操作的一种局部排序。 如果 $e_{1}$ happens before  $e_{2}$，那么也可以说 $e_{2}$ happens after  $e_{1}$。进一步，如果 $e_{1}$  既不 happens before  $e_{2}$，也不 happens after  $e_{2}$，那么我们称 $e_{1}$ 和 $e_{2}$  happen concurrently (<strong>并发</strong>)。</p><blockquote><p>在单个 goroutine 中，Happens Before顺序就是程序设计的顺序</p></blockquote><p>$v$：某个变量$w$: 对$v$的写$w'$: 对$v$的写，不同于$w$$r$: 对$v$的读</p><p><strong>$w$可以被$r$获取的条件</strong>：</p><ul><li>$r$ 不 happen before $w$. (包括 happen after 和 happen concurrently)</li><li>不存在另一个 $w'$  happens after $w$ but before $r$.</li></ul><p><strong>$w$保证能被$r$获取的条件</strong>(该条件不允许$w'$与$w$或者$r$并发，因此比上面的条件更强):</p><ul><li>$w$ happens before $r$.</li><li>任何其它的 $w'$ 要么 happens before $w$，要么 happens after $r$.</li></ul><p>当有多个 goroutine 可以访问$v$时，必须利用同步事件(synchronization events)来建立 happens before 以保证 $r$能够获取想要的$w$。在初始化过程中，赋给$v$以其类型的零值的操作可以看作是内存模型中的一种$w$</p><h3><span id="3-synchronization">3. Synchronization</span><a href="#3-synchronization" class="header-anchor">#</a></h3><h4><span id="3-1-initialization">3.1 Initialization</span><a href="#3-1-initialization" class="header-anchor">#</a></h4><p>程序的初始化在一个 goroutine 中进行，并且在该 goroutine 中还可以创建其它的 goroutine</p><blockquote><p>如果包 $p$导入了包$q$，那么包$q$在被导入之前就完成了初始化，函数main.main在所有的init函数完成后开始执行，见astaxie的<a href="https://github.com/jiangtaohe/build-web-application-with-golang/blob/master/zh/02.3.md" target="_blank" rel="noopener">main函数和init函数一文</a></p></blockquote><h4><span id="3-2-goroutine-creation">3.2 Goroutine creation</span><a href="#3-2-goroutine-creation" class="header-anchor">#</a></h4><blockquote><p>启动一个新的 goroutine 的 <strong>Go</strong>声明发生在该 goroutine开始执行之前</p></blockquote><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> a <span class="keyword">string</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">f</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line"><span class="built_in">print</span>(a)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">hello</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">a = <span class="string">"hello, world"</span></span><br><span class="line"><span class="keyword">go</span> f()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">hello()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>调用hello()将会在未来某个时间点( 可能在hello()返回之后 )打印hello, world</p><h4><span id="3-3-goroutine-destruction">3.3 Goroutine destruction</span><a href="#3-3-goroutine-destruction" class="header-anchor">#</a></h4><p>无法保证 goroutine 在其创建程序中的某个位置退出</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> a <span class="keyword">string</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">hello</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line"><span class="keyword">go</span> <span class="function"><span class="keyword">func</span>(<span class="params"></span>)</span> &#123; a = <span class="string">"hello"</span> &#125;()</span><br><span class="line"><span class="built_in">print</span>(a)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>对 a 的写(赋值)没有进行任何同步操作，无法被其它 goroutine 获取，在激进的编译器中甚至可能会删除整个 go 声明。</p><h4><span id="3-4-channel-communication">3.4 Channel communication</span><a href="#3-4-channel-communication" class="header-anchor">#</a></h4><p>通道通信(channel communication)是同步两个 goroutine 的主要方法。</p><blockquote><p>send 发生在完成相应的 receive 之前</p></blockquote><p>程序：</p> <figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> c = <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>, <span class="number">10</span>)</span><br><span class="line"><span class="keyword">var</span> a <span class="keyword">string</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">f</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">a = <span class="string">"hello, world"</span></span><br><span class="line">c &lt;- <span class="number">0</span> <span class="comment">// send</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line"><span class="keyword">go</span> f()</span><br><span class="line">&lt;-c <span class="comment">// receive</span></span><br><span class="line"><span class="built_in">print</span>(a)</span><br><span class="line">&#125;</span><br><span class="line">&gt; Output:</span><br><span class="line">command-line-arguments</span><br><span class="line">hello, world</span><br></pre></td></tr></table></figure><p>会保证打印 hello, world，因为：对 a 的写 <strong>happens before</strong> 通道 c 的 send通道 c 的 send <strong>happens before</strong> 通道 c 的 receive通道 c 的 receive <strong>happens before</strong> print(a)，因此 ,对 a 的写 <strong>happens before</strong> print(a), 即保证 main() 获取了 goroutine 对 a的写</p><blockquote><p>channel 的关闭发生在完成 receive(此时得到的是通道类型的零值)之前</p></blockquote><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> c = <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>, <span class="number">10</span>)</span><br><span class="line"><span class="keyword">var</span> a <span class="keyword">string</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">f</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">a = <span class="string">"hello, world"</span></span><br><span class="line"><span class="built_in">close</span>(c) <span class="comment">// 关闭</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line"><span class="keyword">go</span> f()</span><br><span class="line"><span class="built_in">print</span>(a, <span class="string">"\n"</span>, &lt;-c) <span class="comment">// receive</span></span><br><span class="line">&#125;</span><br><span class="line">&gt;Output:</span><br><span class="line">command-line-arguments</span><br><span class="line">hello, world</span><br><span class="line"><span class="number">0</span></span><br></pre></td></tr></table></figure><blockquote><p>无缓存通道的 receive 发生在完成 send 之前</p></blockquote><p>调换 <code>c &lt;- 0 // send</code> 和 <code>&lt;-c // receive</code>的位置，得到程序</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> c = <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>)</span><br><span class="line"><span class="keyword">var</span> a <span class="keyword">string</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">f</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">a = <span class="string">"hello, world"</span></span><br><span class="line">&lt;-c <span class="comment">//receive</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line"><span class="keyword">go</span> f()</span><br><span class="line">c &lt;- <span class="number">0</span> <span class="comment">// send</span></span><br><span class="line"><span class="built_in">print</span>(a)</span><br><span class="line">&#125;</span><br><span class="line">&gt; Output:</span><br><span class="line">command-line-arguments</span><br><span class="line">hello, world</span><br></pre></td></tr></table></figure><p>仍然保证打印 hello, world但如果channel具有缓存，例如当<code>c = make(chan int, 1)</code>，那么程序无法保证打印 hello, world</p><blockquote><p>当通道的容量为$c$时，第 $k$ 次 receive 发生在完成第 $k+c$ 次 send 之前</p></blockquote><p>下面的程序给 work 的每个条目(函数类型)启动一个 goroutine，由于通道limit的容量为3，因此最多允许3个 goroutine 调用调用了函数w()</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> limit = <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>, <span class="number">3</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line"><span class="keyword">for</span> _, w := <span class="keyword">range</span> work &#123;</span><br><span class="line"><span class="keyword">go</span> <span class="function"><span class="keyword">func</span>(<span class="params">w <span class="keyword">func</span>(</span>))</span> &#123;</span><br><span class="line">limit &lt;- <span class="number">1</span></span><br><span class="line">w()</span><br><span class="line">&lt;-limit</span><br><span class="line">&#125;(w)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4><span id="3-5-locks">3.5 Locks</span><a href="#3-5-locks" class="header-anchor">#</a></h4><p><code>sync</code> 包实现了两种 <code>lock</code> 数据类型, <code>sync.Mutex</code>和 <code>sync.RWMutex</code>.</p><blockquote><p>对任意的 <code>sync.Mutex</code> 或者 <code>sync.RWMutex</code>变量 <code>l</code>且$n&lt;m$，第$n$次调用  <code>l.Unlock()</code> 发生在 第 $m$次调用 <code>l.Lock()</code>返回之前</p></blockquote><p>程序</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">"sync"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> l sync.Mutex</span><br><span class="line"><span class="keyword">var</span> a <span class="keyword">string</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">f</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">a = <span class="string">"hello, world"</span></span><br><span class="line">l.Unlock() <span class="comment">//第一次 l.Unlock()</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">l.Lock()</span><br><span class="line"><span class="keyword">go</span> f()</span><br><span class="line">l.Lock() <span class="comment">//第二次 l.Lock()</span></span><br><span class="line"><span class="built_in">print</span>(a)</span><br><span class="line">&#125;</span><br><span class="line">&gt; Output:</span><br><span class="line">command-line-arguments</span><br><span class="line">hello, world</span><br></pre></td></tr></table></figure><p>保证打印hello, world，因为，第一次 <code>l.Unlock()</code>  <strong>happens before</strong>  第二次 <code>l.Lock()</code> 返回第二次 <code>l.Lock()</code> 返回 <strong>happens before</strong>  print(a)</p><blockquote><p>对于任意的<code>l.RLock</code>，存在$k$满足：第 $k$ 次调用 <code>l.Unlock</code> <strong>happens  before</strong> <code>l.RLock</code>；<br>与<code>l.RLock</code>对应的<code>l.RUnlock</code> <strong>happens before</strong> 第 $k+1$次调用 <code>l.Lock</code></p></blockquote><h4><span id="3-6-once">3.6 Once</span><a href="#3-6-once" class="header-anchor">#</a></h4><p>对某个函数<code>f()</code>，可以有多个线程通过<code>once.Do(f)</code>来对其调用，但仅有线程能够调用执行函数<code>f()</code>，其它的调用会被阻塞知道<code>f()</code>返回。</p><p>程序</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">"sync"</span></span><br><span class="line"><span class="string">"time"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> a <span class="keyword">string</span></span><br><span class="line"><span class="keyword">var</span> once sync.Once</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">setup</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">a = <span class="string">"hello, world"</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">SETUP</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">a = <span class="string">"HELLO, WORLD"</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">doprint</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">once.Do(setup) <span class="comment">//注意不要括号</span></span><br><span class="line">once.Do(SETUP)</span><br><span class="line"><span class="built_in">print</span>(a, <span class="string">"\n"</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line"><span class="keyword">go</span> doprint()</span><br><span class="line"><span class="keyword">go</span> doprint()</span><br><span class="line">time.Sleep(time.Second)</span><br><span class="line">&#125;</span><br><span class="line">&gt; Output:</span><br><span class="line">command-line-arguments</span><br><span class="line">hello, world</span><br><span class="line">hello, world</span><br></pre></td></tr></table></figure><p>会打印两次 hello, world，但是仅在第一次调用 doprint 时执行了 setup</p><h3><span id="4-incorrect-synchronization">4. Incorrect synchronization</span><a href="#4-incorrect-synchronization" class="header-anchor">#</a></h3><p>程序</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> a, b <span class="keyword">int</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">f</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">a = <span class="number">1</span></span><br><span class="line">b = <span class="number">2</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">g</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line"><span class="built_in">print</span>(b, <span class="string">"\n"</span>)</span><br><span class="line"><span class="built_in">print</span>(a)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line"><span class="keyword">go</span> f()</span><br><span class="line">g()</span><br><span class="line">&#125;</span><br><span class="line">&gt; Output: <span class="comment">//大多数输出结果</span></span><br><span class="line"><span class="number">0</span></span><br><span class="line"><span class="number">0</span></span><br><span class="line"></span><br><span class="line">&gt; Output: <span class="comment">//少数输出结果</span></span><br><span class="line"><span class="number">0</span></span><br><span class="line"><span class="number">1</span></span><br></pre></td></tr></table></figure><p>也可能先打印2，然后打印0</p><p>程序</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> a <span class="keyword">string</span></span><br><span class="line"><span class="keyword">var</span> done <span class="keyword">bool</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">setup</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">a = <span class="string">"hello, world \n"</span></span><br><span class="line">done = <span class="literal">true</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">doprint</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line"><span class="keyword">if</span> !done &#123;</span><br><span class="line">setup()</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">print</span>(a)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">twoprint</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line"><span class="keyword">go</span> doprint()</span><br><span class="line"><span class="keyword">go</span> doprint()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">twoprint()</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//有3种输出的可能</span></span><br><span class="line">&gt; Output:</span><br><span class="line">hello, world </span><br><span class="line">hello, world </span><br><span class="line">&gt; Output:</span><br><span class="line">hello, world </span><br><span class="line">&gt; Output:</span><br></pre></td></tr></table></figure><p>下面的程序，由于不能保证main()先获取对done的写，因此print()可能打印空字符串。甚至main()完全没有获取对done的写，此时main()进入死循环</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> a <span class="keyword">string</span></span><br><span class="line"><span class="keyword">var</span> done <span class="keyword">bool</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">setup</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">a = <span class="string">"hello, world"</span></span><br><span class="line">done = <span class="literal">true</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line"><span class="keyword">go</span> setup()</span><br><span class="line"><span class="keyword">for</span> !done &#123;</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">print</span>(a)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&gt; Output:</span><br><span class="line">hello, world</span><br><span class="line">&gt; Elapsed: <span class="number">3.703</span>s  <span class="comment">//等待了较长的时间</span></span><br><span class="line">&gt; Result: Success</span><br><span class="line">&gt; Output:</span><br><span class="line">hello, world</span><br><span class="line">&gt; Elapsed: <span class="number">0.704</span>s </span><br><span class="line">&gt; Result: Success</span><br></pre></td></tr></table></figure><p>类似的程序如下</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> T <span class="keyword">struct</span> &#123;</span><br><span class="line">msg <span class="keyword">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> g *T</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">setup</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">t := <span class="built_in">new</span>(T)</span><br><span class="line">t.msg = <span class="string">"hello, world"</span></span><br><span class="line">g = t</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line"><span class="keyword">go</span> setup()</span><br><span class="line"><span class="keyword">for</span> g == <span class="literal">nil</span> &#123;</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">print</span>(g.msg)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;link rel=&quot;stylesheet&quot; class=&quot;aplayer-secondary-style-marker&quot; href=&quot;/assets/css/APlayer.min.css&quot;&gt;&lt;script src=&quot;/assets/js/APlayer.min.js&quot; cla
      
    
    </summary>
    
    
      <category term="Golang" scheme="https://hejtao.netlify.com/tags/Golang/"/>
    
  </entry>
  
  <entry>
    <title>搭建IPFS 私有网络</title>
    <link href="https://hejtao.netlify.com/2018/11/05/2018-11-5/"/>
    <id>https://hejtao.netlify.com/2018/11/05/2018-11-5/</id>
    <published>2018-11-04T16:00:00.000Z</published>
    <updated>2019-11-11T19:59:33.200Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><meta name="referrer" content="no-referrer"><div class="toc"><!-- toc --><ul><li><a href="#zai-servers-shang-an-zhuang-go-huan-jing">在servers上安装 Go 环境</a></li><li><a href="#sheng-cheng-ifps-jie-dian">生成 ifps 节点</a></li><li><a href="#chuang-jian-gong-xiang-mi-yao">创建共享密钥</a></li><li><a href="#tian-jia-qi-dong-jie-dian">添加启动节点</a></li><li><a href="#qi-dong-si-you-wang-luo">启动私有网络</a></li></ul><!-- tocstop --></div><p>本例为建立包含三个节点的IPFS私有网络，节点分别为：server a: root@45.32.28.71server b: root@207.148.109.110本地 mac</p><h3><span id="zai-servers-shang-an-zhuang-go-huan-jing">在servers上安装 Go 环境</span><a href="#zai-servers-shang-an-zhuang-go-huan-jing" class="header-anchor">#</a></h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">cd ~ </span><br><span class="line">$wget https://dl.google.com/go/go1.11.2.linux-amd64.tar.gz</span><br><span class="line">$tar -C /usr/local -xzf go1.11.2.linux-amd64.tar.gz    //解压到得到的 go 目录，放到 /usr/local 目录下</span><br><span class="line">$vim .bashrc</span><br><span class="line">export GOPATH=~/hejtao/go_projects</span><br><span class="line">export GOROOT=/usr/local/go</span><br><span class="line">export GOBIN=$GOROOT/bin</span><br><span class="line">export PATH=$PATH:$GOBIN</span><br><span class="line">$source .bashrc</span><br><span class="line">$go version </span><br><span class="line">go version go1.11.2 linux/amd64  //安装成功</span><br></pre></td></tr></table></figure><p>mac 上的安装类似。</p><h3><span id="sheng-cheng-ifps-jie-dian">生成 ifps 节点</span><a href="#sheng-cheng-ifps-jie-dian" class="header-anchor">#</a></h3><p>在三台机器上执行</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">$go get -u -d github.com/ipfs/go-ipfs         </span><br><span class="line">$cd $GOPATH/src/github.com/ipfs/go-ipfs</span><br><span class="line">$make install</span><br><span class="line">Command &apos;make&apos; not found, but can be installed with:</span><br><span class="line"></span><br><span class="line">sudo apt install make</span><br><span class="line">sudo apt install make-guile</span><br><span class="line">$apt update        \\ 需要安装 make ， 先检查安装包</span><br><span class="line">...</span><br><span class="line">$apt upgrade        \\ 更新安装包</span><br><span class="line">...</span><br><span class="line">$apt install make      \\ 安装 make</span><br><span class="line">...</span><br><span class="line">$make install</span><br><span class="line">/usr/local/go/pkg/tool/linux_amd64/link: running gcc failed: exec: &quot;gcc&quot;: executable file not found in $PATH</span><br><span class="line"></span><br><span class="line">cmd/ipfs/Rules.mk:37: recipe for target &apos;cmd/ipfs-install&apos; failed</span><br><span class="line">make: *** [cmd/ipfs-install] Error 2</span><br><span class="line"></span><br><span class="line">$apt install gcc</span><br><span class="line">...</span><br><span class="line">$gcc -v</span><br><span class="line">...</span><br><span class="line">gcc version 7.3.0 (Ubuntu 7.3.0-27ubuntu1~18.04)</span><br><span class="line">$make install</span><br><span class="line">...</span><br><span class="line">$ipfs init</span><br><span class="line">...</span><br></pre></td></tr></table></figure><p>记下每个节点的ID，比如本例server a 的ID: <strong>QmQ9RjTGVDjhZ2kRVx9tjL4CciiKdNrQzknSyUnCMmB3m2</strong>server b 的ID: <strong>QmRyxoe9JpkDZuMK4G7PkXUy7nGv8VdM98d6Vr2wxFSa3V</strong>mac 的ID: <strong>QmWKKVUy9XqWEGhrikJW8ugHuFzKJJGP5DCGFyvzUJFjzL</strong></p><h3><span id="chuang-jian-gong-xiang-mi-yao">创建共享密钥</span><a href="#chuang-jian-gong-xiang-mi-yao" class="header-anchor">#</a></h3><p>先在任意一台机器上创建密钥，然后拷贝到剩余节点。本例在mac上创建</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$go get -u github.com/Kubuxu/go-ipfs-swarm-key-gen/ipfs-swarm-key-gen</span><br><span class="line">$ipfs-swarm-key-gen &gt; ~/.ipfs/swarm.key</span><br></pre></td></tr></table></figure><ul><li>手动拷贝</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$vim ~/.ipfs/swarm.key        \\ 打开swarm.key, 拷贝内容</span><br></pre></td></tr></table></figure><p>在servers上新建swarm.key</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$vim ~/.ipfs/swarm.key        \\ 将拷贝的内容粘贴</span><br></pre></td></tr></table></figure><ul><li>使用 <code>scp</code> 命令</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$scp ~/.ipfs/swarm.key root@45.32.28.71:~/.ipfs/</span><br><span class="line">$scp ~/.ipfs/swarm.key root@207.148.109.110:~/.ipfs/</span><br></pre></td></tr></table></figure><h3><span id="tian-jia-qi-dong-jie-dian">添加启动节点</span><a href="#tian-jia-qi-dong-jie-dian" class="header-anchor">#</a></h3><p><code>pfs init</code>后的默认启动节点是连接ipfs公网的节点。建立私有网络需要在<strong>每一个节点上</strong>删掉默认启动节点</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ipfs bootstrap rm --all</span><br></pre></td></tr></table></figure><p>将网络中任意其他节点作为启动节点。例如将 server a 作为mac的启动节点</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ipfs bootstrap add/ip4/45.32.28.71/tcp/4001/ipfs/QmQ9RjTGVDjhZ2kRVx9tjL4CciiKdNrQzknSyUnCMmB3m2</span><br></pre></td></tr></table></figure><h3><span id="qi-dong-si-you-wang-luo">启动私有网络</span><a href="#qi-dong-si-you-wang-luo" class="header-anchor">#</a></h3><p>给三个节点添加了启动节点后，启动所有节点，便建立起了含有三个节点的IPFS私有网络。分别执行</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ipfs daemon</span><br></pre></td></tr></table></figure><p>可以使用 <figure class="highlight plain"><figcaption><span>bootstrap list```查看节点所包含的启动节点，使用```ipfs swarm peers```查看节点连接了哪些其他节点。使用```ipfs add file```上传文件到节点，比如给mac节点上传pdf文件，并得到该文件的ID</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">```</span><br><span class="line">$ipfs add ~/files/GO语言编程.pdf</span><br></pre></td></tr></table></figure></p><p>该文件的ID：<strong>QmRDqZoSMCLMP2GH66MKKnduqgTqKBfqNeysPugp9xadUi</strong>。现在与mac建立了连接的server就可以下载该文件了，在server上执行</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ipfs get QmRDqZoSMCLMP2GH66MKKnduqgTqKBfqNeysPugp9xadUi        \\在当前目录会多出一个新的文件便是get到的文件</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;link rel=&quot;stylesheet&quot; class=&quot;aplayer-secondary-style-marker&quot; href=&quot;/assets/css/APlayer.min.css&quot;&gt;&lt;script src=&quot;/assets/js/APlayer.min.js&quot; cla
      
    
    </summary>
    
    
      <category term="IPFS" scheme="https://hejtao.netlify.com/tags/IPFS/"/>
    
  </entry>
  
  <entry>
    <title>A Study for the Reed-Solomon Code</title>
    <link href="https://hejtao.netlify.com/2018/10/18/2018-10-18/"/>
    <id>https://hejtao.netlify.com/2018/10/18/2018-10-18/</id>
    <published>2018-10-18T04:11:11.000Z</published>
    <updated>2019-11-11T19:59:33.199Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><meta name="referrer" content="no-referrer"><div class="toc"><!-- toc --><ul><li><a href="#introduction">Introduction</a></li><li><a href="#galois-field">Galois Field</a></li><li><a href="#galois-field-arithmetic">Galois Field Arithmetic</a><ul><li><a href="#addition-and-subtraction">Addition and Subtraction</a></li><li><a href="#multiplication-and-division">Multiplication and Division</a></li></ul></li><li><a href="#rs-code">RS Code</a><ul><li><a href="#coding-matrix-method">Coding Matrix Method</a></li><li><a href="#generator-polynomial-method">Generator Polynomial Method</a></li></ul></li><li><a href="#rs-code-in-distributed-storage-systems">RS Code in Distributed Storage Systems</a><ul><li><a href="#5-1-rotated-reed-solomon-code">5.1 Rotated Reed-Solomon code</a></li></ul><ul><li><a href="#local-reconstruction-code-lrc">Local Reconstruction Code (LRC)</a></li></ul></li><li><a href="#references">References</a></li></ul><!-- tocstop --></div><h3><span id="introduction">Introduction</span><a href="#introduction" class="header-anchor">#</a></h3><p>Reed-Solomon (RS) code is an error-correcting code first proposed by Reed and Solomon in 1960, which is the most frequently applied digital error correction code around the word. The applications include data storage(hard drives, CD/DVD/Blue Ray), data transmission and common commercial activities(bar codes, QR codes) .RS code has the advantage of high capability of correcting  random or burst errors since it encodes  groups of bits instead of one bit at a time. Redundant datas are generated  so that the original data can be reconstructed with part of the stored or received data loss.  People often back up important files which can be regarded as kind of  data loss protection with redundant data. However, backup is just a copy of the original datas while the redundant data generated in the RS code is a  fusion of the all the original data parts, which is more efficient for storage and error correction.In this article, I have run through the procedure of the RS code and hope it is usefull for you to understand what is going on with this erasure code. Its application in the distributed strorage system are briefly introduced at the end. Part of implementations in pure Go are also provided whose source files can be found on the <a href="https://github.com/klauspost/reedsolomon" target="_blank" rel="noopener">Githup website</a> .</p><h3><span id="galois-field">Galois Field</span><a href="#galois-field" class="header-anchor">#</a></h3><p>The finite field is also called Galois field which has finite elements  and the property that arithmetic operations on field elements always have a result in the field. In the sequel, we illustrate two kind of representations of the finite elements and its arithmetic operations.</p><blockquote><p><strong>Proposition 1.</strong> For any prime $ p $ and any natual number$ r $ there exists a finite field with $ p^{r} $ elements and vice versa.</p></blockquote><p>With the proposition 1, the Galois Field is denoted as $ GF(p^{r}) $. In fact, the nature of RS encoding is mapping $ k $ elments of $ GF(2^{r}) $ into another $ n $ elements of $ GF(2^{r}) $ and $k+2\leq n\leq 2^{r} $. This Galois fields can be represented with the help of $ \mathbf{Z}<em>{2}[x] $, the set of polynomials with coefficients in the field of two elements $ \mathbf{Z}</em>{2} $, namely the polynomial representation as$$0,1,x,x+1,x<sup>{2},..,x</sup>{r-1}+x^{r-2}+...+1 \tag{1}$$This representation  can also be seen as a $r$-bit digit or binary vector.</p><blockquote><p><strong>Proposition 2.</strong> $ GF(q) $ has cyclic the multiplicative group $ {\alpha, \alpha<sup>{2},...,\alpha</sup>{q-1}=1}$, where $ \alpha $ is the primitive element.</p></blockquote><p>Thus, $ GF(2^{r}) $ has the exponential representation as$$0, 1(=\alpha^{255}), \alpha, \alpha^{2},..., \alpha<sup>{2</sup>{r}-2} \tag{2}$$which is a better choice for the '$ \times $' and '$ / $'  operation. Even a binary matrix can be used to  represente the elements. For example, we can establish a bijection between the vector representation and matrix representation over $ GF(2^{4}) $ as follows</p><p><img src="https://upload-images.jianshu.io/upload_images/1863961-ea01dad7bef4b4f4.JPG?imageMogr2/auto-orient/strip%7CimageView2/2/w/600" alt="Matrix representation"></p><p>where the first column is the vector representation and the columns satisfy $column(i)=2\times column(i-1)$. This matrix representation transforms arithmetic over $ GF(2^{4}) $ into arithmetic over $ GF(2) $ which only has XOR, AND operations.</p><h3><span id="galois-field-arithmetic">Galois Field Arithmetic</span><a href="#galois-field-arithmetic" class="header-anchor">#</a></h3><p>In this section, we discuss  arithmetic in $ GF(2^{8}) $, whose element corresponds a byte data.</p><h4><span id="addition-and-subtraction">Addition and Subtraction</span><a href="#addition-and-subtraction" class="header-anchor">#</a></h4><p>Addition and subtraction are operated under the polynomial representation (also a byte in $ GF(2^{8}) $) and both are equivalent to XOR operation</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">galAdd</span>(<span class="params">a, b <span class="keyword">byte</span></span>) <span class="title">byte</span></span> &#123;</span><br><span class="line"><span class="keyword">return</span> a ^ b</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">galSub</span>(<span class="params">a, b <span class="keyword">byte</span></span>) <span class="title">byte</span></span> &#123;</span><br><span class="line"><span class="keyword">return</span> a ^ b</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4><span id="multiplication-and-division">Multiplication and Division</span><a href="#multiplication-and-division" class="header-anchor">#</a></h4><p>The multiplication is operated with the exponential representation $(2)$, before that we should establish a bijection (injection and surjection) between the two representations. Suppose$$\alpha^{i}   -&gt;  2^{i}$$where $0\leq i \leq 2^{8}-2=254$. According to proposition 2, $\forall j\geq 255,\alpha<sup>{j}=\alpha</sup>{j-255}$.</p><blockquote><p><strong>Proposition 3.</strong>$ GF(2^{8}) $ has the irreducible polynomial $ f(x)=x<sup>{8}+x</sup>{4}+x<sup>{3}+x</sup>{2}+1 $ which has no factors of smaller polynomials.</p></blockquote><p>The irreducible polynomial is necessary to establish the bijection since some $2^{i}$ term are no longer in  $GF(2^{8})$. Let $ f(\alpha) =0$, we have $$\alpha<sup>{8}=\alpha</sup>{4}+\alpha<sup>{3}+\alpha</sup>{2}+1=2<sup>{4}+2</sup>{3}+2^{2}+1=00011101$$or <strong>0x1d</strong> . For convenience, we record the bijection with a table, namely called exponent table, whose indexs is the exponents of elements in exponential representation and value is elements in byte representation.</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> expTable = [<span class="number">255</span>]<span class="keyword">byte</span>&#123;<span class="number">0x1</span>, <span class="number">0x2</span>, <span class="number">0x4</span>, <span class="number">0x8</span>, <span class="number">0x10</span>, <span class="number">0x20</span>, <span class="number">0x40</span>, <span class="number">0x80</span>, <span class="number">0x1d</span>, <span class="number">0x3a</span>, ..., <span class="number">0x8e</span>&#125;</span><br></pre></td></tr></table></figure><p>Use logTable[expTable[$i$]]=$i$, the logarithmic table is generated,</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> logTable = []<span class="keyword">byte</span>&#123;</span><br><span class="line"><span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">25</span>, <span class="number">2</span>, <span class="number">50</span>, <span class="number">26</span>, <span class="number">198</span>,</span><br><span class="line">...</span><br><span class="line"><span class="number">116</span>, <span class="number">214</span>, <span class="number">244</span>, <span class="number">234</span>, <span class="number">168</span>, <span class="number">80</span>, <span class="number">88</span>, <span class="number">175</span>,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>With these tables, the $\times$ and $/$ functions in $GF(2^8)$ are easily defined,</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">galMultiply</span>(<span class="params">a, b <span class="keyword">byte</span></span>) <span class="title">byte</span></span> &#123;</span><br><span class="line"><span class="keyword">if</span> a == <span class="number">0</span> || b == <span class="number">0</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">logA := <span class="keyword">int</span>(logTable[a])</span><br><span class="line">logB := <span class="keyword">int</span>(logTable[b])</span><br><span class="line"></span><br><span class="line">sum := logA+logB</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> sum&gt;<span class="number">254</span> &#123;</span><br><span class="line">        sum -= <span class="number">255</span></span><br><span class="line">    &#125;</span><br><span class="line"><span class="keyword">return</span> expTable[sum]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">galDivide</span>(<span class="params">a, b <span class="keyword">byte</span></span>) <span class="title">byte</span></span> &#123;</span><br><span class="line"><span class="keyword">if</span> a == <span class="number">0</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> b == <span class="number">0</span> &#123;</span><br><span class="line"><span class="built_in">panic</span>(<span class="string">"Argument 'divisor' is 0"</span>)</span><br><span class="line">&#125;</span><br><span class="line">logA := <span class="keyword">int</span>(logTable[a])</span><br><span class="line">logB := <span class="keyword">int</span>(logTable[b])</span><br><span class="line">logResult := logA - logB</span><br><span class="line"><span class="keyword">if</span> logResult &lt; <span class="number">0</span> &#123;</span><br><span class="line">logResult += <span class="number">255</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> expTable[logResult]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Based on the result above, the power and inverse functions can be further obtained. In fact, the method to establish the bijection is not unique. The original paper of Reed and Solomon in 1960 provides another method  with finite difference equation which has better computability.</p><h3><span id="rs-code">RS Code</span><a href="#rs-code" class="header-anchor">#</a></h3><h4><span id="coding-matrix-method">Coding Matrix Method</span><a href="#coding-matrix-method" class="header-anchor">#</a></h4><p><strong>1.</strong> Orignal approach:For arbitrary $ k $  8-bit symbols,$ m_{0}$,  $m_{1}$,  $...$,  $m_{k-1} $, we have the message polynomial$$m(x)=m_{0}+m_{1}x+...+m_{k-1}x^{k-1},$$with this $ m(x) $, $ 2^{8} $ codewords, i.e. $ m(0)$,$m(1)$,$...$,  $m(\alpha^{r-2}) $ are obtained and the  the encoded messages, which will be transmitted or stored, are $ n $ of the codewords (professionally called stripe).  Using linear algebra, the stripe are denoted collectively as follows$$\begin{bmatrix}m(\alpha_{1})\m(\alpha_{2})\...\m(\alpha_{n})\end{bmatrix} =\begin{bmatrix}1 &amp; \alpha_{1} &amp; ... &amp; \alpha_{1}^{k-1} \1 &amp; \alpha_{2} &amp; ...&amp;\alpha_{2}^{k-1} \... &amp; ... &amp; ...&amp;... \1 &amp; \alpha_{n} &amp; ...&amp;\alpha_{n}^{k-1}\end{bmatrix} \begin{bmatrix}m_{0}\m_{1}\...\m_{k-1}\end{bmatrix}\tag{3}$$Note that  we only discuss one byte a shard (the messages are splited into multiple shards for encoding) here, in practice  one input shard contains thousands of bytes, in this case the output shard contains same size of byte as input shard and the vectors in $(3)$ becomes matrice.</p><blockquote><p><strong>Coding procedure :</strong> <br>1.Split the whole message into same size data shards;  <br>2. Build the  Vandermonde matrix (coding matrix); <br>3. Multiplies the coding matrix by data shards to produce code shards.</p></blockquote><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> (<span class="params">r reedSolomon</span>) <span class="title">Split</span>(<span class="params">data []<span class="keyword">byte</span></span>) (<span class="params">[][]<span class="keyword">byte</span>, error</span>)</span> &#123;</span><br><span class="line"><span class="keyword">if</span> <span class="built_in">len</span>(data) == <span class="number">0</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span>, ErrShortData</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// Calculate number of bytes per data shard.</span></span><br><span class="line">perShard := (<span class="built_in">len</span>(data) + r.DataShards - <span class="number">1</span>) / r.DataShards</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> <span class="built_in">cap</span>(data) &gt; <span class="built_in">len</span>(data) &#123;</span><br><span class="line">data = data[:<span class="built_in">cap</span>(data)]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Only allocate memory if necessary</span></span><br><span class="line"><span class="keyword">if</span> <span class="built_in">len</span>(data) &lt; (r.Shards * perShard) &#123;</span><br><span class="line"><span class="comment">// Pad data to r.Shards*perShard.</span></span><br><span class="line">padding := <span class="built_in">make</span>([]<span class="keyword">byte</span>, (r.Shards*perShard)-<span class="built_in">len</span>(data))</span><br><span class="line">data = <span class="built_in">append</span>(data, padding...)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Split into equal-length shards.</span></span><br><span class="line">dst := <span class="built_in">make</span>([][]<span class="keyword">byte</span>, r.Shards)</span><br><span class="line"><span class="keyword">for</span> i := <span class="keyword">range</span> dst &#123;</span><br><span class="line">dst[i] = data[:perShard]</span><br><span class="line">data = data[perShard:]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> dst, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">vandermonde</span>(<span class="params">rows, cols <span class="keyword">int</span></span>) (<span class="params">matrix, error</span>)</span> &#123;</span><br><span class="line">result, err := newMatrix(rows, cols)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">for</span> r, row := <span class="keyword">range</span> result &#123;</span><br><span class="line"><span class="keyword">for</span> c := <span class="keyword">range</span> row &#123;</span><br><span class="line">result[r][c] = galExp(<span class="keyword">byte</span>(r), c)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> result, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Multiplies a subset of rows from a coding matrix by a full set of</span></span><br><span class="line"><span class="comment">// input shards to produce some output shards.</span></span><br><span class="line"><span class="comment">// 'matrixRows' is The rows from the matrix to use.</span></span><br><span class="line"><span class="comment">// 'inputs' An array of byte arrays, each of which is one input shard.</span></span><br><span class="line"><span class="comment">// The number of inputs used is determined by the length of each matrix row.</span></span><br><span class="line"><span class="comment">// outputs Byte arrays where the computed shards are stored.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> (<span class="params">r reedSolomon</span>) <span class="title">codeSomeShards</span>(<span class="params">matrixRows, inputs, outputs [][]<span class="keyword">byte</span></span>)</span> &#123;</span><br><span class="line"><span class="keyword">for</span> c := <span class="number">0</span>; c &lt; r.DataShards; c++ &#123;</span><br><span class="line">in := inputs[c]</span><br><span class="line"><span class="keyword">for</span> iRow := <span class="number">0</span>; iRow &lt; outputCount; iRow++ &#123;</span><br><span class="line"><span class="keyword">if</span> c == <span class="number">0</span> &#123;</span><br><span class="line">galMulSlice(matrixRows[iRow][c], in, outputs[iRow], r.o.useSSSE3, r.o.useAVX2)</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">galMulSliceXor(matrixRows[iRow][c], in, outputs[iRow], r.o.useSSSE3, r.o.useAVX2)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Since any $ k $ rows of Vandermonde matrix are linearly independent, with arbitrary $ k $ correct code shards, the original $ k $  data shards can be reconstructed by multiplying the corresponding inverse matrix. However, in practice, we usually do not know which one is correct or corrupted for the $ n $ received codewords. In this case, the plurality of votes method is necessary and$$\left(\begin{array}{c}n-s\k\end{array} \right)&gt;\left(\begin{array}{c}s+k-1\k\end{array} \right)$$or$$s&lt;\frac{n-k+1}{2}$$where $s$ is number of unkown errors, therefore $ n=k+2s $ always satisfies the in-equation. Another approach is to use the Berlekamp-Welsh Algorithm  which avoids the heavy computation of votes:</p><blockquote><p><strong>Berlekamp-Welsh decoder:</strong><br> 1. Send $m(0),m(1),...,m(n)$,  receive $m'(0),m'(1),...,m'(n)$, and most $s$ of  them such that $m(i)\neq m'(i)$；<br> 2.  $E(x)=x<sup>{s}+b_{s-1}x</sup>{s-1}+...+b_{0}$, $Q(x)=a_{k+s-1}x<sup>{k+s-1}+a_{k+s-2}x</sup>{k+s-2}+...+a_{0}$ <br> 3. Solve the coefficients of co$E(x)$,$Q(x)$ with $  Q(i)=m'(i)E(i)$ <br>4. Derive $m(x)=Q(x)/E(x)$.</p></blockquote><p>And $\forall m(i)\neq m'(i)$,$E(i)=0$.<strong>The implicite principle:</strong> $Q'(x)/E'(x)$ and $Q(x)/E(x)$  agree on at least $k+s$ points. $E'(x)$  and  $E(x)$ both have at most $s$ zero points. Elimilate $E'(x)$  and  $E(x)$,$Q'(x)/E'(x)$ and $Q(x)/E(x)$ are degree at least $k-1$ and agree on at least $k$ points, thus $Q'(x)/E'(x)=Q(x)/E(x)=m(x)$.<br><strong>2.</strong> Systematic coding matrix:</p><p><img src="https://upload-images.jianshu.io/upload_images/1863961-aceb4a25d416d295.JPG?imageMogr2/auto-orient/strip%7CimageView2/2/w/600" alt=""><br></p><p><img src="https://upload-images.jianshu.io/upload_images/1863961-8b2f627ce05e386f.JPG?imageMogr2/auto-orient/strip%7CimageView2/2/w/600" alt=""><br></p><p><img src="https://upload-images.jianshu.io/upload_images/1863961-7404acc2dbc829e4.JPG?imageMogr2/auto-orient/strip%7CimageView2/2/w/600" alt=""><br></p><p><img src="https://upload-images.jianshu.io/upload_images/1863961-df23756e41d208b3.JPG?imageMogr2/auto-orient/strip%7CimageView2/2/w/600" alt=""><br></p><p><img src="https://upload-images.jianshu.io/upload_images/1863961-8c7bbe0310c9efea.JPG?imageMogr2/auto-orient/strip%7CimageView2/2/w/600" alt=""><br></p><p><img src="https://upload-images.jianshu.io/upload_images/1863961-d69a32352af4c86a.JPG?imageMogr2/auto-orient/strip%7CimageView2/2/w/600" alt=""><br></p><p><img src="https://upload-images.jianshu.io/upload_images/1863961-c0a5889de5a6bd1d.JPG?imageMogr2/auto-orient/strip%7CimageView2/2/w/600" alt=""><br></p><p>In the original approach, all the code shards have been encoded. While in the systematic encoding, the original data shards become part of the code shards and only the parity shards should be encoded. In other words, the stripe contains the original datas and parity codewords together no longer codewords only. The coding matrix is composed of  the top square identity matrix and the parity matrix. There are three methods of building the coding matrix in this systematic way are provided:</p><ul><li>Elementary transform on the Vandermonde matrix as the procedure 1.</li></ul><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">buildMatrix</span>(<span class="params">dataShards, totalShards <span class="keyword">int</span></span>) (<span class="params">matrix, error</span>)</span> &#123;</span><br><span class="line">vm, err := vandermonde(totalShards, dataShards)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">top, err := vm.SubMatrix(<span class="number">0</span>, <span class="number">0</span>, dataShards, dataShards)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">topInv, err := top.Invert()</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> vm.Multiply(topInv)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>Parity matrix is Vandermonde matrix.</li></ul><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">buildMatrixPAR1</span>(<span class="params">dataShards, totalShards <span class="keyword">int</span></span>) (<span class="params">matrix, error</span>)</span> &#123;</span><br><span class="line">result, err := newMatrix(totalShards, dataShards)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> r, row := <span class="keyword">range</span> result &#123;</span><br><span class="line"><span class="comment">// The top portion of the matrix is the identity</span></span><br><span class="line"><span class="comment">// matrix, and the bottom is a transposed Vandermonde</span></span><br><span class="line"><span class="comment">// matrix starting at 1 instead of 0.</span></span><br><span class="line"><span class="keyword">if</span> r &lt; dataShards &#123;</span><br><span class="line">result[r][r] = <span class="number">1</span></span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="keyword">for</span> c := <span class="keyword">range</span> row &#123;</span><br><span class="line">result[r][c] = galExp(<span class="keyword">byte</span>(c+<span class="number">1</span>), r-dataShards)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> result, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>Parity matrix is Cauchy matrix. Cauchy matrices are easier to invert than general matrices [8].</li></ul><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">buildMatrixCauchy</span>(<span class="params">dataShards, totalShards <span class="keyword">int</span></span>) (<span class="params">matrix, error</span>)</span> &#123;</span><br><span class="line">result, err := newMatrix(totalShards, dataShards)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> r, row := <span class="keyword">range</span> result &#123;</span><br><span class="line"><span class="comment">// The top portion of the matrix is the identity</span></span><br><span class="line"><span class="comment">// matrix, and the bottom is a transposed Cauchy matrix.</span></span><br><span class="line"><span class="keyword">if</span> r &lt; dataShards &#123;</span><br><span class="line">result[r][r] = <span class="number">1</span></span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="keyword">for</span> c := <span class="keyword">range</span> row &#123;</span><br><span class="line">result[r][c] = invTable[(<span class="keyword">byte</span>(r ^ c))]</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> result, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4><span id="generator-polynomial-method">Generator Polynomial Method</span><a href="#generator-polynomial-method" class="header-anchor">#</a></h4><p>Define the generator polynomial:</p><p>$$g(x)=(x-\alpha)(x-\alpha<sup>{2})\dots(x-\alpha</sup>{2s})$$and the codeword polynomial can be directly computed as$$c(x)=m(x)g(x)$$For the systematic form, which is more often used in practice, we define$$b(x)=x^{2s}m(x) \quad mod\quad g(x)$$then the codeword polynomial becomes$$c(x)=x^{2s}m(x)-b(x)$$</p><p>where $-b(x)$ is the parity  codeword polynomial. All the polynomial operation above is processed over $GF(2^8)$. It is also observed that the correction of received message can be checked  by testing its divisibility by g(x), and there is no need to decode for the systematic encoding if the answer is affirmative. Otherwise, we denote $r(x)=c(x)+e(x)$ and suppose there are $ v(\leq s) $ errors</p><blockquote><p><strong>Syndrome based decoder:</strong>1.Calculate the $2s$ Syndromes: $S_{j}=r(\alpha<sup>{j})=e(\alpha</sup>{j})$ <br> 2. Solve$$ \begin{bmatrix}S_{1} &amp; S_{2}&amp; ... &amp; S_{v} \S_{2} &amp; S_{3} &amp; ...&amp;S_{v+1} \... &amp; ... &amp; ...&amp;... \S_{v} &amp; S_{v+1} &amp; ...&amp;S_{2v-1}\end{bmatrix} \begin{bmatrix}\Lambda_{v}\\Lambda_{v-1}\...\\Lambda_{1}\end{bmatrix}=\begin{bmatrix}-S_{v} \-S_{v+1}\...\-S_{2v}\tag{4}\end{bmatrix} $$ and use <a href="https://en.wikipedia.org/wiki/Chien_search" target="_blank" rel="noopener">Chien search</a> solve $\Lambda(x)=\Lambda_{v}x^{v} +\Lambda_{v-1}x^{v-1}+...+1=0$ to derive the $v$ roots, denoted as,$x_{1},..,x_{v}$. <br> 3. Use <a href="https://en.wikipedia.org/wiki/Forney_algorithm" target="_blank" rel="noopener">Forney algorithm</a> to solve$$ \begin{bmatrix}x_{1}^{-1} &amp; x_{2}^{-1}&amp; ... &amp; x_{v}^{-1} \x_{1}^{-2} &amp; x_{2}^{-2} &amp; ...&amp;x_{v}^{-2} \... &amp; ... &amp; ...&amp;... \x_{1}^{-2s} &amp; x_{2}^{-2s} &amp; ...&amp;x_{v}^{-2s}\end{bmatrix} \begin{bmatrix}e_{i_{1}}\e_{i_{2}}\...\e_{i_{v}}\end{bmatrix}=\begin{bmatrix}S_{1} \S_{2}\...\S_{2s}\tag{5}\end{bmatrix} $$  <br>4. The index $i_{j}$ of $e_{i_{j}}$ are determined by looking up the  logarithmic table as earlier mentioned <br> 5. Compute $e(x)=\sum_{j=1}<sup>{v}e_{i_{j}}x</sup>{i_{j}}$ and $c(x) = r(x)-e(x)$.</p></blockquote><p>It is worth mentioning that all the syndromes are zeros if $r(x)=c(x)$,  this can be used to check if the received message is corrupted or if the message was completely constructed.  RS encoding is relatively straightforward for the generator approach, but decoding needs complicated algebraic computation, especially for the step 2. Because the real value of $v$ is unknown and the normal way has to use the trial value  untill the matrix in $(4)$ is nonsingular.  Other algebraic methods for the evaluation of this error location polynomial $\Lambda(x)$ include  <a href="https://en.wikipedia.org/wiki/Berlekamp%E2%80%93Massey_algorithm" target="_blank" rel="noopener">Berlekamp–Massey algorithm</a> and <a href="https://en.wikipedia.org/wiki/Extended_Euclidean_algorithm" target="_blank" rel="noopener">Extended Euclidean algorithm</a>.This syndrome based decoder  can be implemented with different hardware unit such as matrix vector multiplication unit, remainder unit,  and performs <strong>hard-decision decoding</strong> up to $s$ errors. Hard-decision decoding decides the  bit according to the a threshold, where each bit is  definitely one or zero. While <strong>soft-decision decoding</strong>  requires additional reliability information to improve the decision, which has better coding gain for the white Guassian channel [2].</p><h3><span id="rs-code-in-distributed-storage-systems">RS Code in Distributed Storage Systems</span><a href="#rs-code-in-distributed-storage-systems" class="header-anchor">#</a></h3><p>The RS code are stored in different disks in the distributed storage systems, and the performance arasure code in distributed storage systems involves  disk I/O and repair bandwidth overhead.</p><h5><span id="5-1-rotated-reed-solomon-code">5.1 Rotated Reed-Solomon code</span><a href="#5-1-rotated-reed-solomon-code" class="header-anchor">#</a></h5><p>In the conventional RS code, all the parity blocds are encoded with data blocks in the same strip, while in the rotated reed-solomon code, parity blocks may be generated with different stripes as in the following figure,</p><p><img src="https://upload-images.jianshu.io/upload_images/1863961-1a81fb7850f88085.JPG?imageMogr2/auto-orient/strip%7CimageView2/2/w/600" alt="RRS code"></p><p>when the disk 5 in the figure fails, this method reduceS 3 operations of reading the data blocks than the conventional RS code [5].</p><h4><span id="local-reconstruction-code-lrc">Local Reconstruction Code (LRC)</span><a href="#local-reconstruction-code-lrc" class="header-anchor">#</a></h4><p>LRC introduces local parity codes which requires slightly more storage space than conventional RS code, but significantly reduce the number of participating data discs for encoding, thus it is beneficial to the reduction of bandwidth and disc I/O overhead.  The figure of pyramid code is shown as follows [6]</p><p><img src="https://upload-images.jianshu.io/upload_images/1863961-eb3e80741654047b.JPG?imageMogr2/auto-orient/strip%7CimageView2/2/w/600" alt="Pyramid"></p><p>However, repair of the global redundancy still needs to access all data discs, another LRC approach in  [7] further introduces parity code ($ S_{3} $ in the figure) for the global parity codes ($P_{1}$,$P_{2}$,$P_{3}$,$P_{4}$)  to avoid this undesirable situation. By choosing the coefficients of $c_{1}^{'}$, $c_{2}^{'}$, $c_{3}^{'}$, $c_{4}^{'}$ and $c_{5}^{'}$, $c_{6}^{'}$ properly, the parity code of  $ S_{3} $ can be calculated by the existing parity codes $ S_{1} $ and $ S_{2} $. Thus parity code $ S_{3} $ does not have to occupy additional storage.</p><p><img src="https://upload-images.jianshu.io/upload_images/1863961-26576a62ea3ad8ca.JPG?imageMogr2/auto-orient/strip%7CimageView2/2/w/600" alt="HDFS-Xorbas"></p><blockquote><p><strong>Observation:</strong>  Copy is kind of LRC.</p></blockquote><h3><span id="references">References</span><a href="#references" class="header-anchor">#</a></h3><p>[1] I. Reed and G. Solomon, BPolynomial codes over certain finite fields,[ J. Soc. Ind. Appl. Math., vol. 8,<br>no. 2, pp. 300–304, Jun. 1960.[2] Wicker and Bhargava, Reed-Solomon Codes and Their Applications, 1994.[3] James S. Plank and Lihao Xu, Optimizing Cauchy Reed-Solomon Codes for Fault-Tolerant Network Storage Applications.[4] Reed–Solomon codes for coders.[5] Khan O, Burns R C, Plank J S, et al. Rethinking erasure codes for cloud file systems: minimizing I/O for recovery and degraded reads.[6] Huang Cheng, Chen Minghua, Li Jin. Pyramid codes: flexible schemes to trade space for access efficiency in reliable data storage systems.[7] Sathiamoorthy M, Asteris M, Papailiopoulos D, et al. Xoring elephants: novel erasure codes for big data.[8]  J. Blomer, M. Kalfane, R. Karp, M. Karpinski, M. Luby, and D. Zuckerman, An XOR-Based Erasure-Resilient Coding Scheme.</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;link rel=&quot;stylesheet&quot; class=&quot;aplayer-secondary-style-marker&quot; href=&quot;/assets/css/APlayer.min.css&quot;&gt;&lt;script src=&quot;/assets/js/APlayer.min.js&quot; cla
      
    
    </summary>
    
    
      <category term="RS Code" scheme="https://hejtao.netlify.com/tags/RS-Code/"/>
    
      <category term="Golang" scheme="https://hejtao.netlify.com/tags/Golang/"/>
    
      <category term="长文" scheme="https://hejtao.netlify.com/tags/%E9%95%BF%E6%96%87/"/>
    
  </entry>
  
  <entry>
    <title>Golang编程基础</title>
    <link href="https://hejtao.netlify.com/2018/08/20/2018-8-20/"/>
    <id>https://hejtao.netlify.com/2018/08/20/2018-8-20/</id>
    <published>2018-08-20T05:59:10.000Z</published>
    <updated>2019-11-11T19:59:33.203Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><meta name="referrer" content="no-referrer"><div class="toc"><!-- toc --><ul><li><a href="#zai-ubuntu-an-zhuang">在Ubuntu安装:</a></li><li><a href="#shu-ju-lei-xing">数据类型:</a><ul><li><a href="#ji-ben-lei-xing">基本类型：</a></li><li><a href="#ju-ji-lei-xing-aggregate-types">聚集类型 (aggregate types)：</a><ul><li><a href="#shu-zu">数组</a></li><li><a href="#jie-gou">结构</a></li></ul></li><li><a href="#yin-yong-lei-xing">引用类型</a><ul><li><a href="#zhi-zhen">指针</a></li><li><a href="#qie-pian-slice">切片（slice）</a></li><li><a href="#zi-dian-map">字典（map）</a></li><li><a href="#han-shu">函数</a></li><li><a href="#tong-dao-channel">通道（channel）</a></li></ul></li><li><a href="#jie-kou-lei-xing-interface">接口类型（interface）：</a></li></ul></li><li><a href="#kong-zhi-liu-for-if-switch-defer-goto">控制流 （for if switch defer goto）：</a></li><li><a href="#chuang-jian-gong-cheng-mu-lu">创建工程目录：</a></li><li><a href="#tips">Tips:</a></li><li><a href="#qi-ta">其他：</a></li><li><a href="#can-kao-zi-liao">参考资料：</a></li></ul><!-- tocstop --></div><h3><span id="zai-ubuntu-an-zhuang">在Ubuntu安装:</span><a href="#zai-ubuntu-an-zhuang" class="header-anchor">#</a></h3> <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&gt;<span class="built_in">cd</span> ~ </span><br><span class="line">&gt;wget https://dl.google.com/go/go1.11.2.linux-amd64.tar.gz</span><br><span class="line">&gt;tar -C /usr/<span class="built_in">local</span> -xzf go1.11.2.linux-amd64.tar.gz    // 解压到得到的 go 目录，放到 /usr/<span class="built_in">local</span> 目录下</span><br><span class="line">&gt;vim .bashrc    // 写入以下内容</span><br><span class="line"><span class="built_in">export</span> GOPATH=~/hejtao/go_projects</span><br><span class="line"><span class="built_in">export</span> GOROOT=/usr/<span class="built_in">local</span>/go</span><br><span class="line"><span class="built_in">export</span> GOBIN=<span class="variable">$GOROOT</span>/bin</span><br><span class="line"><span class="built_in">export</span> PATH=<span class="variable">$PATH</span>:<span class="variable">$GOBIN</span></span><br><span class="line">&gt;<span class="built_in">source</span> .bashrc</span><br></pre></td></tr></table></figure><h3><span id="shu-ju-lei-xing">数据类型:</span><a href="#shu-ju-lei-xing" class="header-anchor">#</a></h3><p><img src="https://upload-images.jianshu.io/upload_images/1863961-07626fa602c42064.JPG?imageMogr2/auto-orient/strip%7CimageView2/2/w/600" alt=""></p><h4><span id="ji-ben-lei-xing">基本类型：</span><a href="#ji-ben-lei-xing" class="header-anchor">#</a></h4><ul><li>数值<ul><li>整型：<code>int</code>； <code>int8</code>； <code>int16</code>；  <code>int32</code>(<code>rune</code>，<code>Unicode</code>)；  <code>int64</code>； <code>uint</code>； <code>uint8</code>(<code>byte</code>)； <code>uint16</code>； <code>uint32</code>； <code>uint64</code>； <code>uintptr</code><code>int</code>, <code>uint</code>, <code>uintptr</code> 在 32 位系统上是 32 位，在 64位 系统上是 64位</li><li>浮点型：<code>float32</code>； <code>float64</code></li><li>复数型：<code>complex64</code>； <code>complex128</code></li></ul></li><li>字符串：使用双引号 <code>&quot;a&quot;</code></li><li>布尔: <code>true</code>； <code>false</code></li><li>常量：三种基本类型</li></ul><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span>(</span><br><span class="line">  kb = <span class="number">1024</span></span><br><span class="line">  e = <span class="number">2.71828182845904523536028747135266249775724709369995957496696763</span></span><br><span class="line">  F = <span class="literal">false</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure><blockquote><p>在 <code>if</code>语句中，若检验条件为<code>i &gt;= 0</code>，则<code>i</code> 的类型不宜为 <code>uint</code> 型（<code>uint</code> 数据始终 &gt;= 0）。尽管内置函数 <code>len()</code> 返回值是非负整数，但它际返回 <code>int</code> 型，</p></blockquote><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">medals := []<span class="keyword">string</span>&#123;<span class="string">"gold"</span>, <span class="string">"silver"</span>, <span class="string">"bronze"</span>&#125;</span><br><span class="line"><span class="keyword">for</span> i := <span class="built_in">len</span>(medals)<span class="number">-1</span>; i &gt;= <span class="number">0</span>; i--&#123;</span><br><span class="line">  fmt.Println(medals[i]) <span class="comment">// "bronze", "silver", "gold"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>基本类型与操作符构成表达式</p><p><img src="https://upload-images.jianshu.io/upload_images/1863961-f1c19a4e5f60b7af.JPG?imageMogr2/auto-orient/strip%7CimageView2/2/w/300" alt=""></p><ul><li>取余 <code>%</code> 只用于整型；余数与被除数符号相同，<code>5%3=2</code>； <code>-5%3=-2</code></li><li><code>5.0/4=1.25</code>；<code>5/4.0=1.25</code>；<code>5/4=1</code></li><li><code>&amp;&amp;</code> 若左边的表达式结果为 <code>false</code>，不检验右边的表达式；<code>&amp;</code> 始终检验两边的表达式</li><li>与或<code>^</code> ; 一元前缀<code>^</code></li></ul><h4><span id="ju-ji-lei-xing-aggregate-types">聚集类型 (aggregate types)：</span><a href="#ju-ji-lei-xing-aggregate-types" class="header-anchor">#</a></h4><h5><span id="shu-zu">数组</span><a href="#shu-zu" class="header-anchor">#</a></h5><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> a [<span class="number">3</span>]<span class="keyword">int</span></span><br><span class="line">r := [...]<span class="keyword">int</span>&#123;<span class="number">99</span>: <span class="number">1</span>&#125;    <span class="comment">// 索引为99的元素，r[99]， 等于 1，其他默认 0</span></span><br><span class="line"></span><br><span class="line">p := <span class="built_in">new</span>([<span class="number">10</span>]<span class="keyword">int</span>)    <span class="comment">// 将生成的数组的指针赋给 p, 为 *[10]int 类型</span></span><br><span class="line">p[<span class="number">0</span>]=<span class="number">1</span>    <span class="comment">// 给 p 指向的数组的索引为0的元素赋值 1</span></span><br></pre></td></tr></table></figure><p>数组的长度也是数组类型的一部分，因此 <code>[3]int</code> 和 <code>[4]int</code> 是不同类型的数组，不能进行比较或赋值。</p><h5><span id="jie-gou">结构</span><a href="#jie-gou" class="header-anchor">#</a></h5><p>（1）结构的字段（field）</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> person <span class="keyword">struct</span>&#123;      <span class="comment">// 定义 person 类型</span></span><br><span class="line">    gender <span class="keyword">string</span></span><br><span class="line">    age <span class="keyword">int</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    student := person&#123;&#125;</span><br><span class="line">    student.age = <span class="number">16</span></span><br><span class="line">    student.gender = <span class="string">"male"</span></span><br><span class="line">    <span class="comment">// or</span></span><br><span class="line">    student := person&#123;</span><br><span class="line">       gender : <span class="string">"male"</span>, </span><br><span class="line">        age : <span class="number">16</span>,    <span class="comment">//逗号不能省</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// or</span></span><br><span class="line">    student := person&#123;<span class="string">"male"</span>, <span class="number">16</span>&#125;</span><br><span class="line"></span><br><span class="line">    teacher := &amp;person&#123;    <span class="comment">//取指针</span></span><br><span class="line">      gender : <span class="string">"female"</span>, </span><br><span class="line">       age : <span class="number">30</span>,    </span><br><span class="line">    &#125;</span><br><span class="line">    teacher.age = <span class="number">36</span>    <span class="comment">//指针 teacher 仍然可以进行点操作</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>指针也可以进行点操作。</p></blockquote><p>匿名结构，字段匿名</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">student := <span class="keyword">struct</span>&#123;      <span class="comment">// 匿名结构</span></span><br><span class="line">    gender : <span class="keyword">string</span></span><br><span class="line">    age : <span class="keyword">int</span></span><br><span class="line">&#125;&#123;</span><br><span class="line">    gender : <span class="string">"male"</span>,</span><br><span class="line">    age : <span class="string">"17"</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> person <span class="keyword">struct</span>&#123;      </span><br><span class="line">    <span class="keyword">string</span></span><br><span class="line">    <span class="keyword">int</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 按照顺序初始化</span></span><br><span class="line">student := person&#123;<span class="string">"male"</span>, <span class="number">10</span>&#125;</span><br></pre></td></tr></table></figure><p>结构嵌套，</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> person <span class="keyword">struct</span>&#123;      </span><br><span class="line">    gender <span class="keyword">string</span></span><br><span class="line">    age <span class="keyword">int</span></span><br><span class="line">    parents <span class="keyword">struct</span>&#123;      <span class="comment">//  嵌套一个匿名结构</span></span><br><span class="line">        dad, mom : <span class="keyword">string</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> address <span class="keyword">struct</span>&#123;</span><br><span class="line">    state, city <span class="keyword">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> person2 <span class="keyword">struct</span>&#123;      </span><br><span class="line">    gender <span class="keyword">string</span></span><br><span class="line">    age <span class="keyword">int</span></span><br><span class="line">    address    <span class="comment">// 嵌套你一个结构address</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    student := person&#123;gender : <span class="string">"female"</span>, age : <span class="number">10</span>&#125;</span><br><span class="line">    student.parents.dad = <span class="string">"Tom"</span></span><br><span class="line">    student.parents.mom = <span class="string">"Lily"</span>     </span><br><span class="line">    </span><br><span class="line">    student2 := person2&#123;gender:<span class="string">"female"</span>, age:<span class="number">10</span>, address : address&#123;county:<span class="string">"LA"</span> state:<span class="string">"California"</span>&#125;  &#125; </span><br><span class="line">    student2.address.state = <span class="string">"Massachusetts"</span>    <span class="comment">// or</span></span><br><span class="line">    student2.state = <span class="string">"Massachusetts"</span>  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>（2）结构的方法（method）函数与方法</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">"fmt"</span></span><br><span class="line"><span class="string">"math"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Point <span class="keyword">struct</span>&#123; X, Y <span class="keyword">float64</span> &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Distance</span>(<span class="params">p, q Point</span>) <span class="title">float64</span></span> &#123;<span class="comment">//函数</span></span><br><span class="line"><span class="keyword">return</span> math.Hypot(q.X-p.X, q.Y-p.Y)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> (<span class="params">p Point</span>) <span class="title">Distance</span>(<span class="params">q Point</span>) <span class="title">float64</span></span> &#123;<span class="comment">// 方法，在函数名前增加一个形参（receiver） 类似于Java的this 和python的 self，</span></span><br><span class="line"><span class="keyword">return</span> math.Hypot(q.X-p.X, q.Y-p.Y)             <span class="comment">// 接收者的名称通常取它的类型名称的第一个字母</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">p := Point&#123;<span class="number">1</span>, <span class="number">2</span>&#125;</span><br><span class="line">q := Point&#123;<span class="number">4</span>, <span class="number">6</span>&#125;</span><br><span class="line">fmt.Println(Distance(p, q))<span class="comment">// 打印 5， 调用函数</span></span><br><span class="line">fmt.Println(p.Distance(q))<span class="comment">// 调用方法</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>当需要使用方法对值（value of type T，相对于方法来讲就是实参，argument） 的字段进行修改时，使用接收者为指针的方法或者叫指针方法</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> (<span class="params">p *Point</span>) <span class="title">ScaleBy</span>(<span class="params">factor <span class="keyword">float64</span></span>)</span> &#123;      <span class="comment">// 接收者参数p的类型是指针类型</span></span><br><span class="line">    p.X *= factor      <span class="comment">// p在这里是指针，等价于 (*p).X</span></span><br><span class="line">    p.Y *= factor</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>同一个 struct 的方法和字段占据相同的命名空间（name space），因此两者的名称不能重复；指针方法看作高权限方法。</p></blockquote><p>对方法的调用, 值（实参） 和 接收者（形参）类型要相同</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Point&#123;<span class="number">1</span>, <span class="number">2</span>&#125;.Distance(q)     <span class="comment">// Point  Point</span></span><br><span class="line">pptr.ScaleBy(<span class="number">2</span>)       <span class="comment">// *Point  *Point</span></span><br><span class="line"></span><br><span class="line">pptr.Distance(q)     <span class="comment">// 隐含 (*pptr)</span></span><br><span class="line">p.ScaleBy(<span class="number">2</span>)     <span class="comment">// 隐含 (&amp;p)</span></span><br><span class="line"></span><br><span class="line">             Point&#123;<span class="number">1</span>, <span class="number">2</span>&#125;.ScaleBy(<span class="number">2</span>)    <span class="comment">//错误！！！</span></span><br><span class="line">(&amp;Point&#123;<span class="number">1</span>, <span class="number">2</span>&#125;).ScaleBy(<span class="number">2</span>)</span><br></pre></td></tr></table></figure><p>不仅仅是 <code>struct</code></p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">"fmt"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> INT <span class="keyword">int</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line"><span class="keyword">var</span> a INT</span><br><span class="line">a = <span class="number">1</span></span><br><span class="line">a.Print()    <span class="comment">// 打印 2</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> (<span class="params">a *INT</span>) <span class="title">Print</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">*a = <span class="number">2</span></span><br><span class="line">fmt.Println(*a)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>方法是与命名类型(named type)相关联的函数。</p></blockquote><h4><span id="yin-yong-lei-xing">引用类型</span><a href="#yin-yong-lei-xing" class="header-anchor">#</a></h4><h5><span id="zhi-zhen">指针</span><a href="#zhi-zhen" class="header-anchor">#</a></h5><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> p *<span class="keyword">int</span></span><br><span class="line">i := <span class="number">20</span></span><br><span class="line">p = &amp;i</span><br><span class="line">*p = <span class="number">10</span>    <span class="comment">// i 的值为 10</span></span><br></pre></td></tr></table></figure><h5><span id="qie-pian-slice">切片（slice）</span><a href="#qie-pian-slice" class="header-anchor">#</a></h5><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> s []<span class="keyword">int</span>    <span class="comment">// 声明切片 s</span></span><br><span class="line">a := [<span class="number">5</span>]<span class="keyword">int</span>&#123;<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>&#125;</span><br><span class="line">s = a[:<span class="number">2</span>]    <span class="comment">// [1, 2]， len(s)等于2，cap(s)等于5</span></span><br><span class="line">s = a[<span class="number">0</span>:<span class="number">1</span>]    <span class="comment">// [1]，len(s)等于1，cap(s)等于5</span></span><br><span class="line">s = a[<span class="number">3</span>:]    <span class="comment">// [4, 5]，len(s)等于2，cap(s)等于2</span></span><br><span class="line"></span><br><span class="line">s := <span class="built_in">make</span>([]<span class="keyword">int</span>, <span class="number">2</span>, <span class="number">4</span>)    <span class="comment">//make([]type, len, cap) ，切片长度为2，底层数组的长度为4</span></span><br><span class="line">s = <span class="built_in">append</span>(s, <span class="number">1</span>)    <span class="comment">// s 的地址不变</span></span><br><span class="line">s = <span class="built_in">append</span>(s, <span class="number">2</span>, <span class="number">3</span>)    <span class="comment">// 生成新的数组，地址改变，容量翻倍，也就是cap(s)等于4*2=8</span></span><br><span class="line">s1 := []<span class="keyword">int</span>&#123;<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>&#125;</span><br><span class="line">s2 := []<span class="keyword">int</span>&#123;<span class="number">4</span>, <span class="number">5</span>&#125;</span><br><span class="line"><span class="built_in">copy</span>(s1, s2)    <span class="comment">//把 s2 复制到 s1，s1 为 [4, 5, 3]</span></span><br><span class="line"></span><br><span class="line">s1 = []<span class="keyword">int</span>&#123;<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>&#125;</span><br><span class="line"><span class="built_in">copy</span>(s2, s1)    <span class="comment">// s2 为 [1, 2]</span></span><br></pre></td></tr></table></figure><blockquote><p>切片的本质是对底层数组的引用；切片的容量（cap）是切片的始索引到底层数组的末索引的长度。</p></blockquote><h5><span id="zi-dian-map">字典（map）</span><a href="#zi-dian-map" class="header-anchor">#</a></h5><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> m <span class="keyword">map</span>[<span class="keyword">int</span>]<span class="keyword">string</span>    <span class="comment">// key int 型；value string 型</span></span><br><span class="line">m = <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="keyword">int</span>]<span class="keyword">string</span>)</span><br><span class="line">m2 := <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="keyword">int</span>]<span class="keyword">string</span>)</span><br><span class="line"></span><br><span class="line">m[<span class="number">0</span>] = <span class="string">"OK"</span></span><br><span class="line"><span class="built_in">delete</span>(m, <span class="number">0</span>)    <span class="comment">// 删除 m 中键为0的键值对</span></span><br></pre></td></tr></table></figure><p>嵌套，</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">m := <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="keyword">int</span>]<span class="keyword">map</span>[<span class="keyword">int</span>]<span class="keyword">string</span>)    <span class="comment">// value  map型</span></span><br><span class="line">m[<span class="number">1</span>] = <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="keyword">int</span>]<span class="keyword">string</span>)</span><br><span class="line">m[<span class="number">1</span>][<span class="number">2</span>] = <span class="string">"YES"</span></span><br></pre></td></tr></table></figure><h5><span id="han-shu">函数</span><a href="#han-shu" class="header-anchor">#</a></h5><p><code>func main(int, []string) int</code>means， function main takes an int and a slice of strings and returns an int函数作为类型，</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> f <span class="function"><span class="keyword">func</span>(<span class="params"><span class="keyword">func</span>(<span class="keyword">int</span>,<span class="keyword">int</span></span>) <span class="title">int</span>, <span class="title">int</span>) <span class="title">func</span>(<span class="params"><span class="keyword">int</span>, <span class="keyword">int</span></span>) <span class="title">int</span></span></span><br></pre></td></tr></table></figure><p>不定长变参，闭包</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">"fmt"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">  var_args(<span class="number">1</span>)    </span><br><span class="line">  var_args(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>)    </span><br><span class="line"></span><br><span class="line">  f := closure(<span class="number">10</span>)</span><br><span class="line">  fmt.Println(f(<span class="number">1</span>))   </span><br><span class="line">  fmt.Println(f(<span class="number">2</span>))    </span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">var_args</span>(<span class="params">args ...<span class="keyword">int</span></span>)</span>&#123;</span><br><span class="line">  fmt.Println(args)</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">closure</span>(<span class="params">x <span class="keyword">int</span></span>) <span class="title">func</span>(<span class="params"><span class="keyword">int</span></span>) <span class="title">int</span></span>&#123;    <span class="comment">// 返回匿名函数</span></span><br><span class="line">  <span class="keyword">return</span> <span class="function"><span class="keyword">func</span>(<span class="params">y <span class="keyword">int</span></span>) <span class="title">int</span></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> x + y</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">输出：</span><br><span class="line">[<span class="number">1</span>]</span><br><span class="line">[<span class="number">1</span> <span class="number">2</span> <span class="number">3</span>]</span><br><span class="line"><span class="number">11</span></span><br><span class="line"><span class="number">12</span></span><br></pre></td></tr></table></figure><h5><span id="tong-dao-channel">通道（channel）</span><a href="#tong-dao-channel" class="header-anchor">#</a></h5><p>channel 是 goroutine 沟通的桥梁，通过 make 创建，close 关闭</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">"fmt"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">c := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">bool</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">go</span> <span class="function"><span class="keyword">func</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">fmt.Println(<span class="string">"I from goroutine !"</span>)</span><br><span class="line">c &lt;- <span class="literal">true</span></span><br><span class="line">&#125;()</span><br><span class="line"></span><br><span class="line">&lt;-c</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>channel 作为函数形参</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">"fmt"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">c := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">bool</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">go</span> Hello(c)</span><br><span class="line"></span><br><span class="line">&lt;-c</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Hello</span>(<span class="params">c <span class="keyword">chan</span> <span class="keyword">bool</span></span>)</span> &#123;</span><br><span class="line">fmt.Println(<span class="string">"Hello, I from goroutine!"</span>)</span><br><span class="line">c &lt;- <span class="literal">true</span>    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>多个 goroutine，多个channel</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">"fmt"</span></span><br><span class="line"><span class="string">"runtime"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">runtime.GOMAXPROCS(runtime.NumCPU())    <span class="comment">// 开启多核</span></span><br><span class="line">c := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">bool</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">5</span>; i++ &#123;    <span class="comment">// 启动多个 goroutin</span></span><br><span class="line"><span class="keyword">go</span> Decomposition(c, i, <span class="number">100000007</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">5</span>; i++ &#123;    <span class="comment">// 多个 channel 阻塞</span></span><br><span class="line">&lt;-c</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Decomposition</span>(<span class="params">c <span class="keyword">chan</span> <span class="keyword">bool</span>, index <span class="keyword">int</span>, n <span class="keyword">int</span></span>)</span> &#123;    <span class="comment">// 质数分解</span></span><br><span class="line"><span class="keyword">for</span> i := <span class="number">2</span>; i &lt;= n; i++ &#123;</span><br><span class="line"><span class="keyword">for</span> n != i &#123;</span><br><span class="line"><span class="keyword">if</span> n%i == <span class="number">0</span> &#123;</span><br><span class="line">fmt.Printf(<span class="string">"%d*"</span>, i)</span><br><span class="line">n = n / i</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="keyword">break</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">fmt.Printf(<span class="string">"%d: %d\n"</span>, index, n)</span><br><span class="line"></span><br><span class="line">c &lt;- <span class="literal">true</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">输出：   </span><br><span class="line"><span class="number">0</span>: <span class="number">100000007</span></span><br><span class="line"><span class="number">2</span>: <span class="number">100000007</span></span><br><span class="line"><span class="number">1</span>: <span class="number">100000007</span></span><br><span class="line"><span class="number">4</span>: <span class="number">100000007</span></span><br><span class="line"><span class="number">3</span>: <span class="number">100000007</span></span><br><span class="line">从输出结果的顺序可以看出 goroutine 并非先启动先执行</span><br></pre></td></tr></table></figure><p>使用同步包来代替 channel</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">"fmt"</span></span><br><span class="line"><span class="string">"runtime"</span></span><br><span class="line"><span class="string">"sync"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">runtime.GOMAXPROCS(runtime.NumCPU())</span><br><span class="line">wg := sync.WaitGroup&#123;&#125;</span><br><span class="line">wg.Add(<span class="number">5</span>)    <span class="comment">//  添加 5 个 任务（goroutine）</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">5</span>; i++ &#123;</span><br><span class="line"><span class="keyword">go</span> Decomposition(&amp;wg, i, <span class="number">100000007</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">wg.Wait()    <span class="comment">// 等到任务数减到 0 </span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Decomposition</span>(<span class="params">wg *sync.WaitGroup, m <span class="keyword">int</span>, n <span class="keyword">int</span></span>)</span> &#123;</span><br><span class="line"><span class="keyword">for</span> i := <span class="number">2</span>; i &lt;= n; i++ &#123;</span><br><span class="line"><span class="keyword">for</span> n != i &#123;</span><br><span class="line"><span class="keyword">if</span> n%i == <span class="number">0</span> &#123;</span><br><span class="line">fmt.Printf(<span class="string">"%d*"</span>, i)</span><br><span class="line">n = n / i</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="keyword">break</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">fmt.Printf(<span class="string">"%d: %d\n"</span>, m, n)</span><br><span class="line"></span><br><span class="line">wg.Done()    <span class="comment">// 任务数减 1</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">输出：</span><br><span class="line"><span class="number">0</span>: <span class="number">100000007</span></span><br><span class="line"><span class="number">2</span>: <span class="number">100000007</span></span><br><span class="line"><span class="number">4</span>: <span class="number">100000007</span></span><br><span class="line"><span class="number">1</span>: <span class="number">100000007</span></span><br><span class="line"><span class="number">3</span>: <span class="number">100000007</span></span><br></pre></td></tr></table></figure><p><code>selec{}</code>语句，如果有多个case 读取数据，select会随机选择一个case执行，其他不执行；如果没有case读取数据，就执行default；如果没有case读取数据，且没有default，select将阻塞，直到某个case可以执行。</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">"fmt"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">c1, c2, block := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>), <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">string</span>), <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">bool</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">go</span> <span class="function"><span class="keyword">func</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line"><span class="keyword">for</span> &#123;</span><br><span class="line"><span class="keyword">select</span> &#123;    <span class="comment">// 按随机顺序处理多个 case</span></span><br><span class="line"><span class="keyword">case</span> message, open := &lt;-c1:</span><br><span class="line"><span class="keyword">if</span> !open &#123;    <span class="comment">// 如果通道 c1 关闭，则跳出无限循环</span></span><br><span class="line">block &lt;- <span class="literal">true</span></span><br><span class="line"><span class="keyword">break</span></span><br><span class="line">&#125;</span><br><span class="line">fmt.Println(<span class="string">"A message from main by c1:"</span>, message)</span><br><span class="line"></span><br><span class="line"><span class="keyword">case</span> message, open := &lt;-c2:</span><br><span class="line"><span class="keyword">if</span> !open &#123;    <span class="comment">// 如果通道 c2 关闭，则跳出无限循环</span></span><br><span class="line">block &lt;- <span class="literal">true</span></span><br><span class="line"><span class="keyword">break</span></span><br><span class="line">&#125;</span><br><span class="line">fmt.Println(<span class="string">"A message from main by c2:"</span>, message)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;()</span><br><span class="line"></span><br><span class="line">c1 &lt;- <span class="number">10</span></span><br><span class="line">c2 &lt;- <span class="string">"hello"</span></span><br><span class="line">c1 &lt;- <span class="number">20</span></span><br><span class="line">c2 &lt;- <span class="string">"world"</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">close</span>(c1)    <span class="comment">// 关闭通道 c1</span></span><br><span class="line"></span><br><span class="line">&lt;-block</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">输出：</span><br><span class="line">A message from main by c1: <span class="number">10</span></span><br><span class="line">A message from main by c2: hello</span><br><span class="line">A message from main by c1: <span class="number">20</span></span><br><span class="line">A message from main by c2: world</span><br></pre></td></tr></table></figure><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">"fmt"</span></span><br><span class="line"><span class="string">"time"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line"><span class="keyword">select</span> &#123;</span><br><span class="line"><span class="keyword">case</span> &lt;-time.After(<span class="number">2000000</span> * time.Microsecond):</span><br><span class="line">fmt.Println(<span class="string">"2 seconds"</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">case</span> &lt;-time.After(<span class="number">1999999</span> * time.Microsecond):</span><br><span class="line">fmt.Println(<span class="string">"1.999999 seconds"</span>)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">输出：</span><br><span class="line"><span class="number">1.999999</span> seconds</span><br></pre></td></tr></table></figure><h4><span id="jie-kou-lei-xing-interface">接口类型（interface）：</span><a href="#jie-kou-lei-xing-interface" class="header-anchor">#</a></h4><p>（1）接口代表某些方法的集合</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">"fmt"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> game <span class="keyword">interface</span> &#123;</span><br><span class="line">Strike_of_Kings() <span class="keyword">int</span></span><br><span class="line">Battle_Grounds() <span class="keyword">int</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">type</span> contact <span class="keyword">interface</span> &#123;</span><br><span class="line">Wechat()</span><br><span class="line">QQ()</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">type</span> smartphone <span class="keyword">interface</span>&#123;    <span class="comment">// 接口嵌套，</span></span><br><span class="line">    game</span><br><span class="line">    contact</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> iphone <span class="keyword">struct</span> &#123;    </span><br><span class="line">version <span class="keyword">string</span></span><br><span class="line">price   <span class="keyword">float32</span></span><br><span class="line">user    <span class="keyword">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> (<span class="params">iph iphone</span>) <span class="title">Wechat</span>(<span class="params"></span>)</span> &#123;    </span><br><span class="line">fmt.Println(<span class="string">"I installed wechat on my iphone"</span>, iph.version)</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> (<span class="params">iph *iphone</span>) <span class="title">QQ</span>(<span class="params"></span>)</span> &#123;    </span><br><span class="line">fmt.Println(<span class="string">"I installed wechat on my iphone"</span>, iph.version)</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// iphone 不满足 contact 接口</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> (<span class="params">iph iphone</span>) <span class="title">Battle_Grounds</span>(<span class="params"></span>) <span class="title">int</span></span> &#123;</span><br><span class="line">fmt.Println(<span class="string">"There are 4 teammates at most in the Battle Grounds."</span>)</span><br><span class="line"><span class="keyword">return</span> <span class="number">4</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> (<span class="params">iph iphone</span>) <span class="title">Strike_of_Kings</span>(<span class="params"></span>) <span class="title">int</span></span> &#123;    </span><br><span class="line">fmt.Println(<span class="string">"There are 5 teammates at most in the Strike of Kings."</span>)</span><br><span class="line"><span class="keyword">return</span> <span class="number">5</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// iphone 满足 game 接口</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> (<span class="params">iph *iphone</span>) <span class="title">New_Version</span>(<span class="params">version <span class="keyword">string</span></span>)</span> &#123;</span><br><span class="line">iph.version = version</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">all_round_game</span>(<span class="params">game</span>)</span> &#123;      <span class="comment">// 接口作为形参</span></span><br><span class="line">fmt.Println(<span class="string">"Both Strike of_Kings and Battle Grounds have installed."</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line"></span><br><span class="line">my_phone := iphone&#123;<span class="string">"X"</span>, <span class="number">8316</span>, <span class="string">"Xiaohe"</span>&#125;</span><br><span class="line">my_phone.Wechat()</span><br><span class="line">    fmt.Println(my_phone.Battle_Grounds())</span><br><span class="line"></span><br><span class="line">all_round_game(my_phone)    <span class="comment">// my_phone 符合 game 接口，可作为该函数的实参</span></span><br><span class="line"><span class="keyword">var</span> _ game = iphone   <span class="comment">// 确保 iphone 实现了接口game </span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>（2）任何类型都满足空接口；空接口<code>interface{}</code>作为形参可以接受任何类型的实参</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">"fmt"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">m := <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="keyword">int</span>]<span class="keyword">interface</span>&#123;&#125;)</span><br><span class="line">m[<span class="number">1</span>] = <span class="string">"a"</span></span><br><span class="line">m[<span class="number">2</span>] = <span class="number">2</span></span><br><span class="line">m[<span class="number">3</span>] = <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">print_map(m)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">print_map</span>(<span class="params">m <span class="keyword">map</span>[<span class="keyword">int</span>]<span class="keyword">interface</span>&#123;&#125;</span>)</span> &#123;</span><br><span class="line"><span class="keyword">for</span> k, v := <span class="keyword">range</span> m &#123;</span><br><span class="line">fmt.Println(k, <span class="string">":"</span>, v)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">输出：</span><br><span class="line"><span class="number">1</span> : a</span><br><span class="line"><span class="number">2</span> : <span class="number">2</span></span><br><span class="line"><span class="number">3</span> : <span class="literal">false</span></span><br></pre></td></tr></table></figure><blockquote><p><code>[]string</code> 和 <code>[]interface{}</code> 是不同的类型；接口是一种抽象类型，可理解为是将所有具体类型按照方法集进行再分类；指针方法集包含非指针方法集。</p></blockquote><p>（3）接口值（interface value）包含 类型 （接口的动态类型）和 类型值 （接口的动态值） 两个部分，仅当两者均为<code>nil</code> 时，接口才为<code>nil</code><img src="https://upload-images.jianshu.io/upload_images/1863961-48d541dd9a4ab443.JPG?imageMogr2/auto-orient/strip%7CimageView2/2/w/800" alt="The zero value for an interface has both its type and value components set to nil">（4）反射 （reflection）</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">"fmt"</span></span><br><span class="line"><span class="string">"reflect"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> iphone <span class="keyword">struct</span> &#123;</span><br><span class="line">version <span class="keyword">string</span></span><br><span class="line">price   <span class="keyword">int</span></span><br><span class="line">user    <span class="keyword">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> (<span class="params">iph iphone</span>) <span class="title">Wechat</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">fmt.Println(<span class="string">"I installed wechat on my iphone"</span>, iph.version)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">my_phone := iphone&#123;<span class="string">"X"</span>, <span class="number">8316</span>, <span class="string">"Xiaohe"</span>&#125;</span><br><span class="line">Info(my_phone)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Info</span>(<span class="params">itf <span class="keyword">interface</span>&#123;&#125;</span>)</span> &#123;</span><br><span class="line">t := reflect.TypeOf(itf)</span><br><span class="line">fmt.Println(t)</span><br><span class="line"><span class="keyword">for</span> i := <span class="number">0</span>; i &lt; t.NumField(); i++ &#123;</span><br><span class="line">fmt.Println(t.Field(i))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">fmt.Println(<span class="string">"___________________"</span>)</span><br><span class="line"></span><br><span class="line">v := reflect.ValueOf(itf)</span><br><span class="line">fmt.Println(v)</span><br><span class="line"><span class="keyword">for</span> i := <span class="number">0</span>; i &lt; v.NumField(); i++ &#123;</span><br><span class="line">fmt.Println(v.Field(i))</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">输出：</span><br><span class="line">main.iphone</span><br><span class="line">&#123;version main <span class="keyword">string</span>  <span class="number">0</span> [<span class="number">0</span>] <span class="literal">false</span>&#125;</span><br><span class="line">&#123;price main <span class="keyword">int</span>  <span class="number">16</span> [<span class="number">1</span>] <span class="literal">false</span>&#125;</span><br><span class="line">&#123;user main <span class="keyword">string</span>  <span class="number">24</span> [<span class="number">2</span>] <span class="literal">false</span>&#125;</span><br><span class="line">___________________</span><br><span class="line">&#123;X <span class="number">8316</span> Xiaohe&#125;</span><br><span class="line">X</span><br><span class="line"><span class="number">8316</span></span><br><span class="line">Xiaohe</span><br></pre></td></tr></table></figure><h3><span id="kong-zhi-liu-for-if-switch-defer-goto">控制流 （for if switch defer goto）：</span><a href="#kong-zhi-liu-for-if-switch-defer-goto" class="header-anchor">#</a></h3><p>（1）<code>for</code>：</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (inti statement)；condition；(post statement) &#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">10</span>; i++ &#123;</span><br><span class="line">&#125; </span><br><span class="line"><span class="keyword">for</span> ; i &lt; <span class="number">10</span>; &#123;    <span class="comment">// 去掉分号</span></span><br><span class="line">&#125; </span><br><span class="line"><span class="keyword">for</span> i &lt; <span class="number">10</span>&#123;    <span class="comment">// while 语句</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">for</span>&#123;    <span class="comment">// 无限循环</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>（2）<code>if</code>：</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"> <span class="keyword">if</span> (init statement)；condition &#123;</span><br><span class="line">&#125;  </span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (init statement)；condition &#123;</span><br><span class="line">&#125;<span class="keyword">else</span> &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>（3）<code>switch</code>：</p> <figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">switch</span> (init statement)；some value &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">0</span>：</span><br><span class="line">    <span class="keyword">case</span> f()：</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">default</span>：</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">switch</span> &#123;</span><br><span class="line">    <span class="keyword">case</span> 布尔表达式<span class="number">1</span>：</span><br><span class="line">    <span class="keyword">case</span> 布尔表达式<span class="number">2</span>：</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">default</span>：</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>一旦符合条件自动终止，若希望继续检验下面的case，使用 <code>fallthrough</code> 语句。（4）<code>defer</code>：</p><ul><li>defer 后必须跟函数引用</li><li>defer 语句被检验后，延迟函数获得变量的拷贝</li></ul><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">a</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    i := <span class="number">0</span></span><br><span class="line">    <span class="keyword">defer</span> fmt.Println(i)</span><br><span class="line">    i++</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">&#125;    <span class="comment">// defer 语句打印0</span></span><br></pre></td></tr></table></figure><ul><li>defer 语句被检验后，延迟匿名函数获得变量的地址</li></ul><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">b</span>(<span class="params"></span>) (<span class="params">i <span class="keyword">int</span></span>)</span> &#123;</span><br><span class="line">    <span class="keyword">defer</span> <span class="function"><span class="keyword">func</span>(<span class="params"></span>)</span> &#123; i++ &#125;()</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>    <span class="comment">// 将1 赋给 i</span></span><br><span class="line">&#125;    <span class="comment">// 返回 2。利用 defer 语句修改外围函数的命名返回值</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">c</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">3</span>; i++ &#123;</span><br><span class="line">  <span class="keyword">defer</span> <span class="function"><span class="keyword">func</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        fmt.Print(i)</span><br><span class="line">  &#125;()</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">&#125;  <span class="comment">// 打印 333</span></span><br></pre></td></tr></table></figure><ul><li>defer 语句被检验后，延迟函数的引用被推入堆栈，当外围函数返回后，按照后进先出的顺序被调用（即使外围函数发生错误，如 panic，延迟函数仍然会被调用）</li></ul><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">d</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">4</span>; i++ &#123;</span><br><span class="line">        <span class="keyword">defer</span> fmt.Print(i)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;    <span class="comment">// 打印 3210</span></span><br></pre></td></tr></table></figure><p>更多细节如，<code>panic</code>， <code>recover</code>（只能用在延迟函数中） 参考 <a href="https://blog.golang.org/defer-panic-and-recover" target="_blank" rel="noopener">defer blog</a>。</p><p>（5）<code>goto</code>：</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">LABEL:</span><br><span class="line"><span class="keyword">for</span> &#123;</span><br><span class="line"><span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">10</span>; i++ &#123;</span><br><span class="line"><span class="keyword">if</span> i &gt; <span class="number">3</span> &#123;</span><br><span class="line"><span class="keyword">break</span> LABEL    <span class="comment">// 跳出与LABEL同级的循环，即跳出无限循环</span></span><br><span class="line">&#125; </span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">LABEL:</span><br><span class="line"><span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">10</span>; i++ &#123;</span><br><span class="line"><span class="keyword">for</span> &#123;</span><br><span class="line"><span class="keyword">continue</span> LABEL</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">LABEL:</span><br><span class="line"><span class="keyword">for</span> &#123;</span><br><span class="line"><span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">10</span>; i++ &#123;</span><br><span class="line"><span class="keyword">if</span> i &gt; <span class="number">3</span> &#123;</span><br><span class="line"><span class="keyword">goto</span> LABEL    <span class="comment">// 将再次进入无限循环</span></span><br><span class="line">&#125; </span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>通常<code>标签</code>放到 <code>goto</code> 的后面。</p></blockquote><h3><span id="chuang-jian-gong-cheng-mu-lu">创建工程目录：</span><a href="#chuang-jian-gong-cheng-mu-lu" class="header-anchor">#</a></h3><p>Go工程中共有三个部分：</p><ul><li>src：存放go源码文件</li><li>pkg：存放编译后的包文件</li><li>bin：存放编译后的可执行文件</li></ul><blockquote><p>**注意：**src目录需要自己创建，pkg和bin编译时会自动创建。</p></blockquote><p>步骤：</p><ol><li>新建工程目录，my_project，并在该目录下创建 src目录；</li><li>把my_project 添加到 GOPATH，GOPATH=/home/user/...;my_project（可以同时添加多个路径目录，Linux下用冒号:隔开，window下分号;隔开）;</li><li>在 src 下创建my_pkg 和 my_cmd;</li><li>包文件放入到 my_pkg 中，比如 test.go</li></ol><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> my_pkg</span><br><span class="line"><span class="keyword">import</span> <span class="string">"fmt"</span></span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Test</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">  fmt.Println(<span class="string">"Hello,world!"</span>)</span><br><span class="line">  fmt.Println(<span class="string">"You used a function defined in my_package!"</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>在命令行src目录，执行 <code>go install my_pkg</code> 将创建 pkg 目录并声成 my_pkg.a 文件。</p><ol start="5"><li>my_cmd 中放入 package main，比如 hello_world.go</li></ol><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"><span class="keyword">import</span>(</span><br><span class="line">  <span class="string">"my_pkg"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">  my_pkg.Test()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>在命令行src目录，执行 <code>go install my_cmd</code> 将创建 bin 目录并生成可执行文件成 hello_world.exe 文件。</p><blockquote><p>目录结构：src/$\quad$ my_pkg/$\qquad$ test.go$\quad$ my_cmd/$\qquad$ hello_world.go</p></blockquote><h3><span id="tips">Tips:</span><a href="#tips" class="header-anchor">#</a></h3><p>import 包A的时候，会自动调用包A的init()函数（i字母小写）。如果该包A又import了别的包B，会优先调用包B的init()函数，最后才调用main包的init()函数。一个包的init()函数可以定义多个，每个都会被调用，调用的顺序按文件名排序。同一个文件也可以定义多个init函数。</p><h3><span id="qi-ta">其他：</span><a href="#qi-ta" class="header-anchor">#</a></h3><ul><li><code>fmt.printf</code> verbs：<code>%x %b</code>：16进制，2进制显示；<code>%t</code>：显示 bool 结果；<code>%T</code>：显示值的类型；<code>%v</code>：显示值；<code>%p</code>：显示地址；<code>\n</code>：换行</li><li>Sublime text 3上一个编辑处: alt+-下一个编辑处: alt+shift+-</li><li>GoSublime：GoSublime快捷键列表：ctrl+.+. (连击 .)查看声明：ctrl+.+h代码跳转：ctrl+shift+左键package control：ctrl+shift+p</li><li>Goland：退回上一次光标位置：ctrl+win+alt+左键</li></ul><h3><span id="can-kao-zi-liao">参考资料：</span><a href="#can-kao-zi-liao" class="header-anchor">#</a></h3><p>[1] 无闻;<a href="https://study.163.com/course/introduction.htm?courseId=306002" target="_blank" rel="noopener">Go编程基础系列视频</a>.[2] Alan A.A. Donovan; Brain W. Kernighan; The Go Programming Language; 2015.</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;link rel=&quot;stylesheet&quot; class=&quot;aplayer-secondary-style-marker&quot; href=&quot;/assets/css/APlayer.min.css&quot;&gt;&lt;script src=&quot;/assets/js/APlayer.min.js&quot; cla
      
    
    </summary>
    
    
      <category term="Golang" scheme="https://hejtao.netlify.com/tags/Golang/"/>
    
      <category term="长文" scheme="https://hejtao.netlify.com/tags/%E9%95%BF%E6%96%87/"/>
    
  </entry>
  
  <entry>
    <title>本地项目上传到 Github 仓库、Git开发命令</title>
    <link href="https://hejtao.netlify.com/2018/07/04/2018-7-4/"/>
    <id>https://hejtao.netlify.com/2018/07/04/2018-7-4/</id>
    <published>2018-07-04T11:35:11.000Z</published>
    <updated>2019-11-11T19:59:33.203Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><meta name="referrer" content="no-referrer"><div class="toc"><!-- toc --><ul><li><a href="#sheng-cheng-ben-di-ban-ben-ku-git-wen-jian-jia">生成本地版本库 （.git 文件夹）</a></li><li><a href="#chuang-jian-ssh-key">创建 SSH key</a></li><li><a href="#chuang-jian-github-cang-ku">创建 GitHub 仓库</a></li><li><a href="#shang-chuan-dao-github-cang-ku">上传到 GitHub 仓库</a></li><li><a href="#ben-di-xiu-gai-gen-xin-dao-github-cang-ku">本地修改跟新到 GitHub 仓库</a></li></ul><!-- tocstop --></div><h3><span id="sheng-cheng-ben-di-ban-ben-ku-git-wen-jian-jia">生成本地版本库 （.git 文件夹）</span><a href="#sheng-cheng-ben-di-ban-ben-ku-git-wen-jian-jia" class="header-anchor">#</a></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">git init</span><br><span class="line">git add .</span><br><span class="line">git commit -m <span class="string">"..."</span></span><br></pre></td></tr></table></figure><p>操作如下，<br><img src="https://upload-images.jianshu.io/upload_images/1863961-32ad650b5e4944d8.PNG?imageMogr2/auto-orient/strip%7CimageView2/2/w/650" alt=""><br><img src="https://upload-images.jianshu.io/upload_images/1863961-4716f9712379e68f.PNG?imageMogr2/auto-orient/strip%7CimageView2/2/w/650" alt=""></p><h3><span id="chuang-jian-ssh-key">创建 SSH key</span><a href="#chuang-jian-ssh-key" class="header-anchor">#</a></h3><ul><li>查看 c盘 用户目录是否包含 .ssh 目录。如果包含，打开 id_rsa.pub 文件并复制里面的内容（密钥）<br><img src="https://upload-images.jianshu.io/upload_images/1863961-645677c3a3ec906e.PNG?imageMogr2/auto-orient/strip%7CimageView2/2/w/650" alt=""><br></li><li>如果不包含 .ssh 目录（上述操作会报错），通过如下命令创建</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh-keygen -t rsa -C <span class="string">"your email address"</span></span><br></pre></td></tr></table></figure><p>其中 C 为大写。然后按照前面的方式复制密钥。</p><ul><li>将密钥添加到 GitHub<br><img src="https://upload-images.jianshu.io/upload_images/1863961-fd4c50b7021715b1.PNG?imageMogr2/auto-orient/strip%7CimageView2/2/w/650" alt=" "><br><img src="https://upload-images.jianshu.io/upload_images/1863961-fe525f53b369e5cb.PNG?imageMogr2/auto-orient/strip%7CimageView2/2/w/650" alt=" "><br><img src="https://upload-images.jianshu.io/upload_images/1863961-a77e329b14352980.PNG?imageMogr2/auto-orient/strip%7CimageView2/2/w/650" alt=" "></li></ul><h3><span id="chuang-jian-github-cang-ku">创建 GitHub 仓库</span><a href="#chuang-jian-github-cang-ku" class="header-anchor">#</a></h3><br>![](https://upload-images.jianshu.io/upload_images/1863961-d05408b0cfc2e198.PNG?imageMogr2/auto-orient/strip%7CimageView2/2/w/650)<br>![](https://upload-images.jianshu.io/upload_images/1863961-f7edb952c890e069.PNG?imageMogr2/auto-orient/strip%7CimageView2/2/w/650)<h3><span id="shang-chuan-dao-github-cang-ku">上传到 GitHub 仓库</span><a href="#shang-chuan-dao-github-cang-ku" class="header-anchor">#</a></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">git remote add origin git@github.com:jiangtaohe/test.git</span><br><span class="line">git push -u origin master</span><br></pre></td></tr></table></figure><p><img src="https://upload-images.jianshu.io/upload_images/1863961-8e43cefe8d940184.PNG?imageMogr2/auto-orient/strip%7CimageView2/2/w/650" alt=""></p><h3><span id="ben-di-xiu-gai-gen-xin-dao-github-cang-ku">本地修改跟新到 GitHub 仓库</span><a href="#ben-di-xiu-gai-gen-xin-dao-github-cang-ku" class="header-anchor">#</a></h3><p>若本地已经关联到仓库，git remote add origin 命令行去掉。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">git remote add origin git@github.com:jiangtaohe/test.git</span><br><span class="line">git add .</span><br><span class="line">git commit -m <span class="string">"..."</span></span><br><span class="line">git push</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git add file</span><br></pre></td></tr></table></figure><p>file的修改添加到暂存区</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git commit file -m <span class="string">"备注信息"</span></span><br></pre></td></tr></table></figure><p>创建新的版本库，并将file在暂存区中的修改添加到新的版本库中</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git stash</span><br></pre></td></tr></table></figure><p>将工作区和暂存区的修改装箱后回到版本库初始状态(相当于撤销所有修改)</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git stash pop</span><br></pre></td></tr></table></figure><p>将 <code>git stash</code>装箱的修改倒出</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git checkout -- file</span><br></pre></td></tr></table></figure><p>撤销file工作区的修改</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">git checkout --ours (--theirs) file</span><br><span class="line">git add file</span><br></pre></td></tr></table></figure><p>file发生merge冲突时，完全采取本方(他方)的修改</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git fetch origin dev:local_dev</span><br></pre></td></tr></table></figure><p>获取远程分支dev的代码，并在本地创建本地分支local_dev</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git pull origin dev</span><br></pre></td></tr></table></figure><p>拉取远程分支dev与当前分支和并(merge)</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git reset --hard commit_id(前4位数)</span><br></pre></td></tr></table></figure><p>切换到某个版本库</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git branch branch_name</span><br></pre></td></tr></table></figure><p>新建分支</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git branch -d branch_name</span><br></pre></td></tr></table></figure><p>删除分支</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git merge branch_name</span><br></pre></td></tr></table></figure><p>合并分支</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">git status</span><br><span class="line">git <span class="built_in">log</span></span><br><span class="line">git reflog</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git remote -v</span><br></pre></td></tr></table></figure><p>打印远程仓库名称和地址</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git remote <span class="built_in">set</span>-url --add origin git@gitlab.com:jiangtaohe/test.git</span><br></pre></td></tr></table></figure><p>增加一个远程仓库</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;link rel=&quot;stylesheet&quot; class=&quot;aplayer-secondary-style-marker&quot; href=&quot;/assets/css/APlayer.min.css&quot;&gt;&lt;script src=&quot;/assets/js/APlayer.min.js&quot; cla
      
    
    </summary>
    
    
      <category term="Git" scheme="https://hejtao.netlify.com/tags/Git/"/>
    
  </entry>
  
  <entry>
    <title>阅历</title>
    <link href="https://hejtao.netlify.com/2018/07/01/2018-7-1/"/>
    <id>https://hejtao.netlify.com/2018/07/01/2018-7-1/</id>
    <published>2018-07-01T05:54:12.000Z</published>
    <updated>2019-11-11T19:59:33.203Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><meta name="referrer" content="no-referrer"><p>有时人的成长在不知不觉中发生，且不论是生理上的还是心智上的。比如人的身高的变化，对于旁人看来是很大的改变，但对于当事人可能是相当无感的（除非你刻意的去测量，并画出折线图来，很少人会这么做吧）。与前者相比，心智的 变化更加隐蔽，你甚至都不好记录数据作出图表来，但并非一无所知，有些是可以从生活中窥见端倪。<br>少年时期的我非常讨厌吃苦瓜。你可能已经脑补出我第一次吃苦瓜时候的表情了。</p><p><img src="https://upload-images.jianshu.io/upload_images/1863961-957f2582e5306a85.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt=""></p><p>“是人吃的吗？”，当然没有说出口，但我当时就那么想的。让我惊奇的是母亲竟吃得津津有味 (＃°Д°)  好像我吃了一口假的苦瓜。转念一想，既然这玩意儿都叫苦瓜了，那是必苦无疑了。那时的我品不来苦瓜的味道，自然理解不了母亲的有滋有味了。后来偶尔遇到苦瓜也会吃上一小片，“浅尝辄止”，毕竟还是那个味儿啊，干嘛亏待自己。直到上了大学后才有了改变。<br>话说我在大学吃了几年食堂，喜欢吃的都吃得腻了。某天心血来潮，要不来盘炒苦瓜吧。我突然发现这玩意儿不那么苦了，甚至感到别有一番风味。原以为跟苦瓜品种有关，所以后来回外婆家时，我特意让外婆做了道炒苦瓜，吃起来也是不那么苦。我意识到“物是人已非”，苦瓜还是年少时的苦瓜，而我却不一样了。这种变化当然有生理上的，但更多的是心智上的，而后者是自己的阅历在不断增长的结果。有些事情阅历够了自然就会了。</p><p><img src="https://upload-images.jianshu.io/upload_images/1863961-9b10c729b2816844.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="" title="坂东玉三郎在《牡丹亭》中扮演的杜丽娘"></p><br>类似的还有对戏曲的理解。以前的我根本就看不了戏曲的，无感啊。随着年龄的增长，我对戏曲的态度也发生改变，虽然谈不上热爱，但多少也能品到其中的一些韵味。尤其是京剧，不愧为国粹，尽管没看过一个完整的剧目，也叫不出多少剧目的名字来，当我被表演者的一颦一簇、一唱一打所牵动的时候，我知道那就是好的戏曲，了不起的艺术！]]></content>
    
    <summary type="html">
    
      
      
        &lt;link rel=&quot;stylesheet&quot; class=&quot;aplayer-secondary-style-marker&quot; href=&quot;/assets/css/APlayer.min.css&quot;&gt;&lt;script src=&quot;/assets/js/APlayer.min.js&quot; cla
      
    
    </summary>
    
    
      <category term="随想" scheme="https://hejtao.netlify.com/tags/%E9%9A%8F%E6%83%B3/"/>
    
  </entry>
  
  <entry>
    <title>独憩</title>
    <link href="https://hejtao.netlify.com/2018/06/19/2018-6-19/"/>
    <id>https://hejtao.netlify.com/2018/06/19/2018-6-19/</id>
    <published>2018-06-19T15:23:51.000Z</published>
    <updated>2019-11-11T19:59:33.202Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><meta name="referrer" content="no-referrer"><p>有时候我真地喜欢安静，独自一人，不被打扰，做一些没有意义的事情。<br></p><p><img src="https://upload-images.jianshu.io/upload_images/1863961-e2c1ff0d4ed6d93e.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/600" alt=""><br></p><p><img src="https://upload-images.jianshu.io/upload_images/1863961-f7690317383e9115.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/600" alt=""><br></p><p><img src="https://upload-images.jianshu.io/upload_images/1863961-62efa82f3f0a7690.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/600" alt=""><br></p><p><img src="https://upload-images.jianshu.io/upload_images/1863961-8db994a2183f0427.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/600" alt=""><br></p><p>当下简单地唯水，笔，布而已。</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;link rel=&quot;stylesheet&quot; class=&quot;aplayer-secondary-style-marker&quot; href=&quot;/assets/css/APlayer.min.css&quot;&gt;&lt;script src=&quot;/assets/js/APlayer.min.js&quot; cla
      
    
    </summary>
    
    
      <category term="书法" scheme="https://hejtao.netlify.com/tags/%E4%B9%A6%E6%B3%95/"/>
    
  </entry>
  
  <entry>
    <title>运动与冥想</title>
    <link href="https://hejtao.netlify.com/2018/06/14/2018-6-14/"/>
    <id>https://hejtao.netlify.com/2018/06/14/2018-6-14/</id>
    <published>2018-06-14T12:56:23.000Z</published>
    <updated>2019-11-11T19:59:33.202Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><meta name="referrer" content="no-referrer"><p>近来又把跑步纳入日常。跑着跑着，跑出了一点心得，今以记之，算是对自己坚持锻炼的勉励。<br>一开始，我是跟着小伙伴一起跑来着，然后有几次自己跑。回想运动时候的状态，我发现自己跑运动地更充分，锻炼的效果也更好。据说跑步半个小时是一种很好的锻炼方式，前提是要保质保量。保质就要求全程保持在跑的状态，你可以跑快点或者慢点，但不要是 walking 。保量就是最少跑半个小时，当然你也可以按照路程（多少圈跑道）来计。值得注意的是，这个保质保量因人而异，你需要给自己设立合理的目标且不能够轻易就可达成。<br>专注于跑步有利于目标的达成。这也解释了为什么独自跑步的效果更好（与小伙伴相互鼓励当然也挺好），因为不用刻意去协调别人，你可以更快找到自己的节奏。当你持续地专注于自己的身体和感觉时，你可以体会到控制与活力，而维持标准动作可以加深这种体会。因此，不妨把跑步看作一次冥想训练，专注于自我，体会积极的力量也接受脑涨腿乏感觉，但不要让疲劳占据上风，否则你将动作变形，愈感举步维艰。<br>避免外部干扰因素有助于专注，比如握着手机，携带狗狗等尽量避免。<br>最后需要强调的是注意安全。当身体出现不适的时候，千万不要勉强。前两些天就有公众号报道某男子跑步过程中摔倒了两次仍要坚持，最终导致猝亡的杯具。还有上文提到独自运动有助于专注，但还是避免去人少的地方活动，尤其是女同学。学校的操场是绝佳的场所，因为有其他的同学还可以减少孤独感，对自己的坚持是很有帮助的。</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;link rel=&quot;stylesheet&quot; class=&quot;aplayer-secondary-style-marker&quot; href=&quot;/assets/css/APlayer.min.css&quot;&gt;&lt;script src=&quot;/assets/js/APlayer.min.js&quot; cla
      
    
    </summary>
    
    
      <category term="随想" scheme="https://hejtao.netlify.com/tags/%E9%9A%8F%E6%83%B3/"/>
    
  </entry>
  
  <entry>
    <title>多宝塔碑精选</title>
    <link href="https://hejtao.netlify.com/2018/06/10/2018-6-10/"/>
    <id>https://hejtao.netlify.com/2018/06/10/2018-6-10/</id>
    <published>2018-06-09T16:00:00.000Z</published>
    <updated>2019-11-11T19:59:33.202Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><meta name="referrer" content="no-referrer"><p>《多宝塔碑》精选三十七字。来源于搜狐“书法思考”，今藏以时习之。</p><h4><span id="heng-shu-san-wang-shi-ban-zhong">横、竖：(三、王、十、半、中)</span><a href="#heng-shu-san-wang-shi-ban-zhong" class="header-anchor">#</a></h4><p><img src="https://upload-images.jianshu.io/upload_images/1863961-fd42718c0a299083.jpeg?imageMogr2/auto-orient/strip%7CimageView2/2/w/800" alt=""><br><img src="https://upload-images.jianshu.io/upload_images/1863961-4c1effead6120728.jpeg?imageMogr2/auto-orient/strip%7CimageView2/2/w/800" alt=""><br><img src="https://upload-images.jianshu.io/upload_images/1863961-336f4dd557020eb4.jpeg?imageMogr2/auto-orient/strip%7CimageView2/2/w/800" alt=""><br><img src="https://upload-images.jianshu.io/upload_images/1863961-628d5d654e373a56.jpeg?imageMogr2/auto-orient/strip%7CimageView2/2/w/800" alt=""><br><img src="https://upload-images.jianshu.io/upload_images/1863961-288f14358d1a4c63.jpeg?imageMogr2/auto-orient/strip%7CimageView2/2/w/800" alt=""><br></p><h4><span id="pie-na-da-shou-you-nian-ru">撇、捺：(大、手、又、年、入)</span><a href="#pie-na-da-shou-you-nian-ru" class="header-anchor">#</a></h4><p><img src="https://upload-images.jianshu.io/upload_images/1863961-a30469c7962a5558.jpeg?imageMogr2/auto-orient/strip%7CimageView2/2/w/800" alt=""><br><img src="https://upload-images.jianshu.io/upload_images/1863961-107def9ce572f49a.jpeg?imageMogr2/auto-orient/strip%7CimageView2/2/w/800" alt=""><br><img src="https://upload-images.jianshu.io/upload_images/1863961-ee8c1121fa3f592b.jpeg?imageMogr2/auto-orient/strip%7CimageView2/2/w/800" alt=""><br><img src="https://upload-images.jianshu.io/upload_images/1863961-cdaa9fd9128afb46.jpeg?imageMogr2/auto-orient/strip%7CimageView2/2/w/800" alt=""><br><img src="https://upload-images.jianshu.io/upload_images/1863961-c1785e6ab500cc9e.jpeg?imageMogr2/auto-orient/strip%7CimageView2/2/w/800" alt=""><br></p><h4><span id="dian-xin-han-fu-bing-shang-xiao-yu-qi-gan">点：(心、涵、浮、并、尚、小、於、其、感)</span><a href="#dian-xin-han-fu-bing-shang-xiao-yu-qi-gan" class="header-anchor">#</a></h4><p><img src="https://upload-images.jianshu.io/upload_images/1863961-6b5a2f643c434662.jpeg?imageMogr2/auto-orient/strip%7CimageView2/2/w/800" alt=""><br><img src="https://upload-images.jianshu.io/upload_images/1863961-eebc76a56376dacf.jpeg?imageMogr2/auto-orient/strip%7CimageView2/2/w/800" alt=""><br><img src="https://upload-images.jianshu.io/upload_images/1863961-56845155b67f1729.jpeg?imageMogr2/auto-orient/strip%7CimageView2/2/w/800" alt=""><br><img src="https://upload-images.jianshu.io/upload_images/1863961-15395e032a580d63.jpeg?imageMogr2/auto-orient/strip%7CimageView2/2/w/800" alt=""><br><img src="https://upload-images.jianshu.io/upload_images/1863961-bce55f1474f1d73d.jpeg?imageMogr2/auto-orient/strip%7CimageView2/2/w/800" alt=""><br><img src="https://upload-images.jianshu.io/upload_images/1863961-5322fe5638885601.jpeg?imageMogr2/auto-orient/strip%7CimageView2/2/w/800" alt=""><br><img src="https://upload-images.jianshu.io/upload_images/1863961-f1aec2afb515c077.jpeg?imageMogr2/auto-orient/strip%7CimageView2/2/w/800" alt=""><br><img src="https://upload-images.jianshu.io/upload_images/1863961-abf0ee92c1c18314.jpeg?imageMogr2/auto-orient/strip%7CimageView2/2/w/800" alt=""><br><img src="https://upload-images.jianshu.io/upload_images/1863961-9d81be126c2247be.jpeg?imageMogr2/auto-orient/strip%7CimageView2/2/w/800" alt=""><br></p><h4><span id="gou-tiao-zong-qiu-guan-biao-jian-xian-shi-yi">钩、挑：(宗、求、观、表、见、咸、食、以)</span><a href="#gou-tiao-zong-qiu-guan-biao-jian-xian-shi-yi" class="header-anchor">#</a></h4><p><img src="https://upload-images.jianshu.io/upload_images/1863961-07b36ef484f1cf16.jpeg?imageMogr2/auto-orient/strip%7CimageView2/2/w/800" alt=""><br><img src="https://upload-images.jianshu.io/upload_images/1863961-a59190a6d0f9d9e7.jpeg?imageMogr2/auto-orient/strip%7CimageView2/2/w/800" alt=""><br><img src="https://upload-images.jianshu.io/upload_images/1863961-24038d4638101588.jpeg?imageMogr2/auto-orient/strip%7CimageView2/2/w/800" alt=""><br><img src="https://upload-images.jianshu.io/upload_images/1863961-7953ea4a4189c4b0.jpeg?imageMogr2/auto-orient/strip%7CimageView2/2/w/800" alt=""><br><img src="https://upload-images.jianshu.io/upload_images/1863961-32b6e4330997a09d.jpeg?imageMogr2/auto-orient/strip%7CimageView2/2/w/800" alt=""><br><img src="https://upload-images.jianshu.io/upload_images/1863961-3b809c47ed74ceca.jpeg?imageMogr2/auto-orient/strip%7CimageView2/2/w/800" alt=""><br><img src="https://upload-images.jianshu.io/upload_images/1863961-e7b453d37c1e69c2.jpeg?imageMogr2/auto-orient/strip%7CimageView2/2/w/800" alt=""><br><img src="https://upload-images.jianshu.io/upload_images/1863961-994e4901b7bc2c56.jpeg?imageMogr2/auto-orient/strip%7CimageView2/2/w/800" alt=""><br></p><h4><span id="zhe-zi-ming-liao-shan-ya-yi-mu-wai-nu">折：(自、名、了、山、牙、矣、母、外、女)</span><a href="#zhe-zi-ming-liao-shan-ya-yi-mu-wai-nu" class="header-anchor">#</a></h4><p><img src="https://upload-images.jianshu.io/upload_images/1863961-90bc923c63fe4459.jpeg?imageMogr2/auto-orient/strip%7CimageView2/2/w/800" alt=""><br><img src="https://upload-images.jianshu.io/upload_images/1863961-43b34a046df0e9dd.jpeg?imageMogr2/auto-orient/strip%7CimageView2/2/w/800" alt=""><br><img src="https://upload-images.jianshu.io/upload_images/1863961-94f5fe9db9983d3a.jpeg?imageMogr2/auto-orient/strip%7CimageView2/2/w/800" alt=""><br><img src="https://upload-images.jianshu.io/upload_images/1863961-fddb276bcc8db19a.jpeg?imageMogr2/auto-orient/strip%7CimageView2/2/w/800" alt=""><br><img src="https://upload-images.jianshu.io/upload_images/1863961-22d5c7ed19c5bd93.jpeg?imageMogr2/auto-orient/strip%7CimageView2/2/w/800" alt=""><br><img src="https://upload-images.jianshu.io/upload_images/1863961-888cc4c4373cd182.jpeg?imageMogr2/auto-orient/strip%7CimageView2/2/w/800" alt=""><br><img src="https://upload-images.jianshu.io/upload_images/1863961-811cc6bb2382e9b7.jpeg?imageMogr2/auto-orient/strip%7CimageView2/2/w/800" alt=""><br><img src="https://upload-images.jianshu.io/upload_images/1863961-d6760cf1ac098d38.jpeg?imageMogr2/auto-orient/strip%7CimageView2/2/w/800" alt=""><br><img src="https://upload-images.jianshu.io/upload_images/1863961-5ab612b0240ea685.jpeg?imageMogr2/auto-orient/strip%7CimageView2/2/w/800" alt=""></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;link rel=&quot;stylesheet&quot; class=&quot;aplayer-secondary-style-marker&quot; href=&quot;/assets/css/APlayer.min.css&quot;&gt;&lt;script src=&quot;/assets/js/APlayer.min.js&quot; cla
      
    
    </summary>
    
    
      <category term="书法" scheme="https://hejtao.netlify.com/tags/%E4%B9%A6%E6%B3%95/"/>
    
  </entry>
  
  <entry>
    <title>Flask 笔记</title>
    <link href="https://hejtao.netlify.com/2018/05/28/2018-5-28/"/>
    <id>https://hejtao.netlify.com/2018/05/28/2018-5-28/</id>
    <published>2018-05-27T16:00:00.000Z</published>
    <updated>2019-11-11T19:59:33.201Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><meta name="referrer" content="no-referrer"><p>创建 flask instance（也就是一个应用）两种方式：1. (module) 在<code>URL\my_app.py</code>中加入</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">from flask import Flask</span><br><span class="line">app = Flask(__name__)</span><br></pre></td></tr></table></figure><p>2.(package) 在<code>URL\app_folder\__init__.py</code>中加入</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">from flask import Flask</span><br><span class="line">app = Flask(&apos;app_folder&apos;)</span><br></pre></td></tr></table></figure><br><p>阅读 Miguel Grinberg's book: Flask Web Developent SECOND EDITION 中的一个小应用。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os        </span><br><span class="line"><span class="keyword">from</span> datetime <span class="keyword">import</span> datetime       <span class="comment"># python 标准库，datetime.utcnow()</span></span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, render_template, session, redirect, url_for, flash        </span><br><span class="line"><span class="keyword">from</span> flask_bootstrap <span class="keyword">import</span> Bootstrap       <span class="comment"># flask 扩展</span></span><br><span class="line"><span class="keyword">from</span> flask_moment <span class="keyword">import</span> Moment     <span class="comment"># flask 扩展</span></span><br><span class="line"><span class="keyword">from</span> flask_wtf <span class="keyword">import</span> FlaskForm</span><br><span class="line"><span class="keyword">from</span> wtforms <span class="keyword">import</span> StringField, SubmitField</span><br><span class="line"><span class="keyword">from</span> wtforms.validators <span class="keyword">import</span> DataRequired</span><br><span class="line"><span class="keyword">from</span> flask_sqlalchemy <span class="keyword">import</span> SQLAlchemy</span><br><span class="line"><span class="keyword">from</span> flask_migrate <span class="keyword">import</span> Migrate</span><br><span class="line"></span><br><span class="line">basedir = os.path.abspath(os.path.dirname(__file__))</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)       <span class="comment"># 创建应用</span></span><br><span class="line">app.config[<span class="string">'SECRET_KEY'</span>] = <span class="string">'hard to guess string'</span></span><br><span class="line">app.config[<span class="string">'SQLALCHEMY_DATABASE_URI'</span>] = <span class="string">'sqlite:///'</span> + os.path.join(basedir, <span class="string">'data.sqlite'</span>)</span><br><span class="line">app.config[<span class="string">'SQLALCHEMY_TRACK_MODIFICATIONS'</span>] = <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">bootstrap = Bootstrap(app)      <span class="comment"># templates 文件夹中 base.html 扩展了 bootstrap/base.html</span></span><br><span class="line">moment = Moment(app)        <span class="comment"># 设置日期、时间的格式。moment.js 由 base.html导入</span></span><br><span class="line">db = SQLAlchemy(app)        <span class="comment"># 创建数据库</span></span><br><span class="line"></span><br><span class="line">migrate = Migrate(app, db)</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Role</span><span class="params">(db.Model)</span>:</span></span><br><span class="line">    __tablename__ = <span class="string">'roles'</span>        <span class="comment"># 表格名称</span></span><br><span class="line">    id = db.Column(db.Integer, primary_key=<span class="literal">True</span>)</span><br><span class="line">    name = db.Column(db.String(<span class="number">64</span>), unique=<span class="literal">True</span>)</span><br><span class="line">    users = db.relationship(<span class="string">'User'</span>, backref=<span class="string">'role'</span>, lazy=<span class="string">'dynamic'</span>)          <span class="comment"># 与 User 类关联。backref 给 User 类创建 role 属性，在生成 User 对象时通过 role 与一个 Role 对象关联。</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__repr__</span><span class="params">(self)</span>:</span>        <span class="comment"># 直接输出对象或者通过 print 打印对象时，信息都按__repr__方法中定义的格式进行显示。 类似的 __str__ 只有在 print 打印时才生效。便于调试。</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">'&lt;Role %r&gt;'</span> % self.name</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span><span class="params">(db.Model)</span>:</span></span><br><span class="line">    __tablename__ = <span class="string">'users'</span></span><br><span class="line">    id = db.Column(db.Integer, primary_key=<span class="literal">True</span>)</span><br><span class="line">    username = db.Column(db.String(<span class="number">64</span>), unique=<span class="literal">True</span>, index=<span class="literal">True</span>)</span><br><span class="line">    role_id = db.Column(db.Integer, db.ForeignKey(<span class="string">'roles.id'</span>))</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__repr__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">'&lt;User %r&gt;'</span> % self.username</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">NameForm</span><span class="params">(FlaskForm)</span>:</span></span><br><span class="line">    name = StringField(<span class="string">'What is your name?'</span>, validators=[DataRequired()])   <span class="comment"># DataRequired()要求提交时表单不为空</span></span><br><span class="line">    submit = SubmitField(<span class="string">'Submit'</span>)     <span class="comment"># 表单的提交按钮。 在 render  html 时，添加 type='Submit' 属性</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.shell_context_processor</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">make_shell_context</span><span class="params">()</span>:</span>        <span class="comment"># 运行 flask shell 时自动从 app(hello.py) 导入 db, User, Role</span></span><br><span class="line">    <span class="keyword">return</span> dict(db=db, User=User, Role=Role)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.errorhandler(404)      </span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">page_not_found</span><span class="params">(e)</span>:</span>        <span class="comment">#  404，500 为 html 错误类型</span></span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">'404.html'</span>), <span class="number">404</span>     <span class="comment"># 返回元组</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.errorhandler(500)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">internal_server_error</span><span class="params">(e)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">'500.html'</span>), <span class="number">500</span></span><br><span class="line"></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="string">@app.route('/')</span></span><br><span class="line"><span class="string">def index():</span></span><br><span class="line"><span class="string">    return render_template('index.html', current_time=datetime.utcnow())</span></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route('/user/&lt;name&gt;')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">user</span><span class="params">(name)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">'user.html'</span>, name=name)       <span class="comment"># name=name， 前者代表 user.html 中的 name 变量，后者代表由用户在网址栏中输入的值，即&lt;name&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route('/', methods=['GET', 'POST'])        </span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">index</span><span class="params">()</span>:</span>      <span class="comment"># Post/Redirect/Get pattern，inde()被调用两次</span></span><br><span class="line">    form = NameForm()        <span class="comment"># 生成表单实例</span></span><br><span class="line">    <span class="keyword">if</span> form.validate_on_submit():        <span class="comment"># 表单被提交且通过所有的 validators （这里只有 DataRequired()一个）时返回 True</span></span><br><span class="line">        old_name = session.get(<span class="string">'name'</span>)</span><br><span class="line">        <span class="keyword">if</span> old_name <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span> <span class="keyword">and</span> old_name != form.name.data:</span><br><span class="line">            flash(<span class="string">'Looks like you have changed your name!'</span>)        <span class="comment"># 当两次提交的内容不同时显示提示框。flash() 里的参数被 模板 base.html 中的 get_flashed_messages() 函数提取。</span></span><br><span class="line">        session[<span class="string">'name'</span>] = form.name.data        <span class="comment"># 保存表单提交的 data</span></span><br><span class="line">        <span class="keyword">return</span> redirect(url_for(<span class="string">'index'</span>))        <span class="comment"># url_for('index') 返回 root URL。redirect() 发出对 root URL 的 GET请求，作为对 POST 请求的回应。</span></span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">'index.html'</span>, form=form, name=session.get(<span class="string">'name'</span>))        <span class="comment"># 对 redirect() 的 GET请求的回应。</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 加入数据库</span></span><br><span class="line"><span class="meta">@app.route('/', methods=['GET', 'POST'])</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">index</span><span class="params">()</span>:</span></span><br><span class="line">    form = NameForm()</span><br><span class="line">    <span class="keyword">if</span> form.validate_on_submit():</span><br><span class="line">        user = User.query.filter_by(username=form.name.data).first()        <span class="comment"># 查询表单提交的用户名</span></span><br><span class="line">        <span class="keyword">if</span> user <span class="keyword">is</span> <span class="literal">None</span>:        <span class="comment"># 如果不在数据库中就把它加入</span></span><br><span class="line">            user = User(username=form.name.data)</span><br><span class="line">            db.session.add(user)</span><br><span class="line">            db.session.commit()</span><br><span class="line">            session[<span class="string">'known'</span>] = <span class="literal">False</span>          </span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            session[<span class="string">'known'</span>] = <span class="literal">True</span></span><br><span class="line">        session[<span class="string">'name'</span>] = form.name.data</span><br><span class="line">        <span class="keyword">return</span> redirect(url_for(<span class="string">'index'</span>))</span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">'index.html'</span>, form=form, name=session.get(<span class="string">'name'</span>), known=session.get(<span class="string">'known'</span>, <span class="literal">False</span>))</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;link rel=&quot;stylesheet&quot; class=&quot;aplayer-secondary-style-marker&quot; href=&quot;/assets/css/APlayer.min.css&quot;&gt;&lt;script src=&quot;/assets/js/APlayer.min.js&quot; cla
      
    
    </summary>
    
    
      <category term="Flask" scheme="https://hejtao.netlify.com/tags/Flask/"/>
    
  </entry>
  
  <entry>
    <title>How to Create a Personal Blog</title>
    <link href="https://hejtao.netlify.com/2018/05/22/2018-5-22/"/>
    <id>https://hejtao.netlify.com/2018/05/22/2018-5-22/</id>
    <published>2018-05-22T13:37:37.000Z</published>
    <updated>2019-11-11T19:59:33.201Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><meta name="referrer" content="no-referrer"><div class="toc"><!-- toc --><ul><li><a href="#the-structure-of-the-blog">The Structure of The Blog</a></li><li><a href="#apply-for-a-github-account-and-create-a-repository">Apply For a Github Account and Create a Repository</a></li><li><a href="#create-hexo-source-file">Create hexo source file</a><ul><li><a href="#download-and-install">download and install</a></li><li><a href="#create-file">create file</a></li><li><a href="#select-and-add-your-theme">select and add your theme</a></li></ul></li><li><a href="#2-4-deploy-the-source-file-to-the-github-repository">2.4 deploy the source file to the github repository</a></li></ul><!-- tocstop --></div><p>When you see this blog post, you have already had some kind of motivation to create a personal blog, maybe it is to possess something, record your ideas or just to be cool.  From my observation, most people who have a personal blog are the  computer professionals. But this does not mean you have to create your blog with much computer knowledge. The rest of this post will show you the process can be easy and fun.</p><h3><span id="the-structure-of-the-blog">The Structure of The Blog</span><a href="#the-structure-of-the-blog" class="header-anchor">#</a></h3><p><img src="https://upload-images.jianshu.io/upload_images/1863961-5041e3b13c9ead5f.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="">From the structure, you almost know what to do next. You don't have to build a browser, since your PC has already had one. You just need to do the left two things, applying for a github account as the remote platform to store your blog files, creating the local source file which is the root of your blog.</p><h3><span id="apply-for-a-github-account-and-create-a-repository">Apply For a Github Account and Create a Repository</span><a href="#apply-for-a-github-account-and-create-a-repository" class="header-anchor">#</a></h3><p>Click <a href="https://github.com/" target="_blank" rel="noopener">Github</a> to apply.<img src="https://upload-images.jianshu.io/upload_images/1863961-57e384e683a71433.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt=""></p><h3><span id="create-hexo-source-file">Create hexo source file</span><a href="#create-hexo-source-file" class="header-anchor">#</a></h3><p>Most of the source file is generated by <code>Hexo</code> which is a popular blog framework and is based on <code>Node.js</code>. We also need <code>Git</code> to deploy the source file to your newly created repository.</p><h4><span id="download-and-install">download and install</span><a href="#download-and-install" class="header-anchor">#</a></h4><p><a href="https://nodejs.org/en/download/" target="_blank" rel="noopener">Node.js</a><a href="https://www.git-scm.com/download/" target="_blank" rel="noopener">Git</a><code>Hexo</code> is installed with the  <code>Git</code> tool. After installing the <code>Git</code>, click your the right mouse button on the desktop and select the &quot;Git Bash Here&quot; option (means open the bash window in the current directory). Type the following commond to enter your home directory.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> ~</span><br></pre></td></tr></table></figure><p><img src="https://upload-images.jianshu.io/upload_images/1863961-b6fd2d229c7dd513.gif?imageMogr2/auto-orient/strip%7CimageView2/2/w/600" alt=""></p><p>Input the following commond to install <code>Hexo</code>.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install hexo-cli -g</span><br></pre></td></tr></table></figure><h4><span id="create-file">create file</span><a href="#create-file" class="header-anchor">#</a></h4><p>Create hexo source file . You can make your own file name to replace &quot;hexo_source&quot;.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hexo init hexo_source</span><br></pre></td></tr></table></figure><h4><span id="select-and-add-your-theme">select and add your theme</span><a href="#select-and-add-your-theme" class="header-anchor">#</a></h4><p>Select a theme from <a href="https://hexo.io/themes/" target="_blank" rel="noopener">hexo themes library</a> . You can also use  <a href="https://github.com/monniya/hexo-theme-new-vno" target="_blank" rel="noopener">hexo-new-vno</a> if you like the theme of my blog 😉. Then use the commond to add the theme file to your hexo source file you have already created.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> hexo_source</span><br><span class="line">git <span class="built_in">clone</span> https://github.com/monniya/hexo-theme-new-vno themes/new-vno</span><br></pre></td></tr></table></figure><p>You will see the new-vno file at  ...\hexo_source\themes\new-vno if not wrong.  In fact, hexo has a built-in theme landscape. Open ...\hexo_source\ <code>_config.yml</code> (you can use editors like atom, sublime etc.) and revise some arguments.</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">title:</span> <span class="string">小禾の新世界</span></span><br><span class="line"><span class="attr">subtitle:</span> <span class="string">STAY</span> <span class="string">HUNGRY,</span> <span class="string">STAY</span> <span class="string">FOOLISH!</span></span><br><span class="line"><span class="attr">description:</span>  <span class="string">(～￣▽￣)～</span> <span class="string">嗨</span>  <span class="string">(✿●'◡'●)</span></span><br><span class="line"><span class="attr">keywords:</span></span><br><span class="line"><span class="attr">author:</span> <span class="comment">#your name as author</span></span><br><span class="line"><span class="attr">language:</span> <span class="string">zh-Hans</span>  </span><br><span class="line"><span class="attr">timezone:</span>   </span><br><span class="line"><span class="attr">email:</span>  <span class="comment">#your email address</span></span><br><span class="line"></span><br><span class="line"><span class="attr">url:</span> <span class="attr">https://your_user_name.github.io</span></span><br><span class="line"><span class="attr">root:</span> <span class="string">/your_user_name.github.io/</span></span><br><span class="line"></span><br><span class="line"><span class="attr">plugins:</span> <span class="string">hexo-generate-feed</span>     <span class="comment"># you need input "npm install hexo-generate-feed" in the git bash window to install this plugin.</span></span><br><span class="line"></span><br><span class="line"><span class="attr">theme:</span> <span class="string">new-vno</span></span><br><span class="line"></span><br><span class="line"><span class="attr">deploy:</span></span><br><span class="line"><span class="attr">  type:</span> <span class="string">git</span></span><br><span class="line"><span class="attr">  repo:</span> <span class="attr">https://github.com/your_user_name/your_user_name.github.io.git</span></span><br><span class="line"><span class="attr">  branch:</span> <span class="string">master</span></span><br></pre></td></tr></table></figure><p>More details of configuration click <a href="https://hexo.io/zh-cn/docs/configuration.html" target="_blank" rel="noopener">here</a>.  And revise arguments in ...\hexo_source\themes\new-vno\ <code>_config.yml</code> to configure the theme.</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">menu:</span></span><br><span class="line">  <span class="string">归档:</span> <span class="string">/archives</span></span><br><span class="line"></span><br><span class="line"><span class="attr">rss:</span> <span class="string">/atom.xml</span></span><br><span class="line"><span class="attr">description:</span> <span class="string">RSS</span></span><br><span class="line"></span><br><span class="line"><span class="attr">social:</span></span><br><span class="line"><span class="attr">  weibo:</span> <span class="comment">#your weibo address</span></span><br><span class="line"><span class="attr">  github:</span> <span class="comment">#your github address</span></span><br><span class="line"><span class="attr">  stack_overflow:</span></span><br><span class="line"><span class="attr">  facebook:</span></span><br><span class="line"><span class="attr">  twitter:</span></span><br><span class="line"><span class="attr">  google_plus:</span></span><br></pre></td></tr></table></figure><p>To write a blog, you just write a markdown file in  .../hexo_source/source/ _posts folder.</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">---</span><br><span class="line">title: How to Create a Personal Blog</span><br><span class="line">date: 2018-05-22 21:37:37</span><br><span class="line">tags: hexo</span><br><span class="line">---</span><br><span class="line">My first blog post ...</span><br><span class="line"><span class="section">## The Structure of The Blog</span></span><br></pre></td></tr></table></figure><h3><span id="2-4-deploy-the-source-file-to-the-github-repository">2.4  deploy the source file to the github repository</span><a href="#2-4-deploy-the-source-file-to-the-github-repository" class="header-anchor">#</a></h3><p>Install the deploy tool.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install hexo-deployer-git --save</span><br></pre></td></tr></table></figure><p>Start to deploy.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hexo clean &amp;&amp; hexo g &amp;&amp; hexo d</span><br></pre></td></tr></table></figure><p>After the deploy you can visit your blog by typing &quot;your_user_name.github.io&quot; in the browser. You have already built the blog. Congratulations!</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;link rel=&quot;stylesheet&quot; class=&quot;aplayer-secondary-style-marker&quot; href=&quot;/assets/css/APlayer.min.css&quot;&gt;&lt;script src=&quot;/assets/js/APlayer.min.js&quot; cla
      
    
    </summary>
    
    
      <category term="Hexo" scheme="https://hejtao.netlify.com/tags/Hexo/"/>
    
  </entry>
  
</feed>
